---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Trapezoidal Rule Calculator - Numerical Integration";
const description = "Approximate definite integrals using the trapezoidal rule for f(x) = ax² + bx + c. Compare with exact integral and see error.";

const relatedCalcs = [
  { name: "Newton's Method", url: "/newton-method-calculator", description: "Root finder." },
  { name: "Interpolation Calculator", url: "/interpolation-calculator", description: "Linear interpolation." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
  { name: "Area Calculator", url: "/area-calculator", description: "Geometric areas." },
  { name: "Average Calculator", url: "/average-calculator", description: "Mean, median, mode." },
  { name: "Regression Calculator", url: "/regression-calculator", description: "Linear regression." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Trapezoidal Rule Calculator"
  keywords="trapezoidal rule, numerical integration, definite integral, trapezoid approximation, integration error, calculus"
  breadcrumbs={[{ name: "Trapezoidal Rule Calculator", url: "/trapezoidal-rule-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Trapezoidal Rule Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Numerically integrate f(x) = ax&sup2; + bx + c using the trapezoidal rule and compare with the exact result.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="p-3 bg-surface-alt rounded-xl text-center font-mono text-lg" id="tr-eq">
          f(x) = ax&sup2; + bx + c
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">a</label>
            <input type="number" id="tr-a" class="tr-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="1" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">b</label>
            <input type="number" id="tr-b" class="tr-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="0" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">c</label>
            <input type="number" id="tr-c" class="tr-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="0" step="any" />
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Lower Limit (a)</label>
            <input type="number" id="tr-lo" class="tr-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="0" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Upper Limit (b)</label>
            <input type="number" id="tr-hi" class="tr-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="1" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Intervals (n)</label>
            <input type="number" id="tr-n" class="tr-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="10" min="1" max="10000" />
          </div>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Trapezoidal Approximation</div>
          <div class="text-5xl font-extrabold font-mono" id="tr-result">0</div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Exact Integral</div>
            <div class="text-xl font-bold" id="tr-exact">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Absolute Error</div>
            <div class="text-xl font-bold" id="tr-error">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Relative Error</div>
            <div class="text-xl font-bold" id="tr-relerr">0%</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Step Size (h)</div>
            <div class="text-xl font-bold" id="tr-h">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Number of Points</div>
            <div class="text-xl font-bold" id="tr-pts">0</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Computation Detail</h3>
          <div class="text-sm text-text-secondary font-mono whitespace-pre-wrap" id="tr-detail"></div>
        </div>
      </div>

      <ShareButton calculatorId="trapezoidal-rule" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Trapezoidal Rule</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm">
        <p>&int; f(x)dx &approx; (h/2) [f(x<sub>0</sub>) + 2f(x<sub>1</sub>) + 2f(x<sub>2</sub>) + ... + 2f(x<sub>n-1</sub>) + f(x<sub>n</sub>)]</p>
        <p>where h = (b - a) / n</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcTR() {
      const ca = parseFloat((document.getElementById('tr-a') as HTMLInputElement).value) || 0;
      const cb = parseFloat((document.getElementById('tr-b') as HTMLInputElement).value) || 0;
      const cc = parseFloat((document.getElementById('tr-c') as HTMLInputElement).value) || 0;
      const lo = parseFloat((document.getElementById('tr-lo') as HTMLInputElement).value) || 0;
      const hi = parseFloat((document.getElementById('tr-hi') as HTMLInputElement).value) || 0;
      const n = Math.max(1, parseInt((document.getElementById('tr-n') as HTMLInputElement).value) || 1);
      const fmt = (v: number) => Number.isInteger(v) ? String(v) : v.toFixed(8);

      const f = (x: number) => ca * x * x + cb * x + cc;

      // Trapezoidal rule
      const h = (hi - lo) / n;
      let sum = f(lo) + f(hi);
      for (let i = 1; i < n; i++) {
        sum += 2 * f(lo + i * h);
      }
      const trapApprox = (h / 2) * sum;

      // Exact integral: (a/3)x³ + (b/2)x² + cx evaluated from lo to hi
      const F = (x: number) => (ca / 3) * x * x * x + (cb / 2) * x * x + cc * x;
      const exact = F(hi) - F(lo);

      const absError = Math.abs(trapApprox - exact);
      const relError = exact !== 0 ? (absError / Math.abs(exact)) * 100 : 0;

      document.getElementById('tr-eq')!.textContent = `f(x) = ${ca}x² + ${cb >= 0 ? '+' : ''}${cb}x + ${cc >= 0 ? '+' : ''}${cc}`;
      document.getElementById('tr-result')!.textContent = fmt(trapApprox);
      document.getElementById('tr-exact')!.textContent = fmt(exact);
      document.getElementById('tr-error')!.textContent = fmt(absError);
      document.getElementById('tr-relerr')!.textContent = relError.toFixed(6) + '%';
      document.getElementById('tr-h')!.textContent = fmt(h);
      document.getElementById('tr-pts')!.textContent = String(n + 1);

      let detail = `Antiderivative: F(x) = (${ca}/3)x³ + (${cb}/2)x² + ${cc}x\n`;
      detail += `F(${hi}) = ${fmt(F(hi))}\n`;
      detail += `F(${lo}) = ${fmt(F(lo))}\n`;
      detail += `Exact = F(${hi}) - F(${lo}) = ${fmt(exact)}\n\n`;
      detail += `Trapezoidal: h = (${hi} - ${lo}) / ${n} = ${fmt(h)}\n`;
      if (n <= 10) {
        detail += `Points: `;
        for (let i = 0; i <= n; i++) {
          const xi = lo + i * h;
          detail += `f(${fmt(xi)}) = ${fmt(f(xi))}${i < n ? ', ' : ''}`;
        }
      } else {
        detail += `(${n + 1} evaluation points, first 3 and last shown)\n`;
        for (let i = 0; i < 3; i++) {
          const xi = lo + i * h;
          detail += `  f(${fmt(xi)}) = ${fmt(f(xi))}\n`;
        }
        detail += `  ...\n`;
        const xi = hi;
        detail += `  f(${fmt(xi)}) = ${fmt(f(xi))}`;
      }

      document.getElementById('tr-detail')!.textContent = detail;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.tr-in').forEach(el => {
        el.addEventListener('input', calcTR);
        el.addEventListener('change', calcTR);
      });
      calcTR();
    }, 50);
  </script>
</CalculatorLayout>
