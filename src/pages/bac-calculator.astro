---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "BAC Calculator - Blood Alcohol Content Estimator";
const description = "Estimate your blood alcohol content (BAC) based on drinks, weight, gender, and time. Know when you'll be sober and legal to drive.";

const relatedCalcs = [
  { name: "BMI Calculator", url: "/bmi-calculator", description: "Body Mass Index." },
  { name: "Calorie Calculator", url: "/calorie-calculator", description: "Daily calories." },
  { name: "Water Intake", url: "/water-intake-calculator", description: "Hydration." },
  { name: "Weight Loss Calculator", url: "/weight-loss-calculator", description: "Weight loss." },
  { name: "Time Calculator", url: "/time-calculator", description: "Time math." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="BAC Calculator"
  keywords="BAC calculator, blood alcohol content, blood alcohol level, breathalyzer estimate, sober calculator, alcohol calculator"
  breadcrumbs={[{ name: "BAC Calculator", url: "/bac-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">BAC Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate your blood alcohol content based on what you've consumed.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-xl text-sm text-yellow-800 mb-6">
        <strong>Disclaimer:</strong> This is an estimate only. Do NOT rely on this to determine if you're safe to drive. When in doubt, don't drive.
      </div>

      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Gender</label>
          <div class="flex gap-2">
            <button class="bac-gender-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-primary text-white" data-gender="male">Male</button>
            <button class="bac-gender-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-surface-alt text-text-secondary" data-gender="female">Female</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Body Weight</label>
          <div class="flex gap-1">
            <input type="number" id="bac-weight" class="flex-1 px-3 py-2.5 border border-border rounded-xl text-lg" value="170" min="80" max="500">
            <select id="bac-unit" class="px-2 py-2 border border-border rounded-xl text-sm">
              <option value="lbs">lbs</option>
              <option value="kg">kg</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Drinks Consumed</label>
        <div class="grid grid-cols-2 gap-3" id="bac-drinks">
          <div class="p-3 bg-surface-alt rounded-xl">
            <div class="text-xs text-text-muted uppercase mb-1">Beer (12 oz, 5%)</div>
            <div class="flex items-center gap-2">
              <button class="bac-dec px-2 py-1 border border-border rounded-lg font-bold" data-drink="beer">−</button>
              <span class="text-2xl font-bold w-8 text-center" id="bac-beer">2</span>
              <button class="bac-inc px-2 py-1 border border-border rounded-lg font-bold" data-drink="beer">+</button>
            </div>
          </div>
          <div class="p-3 bg-surface-alt rounded-xl">
            <div class="text-xs text-text-muted uppercase mb-1">Wine (5 oz, 12%)</div>
            <div class="flex items-center gap-2">
              <button class="bac-dec px-2 py-1 border border-border rounded-lg font-bold" data-drink="wine">−</button>
              <span class="text-2xl font-bold w-8 text-center" id="bac-wine">0</span>
              <button class="bac-inc px-2 py-1 border border-border rounded-lg font-bold" data-drink="wine">+</button>
            </div>
          </div>
          <div class="p-3 bg-surface-alt rounded-xl">
            <div class="text-xs text-text-muted uppercase mb-1">Shot (1.5 oz, 40%)</div>
            <div class="flex items-center gap-2">
              <button class="bac-dec px-2 py-1 border border-border rounded-lg font-bold" data-drink="shot">−</button>
              <span class="text-2xl font-bold w-8 text-center" id="bac-shot">0</span>
              <button class="bac-inc px-2 py-1 border border-border rounded-lg font-bold" data-drink="shot">+</button>
            </div>
          </div>
          <div class="p-3 bg-surface-alt rounded-xl">
            <div class="text-xs text-text-muted uppercase mb-1">Cocktail (mixed)</div>
            <div class="flex items-center gap-2">
              <button class="bac-dec px-2 py-1 border border-border rounded-lg font-bold" data-drink="cocktail">−</button>
              <span class="text-2xl font-bold w-8 text-center" id="bac-cocktail">0</span>
              <button class="bac-inc px-2 py-1 border border-border rounded-lg font-bold" data-drink="cocktail">+</button>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-1">Time Since First Drink</label>
        <div class="flex gap-2">
          <input type="number" id="bac-hours" class="flex-1 px-4 py-3 border border-border rounded-xl text-lg" value="1" min="0" max="24" step="0.5">
          <span class="self-center text-text-muted font-semibold">hours</span>
        </div>
      </div>

      <!-- Results -->
      <div class="p-6 rounded-2xl text-white text-center mb-4" id="bac-result-bg">
        <div class="text-sm uppercase tracking-wide mb-1 opacity-80">Estimated BAC</div>
        <div class="text-5xl font-extrabold" id="bac-result">0.000%</div>
        <div class="text-sm mt-2 font-semibold" id="bac-status">Sober</div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Standard Drinks</div>
          <div class="text-xl font-bold" id="bac-std-drinks">0</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Sober In (approx)</div>
          <div class="text-xl font-bold" id="bac-sober-in">0 hrs</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Total Calories</div>
          <div class="text-xl font-bold" id="bac-calories">0</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Legal Limit (0.08%)</div>
          <div class="text-xl font-bold" id="bac-legal">—</div>
        </div>
      </div>

      <!-- BAC level guide -->
      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h3 class="font-semibold text-sm text-text mb-2">BAC Effects Guide</h3>
        <div class="space-y-1 text-sm" id="bac-guide"></div>
      </div>

      <ShareButton calculatorId="bac" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How BAC Is Calculated</h2>
      <p>This calculator uses the Widmark formula to estimate BAC:</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono">BAC = (Alcohol in grams / (Body Weight in grams × r)) × 100 − (0.015 × Hours)</div>
      <p>Where r = 0.73 for males and 0.66 for females (Widmark factor for body water ratio).</p>

      <h3 class="text-xl font-semibold text-text mt-8">Legal Limits</h3>
      <ul>
        <li><strong>United States:</strong> 0.08% BAC (0.04% for commercial drivers)</li>
        <li><strong>Most of Europe:</strong> 0.05% BAC</li>
        <li><strong>Zero tolerance states:</strong> Under 21 = 0.00-0.02%</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>How long does it take to sober up?</strong> Your body metabolizes alcohol at roughly 0.015% BAC per hour. There's no way to speed this up — coffee, water, and food don't reduce BAC faster.</p>
      <p><strong>Is this calculator accurate enough to determine if I can drive?</strong> No. Individual metabolism varies widely. This is only an estimate. If you've been drinking, use a rideshare or designated driver.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let bacGender = 'male';
    const drinks: Record<string, number> = { beer: 2, wine: 0, shot: 0, cocktail: 0 };
    // Standard drink = 14g alcohol. Oz of pure alcohol per drink type:
    const alcOz: Record<string, number> = { beer: 0.6, wine: 0.6, shot: 0.6, cocktail: 0.9 };
    const calories: Record<string, number> = { beer: 153, wine: 125, shot: 97, cocktail: 200 };

    function calcBAC() {
      let weightLbs = parseFloat((document.getElementById('bac-weight') as HTMLInputElement).value) || 170;
      const unit = (document.getElementById('bac-unit') as HTMLSelectElement).value;
      if (unit === 'kg') weightLbs = weightLbs * 2.2046;

      const hours = parseFloat((document.getElementById('bac-hours') as HTMLInputElement).value) || 0;
      const r = bacGender === 'male' ? 0.73 : 0.66;

      const totalAlcOz = Object.entries(drinks).reduce((s, [k, v]) => s + v * alcOz[k], 0);
      const totalCalories = Object.entries(drinks).reduce((s, [k, v]) => s + v * calories[k], 0);
      const stdDrinks = Object.values(drinks).reduce((a, b) => a + b, 0);

      // Widmark formula: BAC = (Alcohol oz × 5.14 / (Weight lbs × r)) - (0.015 × hours)
      let bac = (totalAlcOz * 5.14 / (weightLbs * r)) - (0.015 * hours);
      bac = Math.max(0, bac);

      const soberHours = bac > 0 ? bac / 0.015 : 0;

      // Color coding
      const bg = document.getElementById('bac-result-bg')!;
      let status: string;
      if (bac === 0) { bg.className = 'p-6 rounded-2xl text-white text-center mb-4 bg-gray-500'; status = 'Sober'; }
      else if (bac < 0.04) { bg.className = 'p-6 rounded-2xl text-white text-center mb-4 bg-green-600'; status = 'Minimal impairment'; }
      else if (bac < 0.08) { bg.className = 'p-6 rounded-2xl text-white text-center mb-4 bg-yellow-600'; status = 'Impaired — DO NOT DRIVE'; }
      else if (bac < 0.15) { bg.className = 'p-6 rounded-2xl text-white text-center mb-4 bg-orange-600'; status = 'Legally drunk — DANGER'; }
      else { bg.className = 'p-6 rounded-2xl text-white text-center mb-4 bg-red-700'; status = 'SEVERE impairment — DANGEROUS'; }

      document.getElementById('bac-result')!.textContent = bac.toFixed(3) + '%';
      document.getElementById('bac-status')!.textContent = status;
      document.getElementById('bac-std-drinks')!.textContent = String(stdDrinks);
      document.getElementById('bac-sober-in')!.textContent = soberHours > 0 ? soberHours.toFixed(1) + ' hrs' : 'Now';
      document.getElementById('bac-calories')!.textContent = Math.round(totalCalories).toLocaleString();
      document.getElementById('bac-legal')!.textContent = bac >= 0.08 ? 'OVER' : 'Under';

      // Guide
      const levels = [
        { bac: 0.02, label: '0.02%', effect: 'Slight mood elevation, relaxation', color: 'text-green-700' },
        { bac: 0.05, label: '0.05%', effect: 'Lowered inhibitions, impaired judgment', color: 'text-yellow-700' },
        { bac: 0.08, label: '0.08%', effect: 'Legal limit — impaired coordination & reaction', color: 'text-orange-700' },
        { bac: 0.10, label: '0.10%', effect: 'Clear deterioration of motor control', color: 'text-orange-700' },
        { bac: 0.15, label: '0.15%', effect: 'Major impairment — risk of blackout', color: 'text-red-700' },
        { bac: 0.30, label: '0.30%', effect: 'Potential loss of consciousness', color: 'text-red-800' },
        { bac: 0.40, label: '0.40%', effect: 'Risk of death', color: 'text-red-900' },
      ];
      document.getElementById('bac-guide')!.innerHTML = levels.map(l =>
        `<div class="flex items-center gap-2 py-1 ${bac >= l.bac ? 'font-bold' : ''}">
          <span class="w-14 font-mono ${l.color}">${l.label}</span>
          <div class="flex-1 h-1.5 bg-border/30 rounded-full"><div class="h-full rounded-full ${bac >= l.bac ? 'bg-primary' : 'bg-border/50'}" style="width:${Math.min(100, (l.bac / 0.4) * 100)}%"></div></div>
          <span class="text-text-secondary text-xs flex-1">${l.effect}</span>
        </div>`
      ).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.bac-gender-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.bac-gender-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white'); b.classList.add('bg-surface-alt', 'text-text-secondary'); });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary'); btn.classList.add('bg-primary', 'text-white');
          bacGender = (btn as HTMLElement).dataset.gender || 'male';
          calcBAC();
        });
      });

      document.querySelectorAll('.bac-inc').forEach(btn => {
        btn.addEventListener('click', () => {
          const drink = (btn as HTMLElement).dataset.drink!;
          drinks[drink]++;
          document.getElementById(`bac-${drink}`)!.textContent = String(drinks[drink]);
          calcBAC();
        });
      });

      document.querySelectorAll('.bac-dec').forEach(btn => {
        btn.addEventListener('click', () => {
          const drink = (btn as HTMLElement).dataset.drink!;
          drinks[drink] = Math.max(0, drinks[drink] - 1);
          document.getElementById(`bac-${drink}`)!.textContent = String(drinks[drink]);
          calcBAC();
        });
      });

      ['bac-weight', 'bac-hours'].forEach(id => document.getElementById(id)!.addEventListener('input', calcBAC));
      document.getElementById('bac-unit')!.addEventListener('change', calcBAC);

      calcBAC();
    }, 50);
  </script>
</CalculatorLayout>
