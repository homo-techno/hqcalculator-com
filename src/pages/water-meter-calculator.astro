---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Water Meter Calculator - Flow Rate & Usage Tracking";
const description = "Calculate flow rate from water meter readings, track daily and monthly usage, detect leaks, and estimate water costs from meter data.";
const relatedCalcs = [
  { name: "Water Usage", url: "/water-usage-calculator", description: "Estimate daily water use." },
  { name: "Electricity Bill", url: "/electricity-bill-calculator", description: "Utility bill estimates." },
  { name: "Water Quality", url: "/water-quality-calculator", description: "Water quality testing." },
  { name: "Pool Volume", url: "/pool-volume-calculator", description: "Pool water volume." },
  { name: "Water Intake", url: "/water-intake-calculator", description: "Personal water intake." },
  { name: "Irrigation", url: "/irrigation-calculator", description: "Irrigation water needs." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Water Meter Calculator" keywords="water meter calculator, flow rate, water usage tracking, leak detection, meter reading" breadcrumbs={[{ name: "Water Meter", url: "/water-meter-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Water Meter Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate flow rate and usage from water meter readings, detect leaks, and track your water costs.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-text mb-1">Meter Reading Unit</label>
          <select id="wm2-unit" class="wm2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="gallons" selected>Gallons</option>
            <option value="cf">Cubic Feet</option>
            <option value="ccf">CCF (100 cubic feet)</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Previous Reading</label>
            <input type="number" id="wm2-prev" class="wm2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="45230" min="0" step="1">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Current Reading</label>
            <input type="number" id="wm2-curr" class="wm2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="49850" min="0" step="1">
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Days Between Readings</label>
          <input type="number" id="wm2-days" class="wm2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="30" min="1" max="365" step="1">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">People in Household</label>
            <input type="number" id="wm2-people" class="wm2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="4" min="1" max="20" step="1">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Water Rate ($/1000 gal)</label>
            <input type="number" id="wm2-rate" class="wm2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="10" min="1" step="0.5">
          </div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Total Usage This Period</div>
          <div class="text-4xl font-extrabold" id="wm2-total">0 gallons</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Daily Average</div><div class="text-xl font-bold" id="wm2-daily">0 gal/day</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Per Person/Day</div><div class="text-xl font-bold" id="wm2-perperson">0 gal</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Monthly Projected</div><div class="text-xl font-bold" id="wm2-monthly">0 gal</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Annual Projected</div><div class="text-xl font-bold" id="wm2-annual">0 gal</div></div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-3">Cost &amp; Leak Analysis</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span>Period Cost</span><span class="font-bold" id="wm2-cost">$0</span></div>
            <div class="flex justify-between"><span>Monthly Projected Cost</span><span class="font-bold" id="wm2-mcost">$0</span></div>
            <div class="flex justify-between"><span>Annual Projected Cost</span><span class="font-bold" id="wm2-acost">$0</span></div>
            <div class="flex justify-between"><span>Usage vs Average</span><span class="font-bold" id="wm2-compare">--</span></div>
            <div class="flex justify-between"><span>Leak Indicator</span><span class="font-bold" id="wm2-leak">--</span></div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="water-meter" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcWM2() {
      const unit = (document.getElementById('wm2-unit') as HTMLSelectElement).value;
      const prev = parseFloat((document.getElementById('wm2-prev') as HTMLInputElement).value) || 0;
      const curr = parseFloat((document.getElementById('wm2-curr') as HTMLInputElement).value) || 0;
      const days = parseInt((document.getElementById('wm2-days') as HTMLInputElement).value) || 30;
      const people = parseInt((document.getElementById('wm2-people') as HTMLInputElement).value) || 4;
      const rate = parseFloat((document.getElementById('wm2-rate') as HTMLInputElement).value) || 10;

      let usageRaw = curr - prev;
      if (usageRaw < 0) usageRaw = 0;

      // Convert to gallons
      let usageGal = usageRaw;
      if (unit === 'cf') usageGal = usageRaw * 7.48052;
      else if (unit === 'ccf') usageGal = usageRaw * 748.052;

      const dailyAvg = usageGal / days;
      const perPerson = dailyAvg / people;
      const monthlyProj = dailyAvg * 30;
      const annualProj = dailyAvg * 365;

      const periodCost = usageGal * rate / 1000;
      const monthlyCost = monthlyProj * rate / 1000;
      const annualCost = annualProj * rate / 1000;

      // Average US household: ~80-100 gal/person/day
      const avgPerPerson = 82;
      const ratio = perPerson / avgPerPerson;
      let comparison = 'Average';
      if (ratio < 0.6) comparison = 'Well below average (excellent)';
      else if (ratio < 0.85) comparison = 'Below average (good)';
      else if (ratio < 1.15) comparison = 'Average';
      else if (ratio < 1.5) comparison = 'Above average';
      else comparison = 'Well above average';

      // Leak detection: if per-person usage > 150 gal/day, likely leak
      let leak = 'No leak suspected';
      if (perPerson > 200) leak = 'Likely significant leak!';
      else if (perPerson > 150) leak = 'Possible leak detected';
      else if (perPerson > 120) leak = 'Usage is high - check fixtures';

      document.getElementById('wm2-total')!.textContent = Math.round(usageGal).toLocaleString() + ' gallons';
      document.getElementById('wm2-daily')!.textContent = Math.round(dailyAvg).toLocaleString() + ' gal/day';
      document.getElementById('wm2-perperson')!.textContent = Math.round(perPerson) + ' gal';
      document.getElementById('wm2-monthly')!.textContent = Math.round(monthlyProj).toLocaleString() + ' gal';
      document.getElementById('wm2-annual')!.textContent = Math.round(annualProj).toLocaleString() + ' gal';
      document.getElementById('wm2-cost')!.textContent = '$' + periodCost.toFixed(2);
      document.getElementById('wm2-mcost')!.textContent = '$' + monthlyCost.toFixed(2);
      document.getElementById('wm2-acost')!.textContent = '$' + Math.round(annualCost);
      document.getElementById('wm2-compare')!.textContent = comparison;
      document.getElementById('wm2-leak')!.textContent = leak;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.wm2-in').forEach(el => { el.addEventListener('input', calcWM2); el.addEventListener('change', calcWM2); });
      calcWM2();
    }, 50);
  </script>
</CalculatorLayout>
