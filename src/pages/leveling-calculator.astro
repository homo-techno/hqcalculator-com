---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Leveling Calculator - Differential Leveling Computation";
const description = "Compute elevations from differential leveling field notes with benchmark, backsight, height of instrument, foresight, and turning points.";
const relatedCalcs = [
  { name: "Elevation Difference", url: "/elevation-difference-calculator", description: "Trig leveling." },
  { name: "Total Station", url: "/total-station-calculator", description: "Total station calculations." },
  { name: "Cut & Fill", url: "/cut-fill-calculator", description: "Earthwork volumes." },
  { name: "Topographic Profile", url: "/topographic-profile-calculator", description: "Profile & grade." },
  { name: "Vertical Curve", url: "/vertical-curve-calculator", description: "Vertical curve design." },
  { name: "Slope Grade", url: "/slope-grade-calculator", description: "Slope conversions." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Leveling Calculator" keywords="differential leveling, backsight, foresight, height of instrument, benchmark, turning point, elevation" breadcrumbs={[{ name: "Leveling Calculator", url: "/leveling-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Leveling Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Enter benchmark elevation, backsight, and foresight readings to compute the height of instrument and point elevations.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Benchmark (BM) Elevation (ft)</label>
          <input type="number" id="lev-bm" class="lev-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="100.000" step="0.001">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Level Readings (one per line: type, reading)</label>
          <textarea id="lev-data" class="lev-in w-full px-4 py-3 border border-border rounded-xl text-sm font-mono" rows="8" placeholder="BS/FS/TP, reading"></textarea>
          <p class="text-xs text-text-muted mt-1">Format: BS,reading or FS,reading or TP (auto: FS then BS). Example: BS,4.52 then FS,3.10</p>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Final Elevation</div>
          <div class="text-5xl font-extrabold font-mono" id="lev-final">--</div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Current HI</div>
            <div class="text-xl font-bold" id="lev-hi">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Rise/Fall</div>
            <div class="text-xl font-bold" id="lev-rise">--</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Sum of BS</div>
            <div class="text-xl font-bold" id="lev-sbs">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Sum of FS</div>
            <div class="text-xl font-bold" id="lev-sfs">--</div>
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl overflow-x-auto">
          <div class="text-xs text-text-muted uppercase mb-2">Level Book</div>
          <div class="text-xs font-mono whitespace-pre-wrap" id="lev-table">--</div>
        </div>
      </div>
      <ShareButton calculatorId="leveling" />
      <FeedbackWidget />
    </div>
    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Differential Leveling</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p>HI = Elevation + BS</p>
        <p>Elevation = HI - FS</p>
        <p>Check: Sum BS - Sum FS = Final Elev - Starting Elev</p>
      </div>
    </article>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcLEV() {
      const bm = parseFloat((document.getElementById('lev-bm') as HTMLInputElement).value) || 0;
      const raw = (document.getElementById('lev-data') as HTMLTextAreaElement).value.trim();
      if (!raw) {
        ['lev-final','lev-hi','lev-rise','lev-sbs','lev-sfs','lev-table'].forEach(id => document.getElementById(id)!.textContent = '--');
        return;
      }
      const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      let elevation = bm;
      let hi = 0;
      let sumBS = 0, sumFS = 0;
      let hiSet = false;
      let table = 'Station | BS | HI | FS | Elevation\n';
      table += 'BM | - | - | - | ' + bm.toFixed(3) + '\n';
      let stationNum = 1;
      let lastElev = bm;
      for (const line of lines) {
        const parts = line.split(/[,\s\t]+/);
        const type = parts[0].toUpperCase();
        const reading = parseFloat(parts[1]) || 0;
        if (type === 'BS') {
          hi = lastElev + reading;
          sumBS += reading;
          hiSet = true;
          table += 'S' + stationNum + ' | ' + reading.toFixed(3) + ' | ' + hi.toFixed(3) + ' | - | -\n';
        } else if (type === 'FS' && hiSet) {
          lastElev = hi - reading;
          sumFS += reading;
          table += 'S' + stationNum + ' | - | - | ' + reading.toFixed(3) + ' | ' + lastElev.toFixed(3) + '\n';
          stationNum++;
        } else if (type === 'TP') {
          if (hiSet) {
            lastElev = hi - reading;
            sumFS += reading;
            table += 'TP' + stationNum + ' | - | - | ' + reading.toFixed(3) + ' | ' + lastElev.toFixed(3) + '\n';
          }
          if (parts.length > 2) {
            const bsReading = parseFloat(parts[2]) || 0;
            hi = lastElev + bsReading;
            sumBS += bsReading;
            table += 'TP' + stationNum + ' | ' + bsReading.toFixed(3) + ' | ' + hi.toFixed(3) + ' | - | -\n';
          }
          stationNum++;
        }
      }
      const rise = sumBS - sumFS;
      document.getElementById('lev-final')!.textContent = lastElev.toFixed(3) + ' ft';
      document.getElementById('lev-hi')!.textContent = hi.toFixed(3) + ' ft';
      document.getElementById('lev-rise')!.textContent = rise.toFixed(3) + ' ft';
      document.getElementById('lev-sbs')!.textContent = sumBS.toFixed(3);
      document.getElementById('lev-sfs')!.textContent = sumFS.toFixed(3);
      document.getElementById('lev-table')!.textContent = table;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.lev-in').forEach(el => { el.addEventListener('input', calcLEV); el.addEventListener('change', calcLEV); });
      (document.getElementById('lev-data') as HTMLTextAreaElement).value = 'BS, 4.520\nFS, 3.100\nBS, 5.200\nFS, 2.800\nBS, 3.900\nFS, 4.100';
      calcLEV();
    }, 50);
  </script>
</CalculatorLayout>
