---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Dado Joint Calculator - Dado & Rabbet Dimensions & Router Bit Selection";
const description = "Calculate dado and rabbet joint dimensions including width, depth, and optimal router bit selection. Supports through, stopped, and blind dados.";

const relatedCalcs = [
  { name: "Mortise & Tenon Calculator", url: "/mortise-tenon-calculator", description: "M&T joint dimensions." },
  { name: "Router Bit Speed Calculator", url: "/router-bit-speed-calculator", description: "Router RPM calculator." },
  { name: "Dovetail Joint Calculator", url: "/dovetail-joint-calculator", description: "Dovetail layout." },
  { name: "Box Joint Calculator", url: "/box-joint-calculator", description: "Box joint layout." },
  { name: "Saw Blade Calculator", url: "/saw-blade-calculator", description: "Saw blade specs." },
  { name: "Plywood Cut Calculator", url: "/plywood-cut-calculator", description: "Plywood cut optimizer." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Dado Joint Calculator"
  keywords="dado calculator, dado joint, rabbet joint, router bit, dado width, dado depth, stopped dado, plywood dado"
  breadcrumbs={[{ name: "Dado Joint Calculator", url: "/dado-joint-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Dado Joint Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate dado and rabbet joint dimensions and select the right router bit or dado blade setup.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Joint Type</label>
        <select id="dj2-type" class="dj2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="through" selected>Through Dado</option>
          <option value="stopped">Stopped (Blind) Dado</option>
          <option value="rabbet">Rabbet</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Shelf/Insert Material</label>
          <select id="dj2-matl" class="dj2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="0.75" selected>3/4" Solid Wood</option>
            <option value="0.7185">23/32" Plywood (3/4" nominal)</option>
            <option value="0.5">1/2" Solid Wood</option>
            <option value="0.46875">15/32" Plywood (1/2" nominal)</option>
            <option value="0.25">1/4" Solid/Hardboard</option>
            <option value="0.234375">1/4" Plywood (actual)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Case Material Thickness</label>
          <input type="number" id="dj2-case" class="dj2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.75" min="0.25" step="0.0625">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Dado Length (inches)</label>
          <input type="number" id="dj2-length" class="dj2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="12" min="1" step="0.5">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Cutting Method</label>
          <select id="dj2-method" class="dj2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="router" selected>Router</option>
            <option value="dado-set">Dado Blade Set (Table Saw)</option>
          </select>
        </div>
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Dado Width</div>
        <div class="text-4xl font-extrabold" id="dj2-width">--</div>
        <div class="text-sm text-blue-200 mt-1">to match insert material</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Dado Depth</div>
          <div class="text-xl font-bold" id="dj2-depth">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Remaining Material</div>
          <div class="text-xl font-bold" id="dj2-remain">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Bit/Blade Size</div>
          <div class="text-xl font-bold" id="dj2-bit">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Number of Passes</div>
          <div class="text-xl font-bold" id="dj2-passes">--</div>
        </div>
      </div>

      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h4 class="font-semibold text-sm text-text mb-1">Setup Notes</h4>
        <p class="text-sm text-text-secondary" id="dj2-notes">--</p>
      </div>

      <ShareButton calculatorId="dado-joint" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Dado Joint Design Rules</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Dado Depth = 1/3 to 1/2 of case material thickness</strong></p>
        <p><strong>Dado Width = exact thickness of insert material</strong></p>
      </div>
      <h3 class="text-xl font-semibold text-text mt-8">Plywood Tip</h3>
      <p>Nominal 3/4" plywood is actually 23/32" (0.7185"). A standard 3/4" dado blade or router bit will be too wide. Use a 23/32" undersized plywood bit, or use shims on your dado blade set.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcDJ2() {
      const jointType = (document.getElementById('dj2-type') as HTMLSelectElement).value;
      const insertThick = parseFloat((document.getElementById('dj2-matl') as HTMLSelectElement).value) || 0.75;
      const caseThick = parseFloat((document.getElementById('dj2-case') as HTMLInputElement).value) || 0.75;
      const dadoLength = parseFloat((document.getElementById('dj2-length') as HTMLInputElement).value) || 12;
      const method = (document.getElementById('dj2-method') as HTMLSelectElement).value;

      // Dado width matches insert thickness
      const dadoWidth = insertThick;

      // Dado depth: 1/3 of case thickness (standard rule), max 1/2
      const dadoDepth = Math.round(caseThick / 3 * 16) / 16; // Round to nearest 1/16"
      const remaining = caseThick - dadoDepth;

      // Router bit selection
      const routerBits = [0.125, 0.1875, 0.25, 0.3125, 0.375, 0.5, 0.625, 0.75, 1.0];
      let bestBit = 0.25;
      let passes = 1;

      if (method === 'router') {
        // Find largest bit that evenly divides into dado width
        for (let i = routerBits.length - 1; i >= 0; i--) {
          if (routerBits[i] <= dadoWidth) {
            bestBit = routerBits[i];
            passes = Math.ceil(dadoWidth / bestBit);
            break;
          }
        }
        // If exact match exists
        const exactMatch = routerBits.find(b => Math.abs(b - dadoWidth) < 0.005);
        if (exactMatch) {
          bestBit = exactMatch;
          passes = 1;
        }
      } else {
        // Dado blade set
        bestBit = dadoWidth;
        passes = 1;
      }

      const frac = (n: number) => {
        const fracs: Record<string, string> = {
          '0.125':'1/8"','0.1875':'3/16"','0.234':'15/64"','0.25':'1/4"',
          '0.3125':'5/16"','0.375':'3/8"','0.469':'15/32"','0.5':'1/2"',
          '0.625':'5/8"','0.719':'23/32"','0.75':'3/4"','1':'1"'
        };
        const key = n.toFixed(3).replace(/0+$/,'').replace(/\.$/,'');
        return fracs[key] || n.toFixed(3) + '"';
      };

      document.getElementById('dj2-width')!.textContent = dadoWidth.toFixed(4) + '"';
      document.getElementById('dj2-depth')!.textContent = dadoDepth.toFixed(4) + '" (' + Math.round(dadoDepth / caseThick * 100) + '% of case)';
      document.getElementById('dj2-remain')!.textContent = remaining.toFixed(4) + '"';
      document.getElementById('dj2-bit')!.textContent = method === 'router' ? frac(bestBit) + ' straight bit' : 'Dado set at ' + dadoWidth.toFixed(3) + '"';
      document.getElementById('dj2-passes')!.textContent = passes + (passes > 1 ? ' (shift fence)' : '');

      let notes = '';
      if (jointType === 'stopped') {
        notes = 'Stop the dado 1/2" to 1" from the front edge. Notch the shelf corner to fit. Square the stopped end with a chisel.';
      } else if (jointType === 'rabbet') {
        notes = 'For a rabbet, cut on the edge of the board. Depth should equal the insert thickness for a flush fit. Width equals dado depth.';
      } else {
        notes = 'Through dado runs the full width of the case side. Simplest to cut but visible from the front edge.';
      }
      if (Math.abs(insertThick - 0.75) > 0.01 && insertThick < 0.75 && insertThick > 0.7) {
        notes += ' Note: Undersized plywood detected. Use a plywood-specific router bit or add shims to dado blade set.';
      }
      document.getElementById('dj2-notes')!.textContent = notes;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.dj2-in').forEach(el => {
        el.addEventListener('input', calcDJ2);
        el.addEventListener('change', calcDJ2);
      });
      calcDJ2();
    }, 50);
  </script>
</CalculatorLayout>
