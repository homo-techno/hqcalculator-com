---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Habit Formation Calculator - Days to Automaticity (Lally Model)";
const description = "Calculate how long it takes to form a habit using Phillippa Lally's research model. Track consistency, streak, and automaticity estimate.";
const relatedCalcs = [
  { name: "Productivity Calculator", url: "/productivity-calculator", description: "Productivity metrics." },
  { name: "Calorie Calculator", url: "/calorie-calculator", description: "Daily calorie needs." },
  { name: "Sleep Calculator", url: "/sleep-calculator", description: "Optimize sleep cycles." },
  { name: "Pomodoro Calculator", url: "/pomodoro-calculator", description: "Pomodoro timer." },
  { name: "Age Calculator", url: "/age-calculator", description: "Calculate exact age." },
  { name: "Water Intake", url: "/water-intake-calculator", description: "Daily hydration." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Habit Formation Calculator" keywords="habit formation, days to form habit, Lally model, automaticity, habit streak, consistency, behavior change" breadcrumbs={[{ name: "Habit Formation", url: "/habit-formation-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Habit Formation Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate how many days it will take to make a behavior automatic, based on Lally et al. (2010) research.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-1">Habit Complexity</label>
          <select id="hb3-complex" class="hb3-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center">
            <option value="simple">Simple (e.g., drinking a glass of water)</option>
            <option value="moderate">Moderate (e.g., 10-min walk, journaling)</option>
            <option value="complex">Complex (e.g., 30-min exercise, meditation)</option>
            <option value="very_complex">Very Complex (e.g., 1-hr workout, new diet)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Current Consistency (% of days performed this week)</label>
          <input type="number" id="hb3-consist" class="hb3-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" min="0" max="100" step="5">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Current Streak (consecutive days)</label>
          <input type="number" id="hb3-streak" class="hb3-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" min="0" max="365" step="1">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Days Since You Started</label>
          <input type="number" id="hb3-days" class="hb3-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" min="0" max="365" step="1">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Environmental Cue Strength (1-10)</label>
          <input type="range" id="hb3-cue" class="hb3-in w-full" min="1" max="10" step="1">
          <div class="flex justify-between text-xs text-text-secondary"><span>Weak/random (1)</span><span>Strong/consistent (10)</span></div>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm opacity-80">Estimated Days to Automaticity</div>
          <div class="text-2xl font-extrabold mt-1" id="hb3-target">--</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Automaticity Score</div>
            <div class="text-xl font-bold text-text mt-1" id="hb3-auto">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Days Remaining</div>
            <div class="text-xl font-bold text-text mt-1" id="hb3-remain">--</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Consistency Score</div>
            <div class="text-xl font-bold text-text mt-1" id="hb3-cscore">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Streak Bonus</div>
            <div class="text-xl font-bold text-text mt-1" id="hb3-sbonus">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <div class="text-xs text-text-secondary mb-2">Tips for Building This Habit</div>
          <div class="text-sm text-text" id="hb3-tips">--</div>
        </div>
      </div>

      <ShareButton calculatorId="habit-formation" />
      <FeedbackWidget />
    </div>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcHB3() {
      const complexity = (document.getElementById('hb3-complex') as HTMLSelectElement).value;
      const consistency = parseFloat((document.getElementById('hb3-consist') as HTMLInputElement).value) || 70;
      const streak = parseInt((document.getElementById('hb3-streak') as HTMLInputElement).value) || 0;
      const daysIn = parseInt((document.getElementById('hb3-days') as HTMLInputElement).value) || 0;
      const cue = parseInt((document.getElementById('hb3-cue') as HTMLInputElement).value) || 5;

      // Base days from Lally research: mean 66, range 18-254
      const baseMap: Record<string, number> = {
        simple: 30,
        moderate: 66,
        complex: 120,
        very_complex: 200,
      };
      let baseDays = baseMap[complexity] || 66;

      // Consistency adjustment: higher consistency = faster
      const consistFactor = 1 + (100 - consistency) / 100 * 0.5;

      // Cue strength adjustment: strong cues speed up habit formation
      const cueFactor = 1 - (cue - 5) * 0.03;

      const targetDays = Math.round(baseDays * consistFactor * cueFactor);
      const remaining = Math.max(0, targetDays - daysIn);

      // Automaticity estimate (0-100%)
      const autoRaw = daysIn > 0 ? Math.min(100, (daysIn / targetDays) * 100 * (consistency / 100)) : 0;
      const automaticity = autoRaw.toFixed(1);

      // Streak bonus
      let streakBonus = 'None';
      if (streak >= 21) streakBonus = 'Strong (+15% speed)';
      else if (streak >= 14) streakBonus = 'Good (+10% speed)';
      else if (streak >= 7) streakBonus = 'Moderate (+5% speed)';
      else if (streak >= 3) streakBonus = 'Building';

      // Consistency rating
      let cLabel = '';
      if (consistency >= 90) cLabel = 'Excellent';
      else if (consistency >= 70) cLabel = 'Good';
      else if (consistency >= 50) cLabel = 'Fair';
      else cLabel = 'Needs improvement';

      document.getElementById('hb3-target')!.textContent = targetDays + ' days (range: ' + Math.round(targetDays * 0.5) + '-' + Math.round(targetDays * 1.5) + ')';
      document.getElementById('hb3-auto')!.textContent = automaticity + '%';
      document.getElementById('hb3-remain')!.textContent = remaining > 0 ? remaining + ' days' : 'Likely formed!';
      document.getElementById('hb3-cscore')!.textContent = consistency + '% - ' + cLabel;
      document.getElementById('hb3-sbonus')!.textContent = streakBonus;

      let tips: string[] = [];
      if (consistency < 70) tips.push('Focus on never missing twice in a row. Missing once does not significantly delay habit formation.');
      if (cue < 5) tips.push('Attach your habit to an existing routine (habit stacking). Example: "After I pour my morning coffee, I will..."');
      if (streak < 7) tips.push('Build your streak. Even 7 consecutive days creates momentum and neural pathway reinforcement.');
      if (complexity === 'very_complex') tips.push('For complex habits, start with a 2-minute version and gradually increase. Consistency matters more than duration.');
      if (autoRaw > 50) tips.push('You are past the halfway point. The habit is becoming more automatic. Keep going!');
      if (tips.length === 0) tips.push('Excellent conditions! You have strong cues, good consistency, and are making solid progress toward automaticity.');

      document.getElementById('hb3-tips')!.textContent = tips.join(' ');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      (document.getElementById('hb3-consist') as HTMLInputElement).value = '70';
      (document.getElementById('hb3-streak') as HTMLInputElement).value = '5';
      (document.getElementById('hb3-days') as HTMLInputElement).value = '14';
      (document.getElementById('hb3-cue') as HTMLInputElement).value = '5';
      document.querySelectorAll('.hb3-in').forEach(el => {
        el.addEventListener('input', calcHB3);
        el.addEventListener('change', calcHB3);
      });
      calcHB3();
    }, 50);
  </script>
</CalculatorLayout>
