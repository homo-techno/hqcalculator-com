---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Psychrometric Calculator - Wet Bulb, Enthalpy, Humidity Ratio";
const description = "Calculate psychrometric properties: wet bulb temperature, enthalpy, humidity ratio, dew point, specific volume, and relative humidity from dry bulb and one other property.";

const relatedCalcs = [
  { name: "Cooling Load Calculator", url: "/cooling-load-calculator", description: "Cooling loads." },
  { name: "Dehumidifier Calculator", url: "/dehumidifier-calculator", description: "Dehumidifier sizing." },
  { name: "Cooling Tower Calculator", url: "/cooling-tower-calculator", description: "Tower sizing." },
  { name: "Coil Sizing Calculator", url: "/coil-sizing-calculator", description: "Coil selection." },
  { name: "Heat Exchanger Calculator", url: "/heat-exchanger-calculator", description: "Heat transfer." },
  { name: "Ventilation Rate Calculator", url: "/ventilation-rate-calculator", description: "ASHRAE ventilation." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Psychrometric Calculator"
  keywords="psychrometric calculator, wet bulb, dew point, humidity ratio, enthalpy, specific volume, relative humidity, psychrometric chart"
  breadcrumbs={[{ name: "Psychrometric Calculator", url: "/psychrometric-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Psychrometric Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate all psychrometric properties from dry bulb temperature and relative humidity.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-5">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Dry Bulb Temperature</label>
            <input type="number" id="psy-db" class="psy-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="80" min="-40" max="200" step="1">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Temp Unit</label>
            <select id="psy-unit" class="psy-in w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="F" selected>Fahrenheit (°F)</option>
              <option value="C">Celsius (°C)</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Relative Humidity (%)</label>
            <input type="number" id="psy-rh" class="psy-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="50" min="0" max="100" step="1">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Barometric Pressure (in Hg)</label>
            <input type="number" id="psy-bp" class="psy-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="29.921" min="20" max="35" step="0.01">
          </div>
        </div>

        <!-- Results -->
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Wet Bulb Temperature</div>
          <div class="text-4xl font-extrabold" id="psy-wb">--</div>
          <div class="text-sm text-blue-200 mt-1" id="psy-wb-unit">°F</div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Dew Point</div>
            <div class="text-xl font-bold" id="psy-dp">--</div>
            <div class="text-xs text-text-muted" id="psy-dp-unit">°F</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Humidity Ratio</div>
            <div class="text-xl font-bold" id="psy-hr">--</div>
            <div class="text-xs text-text-muted">gr/lb (grains per lb)</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Enthalpy</div>
            <div class="text-xl font-bold" id="psy-h">--</div>
            <div class="text-xs text-text-muted">BTU/lb dry air</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Specific Volume</div>
            <div class="text-xl font-bold" id="psy-sv">--</div>
            <div class="text-xs text-text-muted">ft3/lb dry air</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Vapor Pressure</div>
            <div class="text-xl font-bold" id="psy-vp">--</div>
            <div class="text-xs text-text-muted">psi</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Air Density</div>
            <div class="text-xl font-bold" id="psy-den">--</div>
            <div class="text-xs text-text-muted">lb/ft3</div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="psychrometric" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl mx-auto prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Psychrometric Properties Explained</h2>
      <ul>
        <li><strong>Dry Bulb Temperature:</strong> The air temperature measured by a standard thermometer</li>
        <li><strong>Wet Bulb Temperature:</strong> Temperature measured with an evaporating-water-covered thermometer; indicates the adiabatic saturation temperature</li>
        <li><strong>Dew Point:</strong> Temperature at which moisture begins to condense</li>
        <li><strong>Humidity Ratio:</strong> Mass of water vapor per mass of dry air</li>
        <li><strong>Enthalpy:</strong> Total energy content of the air-water mixture</li>
        <li><strong>Specific Volume:</strong> Volume per unit mass of dry air</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcPSY() {
      const unit = (document.getElementById('psy-unit') as HTMLSelectElement).value;
      let dbRaw = parseFloat((document.getElementById('psy-db') as HTMLInputElement).value) || 0;
      const rh = (parseFloat((document.getElementById('psy-rh') as HTMLInputElement).value) || 0) / 100;
      const bpInHg = parseFloat((document.getElementById('psy-bp') as HTMLInputElement).value) || 29.921;
      const bpPsi = bpInHg * 0.491154;

      // Convert to Fahrenheit for calculations
      let dbF = unit === 'C' ? dbRaw * 9 / 5 + 32 : dbRaw;
      let dbC = unit === 'C' ? dbRaw : (dbRaw - 32) * 5 / 9;

      // Saturation vapor pressure (Antoine equation approximation) in psi
      // Using ASHRAE correlation
      const C8 = -10440.397, C9 = -11.29465, C10 = -0.027022355, C11 = 0.00001289036, C12 = -2.4780681e-9, C13 = 6.5459673;
      const TRankine = dbF + 459.67;
      let lnPws: number;
      if (dbC >= 0) {
        lnPws = C8 / TRankine + C9 + C10 * TRankine + C11 * TRankine * TRankine + C12 * Math.pow(TRankine, 3) + C13 * Math.log(TRankine);
      } else {
        // Below freezing: simplified
        const C1 = -10214.165, C2 = -4.8932428, C3 = -0.005376579, C4 = 0.000001920237, C5 = 6.35019;
        lnPws = C1 / TRankine + C2 + C3 * TRankine + C4 * TRankine * TRankine + C5 * Math.log(TRankine);
      }
      const pws = Math.exp(lnPws); // psi (saturation vapor pressure)
      const pw = rh * pws; // partial pressure of water vapor (psi)
      const pAtm = bpPsi;

      // Humidity ratio (lb water / lb dry air)
      const W = 0.621945 * pw / (pAtm - pw);

      // Humidity ratio in grains/lb (1 lb = 7000 grains)
      const Wgrains = W * 7000;

      // Dew point: find temperature where pws = pw
      // Simplified: Tdp(°F) = (100.45 + 33.193*log(pw) + 2.319*(log(pw))^2 + 0.1706*(log(pw))^3) for pw in psi
      let dpF: number;
      if (pw > 0) {
        const alpha = Math.log(pw);
        dpF = 100.45 + 33.193 * alpha + 2.319 * alpha * alpha + 0.17074 * Math.pow(alpha, 3) + 1.2063 * Math.pow(pw, 0.1984);
      } else {
        dpF = -100;
      }
      let dpC = (dpF - 32) * 5 / 9;

      // Enthalpy (BTU/lb dry air)
      const h = 0.240 * dbF + W * (1061 + 0.444 * dbF);

      // Specific volume (ft3/lb dry air)
      const sv = 0.370486 * (dbF + 459.67) * (1 + 1.6078 * W) / pAtm;

      // Air density
      const density = (1 + W) / sv;

      // Wet bulb approximation (Stull formula)
      const T = dbC;
      const rhPct = rh * 100;
      const wbC = T * Math.atan(0.151977 * Math.pow(rhPct + 8.313659, 0.5))
                 + Math.atan(T + rhPct)
                 - Math.atan(rhPct - 1.676331)
                 + 0.00391838 * Math.pow(rhPct, 1.5) * Math.atan(0.023101 * rhPct)
                 - 4.686035;
      const wbF = wbC * 9 / 5 + 32;

      const dispUnit = unit === 'C' ? '°C' : '°F';
      document.getElementById('psy-wb')!.textContent = (unit === 'C' ? wbC.toFixed(1) : wbF.toFixed(1));
      document.getElementById('psy-wb-unit')!.textContent = dispUnit;
      document.getElementById('psy-dp')!.textContent = (unit === 'C' ? dpC.toFixed(1) : dpF.toFixed(1));
      document.getElementById('psy-dp-unit')!.textContent = dispUnit;
      document.getElementById('psy-hr')!.textContent = Wgrains.toFixed(1);
      document.getElementById('psy-h')!.textContent = h.toFixed(2);
      document.getElementById('psy-sv')!.textContent = sv.toFixed(3);
      document.getElementById('psy-vp')!.textContent = pw.toFixed(4);
      document.getElementById('psy-den')!.textContent = density.toFixed(4);

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.psy-in').forEach(el => {
        el.addEventListener('input', calcPSY);
        el.addEventListener('change', calcPSY);
      });
      calcPSY();
    }, 50);
  </script>
</CalculatorLayout>
