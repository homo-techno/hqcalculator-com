---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Car Payment Calculator - Auto Loan Monthly Payment 2026";
const description = "Calculate your monthly car payment with down payment, trade-in value, interest rate, and loan term. See total interest paid and amortization summary.";

const relatedCalcs = [
  { name: "Auto Loan Calculator", url: "/auto-loan-calculator", description: "Full auto loan analysis." },
  { name: "Car Lease Calculator", url: "/car-lease-calculator", description: "Lease payment estimator." },
  { name: "Loan Calculator", url: "/loan-calculator", description: "General loan calculator." },
  { name: "Mortgage Calculator", url: "/mortgage-calculator", description: "Home loan payments." },
  { name: "Debt Payoff Calculator", url: "/debt-payoff-calculator", description: "Pay off debt faster." },
  { name: "Budget Calculator", url: "/budget-calculator", description: "Monthly budget planner." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Car Payment Calculator"
  keywords="car payment calculator, auto payment, monthly car payment, car loan, vehicle financing, car loan interest"
  breadcrumbs={[{ name: "Car Payment Calculator", url: "/car-payment-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Car Payment Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate your monthly car loan payment, total interest, and see an amortization summary.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label for="cp2-price" class="block text-sm font-medium text-text mb-1">Vehicle Price ($)</label>
          <input type="number" id="cp2-price" class="cp2-in w-full border border-border rounded-lg px-3 py-2" value="32000" min="0" step="500" />
        </div>
        <div>
          <label for="cp2-down" class="block text-sm font-medium text-text mb-1">Down Payment ($)</label>
          <input type="number" id="cp2-down" class="cp2-in w-full border border-border rounded-lg px-3 py-2" value="3000" min="0" step="500" />
        </div>
        <div>
          <label for="cp2-trade" class="block text-sm font-medium text-text mb-1">Trade-in Value ($)</label>
          <input type="number" id="cp2-trade" class="cp2-in w-full border border-border rounded-lg px-3 py-2" value="0" min="0" step="500" />
        </div>
        <div>
          <label for="cp2-rate" class="block text-sm font-medium text-text mb-1">Interest Rate (APR %)</label>
          <input type="number" id="cp2-rate" class="cp2-in w-full border border-border rounded-lg px-3 py-2" value="6.5" min="0" max="30" step="0.1" />
        </div>
        <div>
          <label for="cp2-term" class="block text-sm font-medium text-text mb-1">Loan Term (months)</label>
          <select id="cp2-term" class="cp2-in w-full border border-border rounded-lg px-3 py-2">
            <option value="24">24 months</option>
            <option value="36">36 months</option>
            <option value="48">48 months</option>
            <option value="60" selected>60 months</option>
            <option value="72">72 months</option>
            <option value="84">84 months</option>
          </select>
        </div>
        <div>
          <label for="cp2-tax" class="block text-sm font-medium text-text mb-1">Sales Tax (%)</label>
          <input type="number" id="cp2-tax" class="cp2-in w-full border border-border rounded-lg px-3 py-2" value="7" min="0" max="15" step="0.25" />
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Monthly Payment</div>
          <div class="text-5xl font-extrabold font-mono" id="cp2-result">$0</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Loan Amount</div>
            <div class="text-xl font-bold" id="cp2-loan-amt">$0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Interest</div>
            <div class="text-xl font-bold text-danger" id="cp2-interest">$0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Cost</div>
            <div class="text-xl font-bold" id="cp2-total-cost">$0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Sales Tax</div>
            <div class="text-xl font-bold" id="cp2-tax-amt">$0</div>
          </div>
        </div>

        <!-- Amortization Summary -->
        <div class="mt-4">
          <h3 class="text-lg font-bold text-text mb-2">Amortization Summary</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-border text-left">
                  <th class="py-2 pr-3 font-semibold">Year</th>
                  <th class="py-2 pr-3 font-semibold text-right">Principal</th>
                  <th class="py-2 pr-3 font-semibold text-right">Interest</th>
                  <th class="py-2 font-semibold text-right">Balance</th>
                </tr>
              </thead>
              <tbody id="cp2-amort"></tbody>
            </table>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="car-payment" />
      <FeedbackWidget />
    </div>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcCP2() {
      const price = parseFloat((document.getElementById('cp2-price') as HTMLInputElement).value) || 0;
      const down = parseFloat((document.getElementById('cp2-down') as HTMLInputElement).value) || 0;
      const trade = parseFloat((document.getElementById('cp2-trade') as HTMLInputElement).value) || 0;
      const annualRate = parseFloat((document.getElementById('cp2-rate') as HTMLInputElement).value) || 0;
      const term = parseInt((document.getElementById('cp2-term') as HTMLSelectElement).value) || 60;
      const taxRate = parseFloat((document.getElementById('cp2-tax') as HTMLInputElement).value) || 0;

      const salesTax = price * (taxRate / 100);
      const loanAmount = Math.max(0, price + salesTax - down - trade);
      const r = annualRate / 100 / 12;

      let monthly = 0;
      if (r > 0 && term > 0) {
        monthly = loanAmount * (r * Math.pow(1 + r, term)) / (Math.pow(1 + r, term) - 1);
      } else if (term > 0) {
        monthly = loanAmount / term;
      }

      const totalPayment = monthly * term;
      const totalInterest = totalPayment - loanAmount;
      const totalCost = totalPayment + down + trade;

      const fmt = (n: number) => '$' + Math.round(n).toLocaleString('en-US');

      (document.getElementById('cp2-result') as HTMLElement).textContent = fmt(monthly);
      (document.getElementById('cp2-loan-amt') as HTMLElement).textContent = fmt(loanAmount);
      (document.getElementById('cp2-interest') as HTMLElement).textContent = fmt(totalInterest);
      (document.getElementById('cp2-total-cost') as HTMLElement).textContent = fmt(totalCost);
      (document.getElementById('cp2-tax-amt') as HTMLElement).textContent = fmt(salesTax);

      // Amortization summary by year
      let balance = loanAmount;
      const years = Math.ceil(term / 12);
      let html = '';
      for (let y = 1; y <= years; y++) {
        let yPrinc = 0, yInt = 0;
        const monthsThisYear = Math.min(12, term - (y - 1) * 12);
        for (let m = 0; m < monthsThisYear; m++) {
          const interest = balance * r;
          const princ = monthly - interest;
          balance = Math.max(0, balance - princ);
          yPrinc += princ;
          yInt += interest;
        }
        html += `<tr class="border-b border-border/30">
          <td class="py-2 pr-3 text-text-secondary">Year ${y}</td>
          <td class="py-2 pr-3 text-right text-primary">${fmt(yPrinc)}</td>
          <td class="py-2 pr-3 text-right text-danger">${fmt(yInt)}</td>
          <td class="py-2 text-right font-medium">${fmt(balance)}</td>
        </tr>`;
      }
      (document.getElementById('cp2-amort') as HTMLElement).innerHTML = html;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.cp2-in').forEach(el => {
        el.addEventListener('input', calcCP2);
        el.addEventListener('change', calcCP2);
      });
      calcCP2();
    }, 50);
  </script>
</CalculatorLayout>
