---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Break-Even Calculator - Find Your Break-Even Point";
const description = "Calculate the break-even point for your business. Find how many units to sell or revenue needed to cover costs and start profiting.";

const relatedCalcs = [
  { name: "Profit Margin", url: "/profit-margin-calculator", description: "Margins." },
  { name: "ROI Calculator", url: "/roi-calculator", description: "Return on investment." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "Discount Calculator", url: "/discount-calculator", description: "Discounts." },
  { name: "Sales Tax Calculator", url: "/sales-tax-calculator", description: "Sales tax." },
  { name: "Loan Calculator", url: "/loan-calculator", description: "Loan payments." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Break-Even Calculator"
  keywords="break even calculator, break even point, business calculator, fixed costs, variable costs, profit analysis"
  breadcrumbs={[{ name: "Break-Even", url: "/break-even-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Break-Even Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Find out how many units you need to sell to cover your costs.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-text mb-1">Fixed Costs (per period)</label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span>
                <input type="number" id="be-fixed" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-xl font-bold" value="10000" min="0" step="100">
              </div>
              <p class="text-xs text-text-muted mt-1">Rent, salaries, insurance, etc.</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-text mb-1">Price per Unit</label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span>
                <input type="number" id="be-price" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-xl font-bold" value="50" min="0" step="1">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-text mb-1">Variable Cost per Unit</label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span>
                <input type="number" id="be-variable" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-xl font-bold" value="20" min="0" step="1">
              </div>
              <p class="text-xs text-text-muted mt-1">Materials, labor, shipping per unit</p>
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Break-Even Point</div>
            <div class="text-5xl font-extrabold" id="be-units">0</div>
            <div class="text-sm text-blue-200 mt-1">units</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Revenue Needed</div>
              <div class="text-xl font-bold text-secondary" id="be-revenue">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Contribution Margin</div>
              <div class="text-xl font-bold" id="be-margin">$0/unit</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Margin Ratio</div>
              <div class="text-xl font-bold" id="be-ratio">0%</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Cost per Unit at BE</div>
              <div class="text-xl font-bold" id="be-cost-per">$0</div>
            </div>
          </div>

          <!-- Profit table -->
          <div class="p-4 bg-surface-alt rounded-xl">
            <h3 class="font-semibold text-sm text-text mb-3">Profit at Different Sales Levels</h3>
            <div class="space-y-1 text-sm" id="be-profit-table"></div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="break-even" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Break-Even Analysis Works</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Contribution Margin</strong> = Price − Variable Cost</p>
        <p><strong>Break-Even Units</strong> = Fixed Costs ÷ Contribution Margin</p>
        <p><strong>Break-Even Revenue</strong> = Break-Even Units × Price</p>
      </div>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>What is the contribution margin?</strong> The amount each unit sale contributes toward covering fixed costs. It's the selling price minus variable costs per unit.</p>
      <p><strong>How can I lower my break-even point?</strong> Reduce fixed costs, reduce variable costs per unit, or increase the selling price.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString();

    function calcBE() {
      const fixed = parseFloat((document.getElementById('be-fixed') as HTMLInputElement).value) || 0;
      const price = parseFloat((document.getElementById('be-price') as HTMLInputElement).value) || 0;
      const variable = parseFloat((document.getElementById('be-variable') as HTMLInputElement).value) || 0;

      const margin = price - variable;
      const beUnits = margin > 0 ? Math.ceil(fixed / margin) : 0;
      const beRevenue = beUnits * price;
      const marginRatio = price > 0 ? (margin / price) * 100 : 0;
      const costPerUnit = beUnits > 0 ? (fixed / beUnits) + variable : 0;

      document.getElementById('be-units')!.textContent = beUnits.toLocaleString();
      document.getElementById('be-revenue')!.textContent = fmt(beRevenue);
      document.getElementById('be-margin')!.textContent = fmt(margin) + '/unit';
      document.getElementById('be-ratio')!.textContent = marginRatio.toFixed(1) + '%';
      document.getElementById('be-cost-per')!.textContent = fmt(costPerUnit);

      // Profit table
      const levels = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2, 3];
      document.getElementById('be-profit-table')!.innerHTML =
        '<div class="grid grid-cols-4 gap-2 font-semibold text-xs text-text-muted mb-1"><span>Units</span><span>Revenue</span><span>Costs</span><span>Profit</span></div>' +
        levels.map(mult => {
          const units = Math.round(beUnits * mult);
          const rev = units * price;
          const costs = fixed + units * variable;
          const profit = rev - costs;
          const isBreakEven = mult === 1;
          return `<div class="grid grid-cols-4 gap-2 text-xs ${isBreakEven ? 'font-bold text-primary bg-blue-50 rounded p-1' : profit < 0 ? 'text-danger' : ''}">
            <span>${units.toLocaleString()}</span>
            <span>${fmt(rev)}</span>
            <span>${fmt(costs)}</span>
            <span>${profit >= 0 ? '+' : ''}${fmt(profit)}</span>
          </div>`;
        }).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      ['be-fixed', 'be-price', 'be-variable'].forEach(id => {
        document.getElementById(id)!.addEventListener('input', calcBE);
      });
      calcBE();
    }, 50);
  </script>
</CalculatorLayout>
