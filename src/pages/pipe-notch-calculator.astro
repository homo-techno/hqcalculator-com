---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Pipe Notch Calculator - Cope & Fish-Mouth Cut Template";
const description = "Calculate cope (fish-mouth) cut dimensions for pipe-to-pipe joints at various angles. Generate cut profiles for round pipe intersections.";

const relatedCalcs = [
  { name: "Welding Rod Calculator", url: "/welding-rod-calculator", description: "Electrode consumption." },
  { name: "Metal Weight Calculator", url: "/metal-weight-calculator", description: "Metal weight." },
  { name: "Welding Cost Calculator", url: "/welding-cost-calculator", description: "Welding job costs." },
  { name: "Structural Steel Calculator", url: "/structural-steel-calculator", description: "Steel sections." },
  { name: "Metal Expansion Calculator", url: "/metal-expansion-calculator", description: "Thermal expansion." },
  { name: "Plasma Cutting Calculator", url: "/plasma-cutting-calculator", description: "Plasma settings." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Pipe Notch Calculator"
  keywords="pipe notch, pipe cope, fish mouth, pipe fitting, pipe joint, saddle cut, pipe intersection, pipe template, tube coping"
  breadcrumbs={[{ name: "Pipe Notch Calculator", url: "/pipe-notch-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Pipe Notch Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate cope/fish-mouth cut dimensions for pipe-to-pipe joints at any angle.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <!-- Branch Pipe OD -->
      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Branch Pipe OD</label>
          <input type="number" id="pn2-branch" class="pn2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="2" min="0.25" step="0.125">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Unit</label>
          <select id="pn2-unit" class="pn2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="in">inches (NPS OD)</option>
            <option value="mm">mm</option>
          </select>
        </div>
      </div>

      <!-- Main Pipe OD -->
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Main (Header) Pipe OD</label>
        <input type="number" id="pn2-main" class="pn2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="4" min="0.25" step="0.125">
      </div>

      <!-- Intersection Angle -->
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Intersection Angle (degrees)</label>
        <input type="number" id="pn2-angle" class="pn2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="90" min="15" max="90" step="5">
        <p class="text-xs text-text-muted mt-1">90 = perpendicular (T-joint), lower = angled saddle</p>
      </div>

      <!-- Number of template points -->
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Template Points</label>
        <select id="pn2-points" class="pn2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="12">12 points</option>
          <option value="24" selected>24 points</option>
          <option value="36">36 points</option>
        </select>
      </div>

      <!-- Results -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Cope Depth Range</div>
        <div class="text-4xl font-extrabold" id="pn2-range">--</div>
        <div class="text-sm text-blue-200 mt-1">min to max cut depth</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Branch Circumference</div>
          <div class="text-xl font-bold" id="pn2-circ">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Template Width</div>
          <div class="text-xl font-bold" id="pn2-width">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Max Cut Height</div>
          <div class="text-xl font-bold" id="pn2-max">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Min Cut Height</div>
          <div class="text-xl font-bold" id="pn2-min">--</div>
        </div>
      </div>

      <!-- Template Data Table -->
      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <div class="text-xs text-text-muted uppercase mb-2">Cut Template (wrap around branch pipe)</div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-border">
                <th class="py-1 px-2 text-left">Point</th>
                <th class="py-1 px-2 text-left">Angle</th>
                <th class="py-1 px-2 text-left">Distance Along</th>
                <th class="py-1 px-2 text-left">Cut Height</th>
              </tr>
            </thead>
            <tbody id="pn2-table">
            </tbody>
          </table>
        </div>
      </div>

      <ShareButton calculatorId="pipe-notch" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Pipe Coping Works</h2>
      <p>A pipe cope (fish-mouth) is a curved cut on the end of a branch pipe that allows it to fit tightly against a larger (or same-size) main pipe. The cut profile follows the contour of the main pipe at the intersection angle.</p>
      <h3 class="text-xl font-semibold text-text mt-8">Using the Template</h3>
      <ul>
        <li>Print or mark the template points around the branch pipe circumference</li>
        <li>Mark the cut height at each point around the pipe</li>
        <li>Connect the marks with a smooth curve</li>
        <li>Cut along the line with a bandsaw, grinder, or plasma cutter</li>
        <li>Bevel the edge for weld preparation (typically 30-37.5 degrees)</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcPN2() {
      const branchOD = parseFloat((document.getElementById('pn2-branch') as HTMLInputElement).value) || 2;
      const mainOD = parseFloat((document.getElementById('pn2-main') as HTMLInputElement).value) || 4;
      const angle = parseFloat((document.getElementById('pn2-angle') as HTMLInputElement).value) || 90;
      const unit = (document.getElementById('pn2-unit') as HTMLSelectElement).value;
      const points = parseInt((document.getElementById('pn2-points') as HTMLSelectElement).value) || 24;

      const unitLabel = unit === 'in' ? '"' : ' mm';
      const branchR = branchOD / 2;
      const mainR = mainOD / 2;
      const angleRad = angle * Math.PI / 180;
      const circumference = Math.PI * branchOD;

      // Calculate cut heights around the branch pipe
      // The cope profile is determined by the intersection of two cylinders
      const tableRows: string[] = [];
      let minH = Infinity;
      let maxH = -Infinity;

      for (let i = 0; i <= points; i++) {
        const theta = (i / points) * 2 * Math.PI; // angle around branch pipe
        const distAlong = (i / points) * circumference;

        // x-position on branch pipe surface (in main pipe frame)
        const x = branchR * Math.sin(theta);

        // Height of intersection: the point where branch pipe surface meets main pipe
        // For pipe on pipe: h = sqrt(R² - x²) / sin(angle) + offset
        const inside = mainR * mainR - x * x;
        let h = 0;
        if (inside >= 0) {
          h = Math.sqrt(inside) / Math.sin(angleRad);
        }

        // Adjust so minimum is at the sides
        if (h < minH) minH = h;
        if (h > maxH) maxH = h;

        tableRows.push(`<tr class="border-b border-border">
          <td class="py-1 px-2">${i}</td>
          <td class="py-1 px-2">${(theta * 180 / Math.PI).toFixed(0)}\u00B0</td>
          <td class="py-1 px-2">${distAlong.toFixed(3)}${unitLabel}</td>
          <td class="py-1 px-2">${h.toFixed(3)}${unitLabel}</td>
        </tr>`);
      }

      // Normalize so minimum is 0 (offset to base)
      // Re-render with normalized heights
      const tbody = document.getElementById('pn2-table')!;
      const rows2: string[] = [];
      for (let i = 0; i <= points; i++) {
        const theta = (i / points) * 2 * Math.PI;
        const distAlong = (i / points) * circumference;
        const x = branchR * Math.sin(theta);
        const inside = mainR * mainR - x * x;
        let h = inside >= 0 ? Math.sqrt(inside) / Math.sin(angleRad) : 0;
        const hNorm = h - minH;

        rows2.push(`<tr class="border-b border-border">
          <td class="py-1 px-2">${i}</td>
          <td class="py-1 px-2">${(theta * 180 / Math.PI).toFixed(0)}\u00B0</td>
          <td class="py-1 px-2">${distAlong.toFixed(3)}${unitLabel}</td>
          <td class="py-1 px-2">${hNorm.toFixed(3)}${unitLabel}</td>
        </tr>`);
      }
      tbody.innerHTML = rows2.join('');

      const rangeVal = (maxH - minH);

      document.getElementById('pn2-range')!.textContent = rangeVal.toFixed(3) + unitLabel;
      document.getElementById('pn2-circ')!.textContent = circumference.toFixed(3) + unitLabel;
      document.getElementById('pn2-width')!.textContent = circumference.toFixed(3) + unitLabel;
      document.getElementById('pn2-max')!.textContent = rangeVal.toFixed(3) + unitLabel;
      document.getElementById('pn2-min')!.textContent = '0' + unitLabel + ' (base)';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.pn2-in').forEach(el => {
        el.addEventListener('input', calcPN2);
        el.addEventListener('change', calcPN2);
      });
      calcPN2();
    }, 50);
  </script>
</CalculatorLayout>
