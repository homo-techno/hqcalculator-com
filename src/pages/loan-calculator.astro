---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import SliderInput from '../components/SliderInput.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Loan Calculator - Free Loan Payment Calculator 2026";
const description = "Calculate monthly loan payments, total interest, and payoff date for any loan. Personal loans, auto loans, student loans, and more. Free amortization schedule.";

const relatedCalcs = [
  { name: "Mortgage Calculator", url: "/mortgage-calculator", description: "Home loan payment calculator with taxes and PMI." },
  { name: "Auto Loan Calculator", url: "/auto-loan-calculator", description: "Calculate car loan payments." },
  { name: "Compound Interest Calculator", url: "/compound-interest-calculator", description: "See how your savings grow." },
  { name: "Debt Payoff Calculator", url: "/debt-payoff-calculator", description: "Plan your debt payoff strategy." },
  { name: "Student Loan Calculator", url: "/student-loan-calculator", description: "Student loan repayment planner." },
  { name: "Credit Card Calculator", url: "/credit-card-calculator", description: "Credit card payoff calculator." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Loan Calculator"
  keywords="loan calculator, loan payment calculator, loan amortization, personal loan calculator, monthly payment calculator"
  breadcrumbs={[{ name: "Loan Calculator", url: "/loan-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Loan Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate your monthly payment, total interest, and see a full amortization schedule for any loan.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <SliderInput id="loan-amount" label="Loan Amount" min={1000} max={500000} step={1000} value={25000} prefix="$" tooltip="Total amount you want to borrow" />
          <SliderInput id="loan-rate" label="Interest Rate (Annual)" min={0.5} max={30} step={0.25} value={7} suffix="%" tooltip="Annual percentage rate (APR)" />
          <SliderInput id="loan-term-months" label="Loan Term" min={6} max={360} step={6} value={60} suffix=" months" tooltip="Duration of the loan in months" />
        </div>

        <div class="space-y-4">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Monthly Payment</div>
            <div class="text-4xl sm:text-5xl font-extrabold" id="loan-monthly">$495</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Interest</div>
              <div class="text-xl font-bold text-danger" id="loan-total-interest">$4,700</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Payment</div>
              <div class="text-xl font-bold" id="loan-total-payment">$29,700</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Payoff Date</div>
              <div class="text-xl font-bold" id="loan-payoff">Mar 2031</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Interest %</div>
              <div class="text-xl font-bold" id="loan-interest-pct">15.8%</div>
            </div>
          </div>
          <!-- Donut -->
          <div class="chart-container p-4 bg-surface-alt rounded-xl">
            <canvas id="loan-donut" width="220" height="220"></canvas>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="loan" />
      <FeedbackWidget />
    </div>

    <!-- Amortization -->
    <div class="mt-12 bg-white border border-border rounded-2xl p-6 sm:p-8">
      <h2 class="text-2xl font-bold text-text mb-4">Amortization Schedule</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-border text-left">
              <th class="py-2 pr-3 font-semibold">Year</th>
              <th class="py-2 pr-3 font-semibold text-right">Payment</th>
              <th class="py-2 pr-3 font-semibold text-right">Principal</th>
              <th class="py-2 pr-3 font-semibold text-right">Interest</th>
              <th class="py-2 font-semibold text-right">Balance</th>
            </tr>
          </thead>
          <tbody id="loan-amort-tbody"></tbody>
        </table>
      </div>
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Loan Payments Are Calculated</h2>
      <p>Loan payments are calculated using the standard amortization formula. With each payment, a portion goes toward interest and the rest reduces the principal balance. In early payments, more goes to interest; over time, more goes to principal.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono">
        M = P &times; [r(1+r)<sup>n</sup>] / [(1+r)<sup>n</sup> - 1]
      </div>
      <p>Where M = monthly payment, P = principal, r = monthly interest rate, n = number of payments.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Types of Loans</h3>
      <ul>
        <li><strong>Personal loans:</strong> Unsecured, typically 6-7 years, rates 6-36%</li>
        <li><strong>Auto loans:</strong> Secured by vehicle, 3-7 years, rates 4-15%</li>
        <li><strong>Student loans:</strong> Federal (fixed ~5-7%) or private (variable 3-15%)</li>
        <li><strong>Home equity loans:</strong> Secured by home, 5-30 years, rates 7-12%</li>
        <li><strong>Business loans:</strong> Various terms, rates depend on creditworthiness</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">Tips to Reduce Loan Costs</h3>
      <ul>
        <li><strong>Improve credit score:</strong> Higher scores qualify for lower rates</li>
        <li><strong>Choose shorter terms:</strong> Less time = less total interest</li>
        <li><strong>Make extra payments:</strong> Even small extra payments save significant interest</li>
        <li><strong>Compare lenders:</strong> Rates vary widely between lenders</li>
        <li><strong>Refinance if rates drop:</strong> Refinancing can lower your rate</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    import Chart from 'chart.js/auto';
    let loanChart: Chart | null = null;

    function getVal(id: string): number {
      const s = document.getElementById(`${id}-slider`) as HTMLInputElement;
      return parseFloat(s?.value || '0');
    }
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString('en-US');

    function calcLoan() {
      const P = getVal('loan-amount');
      const annualRate = getVal('loan-rate');
      const n = getVal('loan-term-months');
      const r = annualRate / 100 / 12;

      let M: number;
      if (r > 0) {
        M = P * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
      } else {
        M = P / n;
      }

      const totalPayment = M * n;
      const totalInterest = totalPayment - P;
      const now = new Date();
      const payoff = new Date(now.getFullYear(), now.getMonth() + n);

      document.getElementById('loan-monthly')!.textContent = fmt(M);
      document.getElementById('loan-total-interest')!.textContent = fmt(totalInterest);
      document.getElementById('loan-total-payment')!.textContent = fmt(totalPayment);
      document.getElementById('loan-payoff')!.textContent = payoff.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      document.getElementById('loan-interest-pct')!.textContent = P > 0 ? (totalInterest / P * 100).toFixed(1) + '%' : '0%';

      // Donut
      const ctx = (document.getElementById('loan-donut') as HTMLCanvasElement).getContext('2d')!;
      if (loanChart) loanChart.destroy();
      loanChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Principal', 'Interest'],
          datasets: [{ data: [P, totalInterest], backgroundColor: ['#3b82f6', '#ef4444'], borderWidth: 0 }]
        },
        options: {
          responsive: true, cutout: '65%',
          plugins: {
            legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true, font: { size: 11 } } },
            tooltip: { callbacks: { label: (c) => `${c.label}: ${fmt(c.parsed)}` } }
          }
        }
      });

      // Amortization (yearly)
      let balance = P;
      const tbody = document.getElementById('loan-amort-tbody')!;
      const years = Math.ceil(n / 12);
      let html = '';
      for (let y = 1; y <= years; y++) {
        let yPay = 0, yPrinc = 0, yInt = 0;
        const monthsThisYear = Math.min(12, n - (y - 1) * 12);
        for (let m = 0; m < monthsThisYear; m++) {
          const interest = balance * r;
          const princ = M - interest;
          balance = Math.max(0, balance - princ);
          yPay += M; yPrinc += princ; yInt += interest;
        }
        html += `<tr class="border-b border-border/30 hover:bg-surface-alt/50">
          <td class="py-2 pr-3 text-text-secondary">Year ${y}</td>
          <td class="py-2 pr-3 text-right">${fmt(yPay)}</td>
          <td class="py-2 pr-3 text-right text-primary">${fmt(yPrinc)}</td>
          <td class="py-2 pr-3 text-right text-danger">${fmt(yInt)}</td>
          <td class="py-2 text-right font-medium">${fmt(balance)}</td>
        </tr>`;
      }
      tbody.innerHTML = html;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      ['loan-amount-slider', 'loan-rate-slider', 'loan-term-months-slider'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calcLoan);
      });
      ['loan-amount-input', 'loan-rate-input', 'loan-term-months-input'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', () => setTimeout(calcLoan, 120));
      });
      calcLoan();
    }, 50);
  </script>
</CalculatorLayout>
