---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Monte Carlo Calculator - Simulation & Estimation";
const description = "Run Monte Carlo simulations to estimate pi, calculate areas under curves, and analyze random sampling with confidence intervals from iteration count.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "Event probability." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical tools." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Spread analysis." },
  { name: "Confidence Interval", url: "/confidence-interval-calculator", description: "Confidence ranges." },
  { name: "Random Number", url: "/random-number-generator", description: "Random numbers." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Monte Carlo Calculator" keywords="monte carlo simulation, pi estimation, random sampling, area estimation, confidence interval, stochastic simulation" breadcrumbs={[{ name: "Monte Carlo", url: "/monte-carlo-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Monte Carlo Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Use random sampling to estimate mathematical values. Watch convergence improve with more iterations.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Simulation Type</label>
          <select class="mc3-in w-full px-4 py-2 border border-border rounded-xl" id="mc3-type">
            <option value="pi">Estimate Pi (circle in square)</option>
            <option value="area">Area under y = x^2 (0 to 1)</option>
            <option value="integral">Area under y = sin(x) (0 to pi)</option>
            <option value="custom">Custom: P(x^2 + y^2 &lt; 1) in [-1,1]x[-1,1]</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Number of Iterations</label>
          <input type="number" class="mc3-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="mc3-iters" min="100" max="1000000" step="100" value="10000">
        </div>
        <button id="mc3-run" class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-blue-700 transition">Run Simulation</button>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Estimated Value</div>
          <div class="text-5xl font-extrabold font-mono" id="mc3-result">--</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Exact Value</div>
            <div class="text-xl font-bold font-mono" id="mc3-exact">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Error</div>
            <div class="text-xl font-bold font-mono" id="mc3-error">--</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Hits / Total</div>
            <div class="text-xl font-bold font-mono" id="mc3-hits">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">95% Confidence</div>
            <div class="text-xl font-bold font-mono" id="mc3-ci">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Convergence by Sample Size</h3>
          <div class="text-xs font-mono space-y-1" id="mc3-convergence"></div>
        </div>
      </div>
      <ShareButton calculatorId="monte-carlo" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Monte Carlo Method</h2>
      <p>Monte Carlo simulation uses random sampling to estimate numerical values. For example, to estimate pi, we randomly scatter points in a square and count how many fall inside an inscribed circle. The ratio approximates pi/4.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Pi estimation:</strong> 4 x (points in circle / total points)</p>
        <p><strong>Error:</strong> decreases as 1 / sqrt(N)</p>
        <p><strong>95% CI:</strong> estimate +/- 1.96 x sqrt(p(1-p)/N) x scale</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function runMC3() {
      const type = (document.getElementById('mc3-type') as HTMLSelectElement).value;
      const iters = parseInt((document.getElementById('mc3-iters') as HTMLInputElement).value) || 10000;

      let hits = 0;
      let exact = 0;
      let scale = 1;
      let label = '';

      if (type === 'pi') {
        exact = Math.PI;
        scale = 4;
        for (let i = 0; i < iters; i++) {
          const x = Math.random();
          const y = Math.random();
          if (x * x + y * y <= 1) hits++;
        }
      } else if (type === 'area') {
        exact = 1 / 3; // integral of x^2 from 0 to 1
        scale = 1;
        for (let i = 0; i < iters; i++) {
          const x = Math.random();
          const y = Math.random();
          if (y <= x * x) hits++;
        }
      } else if (type === 'integral') {
        exact = 2; // integral of sin(x) from 0 to pi
        scale = Math.PI; // area of box is pi x 1
        for (let i = 0; i < iters; i++) {
          const x = Math.random() * Math.PI;
          const y = Math.random();
          if (y <= Math.sin(x)) hits++;
        }
      } else {
        exact = Math.PI;
        scale = 4;
        for (let i = 0; i < iters; i++) {
          const x = Math.random() * 2 - 1;
          const y = Math.random() * 2 - 1;
          if (x * x + y * y < 1) hits++;
        }
      }

      const p = hits / iters;
      const estimate = p * scale;
      const error = Math.abs(estimate - exact);
      const se = Math.sqrt(p * (1 - p) / iters) * scale;
      const ci95 = 1.96 * se;

      document.getElementById('mc3-result')!.textContent = estimate.toFixed(6);
      document.getElementById('mc3-exact')!.textContent = exact.toFixed(6);
      document.getElementById('mc3-error')!.textContent = error.toFixed(6) + ' (' + (error / exact * 100).toFixed(3) + '%)';
      document.getElementById('mc3-hits')!.textContent = hits.toLocaleString() + ' / ' + iters.toLocaleString();
      document.getElementById('mc3-ci')!.textContent = (estimate - ci95).toFixed(4) + ' - ' + (estimate + ci95).toFixed(4);

      // Convergence table - run sub-samples
      const checkpoints = [100, 500, 1000, 5000, 10000, 50000, 100000, 500000, 1000000].filter(n => n <= iters);
      let convHtml = '';
      let subHits = 0;
      let idx = 0;
      // Re-simulate for convergence display
      let runHits = 0;
      for (let i = 0; i < iters; i++) {
        let hit = false;
        if (type === 'pi' || type === 'custom') {
          const x = type === 'custom' ? Math.random() * 2 - 1 : Math.random();
          const y = type === 'custom' ? Math.random() * 2 - 1 : Math.random();
          hit = x * x + y * y <= 1;
        } else if (type === 'area') {
          const x = Math.random(); const y = Math.random();
          hit = y <= x * x;
        } else {
          const x = Math.random() * Math.PI; const y = Math.random();
          hit = y <= Math.sin(x);
        }
        if (hit) runHits++;
        if (idx < checkpoints.length && i + 1 === checkpoints[idx]) {
          const est = (runHits / (i + 1)) * scale;
          const err = Math.abs(est - exact);
          convHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>N=' + checkpoints[idx].toLocaleString() + '</span><span>' + est.toFixed(6) + ' (error: ' + err.toFixed(6) + ')</span></div>';
          idx++;
        }
      }
      document.getElementById('mc3-convergence')!.innerHTML = convHtml;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.getElementById('mc3-run')!.addEventListener('click', runMC3);
      document.querySelectorAll('.mc3-in').forEach(el => { el.addEventListener('change', runMC3); });
      runMC3();
    }, 50);
  </script>
</CalculatorLayout>
