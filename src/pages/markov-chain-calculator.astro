---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Markov Chain Calculator - Transition & Steady State";
const description = "Calculate Markov chain state transition probabilities, steady state distribution, and absorption probabilities for 2-state and 3-state systems.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "Event probability." },
  { name: "Matrix Calculator", url: "/matrix-calculator", description: "Matrix operations." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical tools." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage math." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Spread analysis." },
  { name: "Average Calculator", url: "/average-calculator", description: "Calculate averages." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Markov Chain Calculator" keywords="markov chain, transition matrix, steady state, absorption probability, state distribution, stochastic process" breadcrumbs={[{ name: "Markov Chain", url: "/markov-chain-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Markov Chain Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Analyze Markov chains: enter transition probabilities to find steady state distributions and multi-step probabilities.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Number of States</label>
          <select class="mk2-in w-full px-4 py-2 border border-border rounded-xl" id="mk2-size">
            <option value="2" selected>2 States</option>
            <option value="3">3 States</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-text mb-2">Transition Matrix (rows must sum to 1)</label>
          <div id="mk2-matrix" class="space-y-2"></div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-text mb-1">Steps to Compute</label>
          <input type="number" class="mk2-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" id="mk2-steps" min="1" max="100" value="10">
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Steady State Distribution</div>
          <div class="text-3xl font-extrabold font-mono" id="mk2-steady">--</div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Transition Matrix after N Steps</h3>
          <div class="text-xs font-mono space-y-1" id="mk2-nstep"></div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Row Sum Validation</h3>
          <div class="text-xs font-mono space-y-1" id="mk2-valid"></div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">State Distribution by Step</h3>
          <div class="text-xs font-mono space-y-1" id="mk2-evolution"></div>
        </div>
      </div>
      <ShareButton calculatorId="markov-chain" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Markov Chain Basics</h2>
      <p>A Markov chain models transitions between states where the next state depends only on the current state. The steady state distribution represents the long-run proportion of time spent in each state.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Transition matrix P:</strong> P[i][j] = probability of going from state i to state j</p>
        <p><strong>N-step matrix:</strong> P^n gives n-step transition probabilities</p>
        <p><strong>Steady state pi:</strong> pi * P = pi, sum(pi) = 1</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function getMatrix(): number[][] {
      const size = parseInt((document.getElementById('mk2-size') as HTMLSelectElement).value);
      const m: number[][] = [];
      for (let i = 0; i < size; i++) {
        m[i] = [];
        for (let j = 0; j < size; j++) {
          const el = document.getElementById('mk2-m' + i + j) as HTMLInputElement;
          m[i][j] = el ? parseFloat(el.value) || 0 : 0;
        }
      }
      return m;
    }

    function matMul(a: number[][], b: number[][]): number[][] {
      const n = a.length;
      const result: number[][] = [];
      for (let i = 0; i < n; i++) {
        result[i] = [];
        for (let j = 0; j < n; j++) {
          let sum = 0;
          for (let k = 0; k < n; k++) sum += a[i][k] * b[k][j];
          result[i][j] = sum;
        }
      }
      return result;
    }

    function matPow(m: number[][], p: number): number[][] {
      const n = m.length;
      let result: number[][] = [];
      for (let i = 0; i < n; i++) {
        result[i] = [];
        for (let j = 0; j < n; j++) result[i][j] = i === j ? 1 : 0;
      }
      let base = m.map(r => [...r]);
      while (p > 0) {
        if (p % 2 === 1) result = matMul(result, base);
        base = matMul(base, base);
        p = Math.floor(p / 2);
      }
      return result;
    }

    function renderMatrix() {
      const size = parseInt((document.getElementById('mk2-size') as HTMLSelectElement).value);
      const container = document.getElementById('mk2-matrix')!;
      const defaults2 = [[0.7, 0.3], [0.4, 0.6]];
      const defaults3 = [[0.5, 0.3, 0.2], [0.2, 0.5, 0.3], [0.1, 0.3, 0.6]];
      const defaults = size === 2 ? defaults2 : defaults3;

      let html = '';
      for (let i = 0; i < size; i++) {
        html += '<div class="flex gap-2 items-center"><span class="text-xs font-medium text-text w-8">S' + i + ':</span>';
        for (let j = 0; j < size; j++) {
          html += '<input type="number" class="mk2-in w-full px-2 py-2 border border-border rounded-lg text-center text-sm" id="mk2-m' + i + j + '" value="' + defaults[i][j] + '" min="0" max="1" step="0.01">';
        }
        html += '</div>';
      }
      container.innerHTML = html;

      container.querySelectorAll('.mk2-in').forEach(el => {
        el.addEventListener('input', calcMK2);
        el.addEventListener('change', calcMK2);
      });
    }

    function calcMK2() {
      const size = parseInt((document.getElementById('mk2-size') as HTMLSelectElement).value);
      const steps = parseInt((document.getElementById('mk2-steps') as HTMLInputElement).value) || 10;
      const m = getMatrix();

      // Validate row sums
      let validHtml = '';
      for (let i = 0; i < size; i++) {
        const sum = m[i].reduce((a, b) => a + b, 0);
        const ok = Math.abs(sum - 1) < 0.01;
        validHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>Row ' + i + ' sum</span><span class="' + (ok ? 'text-green-600' : 'text-red-600') + '">' + sum.toFixed(4) + (ok ? ' OK' : ' ERROR') + '</span></div>';
      }
      document.getElementById('mk2-valid')!.innerHTML = validHtml;

      // N-step matrix
      const nStep = matPow(m, steps);
      let nhtml = '';
      for (let i = 0; i < size; i++) {
        nhtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>S' + i + ' -></span><span>' + nStep[i].map(v => v.toFixed(4)).join(' | ') + '</span></div>';
      }
      document.getElementById('mk2-nstep')!.innerHTML = nhtml;

      // Steady state (use power method - take high power)
      const steady = matPow(m, 1000);
      const ss = steady[0]; // all rows converge to same distribution
      document.getElementById('mk2-steady')!.textContent = ss.map((v, i) => 'S' + i + ': ' + (v * 100).toFixed(2) + '%').join('  ');

      // Evolution from state 0
      let evolHtml = '';
      const checkSteps = [1, 2, 3, 5, 10, 20, 50, 100].filter(s => s <= steps);
      for (const s of checkSteps) {
        const mp = matPow(m, s);
        evolHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>Step ' + s + ' (from S0)</span><span>' + mp[0].map((v, i) => 'S' + i + ':' + (v * 100).toFixed(1) + '%').join(' ') + '</span></div>';
      }
      document.getElementById('mk2-evolution')!.innerHTML = evolHtml;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      renderMatrix();
      document.getElementById('mk2-size')!.addEventListener('change', () => { renderMatrix(); calcMK2(); });
      document.getElementById('mk2-steps')!.addEventListener('input', calcMK2);
      calcMK2();
    }, 50);
  </script>
</CalculatorLayout>
