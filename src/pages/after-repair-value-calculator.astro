---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "After Repair Value Calculator";
const description = "Calculate ARV from comparable analysis, apply the 70% rule for flippers, determine max offer price, and estimate profit.";
const relatedCalcs = [
  { name: "House Flipping", url: "/house-flipping-calculator", description: "Flip profit analysis." },
  { name: "ROI Calculator", url: "/roi-calculator", description: "Return on investment." },
  { name: "Mortgage", url: "/mortgage-calculator", description: "Mortgage payments." },
  { name: "Home Equity", url: "/home-equity-calculator", description: "Home equity analysis." },
  { name: "Closing Cost", url: "/closing-cost-calculator", description: "Closing cost estimate." },
  { name: "Rental Property", url: "/rental-property-calculator", description: "Rental property ROI." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="After Repair Value Calculator" keywords="after repair value, ARV, 70% rule, flip profit, max offer, real estate flip, comp analysis" breadcrumbs={[{ name: "After Repair Value", url: "/after-repair-value-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">After Repair Value Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate ARV, calculate max offer using the 70% rule, and project flip profit.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <h3 class="font-semibold text-sm text-text">Comparable Sales (after repair)</h3>
        <div class="grid grid-cols-3 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Comp 1 ($)</label><input type="number" id="av-comp1" class="av-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="280000" min="0" step="5000"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Comp 2 ($)</label><input type="number" id="av-comp2" class="av-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="295000" min="0" step="5000"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Comp 3 ($)</label><input type="number" id="av-comp3" class="av-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="310000" min="0" step="5000"></div>
        </div>
        <h3 class="font-semibold text-sm text-text">Deal Details</h3>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Purchase Price ($)</label><input type="number" id="av-purchase" class="av-in w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold" value="180000" min="0" step="5000"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Estimated Repairs ($)</label><input type="number" id="av-repairs" class="av-in w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold" value="45000" min="0" step="1000"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Closing + Holding Costs ($)</label><input type="number" id="av-holding" class="av-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="15000" min="0" step="1000"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Selling Costs (%)</label><input type="number" id="av-selling" class="av-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="6" min="0" max="15" step="0.5"></div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Estimated ARV</div>
          <div class="text-5xl font-extrabold font-mono" id="av-arv">$0</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">70% Rule Max Offer</div><div class="text-xl font-bold font-mono" id="av-maxoffer">$0</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Estimated Profit</div><div class="text-xl font-bold font-mono" id="av-profit">$0</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Total Investment</div><div class="text-xl font-bold font-mono" id="av-totalinvest">$0</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">ROI</div><div class="text-xl font-bold font-mono" id="av-roi">0%</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Selling Costs</div><div class="text-xl font-bold font-mono" id="av-sellingcost">$0</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Profit Margin</div><div class="text-xl font-bold font-mono" id="av-margin">0%</div></div>
        </div>
        <div class="p-4 rounded-xl text-center" id="av-status-box"><div class="font-bold text-sm" id="av-status">-</div></div>
      </div>
      <ShareButton calculatorId="after-repair-value" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcAV() {
      const comp1 = parseFloat((document.getElementById('av-comp1') as HTMLInputElement).value) || 0;
      const comp2 = parseFloat((document.getElementById('av-comp2') as HTMLInputElement).value) || 0;
      const comp3 = parseFloat((document.getElementById('av-comp3') as HTMLInputElement).value) || 0;
      const purchase = parseFloat((document.getElementById('av-purchase') as HTMLInputElement).value) || 0;
      const repairs = parseFloat((document.getElementById('av-repairs') as HTMLInputElement).value) || 0;
      const holding = parseFloat((document.getElementById('av-holding') as HTMLInputElement).value) || 0;
      const sellingPct = parseFloat((document.getElementById('av-selling') as HTMLInputElement).value) || 0;

      const comps = [comp1, comp2, comp3].filter(c => c > 0);
      const arv = comps.length > 0 ? comps.reduce((a, b) => a + b, 0) / comps.length : 0;
      const maxOffer70 = arv * 0.7 - repairs;
      const sellingCosts = arv * (sellingPct / 100);
      const totalInvestment = purchase + repairs + holding;
      const netProceeds = arv - sellingCosts;
      const profit = netProceeds - totalInvestment;
      const roi = totalInvestment > 0 ? (profit / totalInvestment) * 100 : 0;
      const margin = arv > 0 ? (profit / arv) * 100 : 0;

      const fmt = (v: number) => (v >= 0 ? '$' : '-$') + Math.abs(v).toLocaleString(undefined, { maximumFractionDigits: 0 });

      document.getElementById('av-arv')!.textContent = '$' + arv.toLocaleString(undefined, { maximumFractionDigits: 0 });
      document.getElementById('av-maxoffer')!.textContent = fmt(maxOffer70);
      document.getElementById('av-profit')!.textContent = fmt(profit);
      document.getElementById('av-totalinvest')!.textContent = '$' + totalInvestment.toLocaleString(undefined, { maximumFractionDigits: 0 });
      document.getElementById('av-roi')!.textContent = roi.toFixed(1) + '%';
      document.getElementById('av-sellingcost')!.textContent = '$' + sellingCosts.toLocaleString(undefined, { maximumFractionDigits: 0 });
      document.getElementById('av-margin')!.textContent = margin.toFixed(1) + '%';

      let status: string, color: string;
      if (purchase <= maxOffer70 && profit > 0) { status = 'Great deal — within 70% rule with positive profit'; color = 'bg-green-50 text-green-800'; }
      else if (profit > 0) { status = 'Profitable but above 70% rule — higher risk'; color = 'bg-yellow-50 text-yellow-800'; }
      else { status = 'Not profitable at this purchase price'; color = 'bg-red-50 text-red-800'; }

      document.getElementById('av-status')!.textContent = status;
      document.getElementById('av-status-box')!.className = `p-4 rounded-xl text-center ${color}`;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.av-in').forEach(el => { el.addEventListener('input', calcAV); el.addEventListener('change', calcAV); });
      calcAV();
    }, 50);
  </script>
</CalculatorLayout>
