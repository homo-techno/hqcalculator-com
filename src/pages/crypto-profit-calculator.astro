---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Crypto Profit Calculator - Calculate Cryptocurrency Gains";
const description = "Calculate your cryptocurrency profit or loss. Enter buy and sell prices to see total return, fees impact, and tax implications.";

const relatedCalcs = [
  { name: "Stock Profit", url: "/stock-profit-calculator", description: "Stock returns." },
  { name: "ROI Calculator", url: "/roi-calculator", description: "Return on investment." },
  { name: "Capital Gains", url: "/capital-gains-calculator", description: "Capital gains tax." },
  { name: "Investment Calculator", url: "/investment-calculator", description: "Investments." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "Currency Converter", url: "/currency-converter", description: "Currency exchange." },
];
---

<CalculatorLayout title={title} description={description} calculatorName="Crypto Profit Calculator" keywords="crypto profit calculator, cryptocurrency gains, bitcoin profit, crypto tax, crypto ROI" breadcrumbs={[{ name: "Crypto Profit", url: "/crypto-profit-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Crypto Profit Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate your cryptocurrency trading profit or loss.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Investment Amount</label>
            <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span>
              <input type="number" id="cp-invest" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="5000" min="0" step="100">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Buy Price per Coin</label>
              <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                <input type="number" id="cp-buy" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="30000" min="0" step="100">
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Sell Price per Coin</label>
              <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                <input type="number" id="cp-sell" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="45000" min="0" step="100">
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Buy Fee (%)</label>
              <input type="number" id="cp-buy-fee" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="0.5" min="0" max="10" step="0.1">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Sell Fee (%)</label>
              <input type="number" id="cp-sell-fee" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="0.5" min="0" max="10" step="0.1">
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 rounded-2xl text-white text-center" id="cp-box" style="background:#22c55e;">
            <div class="text-sm uppercase tracking-wide mb-1 opacity-80">Net Profit / Loss</div>
            <div class="text-5xl font-extrabold" id="cp-profit">$0</div>
            <div class="text-sm mt-1 opacity-80" id="cp-pct">0% return</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Coins Purchased</div>
              <div class="text-xl font-bold" id="cp-coins">0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Exit Value</div>
              <div class="text-xl font-bold text-secondary" id="cp-exit">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Fees</div>
              <div class="text-xl font-bold" id="cp-fees">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Price Change</div>
              <div class="text-xl font-bold" id="cp-change">0%</div>
            </div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl">
            <h3 class="font-semibold text-sm text-text mb-3">Breakdown</h3>
            <div class="space-y-1 text-sm" id="cp-breakdown"></div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="crypto-profit" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Calculating Crypto Profits</h2>
      <p>Crypto profits are calculated similarly to stocks: sell value minus cost basis minus fees. Remember that cryptocurrency gains are taxable in most jurisdictions.</p>
    </article>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const fmt = (n: number) => (n < 0 ? '-$' : '$') + Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

    function calcCrypto() {
      const invest = parseFloat((document.getElementById('cp-invest') as HTMLInputElement).value) || 0;
      const buyPrice = parseFloat((document.getElementById('cp-buy') as HTMLInputElement).value) || 0;
      const sellPrice = parseFloat((document.getElementById('cp-sell') as HTMLInputElement).value) || 0;
      const buyFee = (parseFloat((document.getElementById('cp-buy-fee') as HTMLInputElement).value) || 0) / 100;
      const sellFee = (parseFloat((document.getElementById('cp-sell-fee') as HTMLInputElement).value) || 0) / 100;

      const buyFeeAmt = invest * buyFee;
      const effectiveInvest = invest - buyFeeAmt;
      const coins = buyPrice > 0 ? effectiveInvest / buyPrice : 0;
      const grossExit = coins * sellPrice;
      const sellFeeAmt = grossExit * sellFee;
      const netExit = grossExit - sellFeeAmt;
      const profit = netExit - invest;
      const pct = invest > 0 ? (profit / invest) * 100 : 0;
      const priceChange = buyPrice > 0 ? ((sellPrice - buyPrice) / buyPrice) * 100 : 0;

      document.getElementById('cp-profit')!.textContent = fmt(profit);
      document.getElementById('cp-pct')!.textContent = pct.toFixed(2) + '% return';
      document.getElementById('cp-coins')!.textContent = coins.toFixed(6);
      document.getElementById('cp-exit')!.textContent = fmt(netExit);
      document.getElementById('cp-fees')!.textContent = fmt(buyFeeAmt + sellFeeAmt);
      document.getElementById('cp-change')!.textContent = (priceChange >= 0 ? '+' : '') + priceChange.toFixed(2) + '%';
      document.getElementById('cp-box')!.style.backgroundColor = profit >= 0 ? '#22c55e' : '#ef4444';

      document.getElementById('cp-breakdown')!.innerHTML = [
        ['Investment', fmt(invest)],
        ['Buy fee', fmt(buyFeeAmt)],
        ['Coins purchased', coins.toFixed(6)],
        ['Gross exit value', fmt(grossExit)],
        ['Sell fee', fmt(sellFeeAmt)],
        ['Net proceeds', fmt(netExit)],
        ['Profit / Loss', fmt(profit)],
      ].map(([l, v]) => `<div class="flex justify-between ${l.startsWith('Profit') ? 'pt-1 border-t border-border font-bold' : ''}"><span class="text-text-secondary">${l}</span><span class="font-semibold">${v}</span></div>`).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      ['cp-invest', 'cp-buy', 'cp-sell', 'cp-buy-fee', 'cp-sell-fee'].forEach(id =>
        document.getElementById(id)!.addEventListener('input', calcCrypto));
      calcCrypto();
    }, 50);
  </script>
</CalculatorLayout>
