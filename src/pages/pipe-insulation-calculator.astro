---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Pipe Insulation Calculator - Thickness, R-Value & Energy Savings";
const description = "Calculate pipe insulation thickness for heat loss reduction, freeze protection, energy savings, and R-value requirements for hot and cold water pipes.";
const relatedCalcs = [
  { name: "Insulation Calculator", url: "/insulation-calculator", description: "Building insulation." },
  { name: "Heat Transfer", url: "/heat-transfer-calculator", description: "Heat transfer analysis." },
  { name: "HVAC Calculator", url: "/hvac-calculator", description: "HVAC system sizing." },
  { name: "Plumbing Pipe", url: "/plumbing-pipe-calculator", description: "Pipe sizing." },
  { name: "Electricity Cost", url: "/electricity-cost-calculator", description: "Energy costs." },
  { name: "Heat Pump", url: "/heat-pump-calculator", description: "Heat pump efficiency." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Pipe Insulation Calculator" keywords="pipe insulation calculator, insulation thickness, R-value, heat loss, freeze protection, energy savings" breadcrumbs={[{ name: "Pipe Insulation", url: "/pipe-insulation-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Pipe Insulation Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Determine insulation thickness for pipes to prevent heat loss, freezing, and save on energy costs.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-text mb-1">Application</label>
          <select id="pi2-app" class="pi2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="hot" selected>Hot Water Pipe</option>
            <option value="cold">Cold Water (condensation prevention)</option>
            <option value="freeze">Freeze Protection</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Pipe Diameter (inches)</label>
            <select id="pi2-diam" class="pi2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="0.5">1/2"</option>
              <option value="0.75" selected>3/4"</option>
              <option value="1">1"</option>
              <option value="1.25">1-1/4"</option>
              <option value="1.5">1-1/2"</option>
              <option value="2">2"</option>
              <option value="3">3"</option>
              <option value="4">4"</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Pipe Length (ft)</label>
            <input type="number" id="pi2-len" class="pi2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="50" min="1" step="1">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Water Temperature (&deg;F)</label>
            <input type="number" id="pi2-wtemp" class="pi2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="120" min="32" max="200" step="5">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Ambient Temperature (&deg;F)</label>
            <input type="number" id="pi2-atemp" class="pi2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="55" min="-20" max="120" step="5">
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Insulation Material</label>
          <select id="pi2-mat" class="pi2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="foam" selected>Foam (polyethylene) - R-2 per inch</option>
            <option value="fiberglass">Fiberglass - R-3.5 per inch</option>
            <option value="rubber">Rubber (elastomeric) - R-3.8 per inch</option>
            <option value="mineral">Mineral Wool - R-4 per inch</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Insulation Thickness (inches)</label>
          <select id="pi2-thick" class="pi2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="0.5">1/2"</option>
            <option value="0.75">3/4"</option>
            <option value="1" selected>1"</option>
            <option value="1.5">1-1/2"</option>
            <option value="2">2"</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Energy Cost ($/kWh or $/therm)</label>
          <input type="number" id="pi2-ecost" class="pi2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.14" min="0.01" step="0.01">
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Annual Energy Savings</div>
          <div class="text-4xl font-extrabold" id="pi2-savings">$0/year</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">R-Value</div><div class="text-xl font-bold" id="pi2-rval">R-0</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Heat Loss Reduction</div><div class="text-xl font-bold" id="pi2-reduce">0%</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Bare Pipe Loss</div><div class="text-xl font-bold" id="pi2-bare">0 BTU/hr</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Insulated Pipe Loss</div><div class="text-xl font-bold" id="pi2-insulated">0 BTU/hr</div></div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-3">Details</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span>Freeze Protection Time</span><span class="font-bold" id="pi2-freeze">--</span></div>
            <div class="flex justify-between"><span>Temp Drop After 1 Hour</span><span class="font-bold" id="pi2-tempdrop">0 &deg;F</span></div>
            <div class="flex justify-between"><span>Material Cost Estimate</span><span class="font-bold" id="pi2-matcost">$0</span></div>
            <div class="flex justify-between"><span>Payback Period</span><span class="font-bold" id="pi2-payback">--</span></div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="pipe-insulation" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcPI2() {
      const app = (document.getElementById('pi2-app') as HTMLSelectElement).value;
      const diam = parseFloat((document.getElementById('pi2-diam') as HTMLSelectElement).value) || 0.75;
      const len = parseFloat((document.getElementById('pi2-len') as HTMLInputElement).value) || 50;
      const wTemp = parseFloat((document.getElementById('pi2-wtemp') as HTMLInputElement).value) || 120;
      const aTemp = parseFloat((document.getElementById('pi2-atemp') as HTMLInputElement).value) || 55;
      const mat = (document.getElementById('pi2-mat') as HTMLSelectElement).value;
      const thick = parseFloat((document.getElementById('pi2-thick') as HTMLSelectElement).value) || 1;
      const eCost = parseFloat((document.getElementById('pi2-ecost') as HTMLInputElement).value) || 0.14;

      const deltaT = Math.abs(wTemp - aTemp);
      const rPerInch: Record<string, number> = { foam: 2.0, fiberglass: 3.5, rubber: 3.8, mineral: 4.0 };
      const rVal = rPerInch[mat] * thick;

      // Pipe outer diameter (approx OD in inches)
      const od = diam + 0.25; // approximate OD
      const outerDiam = od + 2 * thick;

      // Heat loss per linear foot - bare pipe
      // Bare pipe: h_conv ~ 1.5 BTU/hr/ft2/F (still air)
      const bareArea = Math.PI * (od / 12) * 1; // ft2 per linear foot
      const h_bare = 1.5; // BTU/hr/ft2/F
      const bareLoss = h_bare * bareArea * deltaT; // BTU/hr per ft

      // Insulated pipe: Q = 2*pi*k*L*dT / ln(r2/r1)
      // k = 1/(R_per_inch * 12) BTU/hr/ft/F
      const k = 1 / (rPerInch[mat] * 12); // BTU/hr/ft/F
      const r1 = od / 2 / 12; // inner radius of insulation in feet
      const r2 = outerDiam / 2 / 12; // outer radius in feet
      const insulLoss = 2 * Math.PI * k * deltaT / Math.log(r2 / r1); // BTU/hr per ft

      const totalBareLoss = bareLoss * len;
      const totalInsulLoss = insulLoss * len;
      const reduction = totalBareLoss > 0 ? ((totalBareLoss - totalInsulLoss) / totalBareLoss) * 100 : 0;

      // Annual savings (assume hot water pipe operates ~8 hrs/day for demand, or 24/7 for recirc)
      const hoursPerYear = app === 'freeze' ? 2000 : 4000; // approximate
      const annualBTUSaved = (totalBareLoss - totalInsulLoss) * hoursPerYear;
      const annualKWhSaved = annualBTUSaved / 3412;
      const annualSavings = annualKWhSaved * eCost;

      // Water volume in pipe (gallons per foot)
      const pipeArea = Math.PI * Math.pow(diam / 2, 2);
      const galPerFt = pipeArea * 12 / 231;
      const totalGal = galPerFt * len;
      const waterWeight = totalGal * 8.33; // lbs

      // Temperature drop after 1 hour (insulated)
      const waterBTU = waterWeight * 1; // BTU per degree F
      const tempDrop1hr = waterBTU > 0 ? (totalInsulLoss * 1) / waterBTU : 0;

      // Freeze protection time (time for water to go from wTemp to 32F)
      let freezeTime = '--';
      if (app === 'freeze' && wTemp > 32 && aTemp < 32) {
        const timeToFreeze = (waterWeight * (wTemp - 32)) / totalInsulLoss;
        freezeTime = timeToFreeze.toFixed(1) + ' hrs';
      }

      // Material cost: approx $1-3 per linear foot depending on material
      const costPerFt: Record<string, number> = { foam: 1.50, fiberglass: 2.50, rubber: 3.00, mineral: 3.50 };
      const matCost = (costPerFt[mat] || 2) * len * (thick / 1); // scale by thickness
      const payback = annualSavings > 0 ? matCost / annualSavings : 99;

      document.getElementById('pi2-savings')!.textContent = '$' + Math.round(annualSavings) + '/year';
      document.getElementById('pi2-rval')!.textContent = 'R-' + rVal.toFixed(1);
      document.getElementById('pi2-reduce')!.textContent = reduction.toFixed(1) + '%';
      document.getElementById('pi2-bare')!.textContent = Math.round(totalBareLoss).toLocaleString() + ' BTU/hr';
      document.getElementById('pi2-insulated')!.textContent = Math.round(totalInsulLoss).toLocaleString() + ' BTU/hr';
      document.getElementById('pi2-freeze')!.textContent = freezeTime;
      document.getElementById('pi2-tempdrop')!.textContent = tempDrop1hr.toFixed(1) + ' \u00B0F';
      document.getElementById('pi2-matcost')!.textContent = '$' + Math.round(matCost);
      document.getElementById('pi2-payback')!.textContent = payback < 50 ? payback.toFixed(1) + ' yrs' : 'N/A';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.pi2-in').forEach(el => { el.addEventListener('input', calcPI2); el.addEventListener('change', calcPI2); });
      calcPI2();
    }, 50);
  </script>
</CalculatorLayout>
