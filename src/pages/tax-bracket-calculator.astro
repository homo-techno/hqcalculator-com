---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Tax Bracket Calculator - Federal Income Tax Brackets 2024";
const description = "Find your federal tax bracket and calculate taxes owed. See marginal and effective tax rates for any income level.";

const relatedCalcs = [
  { name: "Income Tax", url: "/income-tax-calculator", description: "Income tax." },
  { name: "Salary Calculator", url: "/salary-calculator", description: "Salary breakdown." },
  { name: "Paycheck Calculator", url: "/paycheck-calculator", description: "Take-home pay." },
  { name: "Capital Gains", url: "/capital-gains-calculator", description: "Capital gains tax." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "ROI Calculator", url: "/roi-calculator", description: "Return on investment." },
];
---

<CalculatorLayout title={title} description={description} calculatorName="Tax Bracket Calculator" keywords="tax bracket calculator, federal tax brackets, marginal tax rate, effective tax rate, income tax brackets 2024" breadcrumbs={[{ name: "Tax Bracket", url: "/tax-bracket-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Tax Bracket Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">See which federal tax bracket you fall in and how much you owe.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Taxable Income</label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span>
              <input type="number" id="tb-income" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="85000" min="0" step="1000">
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Filing Status</label>
            <select id="tb-status" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="single">Single</option>
              <option value="married" selected>Married Filing Jointly</option>
              <option value="hoh">Head of Household</option>
              <option value="separate">Married Filing Separately</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Tax Year</label>
            <select id="tb-year" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="2024" selected>2024</option>
            </select>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Federal Tax Owed</div>
            <div class="text-5xl font-extrabold" id="tb-tax">$0</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Marginal Rate</div>
              <div class="text-xl font-bold text-secondary" id="tb-marginal">0%</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Effective Rate</div>
              <div class="text-xl font-bold" id="tb-effective">0%</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">After-Tax Income</div>
              <div class="text-xl font-bold" id="tb-after">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Tax per Month</div>
              <div class="text-xl font-bold" id="tb-monthly">$0</div>
            </div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl">
            <h3 class="font-semibold text-sm text-text mb-3">Bracket Breakdown</h3>
            <div class="space-y-1 text-sm" id="tb-breakdown"></div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="tax-bracket" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Tax Brackets Work</h2>
      <p>The U.S. uses a progressive tax system. Only the income within each bracket is taxed at that bracket's rate — not your entire income.</p>
      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>What's the difference between marginal and effective tax rate?</strong> Your marginal rate is the bracket your last dollar falls in. Your effective rate is your total tax divided by total income — it's always lower.</p>
    </article>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString();

    const brackets: Record<string, [number, number][]> = {
      single: [[11600, 0.10], [47150, 0.12], [100525, 0.22], [191950, 0.24], [243725, 0.32], [609350, 0.35], [Infinity, 0.37]],
      married: [[23200, 0.10], [94300, 0.12], [201050, 0.22], [383900, 0.24], [487450, 0.32], [731200, 0.35], [Infinity, 0.37]],
      hoh: [[16550, 0.10], [63100, 0.12], [100500, 0.22], [191950, 0.24], [243700, 0.32], [609350, 0.35], [Infinity, 0.37]],
      separate: [[11600, 0.10], [47150, 0.12], [100525, 0.22], [191950, 0.24], [243725, 0.32], [365600, 0.35], [Infinity, 0.37]],
    };

    function calcTax() {
      const income = parseFloat((document.getElementById('tb-income') as HTMLInputElement).value) || 0;
      const status = (document.getElementById('tb-status') as HTMLSelectElement).value;
      const br = brackets[status] || brackets.single;

      let tax = 0, prev = 0, marginalRate = 0.10;
      const rows: { rate: number; low: number; high: number; taxable: number; taxAmt: number }[] = [];

      for (const [limit, rate] of br) {
        const taxable = Math.max(0, Math.min(income, limit) - prev);
        const amt = taxable * rate;
        if (taxable > 0) {
          rows.push({ rate, low: prev, high: Math.min(income, limit), taxable, taxAmt: amt });
          marginalRate = rate;
        }
        tax += amt;
        prev = limit;
        if (income <= limit) break;
      }

      const effective = income > 0 ? (tax / income) * 100 : 0;

      document.getElementById('tb-tax')!.textContent = fmt(tax);
      document.getElementById('tb-marginal')!.textContent = (marginalRate * 100) + '%';
      document.getElementById('tb-effective')!.textContent = effective.toFixed(1) + '%';
      document.getElementById('tb-after')!.textContent = fmt(income - tax);
      document.getElementById('tb-monthly')!.textContent = fmt(tax / 12);

      document.getElementById('tb-breakdown')!.innerHTML =
        '<div class="grid grid-cols-4 gap-1 font-semibold text-xs text-text-muted mb-1"><span>Rate</span><span>Range</span><span>Taxable</span><span>Tax</span></div>' +
        rows.map(r =>
          `<div class="grid grid-cols-4 gap-1 text-xs"><span class="font-semibold">${(r.rate * 100)}%</span><span>${fmt(r.low)} - ${fmt(r.high)}</span><span>${fmt(r.taxable)}</span><span>${fmt(r.taxAmt)}</span></div>`
        ).join('') +
        `<div class="grid grid-cols-4 gap-1 text-xs font-bold pt-1 border-t border-border mt-1"><span></span><span></span><span>Total</span><span>${fmt(tax)}</span></div>`;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.getElementById('tb-income')!.addEventListener('input', calcTax);
      document.getElementById('tb-status')!.addEventListener('change', calcTax);
      document.getElementById('tb-year')!.addEventListener('change', calcTax);
      calcTax();
    }, 50);
  </script>
</CalculatorLayout>
