---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Microwave Link Calculator - Point-to-Point Feasibility 2026";
const description = "Calculate microwave point-to-point link feasibility including path loss, fade margin, system gain, and availability. Comprehensive link engineering tool.";

const relatedCalcs = [
  { name: "Link Budget Calculator", url: "/link-budget-calculator", description: "Complete RF link budget analysis." },
  { name: "Free Space Path Loss Calculator", url: "/free-space-path-loss-calculator", description: "FSPL calculation." },
  { name: "Fresnel Zone Calculator", url: "/fresnel-zone-calculator", description: "Fresnel zone clearance radius." },
  { name: "Tower Height Calculator", url: "/tower-height-calculator", description: "Radio tower line-of-sight height." },
  { name: "Cable Attenuation Calculator", url: "/cable-attenuation-calculator", description: "Coaxial cable signal attenuation." },
  { name: "EIRP Calculator", url: "/eirp-calculator", description: "Effective isotropic radiated power." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Microwave Link Calculator"
  keywords="microwave link calculator, point to point, fade margin, system gain, microwave path, link feasibility, Vigants-Barnett"
  breadcrumbs={[{ name: "Microwave Link Calculator", url: "/microwave-link-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Microwave Link Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Evaluate the feasibility of a point-to-point microwave link including fade margin, system gain, and estimated availability.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <h2 class="text-lg font-bold text-text mb-4">Link Parameters</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Frequency (GHz)</label>
        <input type="number" id="mwl-freq" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="11" step="0.1" min="0.1">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Path Distance (km)</label>
        <input type="number" id="mwl-dist" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="20" step="0.1" min="0.1">
      </div>

      <h2 class="text-lg font-bold text-text mb-4 mt-6">Transmitter</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">TX Power (dBm)</label>
        <input type="number" id="mwl-tx-power" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="23" step="0.1">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">TX Antenna Gain (dBi)</label>
        <input type="number" id="mwl-tx-gain" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="34" step="0.1">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">TX Waveguide/Cable Loss (dB)</label>
        <input type="number" id="mwl-tx-loss" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="1.5" step="0.1" min="0">
      </div>

      <h2 class="text-lg font-bold text-text mb-4 mt-6">Receiver</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">RX Antenna Gain (dBi)</label>
        <input type="number" id="mwl-rx-gain" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="34" step="0.1">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">RX Waveguide/Cable Loss (dB)</label>
        <input type="number" id="mwl-rx-loss" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="1.5" step="0.1" min="0">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Receiver Threshold (dBm) - at target BER</label>
        <input type="number" id="mwl-rx-thresh" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="-75" step="0.1">
      </div>

      <h2 class="text-lg font-bold text-text mb-4 mt-6">Additional Losses</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Atmospheric/Rain Attenuation (dB)</label>
        <input type="number" id="mwl-atm-loss" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="2" step="0.1" min="0">
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-text mb-1">Terrain/Climate Factor</label>
        <select id="mwl-climate" class="mwl-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="0.25">Dry / Mountainous (c=0.25)</option>
          <option value="1" selected>Average / Temperate (c=1)</option>
          <option value="4">Humid / Coastal (c=4)</option>
          <option value="8">Tropical / Over Water (c=8)</option>
        </select>
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm font-medium text-blue-100 mb-1">Fade Margin</div>
        <div class="text-4xl font-extrabold" id="mwl-margin">--</div>
        <div class="text-sm text-blue-200 mt-1">dB</div>
      </div>

      <!-- Secondary Stats -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Free Space Path Loss</div>
          <div class="text-xl font-bold text-text" id="mwl-fspl">--</div>
          <div class="text-xs text-text-muted">dB</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Received Signal Level</div>
          <div class="text-xl font-bold text-text" id="mwl-rsl">--</div>
          <div class="text-xs text-text-muted">dBm</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">System Gain</div>
          <div class="text-xl font-bold text-text" id="mwl-sys-gain">--</div>
          <div class="text-xs text-text-muted">dB</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Link Status</div>
          <div class="text-xl font-bold" id="mwl-status">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Est. Annual Outage</div>
          <div class="text-xl font-bold text-text" id="mwl-outage">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Est. Availability</div>
          <div class="text-xl font-bold text-text" id="mwl-avail">--</div>
        </div>
      </div>

      <ShareButton calculatorId="microwave-link" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Microwave Link Engineering</h2>
      <p>Point-to-point microwave links require careful engineering to ensure reliable communication. The fade margin must be sufficient to maintain the link during atmospheric fading events.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono text-sm">
        RSL = Tx_Power - Tx_Loss + Tx_Gain - FSPL - Atm_Loss + Rx_Gain - Rx_Loss
        <br>Fade Margin = RSL - Rx_Threshold
        <br>Availability uses Vigants-Barnett: Unavail = c * d^3 * f * 10^(-FM/10) * 6e-7
      </div>
      <p>Typical microwave links require 25-40 dB of fade margin for 99.999% availability depending on path length and climate. The Vigants-Barnett model provides a rough estimate of multipath fading probability.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcMWL() {
      const freq = parseFloat((document.getElementById('mwl-freq') as HTMLInputElement).value) || 1;
      const dist = parseFloat((document.getElementById('mwl-dist') as HTMLInputElement).value) || 0.1;
      const txPower = parseFloat((document.getElementById('mwl-tx-power') as HTMLInputElement).value) || 0;
      const txGain = parseFloat((document.getElementById('mwl-tx-gain') as HTMLInputElement).value) || 0;
      const txLoss = parseFloat((document.getElementById('mwl-tx-loss') as HTMLInputElement).value) || 0;
      const rxGain = parseFloat((document.getElementById('mwl-rx-gain') as HTMLInputElement).value) || 0;
      const rxLoss = parseFloat((document.getElementById('mwl-rx-loss') as HTMLInputElement).value) || 0;
      const rxThresh = parseFloat((document.getElementById('mwl-rx-thresh') as HTMLInputElement).value) || -75;
      const atmLoss = parseFloat((document.getElementById('mwl-atm-loss') as HTMLInputElement).value) || 0;
      const climate = parseFloat((document.getElementById('mwl-climate') as HTMLSelectElement).value) || 1;

      // FSPL for freq in GHz, dist in km
      const freqMHz = freq * 1000;
      const fspl = 20 * Math.log10(dist) + 20 * Math.log10(freqMHz) + 32.44;

      // Received signal level
      const rsl = txPower - txLoss + txGain - fspl - atmLoss + rxGain - rxLoss;
      const fadeMargin = rsl - rxThresh;
      const sysGain = txPower - txLoss + txGain + rxGain - rxLoss - rxThresh;

      // Vigants-Barnett fade outage estimation
      // Unavailability = c * d^3 * f * 10^(-FM/10) * 6e-7 (probability)
      const unavailProb = climate * Math.pow(dist, 3) * freq * Math.pow(10, -fadeMargin / 10) * 6e-7;
      const availPct = Math.max(0, (1 - unavailProb) * 100);
      const annualOutageMin = unavailProb * 525960; // minutes per year

      document.getElementById('mwl-margin')!.textContent = fadeMargin.toFixed(2);
      document.getElementById('mwl-fspl')!.textContent = fspl.toFixed(2);
      document.getElementById('mwl-rsl')!.textContent = rsl.toFixed(2);
      document.getElementById('mwl-sys-gain')!.textContent = sysGain.toFixed(1);

      const statusEl = document.getElementById('mwl-status')!;
      if (fadeMargin >= 30) {
        statusEl.textContent = 'Excellent';
        statusEl.className = 'text-xl font-bold text-green-600';
      } else if (fadeMargin >= 20) {
        statusEl.textContent = 'Good';
        statusEl.className = 'text-xl font-bold text-green-500';
      } else if (fadeMargin >= 10) {
        statusEl.textContent = 'Marginal';
        statusEl.className = 'text-xl font-bold text-yellow-500';
      } else if (fadeMargin >= 0) {
        statusEl.textContent = 'Poor';
        statusEl.className = 'text-xl font-bold text-orange-500';
      } else {
        statusEl.textContent = 'No Link';
        statusEl.className = 'text-xl font-bold text-red-500';
      }

      // Format outage
      if (annualOutageMin < 1) {
        document.getElementById('mwl-outage')!.textContent = (annualOutageMin * 60).toFixed(1) + ' sec/yr';
      } else if (annualOutageMin < 60) {
        document.getElementById('mwl-outage')!.textContent = annualOutageMin.toFixed(1) + ' min/yr';
      } else {
        document.getElementById('mwl-outage')!.textContent = (annualOutageMin / 60).toFixed(1) + ' hr/yr';
      }

      document.getElementById('mwl-avail')!.textContent = availPct >= 99.9999 ? availPct.toFixed(6) + '%' : availPct.toFixed(4) + '%';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.mwl-in').forEach(el => { el.addEventListener('input', calcMWL); el.addEventListener('change', calcMWL); });
      calcMWL();
    }, 50);
  </script>
</CalculatorLayout>
