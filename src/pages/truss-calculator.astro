---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Truss Calculator - Roof Truss Height, Rafter Length & Board Feet";
const description = "Calculate roof truss dimensions including height, rafter length, number of trusses, and total board feet for your roofing project.";

const relatedCalcs = [
  { name: "Rafter Calculator", url: "/rafter-calculator", description: "Rafter length and cuts." },
  { name: "Structural Load Calculator", url: "/structural-load-calculator", description: "Load analysis." },
  { name: "Floor Joist Calculator", url: "/floor-joist-calculator", description: "Joist sizing." },
  { name: "Soffit Calculator", url: "/soffit-calculator", description: "Soffit and fascia." },
  { name: "Siding Calculator", url: "/siding-calculator", description: "Siding material." },
  { name: "Pergola Calculator", url: "/pergola-calculator", description: "Pergola lumber." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Truss Calculator"
  keywords="truss calculator, roof truss, truss height, rafter length, truss spacing, board feet, roof pitch"
  breadcrumbs={[{ name: "Truss Calculator", url: "/truss-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Truss Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate roof truss dimensions, count, and lumber requirements.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <div class="grid grid-cols-2 gap-3 mb-5">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Span / Building Width (ft)</label>
              <input type="number" id="tu-span" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="30" min="4" step="1">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Building Length (ft)</label>
              <input type="number" id="tu-length" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="40" min="4" step="1">
            </div>
          </div>

          <div class="mb-5">
            <label class="block text-xs font-medium text-text mb-1">Roof Pitch (rise per 12" run)</label>
            <select id="tu-pitch" class="w-full px-3 py-3 border border-border rounded-xl text-lg">
              <option value="3">3/12 (low slope)</option>
              <option value="4">4/12</option>
              <option value="5" selected>5/12 (standard)</option>
              <option value="6">6/12</option>
              <option value="7">7/12</option>
              <option value="8">8/12 (steep)</option>
              <option value="10">10/12</option>
              <option value="12">12/12 (45 degrees)</option>
            </select>
          </div>

          <div class="mb-5">
            <label class="block text-xs font-medium text-text mb-1">Truss Spacing</label>
            <select id="tu-spacing" class="w-full px-3 py-3 border border-border rounded-xl text-lg">
              <option value="16">16 inches OC (residential)</option>
              <option value="24" selected>24 inches OC (standard)</option>
              <option value="48">48 inches OC (commercial)</option>
            </select>
          </div>

          <div class="p-4 bg-surface-alt rounded-xl">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Design Load (psf total)</label>
              <input type="number" id="tu-load" class="w-full px-3 py-2 border border-border rounded-lg" value="55" min="10" step="5">
              <div class="text-xs text-text-muted mt-1">Dead + live + snow (typical 55 psf)</div>
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Number of Trusses</div>
            <div class="text-5xl font-extrabold font-mono" id="tu-count">0</div>
            <div class="text-sm text-blue-200 mt-1">trusses needed</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Truss Height (peak)</div>
              <div class="text-xl font-bold" id="tu-height">0 ft</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Rafter Length</div>
              <div class="text-xl font-bold" id="tu-rafter">0 ft</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Board Feet</div>
              <div class="text-xl font-bold" id="tu-bdft">0</div>
              <div class="text-xs text-text-muted">2x4 chord lumber</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Roof Load</div>
              <div class="text-xl font-bold" id="tu-totalload">0 lbs</div>
            </div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Load Per Truss</div>
            <div class="text-xl font-bold" id="tu-pertruss">0 lbs</div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="truss" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How to Calculate Roof Trusses</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Truss height:</strong> (Span / 2) x (Pitch / 12)</p>
        <p><strong>Rafter length:</strong> sqrt((Span/2)^2 + Height^2)</p>
        <p><strong>Number:</strong> (Building length x 12 / Spacing) + 1</p>
      </div>

      <h3 class="text-xl font-semibold text-text mt-8">Common Truss Configurations</h3>
      <ul>
        <li><strong>King post:</strong> Simple triangle, spans up to 20 ft</li>
        <li><strong>Fink:</strong> W-shaped web, most common residential, up to 40 ft</li>
        <li><strong>Howe:</strong> Vertical webs, good for heavy loads</li>
        <li><strong>Scissor:</strong> Creates vaulted ceiling, reduced span capacity</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcTruss() {
      const span = parseFloat((document.getElementById('tu-span') as HTMLInputElement).value) || 0;
      const bldgLength = parseFloat((document.getElementById('tu-length') as HTMLInputElement).value) || 0;
      const pitch = parseFloat((document.getElementById('tu-pitch') as HTMLSelectElement).value) || 5;
      const spacing = parseFloat((document.getElementById('tu-spacing') as HTMLSelectElement).value) || 24;
      const load = parseFloat((document.getElementById('tu-load') as HTMLInputElement).value) || 55;

      const halfSpan = span / 2;
      const trussHeight = halfSpan * (pitch / 12);
      const rafterLength = Math.sqrt(halfSpan * halfSpan + trussHeight * trussHeight);

      const numTrusses = Math.ceil((bldgLength * 12) / spacing) + 1;

      // Roof area for load calc (both slopes)
      const roofArea = bldgLength * rafterLength * 2;
      const totalLoad = roofArea * load;
      const loadPerTruss = numTrusses > 0 ? totalLoad / numTrusses : 0;

      // Board feet estimate: each truss has 2 rafters (top chord), 1 bottom chord, ~3 web members
      // Using 2x4 lumber (1.5" x 3.5" actual)
      const topChordBdFt = 2 * rafterLength * (2 * 4) / 12; // 2 rafters
      const bottomChordBdFt = span * (2 * 4) / 12;
      const webBdFt = 3 * (trussHeight * 0.8) * (2 * 4) / 12; // ~3 web members
      const bdFtPerTruss = topChordBdFt + bottomChordBdFt + webBdFt;
      const totalBdFt = Math.ceil(bdFtPerTruss * numTrusses);

      document.getElementById('tu-count')!.textContent = String(numTrusses);
      document.getElementById('tu-height')!.textContent = trussHeight.toFixed(1) + ' ft';
      document.getElementById('tu-rafter')!.textContent = rafterLength.toFixed(1) + ' ft';
      document.getElementById('tu-bdft')!.textContent = totalBdFt.toLocaleString();
      document.getElementById('tu-totalload')!.textContent = Math.round(totalLoad).toLocaleString() + ' lbs';
      document.getElementById('tu-pertruss')!.textContent = Math.round(loadPerTruss).toLocaleString() + ' lbs';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('#tu-span, #tu-length, #tu-load').forEach(el => {
        el.addEventListener('input', calcTruss);
        el.addEventListener('change', calcTruss);
      });
      document.querySelectorAll('#tu-pitch, #tu-spacing').forEach(el => {
        el.addEventListener('input', calcTruss);
        el.addEventListener('change', calcTruss);
      });
      calcTruss();
    }, 50);
  </script>
</CalculatorLayout>
