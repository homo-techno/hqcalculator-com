---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Queueing Theory Calculator - M/M/1 Queue Metrics";
const description = "Calculate M/M/1 queue metrics: utilization, average wait time, average queue length, and service rate needed for target performance.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "Event probability." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical tools." },
  { name: "Average Calculator", url: "/average-calculator", description: "Calculate averages." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage math." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Spread analysis." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Queueing Theory Calculator" keywords="queueing theory, M/M/1 queue, wait time, utilization, queue length, Little's law, service rate" breadcrumbs={[{ name: "Queueing Theory", url: "/queueing-theory-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Queueing Theory Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Analyze M/M/1 and M/M/c queues: find utilization, wait times, queue lengths, and required service capacity.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Arrival Rate (lambda, per hour)</label>
          <input type="number" class="qt-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="qt-lambda" min="0.01" step="0.1" value="10">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Service Rate (mu, per hour per server)</label>
          <input type="number" class="qt-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="qt-mu" min="0.01" step="0.1" value="12">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Number of Servers (c)</label>
          <input type="number" class="qt-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" id="qt-servers" min="1" max="100" value="1">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Target Max Wait Time (minutes)</label>
          <input type="number" class="qt-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" id="qt-target" min="0.1" step="0.1" value="5">
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Server Utilization</div>
          <div class="text-5xl font-extrabold font-mono" id="qt-util">--</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Avg Wait (in queue)</div>
            <div class="text-xl font-bold font-mono" id="qt-wq">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Avg Time in System</div>
            <div class="text-xl font-bold font-mono" id="qt-ws">--</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Avg Queue Length (Lq)</div>
            <div class="text-xl font-bold font-mono" id="qt-lq">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Avg in System (Ls)</div>
            <div class="text-xl font-bold font-mono" id="qt-ls">--</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">P(System Empty)</div>
            <div class="text-xl font-bold font-mono" id="qt-p0">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Service Rate Needed</div>
            <div class="text-xl font-bold font-mono" id="qt-needed">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Impact of Adding Servers</h3>
          <div class="text-xs font-mono space-y-1" id="qt-table"></div>
        </div>
      </div>
      <ShareButton calculatorId="queueing-theory" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Queueing Theory Formulas (M/M/1)</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Utilization (rho):</strong> lambda / (c x mu)</p>
        <p><strong>Ls:</strong> rho / (1 - rho) [M/M/1]</p>
        <p><strong>Lq:</strong> rho^2 / (1 - rho) [M/M/1]</p>
        <p><strong>Ws:</strong> 1 / (mu - lambda) [M/M/1]</p>
        <p><strong>Wq:</strong> rho / (mu - lambda) [M/M/1]</p>
        <p><strong>Little's Law:</strong> L = lambda x W</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function factorial(n: number): number {
      let r = 1;
      for (let i = 2; i <= n; i++) r *= i;
      return r;
    }

    function calcQT() {
      const lambda = parseFloat((document.getElementById('qt-lambda') as HTMLInputElement).value) || 10;
      const mu = parseFloat((document.getElementById('qt-mu') as HTMLInputElement).value) || 12;
      const c = parseInt((document.getElementById('qt-servers') as HTMLInputElement).value) || 1;
      const targetMin = parseFloat((document.getElementById('qt-target') as HTMLInputElement).value) || 5;
      const targetHr = targetMin / 60;

      const rho = lambda / (c * mu);

      if (rho >= 1) {
        document.getElementById('qt-util')!.textContent = (rho * 100).toFixed(1) + '% (UNSTABLE)';
        document.getElementById('qt-wq')!.textContent = 'Infinite';
        document.getElementById('qt-ws')!.textContent = 'Infinite';
        document.getElementById('qt-lq')!.textContent = 'Infinite';
        document.getElementById('qt-ls')!.textContent = 'Infinite';
        document.getElementById('qt-p0')!.textContent = '0%';
        // Find needed service rate
        const neededMu = lambda / (c * 0.8) + 0.1; // target 80% utilization
        document.getElementById('qt-needed')!.textContent = neededMu.toFixed(1) + '/hr';
        document.getElementById('qt-table')!.innerHTML = '<div class="text-red-600">System is unstable (rho >= 1). Add servers or increase service rate.</div>';
        document.dispatchEvent(new CustomEvent('calc-update'));
        return;
      }

      let Lq: number, Ls: number, Wq: number, Ws: number, P0: number;

      if (c === 1) {
        // M/M/1
        Ls = rho / (1 - rho);
        Lq = rho * rho / (1 - rho);
        Ws = 1 / (mu - lambda);
        Wq = rho / (mu - lambda);
        P0 = 1 - rho;
      } else {
        // M/M/c - Erlang C formula
        const a = lambda / mu;
        let sum = 0;
        for (let k = 0; k < c; k++) {
          sum += Math.pow(a, k) / factorial(k);
        }
        const lastTerm = Math.pow(a, c) / (factorial(c) * (1 - rho));
        P0 = 1 / (sum + lastTerm);
        const Pc = (Math.pow(a, c) / factorial(c)) * P0 / (1 - rho);
        Lq = Pc * rho / (1 - rho);
        Wq = Lq / lambda;
        Ws = Wq + 1 / mu;
        Ls = lambda * Ws;
      }

      document.getElementById('qt-util')!.textContent = (rho * 100).toFixed(1) + '%';
      document.getElementById('qt-wq')!.textContent = (Wq * 60).toFixed(2) + ' min';
      document.getElementById('qt-ws')!.textContent = (Ws * 60).toFixed(2) + ' min';
      document.getElementById('qt-lq')!.textContent = Lq.toFixed(2);
      document.getElementById('qt-ls')!.textContent = Ls.toFixed(2);
      document.getElementById('qt-p0')!.textContent = (P0 * 100).toFixed(1) + '%';

      // Service rate needed for target wait
      // For M/M/1: Wq = rho / (mu - lambda) <= target => mu >= lambda + rho/target
      // Simplified: mu >= lambda / (1 - lambda*target/(1+lambda*target)) -- solve iteratively
      let neededMu = lambda + 1;
      if (c === 1) {
        // Wq = lambda / (mu*(mu-lambda)) <= targetHr
        // mu^2 - mu*lambda - lambda/targetHr >= 0
        const disc = lambda * lambda + 4 * lambda / targetHr;
        neededMu = (lambda + Math.sqrt(disc)) / 2;
      }
      document.getElementById('qt-needed')!.textContent = neededMu.toFixed(1) + '/hr (per server)';

      // Server comparison table
      let html = '';
      for (let s = 1; s <= Math.min(c + 5, 20); s++) {
        const r = lambda / (s * mu);
        if (r >= 1) {
          html += '<div class="flex justify-between py-0.5 border-b border-border"><span>' + s + ' server(s)</span><span>Unstable (' + (r * 100).toFixed(0) + '% util)</span></div>';
          continue;
        }
        let wq: number;
        if (s === 1) {
          wq = (lambda / mu) / (mu - lambda);
        } else {
          const a = lambda / mu;
          let sm = 0;
          for (let k = 0; k < s; k++) sm += Math.pow(a, k) / factorial(k);
          const lt = Math.pow(a, s) / (factorial(s) * (1 - r));
          const p0 = 1 / (sm + lt);
          const pc = (Math.pow(a, s) / factorial(s)) * p0 / (1 - r);
          const lq = pc * r / (1 - r);
          wq = lq / lambda;
        }
        const marker = s === c ? ' font-bold text-primary' : '';
        html += '<div class="flex justify-between py-0.5 border-b border-border' + marker + '"><span>' + s + ' server(s)</span><span>Util: ' + (r * 100).toFixed(1) + '% | Wait: ' + (wq * 60).toFixed(1) + ' min</span></div>';
      }
      document.getElementById('qt-table')!.innerHTML = html;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.qt-in').forEach(el => { el.addEventListener('input', calcQT); el.addEventListener('change', calcQT); });
      calcQT();
    }, 50);
  </script>
</CalculatorLayout>
