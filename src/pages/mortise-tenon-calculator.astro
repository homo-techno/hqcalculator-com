---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Mortise & Tenon Calculator - Joint Dimensions from Stock Size";
const description = "Calculate optimal mortise and tenon joint dimensions from your stock size. Get mortise depth, tenon thickness, shoulder widths, and chisel size recommendations.";

const relatedCalcs = [
  { name: "Dovetail Joint Calculator", url: "/dovetail-joint-calculator", description: "Dovetail layout planner." },
  { name: "Dowel Joint Calculator", url: "/dowel-joint-calculator", description: "Dowel joint spacing." },
  { name: "Dado Joint Calculator", url: "/dado-joint-calculator", description: "Dado/rabbet dimensions." },
  { name: "Box Joint Calculator", url: "/box-joint-calculator", description: "Box joint layout." },
  { name: "Wood Glue Calculator", url: "/wood-glue-calculator", description: "Glue coverage estimator." },
  { name: "Board Foot Calculator", url: "/board-foot-calculator", description: "Board feet calculator." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Mortise & Tenon Calculator"
  keywords="mortise tenon calculator, mortise dimensions, tenon thickness, joint design, woodworking joint, M&T joint"
  breadcrumbs={[{ name: "Mortise & Tenon Calculator", url: "/mortise-tenon-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Mortise &amp; Tenon Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate optimal mortise and tenon dimensions based on your stock size for maximum joint strength.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <h3 class="text-lg font-bold text-text mb-4">Stock Dimensions</h3>
      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Stock Thickness (inches)</label>
          <input type="number" id="mt2-thick" class="mt2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.75" min="0.25" step="0.125">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Stock Width (inches)</label>
          <input type="number" id="mt2-width" class="mt2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="3" min="0.5" step="0.25">
        </div>
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Joint Type</label>
        <select id="mt2-type" class="mt2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="through">Through Tenon</option>
          <option value="blind" selected>Blind (Stub) Tenon</option>
          <option value="haunched">Haunched Tenon</option>
        </select>
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Tenon Length Override (inches, 0 = auto)</label>
        <input type="number" id="mt2-tlen" class="mt2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0" min="0" step="0.125">
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Tenon Thickness</div>
        <div class="text-4xl font-extrabold" id="mt2-tenon-thick">--</div>
        <div class="text-sm text-blue-200 mt-1">Rule of thirds: ~1/3 stock thickness</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Tenon Width</div>
          <div class="text-xl font-bold" id="mt2-tenon-w">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Tenon Length</div>
          <div class="text-xl font-bold" id="mt2-tenon-len">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Mortise Depth</div>
          <div class="text-xl font-bold" id="mt2-mort-depth">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Mortise Width</div>
          <div class="text-xl font-bold" id="mt2-mort-w">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Shoulder Width (each)</div>
          <div class="text-xl font-bold" id="mt2-shoulder">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Chisel Size</div>
          <div class="text-xl font-bold" id="mt2-chisel">--</div>
        </div>
      </div>

      <div class="p-4 bg-surface-alt rounded-xl mb-6" id="mt2-haunch-info" style="display:none;">
        <h4 class="font-semibold text-sm text-text mb-1">Haunch Dimensions</h4>
        <p class="text-sm text-text-secondary" id="mt2-haunch-text">--</p>
      </div>

      <ShareButton calculatorId="mortise-tenon" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Mortise &amp; Tenon Design Rules</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Tenon Thickness = ~1/3 of stock thickness</strong></p>
        <p><strong>Tenon Width = Stock Width - 2 x shoulder allowance</strong></p>
        <p><strong>Mortise Depth = 2/3 to 3/4 of mortise member thickness (blind)</strong></p>
      </div>
      <h3 class="text-xl font-semibold text-text mt-8">Tips</h3>
      <ul>
        <li>Choose a chisel size that matches your tenon thickness exactly</li>
        <li>Leave at least 1/16" extra mortise depth for glue accumulation</li>
        <li>For through tenons, add 1/16" to tenon length for trimming flush</li>
        <li>Haunched tenons prevent twist and are ideal for frame-and-panel doors</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcMT2() {
      const stockThick = parseFloat((document.getElementById('mt2-thick') as HTMLInputElement).value) || 0.75;
      const stockWidth = parseFloat((document.getElementById('mt2-width') as HTMLInputElement).value) || 3;
      const jointType = (document.getElementById('mt2-type') as HTMLSelectElement).value;
      const tenonLenOverride = parseFloat((document.getElementById('mt2-tlen') as HTMLInputElement).value) || 0;

      // Tenon thickness: closest chisel size to 1/3 of stock thickness
      const chiselSizes = [0.125, 0.1875, 0.25, 0.3125, 0.375, 0.5, 0.625, 0.75, 1.0];
      const idealThick = stockThick / 3;
      let tenonThick = chiselSizes[0];
      let minDiff = Math.abs(idealThick - chiselSizes[0]);
      for (const cs of chiselSizes) {
        const diff = Math.abs(idealThick - cs);
        if (diff < minDiff) { minDiff = diff; tenonThick = cs; }
      }

      // Shoulder width on each side
      const shoulderEach = (stockThick - tenonThick) / 2;

      // Tenon width: stock width minus a small shoulder on top and bottom (1/16" each typically)
      const edgeShoulder = 0.0625;
      const tenonWidth = stockWidth - 2 * edgeShoulder;

      // Mortise depth / tenon length
      let tenonLen = tenonLenOverride;
      let mortDepth = 0;
      if (jointType === 'through') {
        tenonLen = tenonLenOverride > 0 ? tenonLenOverride : stockWidth + 0.0625;
        mortDepth = stockWidth;
      } else if (jointType === 'blind') {
        tenonLen = tenonLenOverride > 0 ? tenonLenOverride : Math.round(stockWidth * 0.667 * 16) / 16;
        mortDepth = tenonLen + 0.0625;
      } else { // haunched
        tenonLen = tenonLenOverride > 0 ? tenonLenOverride : Math.round(stockWidth * 0.667 * 16) / 16;
        mortDepth = tenonLen + 0.0625;
      }

      const mortWidth = tenonThick; // mortise matches tenon

      // Chisel recommendation
      const frac = (n: number) => {
        const fracs: Record<number, string> = {0.125:'1/8"',0.1875:'3/16"',0.25:'1/4"',0.3125:'5/16"',0.375:'3/8"',0.5:'1/2"',0.625:'5/8"',0.75:'3/4"',1.0:'1"'};
        return fracs[n] || n.toFixed(3) + '"';
      };

      document.getElementById('mt2-tenon-thick')!.textContent = frac(tenonThick);
      document.getElementById('mt2-tenon-w')!.textContent = tenonWidth.toFixed(3) + '"';
      document.getElementById('mt2-tenon-len')!.textContent = tenonLen.toFixed(3) + '"';
      document.getElementById('mt2-mort-depth')!.textContent = mortDepth.toFixed(3) + '"';
      document.getElementById('mt2-mort-w')!.textContent = frac(mortWidth);
      document.getElementById('mt2-shoulder')!.textContent = shoulderEach.toFixed(3) + '"';
      document.getElementById('mt2-chisel')!.textContent = frac(tenonThick);

      // Haunch info
      const haunchEl = document.getElementById('mt2-haunch-info') as HTMLElement;
      if (jointType === 'haunched') {
        const haunchDepth = tenonLen / 3;
        const haunchWidth = tenonWidth / 4;
        haunchEl.style.display = 'block';
        document.getElementById('mt2-haunch-text')!.textContent =
          'Haunch depth: ' + haunchDepth.toFixed(3) + '", Haunch width: ' + haunchWidth.toFixed(3) + '"';
      } else {
        haunchEl.style.display = 'none';
      }

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.mt2-in').forEach(el => {
        el.addEventListener('input', calcMT2);
        el.addEventListener('change', calcMT2);
      });
      calcMT2();
    }, 50);
  </script>
</CalculatorLayout>
