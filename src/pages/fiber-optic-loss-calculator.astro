---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Fiber Optic Loss Calculator - Optical Loss Budget 2026";
const description = "Calculate fiber optic cable loss budget including cable attenuation, splice losses, connector losses, and safety margin. Supports single-mode and multi-mode fiber.";

const relatedCalcs = [
  { name: "Cable Attenuation Calculator", url: "/cable-attenuation-calculator", description: "Coaxial cable signal attenuation." },
  { name: "Network Throughput Calculator", url: "/network-throughput-calculator", description: "TCP throughput estimation." },
  { name: "Bandwidth Calculator", url: "/bandwidth-calculator", description: "Network bandwidth requirements." },
  { name: "Data Transfer Calculator", url: "/data-transfer-calculator", description: "File transfer time estimation." },
  { name: "Ethernet Cable Calculator", url: "/ethernet-cable-calculator", description: "Ethernet cable specifications." },
  { name: "Link Budget Calculator", url: "/link-budget-calculator", description: "RF link budget analysis." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Fiber Optic Loss Calculator"
  keywords="fiber optic loss calculator, optical loss budget, splice loss, connector loss, fiber attenuation, single mode, multi mode"
  breadcrumbs={[{ name: "Fiber Optic Loss Calculator", url: "/fiber-optic-loss-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Fiber Optic Loss Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate the total optical power loss in a fiber optic link including cable, splices, connectors, and safety margin.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Fiber Type</label>
        <select id="fol-type" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="sm1310">Single-Mode (1310 nm) - 0.35 dB/km</option>
          <option value="sm1550">Single-Mode (1550 nm) - 0.22 dB/km</option>
          <option value="mm850">Multi-Mode (850 nm) - 3.5 dB/km</option>
          <option value="mm1300">Multi-Mode (1300 nm) - 1.5 dB/km</option>
          <option value="custom">Custom attenuation</option>
        </select>
      </div>

      <div class="mb-4" id="fol-custom-wrap" style="display:none;">
        <label class="block text-sm font-medium text-text mb-1">Custom Attenuation (dB/km)</label>
        <input type="number" id="fol-custom-atten" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.35" step="0.01" min="0">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Cable Length (km)</label>
        <input type="number" id="fol-length" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="10" step="0.1" min="0">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Number of Connectors</label>
        <input type="number" id="fol-connectors" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="4" step="1" min="0">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Loss per Connector (dB)</label>
        <input type="number" id="fol-conn-loss" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.5" step="0.01" min="0">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Number of Splices</label>
        <input type="number" id="fol-splices" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="2" step="1" min="0">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Loss per Splice (dB)</label>
        <input type="number" id="fol-splice-loss" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.1" step="0.01" min="0">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Transmitter Power (dBm)</label>
        <input type="number" id="fol-tx-power" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0" step="0.1">
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-text mb-1">Receiver Sensitivity (dBm)</label>
        <input type="number" id="fol-rx-sens" class="fol-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="-25" step="0.1">
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm font-medium text-blue-100 mb-1">Total Link Loss</div>
        <div class="text-4xl font-extrabold" id="fol-total">--</div>
        <div class="text-sm text-blue-200 mt-1">dB</div>
      </div>

      <!-- Secondary Stats -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Cable Loss</div>
          <div class="text-xl font-bold text-text" id="fol-cable-loss">--</div>
          <div class="text-xs text-text-muted">dB</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Connector Loss</div>
          <div class="text-xl font-bold text-text" id="fol-conn-total">--</div>
          <div class="text-xs text-text-muted">dB</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Splice Loss</div>
          <div class="text-xl font-bold text-text" id="fol-splice-total">--</div>
          <div class="text-xs text-text-muted">dB</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Power Margin</div>
          <div class="text-xl font-bold" id="fol-margin">--</div>
          <div class="text-xs text-text-muted">dB</div>
        </div>
      </div>

      <ShareButton calculatorId="fiber-optic-loss" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How to Calculate Fiber Optic Loss Budget</h2>
      <p>A fiber optic loss budget estimates the total signal loss in a fiber link. It sums cable attenuation, connector losses, and splice losses.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono text-sm">
        Total Loss = (Length x Attenuation/km) + (Connectors x Loss/Connector) + (Splices x Loss/Splice)
      </div>
      <p>The power margin is the difference between the available power budget (TX power minus RX sensitivity) and the total link loss. A positive margin with at least 3 dB of safety is recommended.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcFOL() {
      const fiberType = (document.getElementById('fol-type') as HTMLSelectElement).value;
      const length = parseFloat((document.getElementById('fol-length') as HTMLInputElement).value) || 0;
      const connectors = parseFloat((document.getElementById('fol-connectors') as HTMLInputElement).value) || 0;
      const connLoss = parseFloat((document.getElementById('fol-conn-loss') as HTMLInputElement).value) || 0;
      const splices = parseFloat((document.getElementById('fol-splices') as HTMLInputElement).value) || 0;
      const spliceLoss = parseFloat((document.getElementById('fol-splice-loss') as HTMLInputElement).value) || 0;
      const txPower = parseFloat((document.getElementById('fol-tx-power') as HTMLInputElement).value) || 0;
      const rxSens = parseFloat((document.getElementById('fol-rx-sens') as HTMLInputElement).value) || -25;

      const attenMap: Record<string, number> = { sm1310: 0.35, sm1550: 0.22, mm850: 3.5, mm1300: 1.5 };
      let atten = attenMap[fiberType] || 0.35;
      if (fiberType === 'custom') {
        atten = parseFloat((document.getElementById('fol-custom-atten') as HTMLInputElement).value) || 0;
      }

      document.getElementById('fol-custom-wrap')!.style.display = fiberType === 'custom' ? '' : 'none';

      const cableLoss = length * atten;
      const connTotal = connectors * connLoss;
      const spliceTotal = splices * spliceLoss;
      const totalLoss = cableLoss + connTotal + spliceTotal;
      const powerBudget = txPower - rxSens;
      const margin = powerBudget - totalLoss;

      document.getElementById('fol-total')!.textContent = totalLoss.toFixed(2);
      document.getElementById('fol-cable-loss')!.textContent = cableLoss.toFixed(2);
      document.getElementById('fol-conn-total')!.textContent = connTotal.toFixed(2);
      document.getElementById('fol-splice-total')!.textContent = spliceTotal.toFixed(2);

      const marginEl = document.getElementById('fol-margin')!;
      marginEl.textContent = margin.toFixed(2);
      marginEl.className = 'text-xl font-bold ' + (margin >= 3 ? 'text-green-600' : margin >= 0 ? 'text-yellow-500' : 'text-red-500');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.fol-in').forEach(el => { el.addEventListener('input', calcFOL); el.addEventListener('change', calcFOL); });
      calcFOL();
    }, 50);
  </script>
</CalculatorLayout>
