---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Soil Composition Calculator - Texture Triangle & Porosity";
const description = "Determine soil texture class from sand/silt/clay percentages using the USDA soil triangle, calculate porosity, and water holding capacity.";
const relatedCalcs = [
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage calculations." },
  { name: "Density Calculator", url: "/density-calculator", description: "Density calculations." },
  { name: "Area Calculator", url: "/area-calculator", description: "Area calculations." },
  { name: "Average Calculator", url: "/average-calculator", description: "Statistical averages." },
  { name: "Carbon Footprint", url: "/carbon-footprint-calculator", description: "Carbon footprint." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Scientific calculations." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Soil Composition Calculator" keywords="soil composition, soil texture, sand silt clay, soil triangle, USDA, porosity, water holding capacity" breadcrumbs={[{ name: "Soil Composition", url: "/soil-composition-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Soil Composition Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">USDA soil texture classification from sand/silt/clay percentages with porosity and water capacity.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-3 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Sand (%)</label><input type="number" id="so-sand" class="so-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" max="100" step="1"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Silt (%)</label><input type="number" id="so-silt" class="so-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" max="100" step="1"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Clay (%)</label><input type="number" id="so-clay" class="so-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" max="100" step="1"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Bulk Density (g/cmÂ³)</label><input type="number" id="so-bd" class="so-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" max="3" step="0.01"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Organic Matter (%)</label><input type="number" id="so-om" class="so-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" max="100" step="0.1"></div>
        </div>

        <p class="text-xs text-red-500 font-medium" id="so-warn"></p>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Soil Texture Class</div>
          <div class="text-4xl font-extrabold font-mono" id="so-result">--</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Porosity (%)</div><div class="text-xl font-bold font-mono" id="so-s1">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Water Holding Cap.</div><div class="text-xl font-bold font-mono" id="so-s2">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Drainage</div><div class="text-xl font-bold font-mono" id="so-s3">--</div></div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Permeability</div><div class="text-xl font-bold font-mono" id="so-s4">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Organic Carbon</div><div class="text-xl font-bold font-mono" id="so-s5">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Fertility Potential</div><div class="text-xl font-bold font-mono" id="so-s6">--</div></div>
        </div>
      </div>
      <ShareButton calculatorId="soil-composition" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function getTextureClass(sand: number, silt: number, clay: number): string {
      // USDA Soil Texture Triangle classification
      if (clay >= 40 && sand <= 45 && silt < 40) return 'Clay';
      if (clay >= 40 && silt >= 40) return 'Silty Clay';
      if (clay >= 35 && sand > 45) return 'Sandy Clay';
      if (clay >= 27 && clay < 40 && sand > 20 && sand <= 45) return 'Clay Loam';
      if (clay >= 27 && clay < 40 && sand <= 20) return 'Silty Clay Loam';
      if (clay >= 20 && clay < 35 && sand > 45 && silt < 28) return 'Sandy Clay Loam';
      if (silt >= 80 && clay < 12) return 'Silt';
      if (silt >= 50 && clay >= 12 && clay < 27) return 'Silty Loam';
      if (silt >= 50 && silt < 80 && clay < 12) return 'Silty Loam';
      if (clay >= 7 && clay < 27 && sand >= 23 && sand <= 52 && silt >= 28 && silt < 50) return 'Loam';
      if (sand >= 70 && sand < 85 && clay < 15) return 'Loamy Sand';
      if (sand >= 85) return 'Sand';
      if (sand >= 43 && sand <= 80 && clay < 20 && silt < 50) return 'Sandy Loam';
      return 'Loam';
    }

    function calcSO() {
      const sand = parseFloat((document.getElementById('so-sand') as HTMLInputElement).value) || 0;
      const silt = parseFloat((document.getElementById('so-silt') as HTMLInputElement).value) || 0;
      const clay = parseFloat((document.getElementById('so-clay') as HTMLInputElement).value) || 0;
      const bd = parseFloat((document.getElementById('so-bd') as HTMLInputElement).value) || 1.3;
      const om = parseFloat((document.getElementById('so-om') as HTMLInputElement).value) || 0;

      const total = sand + silt + clay;
      const warn = document.getElementById('so-warn')!;
      if (Math.abs(total - 100) > 0.5 && total > 0) {
        warn.textContent = 'Warning: Sand + Silt + Clay = ' + total.toFixed(1) + '% (should equal 100%)';
      } else {
        warn.textContent = '';
      }

      const texture = getTextureClass(sand, silt, clay);
      // Porosity = 1 - (bulk density / particle density), particle density ~2.65 g/cm3
      const porosity = (1 - bd / 2.65) * 100;
      // Organic carbon ~ OM / 1.724
      const oc = om / 1.724;

      // Estimated water holding capacity (mm/m) based on texture
      let whc: number, drainage: string, perm: string;
      if (sand >= 70) { whc = 60; drainage = 'Excessive'; perm = 'Rapid'; }
      else if (clay >= 40) { whc = 170; drainage = 'Poor'; perm = 'Very Slow'; }
      else if (clay >= 27) { whc = 155; drainage = 'Moderate'; perm = 'Slow'; }
      else if (silt >= 50) { whc = 190; drainage = 'Moderate'; perm = 'Moderate'; }
      else { whc = 140; drainage = 'Good'; perm = 'Moderate'; }

      // OM effect
      whc += om * 5;

      let fertility: string;
      if (om >= 5 && clay >= 15 && clay <= 35) fertility = 'High';
      else if (om >= 2 && clay >= 10) fertility = 'Moderate';
      else fertility = 'Low';

      document.getElementById('so-result')!.textContent = texture;
      document.getElementById('so-s1')!.textContent = porosity.toFixed(1) + '%';
      document.getElementById('so-s2')!.textContent = whc.toFixed(0) + ' mm/m';
      document.getElementById('so-s3')!.textContent = drainage;
      document.getElementById('so-s4')!.textContent = perm;
      document.getElementById('so-s5')!.textContent = oc.toFixed(2) + '%';
      document.getElementById('so-s6')!.textContent = fertility;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      (document.getElementById('so-sand') as HTMLInputElement).value = '40';
      (document.getElementById('so-silt') as HTMLInputElement).value = '40';
      (document.getElementById('so-clay') as HTMLInputElement).value = '20';
      (document.getElementById('so-bd') as HTMLInputElement).value = '1.3';
      (document.getElementById('so-om') as HTMLInputElement).value = '3.5';
      document.querySelectorAll('.so-in').forEach(el => { el.addEventListener('input', calcSO); el.addEventListener('change', calcSO); });
      calcSO();
    }, 50);
  </script>
</CalculatorLayout>
