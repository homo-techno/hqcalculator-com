---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Caffeine Half-Life Calculator - Remaining Caffeine & Sleep Impact";
const description = "Calculate how much caffeine remains in your system over time using the 5.7-hour half-life. Find your optimal cutoff time and sleep impact.";
const relatedCalcs = [
  { name: "Caffeine Calculator", url: "/caffeine-calculator", description: "Caffeine intake." },
  { name: "Sleep Calculator", url: "/sleep-calculator", description: "Optimize sleep cycles." },
  { name: "Calorie Calculator", url: "/calorie-calculator", description: "Daily calorie needs." },
  { name: "BMI Calculator", url: "/bmi-calculator", description: "Body mass index." },
  { name: "Heart Rate Calculator", url: "/heart-rate-calculator", description: "Heart rate zones." },
  { name: "Water Intake", url: "/water-intake-calculator", description: "Daily hydration." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Caffeine Half-Life Calculator" keywords="caffeine half life, caffeine metabolism, caffeine remaining, sleep impact caffeine, caffeine cutoff time, caffeine sensitivity" breadcrumbs={[{ name: "Caffeine Half-Life", url: "/caffeine-half-life-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Caffeine Half-Life Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">See how caffeine levels decline in your body and find the best cutoff time for quality sleep.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-1">Caffeine Source</label>
          <select id="ch-source" class="ch-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center">
            <option value="95">Coffee (8oz) - 95 mg</option>
            <option value="63">Espresso (1 shot) - 63 mg</option>
            <option value="47">Black Tea (8oz) - 47 mg</option>
            <option value="28">Green Tea (8oz) - 28 mg</option>
            <option value="34">Cola (12oz) - 34 mg</option>
            <option value="80">Energy Drink (8oz) - 80 mg</option>
            <option value="160">Large Energy Drink (16oz) - 160 mg</option>
            <option value="200">Caffeine Pill - 200 mg</option>
            <option value="0">Custom amount</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Caffeine Amount (mg) - adjust if custom</label>
          <input type="number" id="ch-mg" class="ch-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" min="0" max="1000" step="5">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Time Consumed</label>
          <input type="time" id="ch-time" class="ch-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Planned Bedtime</label>
          <input type="time" id="ch-bed" class="ch-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Caffeine Sensitivity</label>
          <select id="ch-sens" class="ch-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center">
            <option value="fast">Fast Metabolizer (half-life ~3-4 hrs)</option>
            <option value="normal">Normal (half-life ~5.7 hrs)</option>
            <option value="slow">Slow Metabolizer (half-life ~7-9 hrs)</option>
          </select>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm opacity-80">Caffeine at Bedtime</div>
          <div class="text-2xl font-extrabold mt-1" id="ch-atbed">--</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Sleep Impact</div>
            <div class="text-xl font-bold text-text mt-1" id="ch-impact">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Optimal Cutoff Time</div>
            <div class="text-xl font-bold text-text mt-1" id="ch-cutoff">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <div class="text-xs text-text-secondary mb-2">Caffeine Decay Timeline</div>
          <div class="text-sm text-text space-y-1" id="ch-timeline">--</div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <div class="text-xs text-text-secondary mb-2">Key Facts</div>
          <div class="text-sm text-text" id="ch-facts">--</div>
        </div>
      </div>

      <ShareButton calculatorId="caffeine-half-life" />
      <FeedbackWidget />
    </div>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function minToTimeStr(m: number): string {
      const mins = ((m % 1440) + 1440) % 1440;
      const h = Math.floor(mins / 60);
      const mm = mins % 60;
      const ampm = h >= 12 ? 'PM' : 'AM';
      const hh = h === 0 ? 12 : h > 12 ? h - 12 : h;
      return hh + ':' + String(mm).padStart(2, '0') + ' ' + ampm;
    }

    function calcCH() {
      const sourceVal = parseInt((document.getElementById('ch-source') as HTMLSelectElement).value);
      let mg = parseFloat((document.getElementById('ch-mg') as HTMLInputElement).value) || sourceVal;
      const timeStr = (document.getElementById('ch-time') as HTMLInputElement).value || '08:00';
      const bedStr = (document.getElementById('ch-bed') as HTMLInputElement).value || '23:00';
      const sens = (document.getElementById('ch-sens') as HTMLSelectElement).value;

      if (sourceVal > 0) mg = sourceVal;

      const halfLife = sens === 'fast' ? 3.5 : sens === 'slow' ? 8 : 5.7;

      const [tH, tM] = timeStr.split(':').map(Number);
      const [bH, bM] = bedStr.split(':').map(Number);
      let consumedMin = tH * 60 + tM;
      let bedMin = bH * 60 + bM;
      if (bedMin <= consumedMin) bedMin += 1440;

      const hoursUntilBed = (bedMin - consumedMin) / 60;
      const atBedtime = mg * Math.pow(0.5, hoursUntilBed / halfLife);

      // Sleep impact threshold: ~50mg can affect sleep, ~25mg minimal
      let impact = 'None';
      if (atBedtime > 100) impact = 'Severe - likely insomnia';
      else if (atBedtime > 50) impact = 'Significant - delayed sleep';
      else if (atBedtime > 25) impact = 'Mild - may affect quality';
      else impact = 'Minimal - sleep should be fine';

      // Optimal cutoff: when caffeine at bedtime would be ~25mg
      // 25 = mg * 0.5^(hours/halfLife) => hours = halfLife * log2(mg/25)
      let cutoffHours = mg > 25 ? halfLife * Math.log2(mg / 25) : 0;
      const cutoffMin = (bedMin - cutoffHours * 60);

      document.getElementById('ch-atbed')!.textContent = atBedtime.toFixed(1) + ' mg remaining (' + (atBedtime / mg * 100).toFixed(0) + '% of original)';
      document.getElementById('ch-impact')!.textContent = impact;
      document.getElementById('ch-cutoff')!.textContent = cutoffHours > 0 ? 'Before ' + minToTimeStr(cutoffMin) : 'Any time is fine';

      // Timeline
      const hours = [1, 2, 3, 4, 6, 8, 10, 12];
      const timeline = hours.map(h => {
        const remaining = mg * Math.pow(0.5, h / halfLife);
        const timeAt = consumedMin + h * 60;
        return '<div class="flex justify-between"><span>' + minToTimeStr(timeAt) + ' (+' + h + 'h)</span><span>' + remaining.toFixed(1) + ' mg (' + (remaining / mg * 100).toFixed(0) + '%)</span></div>';
      }).join('');
      document.getElementById('ch-timeline')!.innerHTML = timeline;

      let facts: string[] = [];
      facts.push('Average caffeine half-life is 5.7 hours, but ranges from 1.5 to 9.5 hours based on genetics (CYP1A2 gene), age, liver function, and medications.');
      if (sens === 'slow') facts.push('Slow metabolizers should be extra cautious. Oral contraceptives, pregnancy, and some medications can double caffeine half-life.');
      if (mg > 400) facts.push('Warning: FDA recommends no more than 400mg caffeine per day for healthy adults.');
      facts.push('Caffeine blocks adenosine receptors. The adenosine is still building up, which is why you may crash when it wears off.');

      document.getElementById('ch-facts')!.textContent = facts.join(' ');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      (document.getElementById('ch-mg') as HTMLInputElement).value = '95';
      (document.getElementById('ch-time') as HTMLInputElement).value = '08:00';
      (document.getElementById('ch-bed') as HTMLInputElement).value = '23:00';
      document.querySelectorAll('.ch-in').forEach(el => {
        el.addEventListener('input', calcCH);
        el.addEventListener('change', calcCH);
      });

      // Update mg when source changes
      document.getElementById('ch-source')!.addEventListener('change', () => {
        const v = parseInt((document.getElementById('ch-source') as HTMLSelectElement).value);
        if (v > 0) (document.getElementById('ch-mg') as HTMLInputElement).value = String(v);
        calcCH();
      });

      calcCH();
    }, 50);
  </script>
</CalculatorLayout>
