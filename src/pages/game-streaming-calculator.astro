---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Game Streaming Calculator";
const description = "Calculate optimal bitrate for resolution and FPS, upload speed requirements, encoding settings, and bandwidth usage for game streaming.";
const relatedCalcs = [
  { name: "Video Bitrate", url: "/video-bitrate-calculator", description: "Bitrate calculation." },
  { name: "Internet Speed", url: "/internet-speed-calculator", description: "Speed testing." },
  { name: "Video Frame Rate", url: "/video-frame-rate-calculator", description: "Frame rates." },
  { name: "Audio File Size", url: "/audio-file-size-calculator", description: "File size math." },
  { name: "Screen Size", url: "/screen-size-calculator", description: "Display size." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage math." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Game Streaming Calculator" keywords="streaming bitrate, obs settings, twitch bitrate, upload speed streaming, game streaming quality, encoding settings" breadcrumbs={[{ name: "Game Streaming", url: "/game-streaming-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Game Streaming Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Find the optimal streaming settings for your setup and internet connection.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Stream Resolution</label>
          <select class="st-in w-full px-4 py-2 border border-border rounded-lg" id="st-res">
            <option value="480">480p (854x480)</option>
            <option value="720">720p (1280x720)</option>
            <option value="1080" selected>1080p (1920x1080)</option>
            <option value="1440">1440p (2560x1440)</option>
            <option value="2160">4K (3840x2160)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Frame Rate (FPS)</label>
          <select class="st-in w-full px-4 py-2 border border-border rounded-lg" id="st-fps">
            <option value="30">30 FPS</option>
            <option value="60" selected>60 FPS</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Content Type</label>
          <select class="st-in w-full px-4 py-2 border border-border rounded-lg" id="st-type">
            <option value="0.8">Low Motion (card games, strategy)</option>
            <option value="1.0" selected>Medium Motion (RPG, MOBA)</option>
            <option value="1.2">High Motion (FPS, racing)</option>
            <option value="1.4">Very High Motion (fast-paced FPS)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Encoder</label>
          <select class="st-in w-full px-4 py-2 border border-border rounded-lg" id="st-enc">
            <option value="1.0" selected>NVENC (GPU - NVIDIA)</option>
            <option value="0.95">AMF (GPU - AMD)</option>
            <option value="0.85">x264 Medium (CPU)</option>
            <option value="0.75">x264 Slow (CPU - Best Quality)</option>
            <option value="1.1">QuickSync (Intel)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Platform</label>
          <select class="st-in w-full px-4 py-2 border border-border rounded-lg" id="st-platform">
            <option value="6000" selected>Twitch (max 6000 kbps)</option>
            <option value="51000">YouTube (max 51000 kbps)</option>
            <option value="6000">Kick (max 6000 kbps)</option>
            <option value="99999">Custom / No limit</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Your Upload Speed (Mbps)</label>
          <input type="number" class="st-in w-full px-4 py-2 border border-border rounded-lg" id="st-upload" min="0.5" step="0.5" value="20">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Audio Bitrate (kbps)</label>
          <select class="st-in w-full px-4 py-2 border border-border rounded-lg" id="st-audio">
            <option value="96">96 kbps (Basic)</option>
            <option value="128">128 kbps (Standard)</option>
            <option value="160" selected>160 kbps (Good)</option>
            <option value="320">320 kbps (High Quality)</option>
          </select>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Recommended Video Bitrate</div>
          <div class="text-5xl font-extrabold font-mono" id="st-result">--</div>
          <div class="text-sm text-blue-200 mt-1">kbps</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Upload Speed Needed</div>
            <div class="text-xl font-bold font-mono" id="st-uploadneed">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Bitrate</div>
            <div class="text-xl font-bold font-mono" id="st-totalbr">--</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Data per Hour</div>
            <div class="text-xl font-bold font-mono" id="st-datahr">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Upload Headroom</div>
            <div class="text-xl font-bold font-mono" id="st-headroom">--</div>
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Quality Presets</h3>
          <div class="text-xs font-mono space-y-1" id="st-presets"></div>
        </div>
      </div>
      <ShareButton calculatorId="game-streaming" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcST() {
      const res = parseInt((document.getElementById('st-res') as HTMLSelectElement).value);
      const fps = parseInt((document.getElementById('st-fps') as HTMLSelectElement).value);
      const motionFactor = parseFloat((document.getElementById('st-type') as HTMLSelectElement).value);
      const encoderFactor = parseFloat((document.getElementById('st-enc') as HTMLSelectElement).value);
      const platformMax = parseInt((document.getElementById('st-platform') as HTMLSelectElement).value);
      const upload = parseFloat((document.getElementById('st-upload') as HTMLInputElement).value) || 20;
      const audio = parseInt((document.getElementById('st-audio') as HTMLSelectElement).value);

      // Base bitrate recommendations per resolution at 30fps
      const baseBitrates: Record<number, number> = {
        480: 1500,
        720: 3000,
        1080: 4500,
        1440: 9000,
        2160: 20000
      };

      let recBitrate = (baseBitrates[res] || 4500);
      // Scale by fps
      recBitrate *= (fps / 30) * 0.7 + 0.3; // not linear, 60fps ~ 1.7x
      // Motion factor
      recBitrate *= motionFactor;
      // Encoder efficiency (lower = better quality per bitrate)
      recBitrate *= encoderFactor;

      recBitrate = Math.round(recBitrate);

      // Cap to platform max
      const cappedBitrate = Math.min(recBitrate, platformMax);

      // Cap to upload speed (use 75% of upload for stream)
      const uploadKbps = upload * 1000;
      const maxFromUpload = Math.floor(uploadKbps * 0.75) - audio;
      const finalBitrate = Math.min(cappedBitrate, Math.max(maxFromUpload, 500));

      const totalBitrate = finalBitrate + audio;
      const uploadNeeded = (totalBitrate / 1000) / 0.75;
      const dataPerHourGB = (totalBitrate / 8 * 3600) / (1024 * 1024);
      const headroom = ((uploadKbps - totalBitrate) / uploadKbps * 100);

      document.getElementById('st-result')!.textContent = finalBitrate.toLocaleString();
      document.getElementById('st-uploadneed')!.textContent = uploadNeeded.toFixed(1) + ' Mbps';
      document.getElementById('st-totalbr')!.textContent = totalBitrate.toLocaleString() + ' kbps';
      document.getElementById('st-datahr')!.textContent = dataPerHourGB.toFixed(2) + ' GB';
      document.getElementById('st-headroom')!.textContent = headroom.toFixed(0) + '%';

      // Quality presets
      const presets = [
        { name: '720p30 (Basic)', res: 720, fps: 30 },
        { name: '720p60 (Standard)', res: 720, fps: 60 },
        { name: '1080p30 (Good)', res: 1080, fps: 30 },
        { name: '1080p60 (Great)', res: 1080, fps: 60 },
        { name: '1440p60 (Premium)', res: 1440, fps: 60 },
        { name: '4K60 (Ultra)', res: 2160, fps: 60 }
      ];
      let html = '';
      for (const p of presets) {
        let br = (baseBitrates[p.res] || 4500) * ((p.fps / 30) * 0.7 + 0.3) * motionFactor * encoderFactor;
        br = Math.round(Math.min(br, platformMax));
        const uploadNeed = ((br + audio) / 1000) / 0.75;
        const feasible = uploadNeed <= upload ? 'OK' : 'Need ' + uploadNeed.toFixed(0) + ' Mbps';
        const marker = p.res === res && p.fps === fps ? ' <-' : '';
        html += '<div class="flex justify-between py-0.5 border-b border-border"><span>' + p.name + '</span><span>' + br.toLocaleString() + ' kbps (' + feasible + ')' + marker + '</span></div>';
      }
      document.getElementById('st-presets')!.innerHTML = html;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.st-in').forEach(el => { el.addEventListener('input', calcST); el.addEventListener('change', calcST); });
      calcST();
    }, 50);
  </script>
</CalculatorLayout>
