---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Soil Test Calculator - NPK & Lime Recommendations";
const description = "Get fertilizer recommendations from NPK soil test values. Calculate lime needed from pH and application rates per acre.";
const relatedCalcs = [
  { name: "Fertilizer Calculator", url: "/fertilizer-calculator", description: "Fertilizer application rates." },
  { name: "Soil Composition", url: "/soil-composition-calculator", description: "Soil texture analysis." },
  { name: "Compost Calculator", url: "/compost-calculator", description: "Composting needs and ratios." },
  { name: "Seed Calculator", url: "/seed-calculator", description: "Seed quantities for planting." },
  { name: "Garden Spacing", url: "/garden-spacing-calculator", description: "Plant spacing for gardens." },
  { name: "Irrigation Calculator", url: "/irrigation-calculator", description: "Irrigation water needs." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Soil Test Calculator" keywords="soil test calculator, NPK recommendation, lime rate, fertilizer from soil test, pH correction" breadcrumbs={[{ name: "Soil Test", url: "/soil-test-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Soil Test Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Convert soil test results into actionable fertilizer and lime recommendations.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-text mb-1">Crop / Use</label>
          <select id="st2-crop" class="st2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
            <option value="150|40|120|6.5">Corn (N:150, P:40, K:120, pH 6.5)</option>
            <option value="0|40|120|6.5">Soybeans (N:0, P:40, K:120, pH 6.5)</option>
            <option value="120|30|60|6.3">Wheat (N:120, P:30, K:60, pH 6.3)</option>
            <option value="50|50|100|6.5">Vegetables (N:50, P:50, K:100, pH 6.5)</option>
            <option value="150|30|150|6.0">Grass/Pasture (N:150, P:30, K:150, pH 6.0)</option>
            <option value="80|40|80|6.5" selected>General Garden (N:80, P:40, K:80, pH 6.5)</option>
          </select>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Soil N (ppm)</label>
            <input type="number" id="st2-n" class="st2-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold" value="20" min="0" max="200" step="1">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Soil P (ppm)</label>
            <input type="number" id="st2-p" class="st2-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold" value="15" min="0" max="200" step="1">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Soil K (ppm)</label>
            <input type="number" id="st2-k" class="st2-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold" value="120" min="0" max="500" step="1">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Soil pH</label>
            <input type="number" id="st2-ph" class="st2-in w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold" value="5.8" min="3.5" max="9.0" step="0.1">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Field Area (acres)</label>
            <input type="number" id="st2-area" class="st2-in w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold" value="2" min="0.1" max="10000" step="0.1">
          </div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Nitrogen Needed (lbs/acre)</div>
          <div class="text-5xl font-extrabold font-mono" id="st2-nrec">--</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">P2O5 Needed (lbs/ac)</div>
            <div class="text-xl font-bold font-mono" id="st2-prec">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">K2O Needed (lbs/ac)</div>
            <div class="text-xl font-bold font-mono" id="st2-krec">--</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Lime Needed (tons/ac)</div>
            <div class="text-xl font-bold font-mono" id="st2-lime">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Lime (tons)</div>
            <div class="text-xl font-bold font-mono" id="st2-tlime">--</div>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total N (lbs)</div>
            <div class="text-xl font-bold font-mono" id="st2-tn">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total P2O5 (lbs)</div>
            <div class="text-xl font-bold font-mono" id="st2-tp">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total K2O (lbs)</div>
            <div class="text-xl font-bold font-mono" id="st2-tk">--</div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="soil-test" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcST2() {
      const cropData = (document.getElementById('st2-crop') as HTMLSelectElement).value.split('|');
      const targetN = parseFloat(cropData[0]);
      const targetP = parseFloat(cropData[1]);
      const targetK = parseFloat(cropData[2]);
      const targetPH = parseFloat(cropData[3]);
      const soilN = parseFloat((document.getElementById('st2-n') as HTMLInputElement).value) || 0;
      const soilP = parseFloat((document.getElementById('st2-p') as HTMLInputElement).value) || 0;
      const soilK = parseFloat((document.getElementById('st2-k') as HTMLInputElement).value) || 0;
      const soilPH = parseFloat((document.getElementById('st2-ph') as HTMLInputElement).value) || 7.0;
      const area = parseFloat((document.getElementById('st2-area') as HTMLInputElement).value) || 1;
      const soilNlbs = soilN * 2;
      const nNeeded = Math.max(0, targetN - soilNlbs);
      const soilPlbs = soilP * 2 * 2.29;
      const pNeeded = Math.max(0, targetP - soilPlbs / 2.29 * 0.5) * 2.29;
      const soilKlbs = soilK * 2 * 1.2;
      const kNeeded = Math.max(0, targetK - soilKlbs / 1.2 * 0.5) * 1.2;
      let limePerAcre = 0;
      if (soilPH < targetPH) {
        const phDiff = targetPH - soilPH;
        limePerAcre = phDiff * 1.5;
      }
      document.getElementById('st2-nrec')!.textContent = Math.round(nNeeded) + ' lbs';
      document.getElementById('st2-prec')!.textContent = Math.round(pNeeded).toString();
      document.getElementById('st2-krec')!.textContent = Math.round(kNeeded).toString();
      document.getElementById('st2-lime')!.textContent = limePerAcre.toFixed(1);
      document.getElementById('st2-tlime')!.textContent = (limePerAcre * area).toFixed(1);
      document.getElementById('st2-tn')!.textContent = Math.round(nNeeded * area).toString();
      document.getElementById('st2-tp')!.textContent = Math.round(pNeeded * area).toString();
      document.getElementById('st2-tk')!.textContent = Math.round(kNeeded * area).toString();
      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.st2-in').forEach(el => { el.addEventListener('input', calcST2); el.addEventListener('change', calcST2); });
      calcST2();
    }, 50);
  </script>
</CalculatorLayout>
