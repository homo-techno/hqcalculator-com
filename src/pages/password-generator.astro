---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Password Generator - Secure Random Password Creator";
const description = "Generate strong, secure random passwords. Customize length, characters, and get password strength analysis with entropy calculation.";

const relatedCalcs = [
  { name: "Random Number", url: "/random-number-generator", description: "Random numbers." },
  { name: "Hex Calculator", url: "/hex-calculator", description: "Hexadecimal." },
  { name: "Binary Calculator", url: "/binary-calculator", description: "Binary math." },
  { name: "Probability Calculator", url: "/probability-calculator", description: "Probability." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Password Generator"
  keywords="password generator, random password, strong password, secure password, password strength, password creator"
  breadcrumbs={[{ name: "Password Generator", url: "/password-generator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Password Generator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Generate strong, secure passwords with customizable options.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <!-- Password display -->
      <div class="p-4 bg-gray-900 rounded-xl mb-4 relative">
        <div class="text-xl sm:text-2xl font-mono text-green-400 break-all pr-20" id="pg-password">Loading...</div>
        <button id="pg-copy" class="absolute right-3 top-1/2 -translate-y-1/2 px-3 py-2 bg-white/10 rounded-lg text-white text-sm font-semibold hover:bg-white/20">Copy</button>
      </div>

      <button id="pg-generate" class="w-full py-3 bg-primary text-white rounded-xl font-bold text-lg hover:bg-blue-700 mb-6">Generate New Password</button>

      <!-- Options -->
      <div class="space-y-4 mb-6">
        <div>
          <div class="flex justify-between mb-1">
            <label class="text-sm font-medium text-text">Length: <span id="pg-len-display" class="font-bold">16</span></label>
          </div>
          <input type="range" id="pg-length" class="w-full" min="4" max="64" value="16">
          <div class="flex justify-between text-xs text-text-muted"><span>4</span><span>64</span></div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <label class="flex items-center gap-2 p-3 bg-surface-alt rounded-xl cursor-pointer">
            <input type="checkbox" id="pg-upper" checked class="w-4 h-4">
            <span class="text-sm font-semibold">Uppercase (A-Z)</span>
          </label>
          <label class="flex items-center gap-2 p-3 bg-surface-alt rounded-xl cursor-pointer">
            <input type="checkbox" id="pg-lower" checked class="w-4 h-4">
            <span class="text-sm font-semibold">Lowercase (a-z)</span>
          </label>
          <label class="flex items-center gap-2 p-3 bg-surface-alt rounded-xl cursor-pointer">
            <input type="checkbox" id="pg-numbers" checked class="w-4 h-4">
            <span class="text-sm font-semibold">Numbers (0-9)</span>
          </label>
          <label class="flex items-center gap-2 p-3 bg-surface-alt rounded-xl cursor-pointer">
            <input type="checkbox" id="pg-symbols" checked class="w-4 h-4">
            <span class="text-sm font-semibold">Symbols (!@#$...)</span>
          </label>
        </div>

        <label class="flex items-center gap-2 p-3 bg-surface-alt rounded-xl cursor-pointer">
          <input type="checkbox" id="pg-ambiguous" class="w-4 h-4">
          <span class="text-sm font-semibold">Exclude ambiguous (0O, 1lI)</span>
        </label>
      </div>

      <!-- Strength -->
      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold text-sm text-text">Password Strength</h3>
          <span class="text-sm font-bold" id="pg-strength-label">Very Strong</span>
        </div>
        <div class="h-3 bg-white rounded-full overflow-hidden mb-3">
          <div id="pg-strength-bar" class="h-full rounded-full transition-all" style="width: 100%; background: #22c55e;"></div>
        </div>
        <div class="grid grid-cols-3 gap-3 text-center text-xs">
          <div><div class="text-text-muted">Entropy</div><div class="font-bold" id="pg-entropy">0 bits</div></div>
          <div><div class="text-text-muted">Charset Size</div><div class="font-bold" id="pg-charset">0</div></div>
          <div><div class="text-text-muted">Crack Time</div><div class="font-bold" id="pg-crack">â€”</div></div>
        </div>
      </div>

      <!-- Multiple passwords -->
      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h3 class="font-semibold text-sm text-text mb-2">Batch Generate</h3>
        <div class="flex gap-2 mb-3">
          <input type="number" id="pg-batch" class="flex-1 px-3 py-2 border border-border rounded-lg text-center" value="5" min="1" max="20">
          <button id="pg-batch-gen" class="px-4 py-2 border border-border rounded-lg text-sm font-semibold hover:bg-white">Generate</button>
        </div>
        <div class="space-y-1 text-sm font-mono" id="pg-batch-list"></div>
      </div>

      <ShareButton calculatorId="password" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Creating Strong Passwords</h2>
      <p>A strong password should be at least 12 characters long and include a mix of uppercase, lowercase, numbers, and symbols. This generator uses cryptographically secure randomness.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Password Strength Guide</h3>
      <ul>
        <li><strong>Weak (< 40 bits):</strong> Can be cracked in seconds to minutes</li>
        <li><strong>Fair (40-60 bits):</strong> Crackable in hours to days</li>
        <li><strong>Strong (60-80 bits):</strong> Would take years to crack</li>
        <li><strong>Very Strong (80+ bits):</strong> Practically uncrackable with current technology</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>Is this generator secure?</strong> Yes. It uses your browser's built-in crypto.getRandomValues() API. Passwords are generated entirely client-side and never sent to any server.</p>
      <p><strong>How long should my password be?</strong> At least 12-16 characters for most accounts. Use 20+ characters for critical accounts like email and banking.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const UPPER = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const LOWER = 'abcdefghijklmnopqrstuvwxyz';
    const NUMBERS = '0123456789';
    const SYMBOLS = '!@#$%^&*()_+-=[]{}|;:,.<>?';
    const AMBIGUOUS = '0O1lI';

    function getCharset(): string {
      let chars = '';
      if ((document.getElementById('pg-upper') as HTMLInputElement).checked) chars += UPPER;
      if ((document.getElementById('pg-lower') as HTMLInputElement).checked) chars += LOWER;
      if ((document.getElementById('pg-numbers') as HTMLInputElement).checked) chars += NUMBERS;
      if ((document.getElementById('pg-symbols') as HTMLInputElement).checked) chars += SYMBOLS;
      if ((document.getElementById('pg-ambiguous') as HTMLInputElement).checked) {
        chars = chars.split('').filter(c => !AMBIGUOUS.includes(c)).join('');
      }
      return chars || 'abcdefghijklmnopqrstuvwxyz';
    }

    function generate(): string {
      const chars = getCharset();
      const length = parseInt((document.getElementById('pg-length') as HTMLInputElement).value) || 16;
      const array = new Uint32Array(length);
      crypto.getRandomValues(array);
      return Array.from(array, v => chars[v % chars.length]).join('');
    }

    function updateStrength() {
      const chars = getCharset();
      const length = parseInt((document.getElementById('pg-length') as HTMLInputElement).value) || 16;
      const entropy = Math.log2(chars.length) * length;

      document.getElementById('pg-entropy')!.textContent = Math.round(entropy) + ' bits';
      document.getElementById('pg-charset')!.textContent = String(chars.length);

      let label: string, color: string, width: number;
      if (entropy >= 80) { label = 'Very Strong'; color = '#22c55e'; width = 100; }
      else if (entropy >= 60) { label = 'Strong'; color = '#3b82f6'; width = 75; }
      else if (entropy >= 40) { label = 'Fair'; color = '#eab308'; width = 50; }
      else { label = 'Weak'; color = '#ef4444'; width = 25; }

      document.getElementById('pg-strength-label')!.textContent = label;
      document.getElementById('pg-strength-label')!.style.color = color;
      const bar = document.getElementById('pg-strength-bar')!;
      bar.style.width = width + '%';
      bar.style.backgroundColor = color;

      // Crack time (10 billion guesses/sec)
      const combinations = Math.pow(chars.length, length);
      const seconds = combinations / 1e10 / 2;
      let crackTime: string;
      if (seconds < 1) crackTime = 'Instantly';
      else if (seconds < 60) crackTime = Math.round(seconds) + ' seconds';
      else if (seconds < 3600) crackTime = Math.round(seconds / 60) + ' minutes';
      else if (seconds < 86400) crackTime = Math.round(seconds / 3600) + ' hours';
      else if (seconds < 86400 * 365) crackTime = Math.round(seconds / 86400) + ' days';
      else if (seconds < 86400 * 365 * 1e6) crackTime = Math.round(seconds / (86400 * 365)) + ' years';
      else if (seconds < 86400 * 365 * 1e9) crackTime = (seconds / (86400 * 365 * 1e6)).toFixed(1) + 'M years';
      else crackTime = 'Centuries+';
      document.getElementById('pg-crack')!.textContent = crackTime;
    }

    function generateAndDisplay() {
      const pw = generate();
      document.getElementById('pg-password')!.textContent = pw;
      updateStrength();
    }

    setTimeout(() => {
      generateAndDisplay();

      document.getElementById('pg-generate')!.addEventListener('click', generateAndDisplay);
      document.getElementById('pg-length')!.addEventListener('input', () => {
        document.getElementById('pg-len-display')!.textContent = (document.getElementById('pg-length') as HTMLInputElement).value;
        generateAndDisplay();
      });
      ['pg-upper', 'pg-lower', 'pg-numbers', 'pg-symbols', 'pg-ambiguous'].forEach(id => {
        document.getElementById(id)!.addEventListener('change', generateAndDisplay);
      });

      document.getElementById('pg-copy')!.addEventListener('click', () => {
        const pw = document.getElementById('pg-password')!.textContent || '';
        navigator.clipboard.writeText(pw).then(() => {
          const btn = document.getElementById('pg-copy')!;
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = 'Copy', 1500);
        });
      });

      document.getElementById('pg-batch-gen')!.addEventListener('click', () => {
        const count = Math.min(20, parseInt((document.getElementById('pg-batch') as HTMLInputElement).value) || 5);
        const passwords = Array.from({ length: count }, () => generate());
        document.getElementById('pg-batch-list')!.innerHTML = passwords.map(pw =>
          `<div class="p-2 bg-white rounded text-xs break-all">${pw}</div>`
        ).join('');
      });
    }, 50);
  </script>
</CalculatorLayout>
