---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Drainage Calculator - Flow Rate, Pipe Size & French Drain Length";
const description = "Calculate drainage requirements using the Rational Method. Enter area, rainfall intensity, and runoff coefficient to get flow rate, pipe size, and French drain length.";

const relatedCalcs = [
  { name: "Septic Tank Calculator", url: "/septic-tank-calculator", description: "Septic system sizing." },
  { name: "Excavation Calculator", url: "/excavation-calculator", description: "Dig volume." },
  { name: "Patio Calculator", url: "/patio-calculator", description: "Patio material." },
  { name: "Foundation Calculator", url: "/foundation-calculator", description: "Foundation concrete." },
  { name: "Pool Cost Calculator", url: "/pool-cost-calculator", description: "Pool sizing." },
  { name: "Asphalt Calculator", url: "/asphalt-calculator", description: "Asphalt tonnage." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Drainage Calculator"
  keywords="drainage calculator, stormwater, runoff, rational method, French drain, pipe sizing, catch basin, flow rate"
  breadcrumbs={[{ name: "Drainage Calculator", url: "/drainage-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Drainage Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate stormwater flow rate, pipe sizing, and French drain requirements using the Rational Method.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <div class="grid grid-cols-2 gap-3 mb-5">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Drainage Area (sq ft)</label>
              <input type="number" id="dn-area" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="5000" min="100" step="100">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Area (acres)</label>
              <input type="number" id="dn-acres" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="0.115" min="0.01" step="0.01" readonly>
            </div>
          </div>

          <div class="mb-5">
            <label class="block text-xs font-medium text-text mb-1">Rainfall Intensity (inches/hour)</label>
            <select id="dn-rain" class="w-full px-3 py-3 border border-border rounded-xl text-lg">
              <option value="1">1 in/hr (light rain)</option>
              <option value="2" selected>2 in/hr (moderate)</option>
              <option value="3">3 in/hr (heavy)</option>
              <option value="4">4 in/hr (very heavy)</option>
              <option value="5">5 in/hr (extreme)</option>
              <option value="6">6 in/hr (tropical)</option>
            </select>
          </div>

          <div class="mb-5">
            <label class="block text-xs font-medium text-text mb-1">Surface / Runoff Coefficient (C)</label>
            <select id="dn-coeff" class="w-full px-3 py-3 border border-border rounded-xl text-lg">
              <option value="0.15">Lawn - sandy soil (0.15)</option>
              <option value="0.35" selected>Lawn - clay soil (0.35)</option>
              <option value="0.50">Gravel surface (0.50)</option>
              <option value="0.70">Residential - mixed (0.70)</option>
              <option value="0.85">Asphalt / Concrete (0.85)</option>
              <option value="0.95">Rooftop (0.95)</option>
            </select>
          </div>

          <div class="p-4 bg-surface-alt rounded-xl">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Pipe Slope (%)</label>
              <input type="number" id="dn-slope" class="w-full px-3 py-2 border border-border rounded-lg" value="1.0" min="0.25" max="5" step="0.25">
              <div class="text-xs text-text-muted mt-1">Minimum 0.5% for drainage pipes</div>
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Peak Flow Rate</div>
            <div class="text-5xl font-extrabold font-mono" id="dn-flowcfs">0</div>
            <div class="text-sm text-blue-200 mt-1">cubic feet per second (CFS)</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Flow (GPM)</div>
              <div class="text-xl font-bold" id="dn-flowgpm">0</div>
              <div class="text-xs text-text-muted">gallons per minute</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Pipe Size Needed</div>
              <div class="text-xl font-bold" id="dn-pipesize">--</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Catch Basins</div>
              <div class="text-xl font-bold" id="dn-basins">0</div>
              <div class="text-xs text-text-muted">recommended</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">French Drain Length</div>
              <div class="text-xl font-bold" id="dn-frenchlength">0 ft</div>
            </div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Runoff Volume (1 hr storm)</div>
            <div class="text-xl font-bold" id="dn-volume">0 gallons</div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="drainage" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How to Calculate Drainage (Rational Method)</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Rational Method:</strong> Q = C x I x A</p>
        <p>Q = Peak flow rate (CFS)</p>
        <p>C = Runoff coefficient (0 to 1)</p>
        <p>I = Rainfall intensity (in/hr)</p>
        <p>A = Drainage area (acres)</p>
      </div>

      <h3 class="text-xl font-semibold text-text mt-8">Runoff Coefficients</h3>
      <ul>
        <li><strong>Lawns (sandy):</strong> 0.10-0.20</li>
        <li><strong>Lawns (clay):</strong> 0.25-0.40</li>
        <li><strong>Gravel:</strong> 0.40-0.60</li>
        <li><strong>Residential (mixed):</strong> 0.60-0.80</li>
        <li><strong>Pavement/Roof:</strong> 0.85-0.95</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">French Drain Sizing</h3>
      <ul>
        <li><strong>Residential:</strong> 4" perforated pipe in 12" wide trench</li>
        <li><strong>Medium loads:</strong> 6" pipe in 18" wide trench</li>
        <li><strong>Length:</strong> Typically 1 ft per 5-10 GPM capacity needed</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcDrainage() {
      const areaSqFt = parseFloat((document.getElementById('dn-area') as HTMLInputElement).value) || 0;
      const rainIntensity = parseFloat((document.getElementById('dn-rain') as HTMLSelectElement).value) || 2;
      const coeff = parseFloat((document.getElementById('dn-coeff') as HTMLSelectElement).value) || 0.35;
      const slope = parseFloat((document.getElementById('dn-slope') as HTMLInputElement).value) || 1.0;

      // Convert sq ft to acres
      const acres = areaSqFt / 43560;
      (document.getElementById('dn-acres') as HTMLInputElement).value = acres.toFixed(3);

      // Rational Method: Q = C * I * A (CFS when A in acres, I in in/hr)
      const flowCFS = coeff * rainIntensity * acres;
      const flowGPM = flowCFS * 448.831; // 1 CFS = 448.831 GPM

      // Pipe sizing using Manning's equation approximation for smooth pipe
      // For a given flow and slope, find minimum pipe diameter
      // Q = (1.486/n) * A * R^(2/3) * S^(1/2), n=0.012 for smooth PVC
      // For a full pipe: A = pi*D^2/4, R = D/4
      // Simplified: D = (Q*n / (0.463 * S^0.5))^0.375 * 12 (inches)
      const n = 0.012;
      const S = slope / 100;
      let pipeDiaCalc = 0;
      if (flowCFS > 0 && S > 0) {
        pipeDiaCalc = Math.pow((flowCFS * n) / (0.463 * Math.sqrt(S)), 0.375) * 12;
      }

      // Round up to standard pipe sizes
      let pipeSize = '4"';
      if (pipeDiaCalc > 4) pipeSize = '6"';
      if (pipeDiaCalc > 6) pipeSize = '8"';
      if (pipeDiaCalc > 8) pipeSize = '10"';
      if (pipeDiaCalc > 10) pipeSize = '12"';
      if (pipeDiaCalc > 12) pipeSize = '15"';
      if (pipeDiaCalc > 15) pipeSize = '18"';
      if (pipeDiaCalc > 18) pipeSize = '24"+';

      // Catch basins: 1 per ~2500 sq ft of impervious area or ~5000 sq ft total
      const basins = Math.max(1, Math.ceil(areaSqFt / 5000));

      // French drain length: ~1 linear foot per 5 GPM capacity
      // 4" French drain handles ~5-8 GPM per linear foot in good soil
      const frenchDrainFt = Math.ceil(flowGPM / 6);

      // Total runoff volume for 1 hour storm
      const volumeCuFt = flowCFS * 3600; // 1 hour in seconds
      const volumeGal = volumeCuFt * 7.48;

      document.getElementById('dn-flowcfs')!.textContent = flowCFS.toFixed(3);
      document.getElementById('dn-flowgpm')!.textContent = flowGPM.toFixed(1);
      document.getElementById('dn-pipesize')!.textContent = pipeSize + ' diameter';
      document.getElementById('dn-basins')!.textContent = String(basins);
      document.getElementById('dn-frenchlength')!.textContent = frenchDrainFt + ' ft';
      document.getElementById('dn-volume')!.textContent = Math.round(volumeGal).toLocaleString() + ' gallons';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('#dn-area, #dn-slope').forEach(el => {
        el.addEventListener('input', calcDrainage);
        el.addEventListener('change', calcDrainage);
      });
      document.querySelectorAll('#dn-rain, #dn-coeff').forEach(el => {
        el.addEventListener('input', calcDrainage);
        el.addEventListener('change', calcDrainage);
      });
      calcDrainage();
    }, 50);
  </script>
</CalculatorLayout>
