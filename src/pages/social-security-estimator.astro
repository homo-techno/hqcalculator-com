---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Social Security Estimator - Monthly Benefit by Claiming Age";
const description = "Estimate your Social Security benefit based on average indexed monthly earnings and claiming age (62, 67, or 70).";

const relatedCalcs = [
  { name: "Retirement Calculator", url: "/retirement-calculator", description: "Retirement planning." },
  { name: "Pension Calculator", url: "/pension-calculator", description: "Pension benefits." },
  { name: "401k Calculator", url: "/401k-calculator", description: "401k growth." },
  { name: "Financial Independence", url: "/financial-independence-calculator", description: "FIRE planning." },
  { name: "Investment Calculator", url: "/investment-calculator", description: "Investment returns." },
  { name: "Annuity Calculator", url: "/annuity-calculator", description: "Annuity payments." },
];
---

<CalculatorLayout title={title} description={description} calculatorName="Social Security Estimator" keywords="social security estimator, social security benefit, claiming age, AIME, retirement benefit, breakeven age" breadcrumbs={[{ name: "Social Security Estimator", url: "/social-security-estimator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Social Security Estimator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate your Social Security benefit at different claiming ages and find the breakeven point.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Average Indexed Monthly Earnings (AIME)</label>
            <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span>
              <input type="number" id="ss2-aime" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="6000" min="0" step="100">
            </div>
            <p class="text-xs text-text-muted mt-1">Your average monthly income over your 35 highest-earning years (indexed for inflation)</p>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Planned Claiming Age</label>
            <select id="ss2-claim-age" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="62">62 (earliest, reduced benefit)</option>
              <option value="63">63</option>
              <option value="64">64</option>
              <option value="65">65</option>
              <option value="66">66</option>
              <option value="67" selected>67 (full retirement age)</option>
              <option value="68">68</option>
              <option value="69">69</option>
              <option value="70">70 (maximum benefit)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Current Age</label>
            <input type="number" id="ss2-current-age" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="55" min="30" max="70" step="1">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Life Expectancy</label>
            <input type="number" id="ss2-life" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="85" min="62" max="100" step="1">
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Estimated Monthly Benefit</div>
            <div class="text-5xl font-extrabold font-mono" id="ss2-monthly">$0</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Annual Benefit</div>
              <div class="text-xl font-bold text-secondary" id="ss2-annual">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Lifetime Total</div>
              <div class="text-xl font-bold" id="ss2-lifetime">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">At Age 62</div>
              <div class="text-xl font-bold text-orange-600" id="ss2-at62">$0/mo</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">At Age 70</div>
              <div class="text-xl font-bold text-green-600" id="ss2-at70">$0/mo</div>
            </div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Breakeven: 62 vs 70</div>
            <div class="text-xl font-bold" id="ss2-breakeven">Age --</div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="social-security-estimator" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Social Security Benefits Are Calculated</h2>
      <p>Your Primary Insurance Amount (PIA) is calculated using a progressive formula applied to your AIME. Claiming at 62 reduces your benefit by about 30%, while delaying to 70 increases it by about 24% above the full retirement age benefit (through delayed retirement credits of 8% per year).</p>
      <h3 class="text-xl font-semibold text-text mt-8">When to Claim</h3>
      <p>If you expect to live past your mid-80s, delaying to 70 typically provides more lifetime income. If you have health concerns or need income immediately, claiming earlier may make sense. The breakeven age between 62 and 70 is typically around age 80-82.</p>
    </article>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString();

    function calcPIA(aime: number): number {
      // 2024 bend points
      const bp1 = 1174;
      const bp2 = 7078;
      let pia = 0;
      if (aime <= bp1) {
        pia = aime * 0.90;
      } else if (aime <= bp2) {
        pia = bp1 * 0.90 + (aime - bp1) * 0.32;
      } else {
        pia = bp1 * 0.90 + (bp2 - bp1) * 0.32 + (aime - bp2) * 0.15;
      }
      return pia;
    }

    function adjustForAge(pia: number, claimAge: number): number {
      const fra = 67;
      if (claimAge < fra) {
        const monthsEarly = (fra - claimAge) * 12;
        // First 36 months: 5/9% per month; additional months: 5/12% per month
        let reduction = 0;
        if (monthsEarly <= 36) {
          reduction = monthsEarly * (5 / 900);
        } else {
          reduction = 36 * (5 / 900) + (monthsEarly - 36) * (5 / 1200);
        }
        return pia * (1 - reduction);
      } else if (claimAge > fra) {
        const monthsLate = (claimAge - fra) * 12;
        const increase = monthsLate * (8 / 1200); // 8% per year = 2/3% per month
        return pia * (1 + increase);
      }
      return pia;
    }

    function calcSS2() {
      const aime = parseFloat((document.getElementById('ss2-aime') as HTMLInputElement).value) || 0;
      const claimAge = parseInt((document.getElementById('ss2-claim-age') as HTMLSelectElement).value) || 67;
      const currentAge = parseInt((document.getElementById('ss2-current-age') as HTMLInputElement).value) || 55;
      const lifeExpectancy = parseInt((document.getElementById('ss2-life') as HTMLInputElement).value) || 85;

      const pia = calcPIA(aime);
      const monthlyBenefit = adjustForAge(pia, claimAge);
      const annualBenefit = monthlyBenefit * 12;
      const yearsCollecting = Math.max(0, lifeExpectancy - claimAge);
      const lifetimeTotal = annualBenefit * yearsCollecting;

      const at62 = adjustForAge(pia, 62);
      const at70 = adjustForAge(pia, 70);

      // Breakeven: cumulative at 62 vs cumulative at 70
      let breakeven = 70;
      let cum62 = 0;
      let cum70 = 0;
      for (let age = 62; age <= 100; age++) {
        if (age >= 62) cum62 += at62 * 12;
        if (age >= 70) cum70 += at70 * 12;
        if (cum70 > cum62 && age >= 70) {
          breakeven = age;
          break;
        }
      }

      document.getElementById('ss2-monthly')!.textContent = fmt(monthlyBenefit);
      document.getElementById('ss2-annual')!.textContent = fmt(annualBenefit);
      document.getElementById('ss2-lifetime')!.textContent = fmt(lifetimeTotal);
      document.getElementById('ss2-at62')!.textContent = fmt(at62) + '/mo';
      document.getElementById('ss2-at70')!.textContent = fmt(at70) + '/mo';
      document.getElementById('ss2-breakeven')!.textContent = 'Age ' + breakeven;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      ['ss2-aime', 'ss2-current-age', 'ss2-life'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.addEventListener('input', calcSS2); el.addEventListener('change', calcSS2); }
      });
      document.getElementById('ss2-claim-age')!.addEventListener('change', calcSS2);
      calcSS2();
    }, 50);
  </script>
</CalculatorLayout>
