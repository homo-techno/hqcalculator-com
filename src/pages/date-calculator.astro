---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Date Calculator - Days Between Dates, Add/Subtract Days";
const description = "Free date calculator. Find the number of days between two dates, or add/subtract days from a date. Business days, weekdays, and calendar date math.";

const relatedCalcs = [
  { name: "Age Calculator", url: "/age-calculator", description: "Calculate your exact age." },
  { name: "Time Calculator", url: "/time-calculator", description: "Add & subtract time." },
  { name: "Hours Calculator", url: "/hours-calculator", description: "Hours between times." },
  { name: "Day Counter", url: "/day-counter", description: "Count days from a date." },
  { name: "Pregnancy Calculator", url: "/pregnancy-calculator", description: "Due date calculator." },
  { name: "Time Zone Converter", url: "/time-zone-converter", description: "Convert time zones." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Date Calculator"
  keywords="date calculator, days between dates, add days to date, date difference, business days calculator, date math"
  breadcrumbs={[{ name: "Date Calculator", url: "/date-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Date Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Find the difference between dates or add/subtract days, weeks, months, or years from a date.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <!-- Mode Tabs -->
      <div class="flex gap-2 mb-8">
        <button class="date-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-primary text-white" data-mode="diff">Days Between Dates</button>
        <button class="date-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-surface-alt text-text-secondary" data-mode="add">Add/Subtract Days</button>
      </div>

      <!-- Mode 1: Date Difference -->
      <div id="date-diff-mode">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Start Date</label>
            <input type="date" id="date-start" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">End Date</label>
            <input type="date" id="date-end" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
          </div>
        </div>

        <!-- Result -->
        <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Difference</div>
          <div class="text-4xl sm:text-5xl font-extrabold" id="date-diff-days">0 days</div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Years, Months, Days</div>
            <div class="text-lg font-bold" id="date-diff-ymd">0y 0m 0d</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Weeks</div>
            <div class="text-lg font-bold" id="date-diff-weeks">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Business Days</div>
            <div class="text-lg font-bold" id="date-diff-business">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Hours</div>
            <div class="text-lg font-bold" id="date-diff-hours">0</div>
          </div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="p-3 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Minutes</div>
            <div class="text-lg font-bold" id="date-diff-minutes">0</div>
          </div>
          <div class="p-3 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Seconds</div>
            <div class="text-lg font-bold" id="date-diff-seconds">0</div>
          </div>
          <div class="p-3 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Weekends</div>
            <div class="text-lg font-bold" id="date-diff-weekends">0</div>
          </div>
          <div class="p-3 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Months</div>
            <div class="text-lg font-bold" id="date-diff-months">0</div>
          </div>
        </div>
      </div>

      <!-- Mode 2: Add/Subtract -->
      <div id="date-add-mode" class="hidden">
        <div class="mb-6">
          <label class="block text-sm font-medium text-text mb-1">Start Date</label>
          <input type="date" id="date-add-start" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
        </div>

        <div class="mb-6">
          <div class="flex gap-2 mb-3">
            <button class="date-addop-btn px-4 py-2 rounded-lg text-sm font-semibold bg-primary text-white" data-op="add">Add (+)</button>
            <button class="date-addop-btn px-4 py-2 rounded-lg text-sm font-semibold bg-surface-alt text-text-secondary" data-op="sub">Subtract (−)</button>
          </div>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div>
              <label class="text-xs text-text-muted">Years</label>
              <input type="number" id="date-add-years" class="w-full px-3 py-2 border border-border rounded-lg text-center" value="0" min="0">
            </div>
            <div>
              <label class="text-xs text-text-muted">Months</label>
              <input type="number" id="date-add-months" class="w-full px-3 py-2 border border-border rounded-lg text-center" value="0" min="0">
            </div>
            <div>
              <label class="text-xs text-text-muted">Weeks</label>
              <input type="number" id="date-add-weeks" class="w-full px-3 py-2 border border-border rounded-lg text-center" value="0" min="0">
            </div>
            <div>
              <label class="text-xs text-text-muted">Days</label>
              <input type="number" id="date-add-days" class="w-full px-3 py-2 border border-border rounded-lg text-center" value="30" min="0">
            </div>
          </div>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Result Date</div>
          <div class="text-3xl sm:text-4xl font-extrabold" id="date-add-result">—</div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div class="p-3 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Day of Week</div>
            <div class="text-lg font-bold" id="date-add-dow">—</div>
          </div>
          <div class="p-3 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Week Number</div>
            <div class="text-lg font-bold" id="date-add-weeknum">—</div>
          </div>
          <div class="p-3 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Day of Year</div>
            <div class="text-lg font-bold" id="date-add-doy">—</div>
          </div>
        </div>
      </div>

      <div class="mt-6">
        <ShareButton calculatorId="date" />
        <FeedbackWidget />
      </div>
    </div>

    <!-- Quick Reference -->
    <div class="mt-12 bg-white border border-border rounded-2xl p-6 sm:p-8">
      <h2 class="text-2xl font-bold text-text mb-4">Quick Date Reference</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3" id="date-quick-ref"></div>
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Date Calculations Work</h2>
      <p>Date calculations help you find the difference between two dates or determine a future/past date by adding or subtracting time units. Our calculator handles months with different lengths, leap years, and business day calculations automatically.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Business Days vs. Calendar Days</h3>
      <p>Business days (also called working days or weekdays) exclude Saturdays and Sundays. This calculator counts business days between two dates. For example, one calendar week has 7 calendar days but only 5 business days.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Leap Years</h3>
      <p>A leap year occurs every 4 years (with exceptions for century years not divisible by 400). Leap years have 366 days instead of 365, with February having 29 days. This calculator automatically accounts for leap years.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Common Date Calculations</h3>
      <ul>
        <li><strong>90 days from today:</strong> Often used for project deadlines and financial quarters</li>
        <li><strong>30/60/90 day periods:</strong> Standard business intervals</li>
        <li><strong>180 days:</strong> Half a year, used for many legal and financial deadlines</li>
        <li><strong>365 days:</strong> One full year from any date</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>Does this include the start date?</strong> No — the day count starts from the day after the start date. For example, January 1 to January 2 = 1 day.</p>
      <p><strong>How are business days calculated?</strong> Business days exclude Saturdays and Sundays. Public holidays are not excluded as they vary by country and region.</p>
      <p><strong>How does adding months work?</strong> Adding 1 month to January 31 gives February 28 (or 29 in a leap year), since February doesn't have 31 days.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let dateMode = 'diff';
    let addOp = 'add';

    function formatDateLong(d: Date): string {
      return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    }

    function getBusinessDays(start: Date, end: Date): number {
      let count = 0;
      const d = new Date(start);
      while (d < end) {
        d.setDate(d.getDate() + 1);
        const dow = d.getDay();
        if (dow !== 0 && dow !== 6) count++;
      }
      return count;
    }

    function getWeekendDays(start: Date, end: Date): number {
      let count = 0;
      const d = new Date(start);
      while (d < end) {
        d.setDate(d.getDate() + 1);
        const dow = d.getDay();
        if (dow === 0 || dow === 6) count++;
      }
      return count;
    }

    function getWeekNumber(d: Date): number {
      const oneJan = new Date(d.getFullYear(), 0, 1);
      const days = Math.floor((d.getTime() - oneJan.getTime()) / 86400000);
      return Math.ceil((days + oneJan.getDay() + 1) / 7);
    }

    function getDayOfYear(d: Date): number {
      const start = new Date(d.getFullYear(), 0, 0);
      return Math.floor((d.getTime() - start.getTime()) / 86400000);
    }

    function dateDiff(start: Date, end: Date): { years: number; months: number; days: number } {
      let years = end.getFullYear() - start.getFullYear();
      let months = end.getMonth() - start.getMonth();
      let days = end.getDate() - start.getDate();
      if (days < 0) {
        months--;
        const prevMonth = new Date(end.getFullYear(), end.getMonth(), 0);
        days += prevMonth.getDate();
      }
      if (months < 0) {
        years--;
        months += 12;
      }
      return { years, months, days };
    }

    function calcDateDiff() {
      const startStr = (document.getElementById('date-start') as HTMLInputElement).value;
      const endStr = (document.getElementById('date-end') as HTMLInputElement).value;
      if (!startStr || !endStr) return;

      const start = new Date(startStr + 'T00:00:00');
      const end = new Date(endStr + 'T00:00:00');
      const diffMs = Math.abs(end.getTime() - start.getTime());
      const totalDays = Math.round(diffMs / 86400000);

      const earlier = start < end ? start : end;
      const later = start < end ? end : start;
      const ymd = dateDiff(earlier, later);

      document.getElementById('date-diff-days')!.textContent = totalDays.toLocaleString() + ' days';
      document.getElementById('date-diff-ymd')!.textContent = `${ymd.years}y ${ymd.months}m ${ymd.days}d`;
      document.getElementById('date-diff-weeks')!.textContent = (totalDays / 7).toFixed(1);
      document.getElementById('date-diff-business')!.textContent = getBusinessDays(earlier, later).toLocaleString();
      document.getElementById('date-diff-hours')!.textContent = (totalDays * 24).toLocaleString();
      document.getElementById('date-diff-minutes')!.textContent = (totalDays * 1440).toLocaleString();
      document.getElementById('date-diff-seconds')!.textContent = (totalDays * 86400).toLocaleString();
      document.getElementById('date-diff-weekends')!.textContent = getWeekendDays(earlier, later).toLocaleString();

      const totalMonths = ymd.years * 12 + ymd.months;
      document.getElementById('date-diff-months')!.textContent = String(totalMonths);

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    function calcDateAdd() {
      const startStr = (document.getElementById('date-add-start') as HTMLInputElement).value;
      if (!startStr) return;

      const start = new Date(startStr + 'T00:00:00');
      const years = parseInt((document.getElementById('date-add-years') as HTMLInputElement).value) || 0;
      const months = parseInt((document.getElementById('date-add-months') as HTMLInputElement).value) || 0;
      const weeks = parseInt((document.getElementById('date-add-weeks') as HTMLInputElement).value) || 0;
      const days = parseInt((document.getElementById('date-add-days') as HTMLInputElement).value) || 0;

      const sign = addOp === 'add' ? 1 : -1;
      const result = new Date(start);
      result.setFullYear(result.getFullYear() + sign * years);
      result.setMonth(result.getMonth() + sign * months);
      result.setDate(result.getDate() + sign * (weeks * 7 + days));

      document.getElementById('date-add-result')!.textContent = formatDateLong(result);
      document.getElementById('date-add-dow')!.textContent = result.toLocaleDateString('en-US', { weekday: 'long' });
      document.getElementById('date-add-weeknum')!.textContent = 'Week ' + getWeekNumber(result);
      document.getElementById('date-add-doy')!.textContent = 'Day ' + getDayOfYear(result);

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    function buildQuickRef() {
      const today = new Date();
      const items = [
        { label: '30 days from now', days: 30 },
        { label: '60 days from now', days: 60 },
        { label: '90 days from now', days: 90 },
        { label: '180 days from now', days: 180 },
        { label: '365 days from now', days: 365 },
        { label: '30 days ago', days: -30 },
        { label: '90 days ago', days: -90 },
        { label: '1 year ago', days: -365 },
      ];
      const container = document.getElementById('date-quick-ref')!;
      container.innerHTML = items.map(item => {
        const d = new Date(today);
        d.setDate(d.getDate() + item.days);
        return `<div class="p-3 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted">${item.label}</div>
          <div class="font-bold text-sm">${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
        </div>`;
      }).join('');
    }

    setTimeout(() => {
      // Set defaults
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const thirtyAgo = new Date(today);
      thirtyAgo.setDate(thirtyAgo.getDate() - 30);

      (document.getElementById('date-start') as HTMLInputElement).value = thirtyAgo.toISOString().split('T')[0];
      (document.getElementById('date-end') as HTMLInputElement).value = todayStr;
      (document.getElementById('date-add-start') as HTMLInputElement).value = todayStr;

      // Mode toggle
      document.querySelectorAll('.date-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.date-mode-btn').forEach(b => {
            b.classList.remove('bg-primary', 'text-white');
            b.classList.add('bg-surface-alt', 'text-text-secondary');
          });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary');
          btn.classList.add('bg-primary', 'text-white');
          dateMode = (btn as HTMLElement).dataset.mode || 'diff';
          document.getElementById('date-diff-mode')!.classList.toggle('hidden', dateMode !== 'diff');
          document.getElementById('date-add-mode')!.classList.toggle('hidden', dateMode !== 'add');
        });
      });

      // Add/Subtract toggle
      document.querySelectorAll('.date-addop-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.date-addop-btn').forEach(b => {
            b.classList.remove('bg-primary', 'text-white');
            b.classList.add('bg-surface-alt', 'text-text-secondary');
          });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary');
          btn.classList.add('bg-primary', 'text-white');
          addOp = (btn as HTMLElement).dataset.op || 'add';
          calcDateAdd();
        });
      });

      // Events
      ['date-start', 'date-end'].forEach(id => {
        document.getElementById(id)!.addEventListener('change', calcDateDiff);
      });
      ['date-add-start'].forEach(id => {
        document.getElementById(id)!.addEventListener('change', calcDateAdd);
      });
      ['date-add-years', 'date-add-months', 'date-add-weeks', 'date-add-days'].forEach(id => {
        document.getElementById(id)!.addEventListener('input', calcDateAdd);
      });

      calcDateDiff();
      calcDateAdd();
      buildQuickRef();
    }, 50);
  </script>
</CalculatorLayout>
