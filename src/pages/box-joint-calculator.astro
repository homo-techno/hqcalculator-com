---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Box Joint Calculator - Finger Joint Layout & Fit Planner";
const description = "Calculate box joint (finger joint) layout including finger width, count, and jig setup. Plan perfect box joints for boxes, drawers, and cases.";

const relatedCalcs = [
  { name: "Dovetail Joint Calculator", url: "/dovetail-joint-calculator", description: "Dovetail layout." },
  { name: "Dado Joint Calculator", url: "/dado-joint-calculator", description: "Dado joint sizing." },
  { name: "Mortise & Tenon Calculator", url: "/mortise-tenon-calculator", description: "M&T joint sizing." },
  { name: "Saw Blade Calculator", url: "/saw-blade-calculator", description: "Saw blade specs." },
  { name: "Wood Glue Calculator", url: "/wood-glue-calculator", description: "Glue coverage." },
  { name: "Board Foot Calculator", url: "/board-foot-calculator", description: "Board feet calculator." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Box Joint Calculator"
  keywords="box joint calculator, finger joint, box joint jig, finger width, joint layout, box making, drawer joint"
  breadcrumbs={[{ name: "Box Joint Calculator", url: "/box-joint-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Box Joint Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Plan your box joint (finger joint) layout with precise dimensions and jig setup.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Board Width (inches)</label>
          <input type="number" id="bj2-width" class="bj2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="4" min="1" step="0.25">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Board Thickness (inches)</label>
          <input type="number" id="bj2-thick" class="bj2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.5" min="0.25" step="0.125">
        </div>
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Finger Width</label>
        <select id="bj2-fw" class="bj2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="0">Auto (match stock thickness)</option>
          <option value="0.125">1/8"</option>
          <option value="0.1875">3/16"</option>
          <option value="0.25">1/4"</option>
          <option value="0.3125">5/16"</option>
          <option value="0.375">3/8"</option>
          <option value="0.5">1/2"</option>
          <option value="0.75">3/4"</option>
        </select>
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Cutting Method</label>
        <select id="bj2-method" class="bj2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="dado" selected>Dado Blade on Table Saw</option>
          <option value="router">Router Table with Jig</option>
          <option value="scroll">Scroll Saw / Band Saw</option>
        </select>
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Number of Fingers (per board)</div>
        <div class="text-4xl font-extrabold" id="bj2-count">--</div>
        <div class="text-sm text-blue-200 mt-1" id="bj2-count-sub">--</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Finger Width</div>
          <div class="text-xl font-bold" id="bj2-fwd">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Finger Depth</div>
          <div class="text-xl font-bold" id="bj2-fd">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Total Slots (A piece)</div>
          <div class="text-xl font-bold" id="bj2-slots-a">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Total Slots (B piece)</div>
          <div class="text-xl font-bold" id="bj2-slots-b">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Glue Surface Area</div>
          <div class="text-xl font-bold" id="bj2-glue">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Jig Pin Offset</div>
          <div class="text-xl font-bold" id="bj2-offset">--</div>
        </div>
      </div>

      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h4 class="font-semibold text-sm text-text mb-1">Setup Notes</h4>
        <p class="text-sm text-text-secondary" id="bj2-notes">--</p>
      </div>

      <ShareButton calculatorId="box-joint" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Box Joint Design Guide</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Finger Width = typically matches stock thickness</strong></p>
        <p><strong>Finger Depth = mating board thickness</strong></p>
        <p><strong>Odd number of fingers preferred for symmetry</strong></p>
      </div>
      <h3 class="text-xl font-semibold text-text mt-8">Tips for Perfect Box Joints</h3>
      <ul>
        <li>Use a test cut on scrap wood to verify jig accuracy</li>
        <li>Fingers should require light tapping to assemble (snug fit)</li>
        <li>Sand fingers slightly for easier glue-up if too tight</li>
        <li>Apply glue to both surfaces of every finger for maximum strength</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcBJ2() {
      const boardWidth = parseFloat((document.getElementById('bj2-width') as HTMLInputElement).value) || 4;
      const boardThick = parseFloat((document.getElementById('bj2-thick') as HTMLInputElement).value) || 0.5;
      let fingerWidth = parseFloat((document.getElementById('bj2-fw') as HTMLSelectElement).value) || 0;
      const method = (document.getElementById('bj2-method') as HTMLSelectElement).value;

      // Auto finger width = stock thickness
      if (fingerWidth === 0) fingerWidth = boardThick;

      // Finger depth = mating board's thickness
      const fingerDepth = boardThick;

      // Number of fingers + slots across board width
      const totalUnits = Math.floor(boardWidth / fingerWidth);
      // Ensure odd number for symmetric layout (one board starts/ends with finger)
      const fingers = totalUnits % 2 === 0 ? totalUnits - 1 : totalUnits;

      // Piece A: starts with finger = (fingers+1)/2 fingers, (fingers-1)/2 slots
      const fingersA = Math.ceil(fingers / 2);
      const slotsA = Math.floor(fingers / 2);
      // Piece B: starts with slot = (fingers-1)/2 fingers, (fingers+1)/2 slots
      const fingersB = Math.floor(fingers / 2);
      const slotsB = Math.ceil(fingers / 2);

      // Remainder at top and bottom
      const usedWidth = fingers * fingerWidth;
      const remainder = boardWidth - usedWidth;

      // Glue surface area per corner (sides of all fingers)
      const glueSides = fingers * 2; // both sides of each finger
      const glueArea = glueSides * fingerDepth * fingerWidth; // actually it's finger depth x board thickness
      // More precisely: each slot has 2 walls of (fingerDepth x boardThick... no)
      // Each finger has 2 sides, each side is fingerDepth tall
      const glueAreaSqIn = fingers * 2 * fingerDepth * fingerWidth;

      // Jig pin offset = one finger width from the blade
      const jigOffset = fingerWidth;

      const frac = (n: number) => {
        const fracs: Record<number, string> = {0.125:'1/8"',0.1875:'3/16"',0.25:'1/4"',0.3125:'5/16"',0.375:'3/8"',0.5:'1/2"',0.75:'3/4"'};
        return fracs[n] || n.toFixed(3) + '"';
      };

      document.getElementById('bj2-count')!.textContent = fingers.toString();
      document.getElementById('bj2-count-sub')!.textContent = fingersA + ' fingers on piece A, ' + fingersB + ' fingers on piece B';
      document.getElementById('bj2-fwd')!.textContent = frac(fingerWidth);
      document.getElementById('bj2-fd')!.textContent = fingerDepth.toFixed(3) + '"';
      document.getElementById('bj2-slots-a')!.textContent = slotsA + ' slots';
      document.getElementById('bj2-slots-b')!.textContent = slotsB + ' slots';
      document.getElementById('bj2-glue')!.textContent = glueAreaSqIn.toFixed(1) + ' sq in';
      document.getElementById('bj2-offset')!.textContent = frac(jigOffset) + ' from blade';

      let notes = 'Set dado blade or router bit to exactly ' + frac(fingerWidth) + ' width. ';
      if (method === 'dado') {
        notes += 'Position jig pin exactly ' + frac(jigOffset) + ' from the blade. Test on scrap first.';
      } else if (method === 'router') {
        notes += 'Use a straight bit matching the finger width. Build an indexing jig with pin at ' + frac(jigOffset) + ' offset.';
      } else {
        notes += 'Mark all cuts carefully. This method requires patience but allows any finger width.';
      }
      if (remainder > 0.01) {
        notes += ' Note: ' + remainder.toFixed(3) + '" remainder will be split between top and bottom edges.';
      }
      document.getElementById('bj2-notes')!.textContent = notes;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.bj2-in').forEach(el => {
        el.addEventListener('input', calcBJ2);
        el.addEventListener('change', calcBJ2);
      });
      calcBJ2();
    }, 50);
  </script>
</CalculatorLayout>
