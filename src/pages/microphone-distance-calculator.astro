---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Microphone Distance Calculator - 3:1 Rule & Inverse Square Law";
const description = "Calculate microphone placement using the 3:1 rule, inverse square law falloff, proximity effect threshold, and stereo pair spacing.";
const relatedCalcs = [
  { name: "Sound Speed Calculator", url: "/sound-speed-calculator", description: "Speed of sound." },
  { name: "Decibel Calculator", url: "/decibel-calculator", description: "Decibel math." },
  { name: "Noise Level Calculator", url: "/noise-level-calculator", description: "Noise levels." },
  { name: "Frequency Calculator", url: "/frequency-calculator", description: "Convert frequency units." },
  { name: "Length Converter", url: "/length-converter", description: "Convert lengths." },
  { name: "Noise Reduction Calculator", url: "/noise-reduction-calculator", description: "Noise reduction." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Microphone Distance Calculator" keywords="microphone distance, 3:1 rule, inverse square law, proximity effect, stereo pair, microphone placement" breadcrumbs={[{ name: "Microphone Distance", url: "/microphone-distance-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Microphone Distance Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate optimal microphone placement using acoustic principles.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-text mb-1">Source-to-Mic Distance (inches)</label>
          <input type="number" id="md2-dist" class="md2-in w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold" min="0.5" max="600" step="0.5">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Source SPL (dB at 1 ft)</label>
            <input type="number" id="md2-spl" class="md2-in w-full px-4 py-3 border border-border rounded-xl text-lg" min="30" max="140" step="1">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Mic Sensitivity (dBV/Pa)</label>
            <input type="number" id="md2-sens" class="md2-in w-full px-4 py-3 border border-border rounded-xl text-lg" min="-80" max="-10" step="1">
          </div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">3:1 Rule - Min Distance Between Mics</div>
          <div class="text-4xl font-extrabold font-mono" id="md2-3to1">0"</div>
          <div class="text-sm text-blue-200 mt-1" id="md2-3to1-cm">0 cm</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">SPL at Mic Position</div><div class="text-xl font-bold font-mono" id="md2-splat">0 dB</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Signal Level</div><div class="text-xl font-bold font-mono" id="md2-signal">0 dBV</div></div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <div class="text-xs text-text-muted uppercase mb-2">Inverse Square Law Falloff</div>
          <div class="grid grid-cols-3 gap-2" id="md2-falloff"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Proximity Effect Threshold</div><div class="text-xl font-bold font-mono" id="md2-prox">0"</div><div class="text-xs text-text-muted">Bass boost begins below this distance</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Stereo Pair Spacing (ORTF)</div><div class="text-xl font-bold font-mono" id="md2-ortf">6.7"</div><div class="text-xs text-text-muted">17 cm apart, 110 deg angle</div></div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <div class="text-xs text-text-muted uppercase mb-2">Stereo Pair Techniques</div>
          <div class="grid grid-cols-2 gap-2 text-sm" id="md2-stereo"></div>
        </div>
      </div>
      <ShareButton calculatorId="microphone-distance" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcMD2() {
      const dist = parseFloat((document.getElementById('md2-dist') as HTMLInputElement).value) || 0;
      const splRef = parseFloat((document.getElementById('md2-spl') as HTMLInputElement).value) || 85;
      const sens = parseFloat((document.getElementById('md2-sens') as HTMLInputElement).value) || -40;

      if (dist <= 0) return;

      const minSep = dist * 3;
      document.getElementById('md2-3to1')!.textContent = minSep.toFixed(1) + '"';
      document.getElementById('md2-3to1-cm')!.textContent = (minSep * 2.54).toFixed(1) + ' cm';

      const refDist = 12;
      const splAtMic = splRef - 20 * Math.log10(dist / refDist);
      document.getElementById('md2-splat')!.textContent = splAtMic.toFixed(1) + ' dB SPL';

      const pa = 20e-6 * Math.pow(10, splAtMic / 20);
      const signalLevel = sens + 20 * Math.log10(pa / 1);
      document.getElementById('md2-signal')!.textContent = signalLevel.toFixed(1) + ' dBV';

      const falloff = document.getElementById('md2-falloff')!;
      const distances = [dist * 0.5, dist, dist * 2, dist * 4, dist * 8, dist * 16];
      falloff.innerHTML = distances.map(d => {
        const spl = splRef - 20 * Math.log10(d / refDist);
        return '<div class="text-center p-2 rounded-lg bg-white"><div class="text-xs text-text-muted">' + d.toFixed(1) + '"</div><div class="font-mono font-bold text-sm">' + spl.toFixed(1) + ' dB</div></div>';
      }).join('');

      const proxThreshold = 343 / (2 * 100) * 39.37;
      document.getElementById('md2-prox')!.textContent = proxThreshold.toFixed(1) + '" (~' + (proxThreshold * 2.54).toFixed(0) + ' cm)';

      const stereo = document.getElementById('md2-stereo')!;
      stereo.innerHTML = '<div><span class="font-bold">XY:</span> Coincident, 90-135 deg</div>' +
        '<div><span class="font-bold">ORTF:</span> 17cm apart, 110 deg</div>' +
        '<div><span class="font-bold">NOS:</span> 30cm apart, 90 deg</div>' +
        '<div><span class="font-bold">Spaced Pair:</span> ' + (dist * 2).toFixed(0) + '" - ' + (dist * 6).toFixed(0) + '" apart</div>';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      (document.getElementById('md2-dist') as HTMLInputElement).value = '12';
      (document.getElementById('md2-spl') as HTMLInputElement).value = '85';
      (document.getElementById('md2-sens') as HTMLInputElement).value = '-40';
      document.querySelectorAll('.md2-in').forEach(el => { el.addEventListener('input', calcMD2); el.addEventListener('change', calcMD2); });
      calcMD2();
    }, 50);
  </script>
</CalculatorLayout>
