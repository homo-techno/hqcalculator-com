---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Game Theory Calculator - Nash Equilibrium & Payoff Matrix";
const description = "Analyze 2x2 payoff matrices to find Nash equilibrium, dominant strategies, minimax solutions, and mixed strategy probabilities.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "Event probability." },
  { name: "Matrix Calculator", url: "/matrix-calculator", description: "Matrix operations." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical tools." },
  { name: "Average Calculator", url: "/average-calculator", description: "Calculate averages." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage math." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Game Theory Calculator" keywords="game theory, nash equilibrium, payoff matrix, dominant strategy, minimax, mixed strategy, prisoners dilemma" breadcrumbs={[{ name: "Game Theory", url: "/game-theory-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Game Theory Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Analyze 2-player games: enter payoff values to find Nash equilibria, dominant strategies, and optimal mixed strategies.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Preset Game</label>
          <select class="gt2-in w-full px-4 py-2 border border-border rounded-xl" id="gt2-preset">
            <option value="custom">Custom</option>
            <option value="prisoners">Prisoner's Dilemma</option>
            <option value="chicken">Chicken (Hawk-Dove)</option>
            <option value="stag">Stag Hunt</option>
            <option value="matching">Matching Pennies</option>
            <option value="battle">Battle of the Sexes</option>
          </select>
        </div>

        <div class="text-sm font-medium text-text">Payoff Matrix (Player 1, Player 2)</div>
        <div class="overflow-x-auto">
          <table class="w-full text-center text-sm border border-border rounded-xl overflow-hidden">
            <thead><tr class="bg-surface-alt">
              <th class="p-2 border border-border"></th>
              <th class="p-2 border border-border">P2: Strategy A</th>
              <th class="p-2 border border-border">P2: Strategy B</th>
            </tr></thead>
            <tbody>
              <tr>
                <td class="p-2 border border-border bg-surface-alt font-medium">P1: Strategy A</td>
                <td class="p-2 border border-border"><div class="flex gap-1"><input type="number" class="gt2-in w-full px-1 py-1 border border-border rounded text-center text-sm" id="gt2-aa1" value="3"><input type="number" class="gt2-in w-full px-1 py-1 border border-border rounded text-center text-sm" id="gt2-aa2" value="3"></div></td>
                <td class="p-2 border border-border"><div class="flex gap-1"><input type="number" class="gt2-in w-full px-1 py-1 border border-border rounded text-center text-sm" id="gt2-ab1" value="0"><input type="number" class="gt2-in w-full px-1 py-1 border border-border rounded text-center text-sm" id="gt2-ab2" value="5"></div></td>
              </tr>
              <tr>
                <td class="p-2 border border-border bg-surface-alt font-medium">P1: Strategy B</td>
                <td class="p-2 border border-border"><div class="flex gap-1"><input type="number" class="gt2-in w-full px-1 py-1 border border-border rounded text-center text-sm" id="gt2-ba1" value="5"><input type="number" class="gt2-in w-full px-1 py-1 border border-border rounded text-center text-sm" id="gt2-ba2" value="0"></div></td>
                <td class="p-2 border border-border"><div class="flex gap-1"><input type="number" class="gt2-in w-full px-1 py-1 border border-border rounded text-center text-sm" id="gt2-bb1" value="1"><input type="number" class="gt2-in w-full px-1 py-1 border border-border rounded text-center text-sm" id="gt2-bb2" value="1"></div></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Nash Equilibrium</div>
          <div class="text-3xl font-extrabold" id="gt2-nash">--</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">P1 Dominant Strategy</div>
            <div class="text-lg font-bold" id="gt2-dom1">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">P2 Dominant Strategy</div>
            <div class="text-lg font-bold" id="gt2-dom2">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Mixed Strategy Equilibrium</h3>
          <div class="text-sm font-mono" id="gt2-mixed">--</div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Minimax Solution</h3>
          <div class="text-sm font-mono" id="gt2-minimax">--</div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Analysis</h3>
          <div class="text-sm text-text-secondary" id="gt2-analysis">--</div>
        </div>
      </div>
      <ShareButton calculatorId="game-theory" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Game Theory Concepts</h2>
      <p>A Nash Equilibrium is a set of strategies where no player can improve their payoff by unilaterally changing their strategy. A dominant strategy is one that is always better regardless of the opponent's choice.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcGT2() {
      const aa1 = parseFloat((document.getElementById('gt2-aa1') as HTMLInputElement).value) || 0;
      const aa2 = parseFloat((document.getElementById('gt2-aa2') as HTMLInputElement).value) || 0;
      const ab1 = parseFloat((document.getElementById('gt2-ab1') as HTMLInputElement).value) || 0;
      const ab2 = parseFloat((document.getElementById('gt2-ab2') as HTMLInputElement).value) || 0;
      const ba1 = parseFloat((document.getElementById('gt2-ba1') as HTMLInputElement).value) || 0;
      const ba2 = parseFloat((document.getElementById('gt2-ba2') as HTMLInputElement).value) || 0;
      const bb1 = parseFloat((document.getElementById('gt2-bb1') as HTMLInputElement).value) || 0;
      const bb2 = parseFloat((document.getElementById('gt2-bb2') as HTMLInputElement).value) || 0;

      // P1 payoffs: aa1, ab1 (row A), ba1, bb1 (row B)
      // P2 payoffs: aa2, ab2 (col A), ba2, bb2 (col B)

      // Dominant strategies
      const p1ADom = aa1 >= ba1 && ab1 >= bb1;
      const p1BDom = ba1 >= aa1 && bb1 >= ab1;
      const p2ADom = aa2 >= ab2 && ba2 >= bb2;
      const p2BDom = ab2 >= aa2 && bb2 >= ba2;

      let dom1 = 'None';
      if (p1ADom && !(p1BDom)) dom1 = 'Strategy A';
      else if (p1BDom && !(p1ADom)) dom1 = 'Strategy B';
      let dom2 = 'None';
      if (p2ADom && !(p2BDom)) dom2 = 'Strategy A';
      else if (p2BDom && !(p2ADom)) dom2 = 'Strategy B';

      document.getElementById('gt2-dom1')!.textContent = dom1;
      document.getElementById('gt2-dom2')!.textContent = dom2;

      // Pure strategy Nash Equilibria
      const pureNE: string[] = [];
      // (A,A): P1 can't improve by switching to B, P2 can't improve by switching to B
      if (aa1 >= ba1 && aa2 >= ab2) pureNE.push('(A, A) -> (' + aa1 + ', ' + aa2 + ')');
      if (ab1 >= bb1 && ab2 >= aa2) pureNE.push('(A, B) -> (' + ab1 + ', ' + ab2 + ')');
      if (ba1 >= aa1 && ba2 >= bb2) pureNE.push('(B, A) -> (' + ba1 + ', ' + ba2 + ')');
      if (bb1 >= ab1 && bb2 >= ba2) pureNE.push('(B, B) -> (' + bb1 + ', ' + bb2 + ')');

      // Mixed strategy NE
      // P1 mixes: p*A + (1-p)*B such that P2 is indifferent
      // P2 indifferent: p*aa2 + (1-p)*ba2 = p*ab2 + (1-p)*bb2
      const denomP1 = (aa2 - ba2 - ab2 + bb2);
      const denomP2 = (aa1 - ab1 - ba1 + bb1);
      let p1MixA = -1;
      let p2MixA = -1;
      let mixedText = 'No mixed strategy equilibrium';

      if (Math.abs(denomP1) > 0.0001 && Math.abs(denomP2) > 0.0001) {
        p1MixA = (bb2 - ba2) / denomP1;
        p2MixA = (bb1 - ab1) / denomP2;
        if (p1MixA >= 0 && p1MixA <= 1 && p2MixA >= 0 && p2MixA <= 1) {
          const ev1 = p1MixA * (p2MixA * aa1 + (1 - p2MixA) * ab1) + (1 - p1MixA) * (p2MixA * ba1 + (1 - p2MixA) * bb1);
          const ev2 = p1MixA * (p2MixA * aa2 + (1 - p2MixA) * ab2) + (1 - p1MixA) * (p2MixA * ba2 + (1 - p2MixA) * bb2);
          mixedText = 'P1: A with ' + (p1MixA * 100).toFixed(1) + '%, B with ' + ((1 - p1MixA) * 100).toFixed(1) + '%\n' +
            'P2: A with ' + (p2MixA * 100).toFixed(1) + '%, B with ' + ((1 - p2MixA) * 100).toFixed(1) + '%\n' +
            'Expected payoffs: P1 = ' + ev1.toFixed(2) + ', P2 = ' + ev2.toFixed(2);
        }
      }
      document.getElementById('gt2-mixed')!.textContent = mixedText;

      let nashText = pureNE.length > 0 ? 'Pure: ' + pureNE.join('; ') : 'No pure strategy Nash Equilibrium';
      document.getElementById('gt2-nash')!.textContent = pureNE.length > 0 ? pureNE[0] : 'Mixed only';

      // Minimax
      const p1MaxRegretA = Math.max(ba1 - aa1, bb1 - ab1);
      const p1MaxRegretB = Math.max(aa1 - ba1, ab1 - bb1);
      const minimaxP1 = p1MaxRegretA <= p1MaxRegretB ? 'Strategy A' : 'Strategy B';
      const p2MaxRegretA = Math.max(ab2 - aa2, bb2 - ba2);
      const p2MaxRegretB = Math.max(aa2 - ab2, ba2 - bb2);
      const minimaxP2 = p2MaxRegretA <= p2MaxRegretB ? 'Strategy A' : 'Strategy B';
      document.getElementById('gt2-minimax')!.textContent = 'P1 minimax: ' + minimaxP1 + ' | P2 minimax: ' + minimaxP2;

      // Analysis
      let analysis = nashText;
      if (p1MixA >= 0 && p1MixA <= 1 && p2MixA >= 0 && p2MixA <= 1) {
        analysis += '. Mixed strategy equilibrium also exists.';
      }
      const isZeroSum = (aa1 + aa2 === 0) && (ab1 + ab2 === 0) && (ba1 + ba2 === 0) && (bb1 + bb2 === 0);
      if (isZeroSum) analysis += ' This is a zero-sum game.';
      document.getElementById('gt2-analysis')!.textContent = analysis;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.getElementById('gt2-preset')!.addEventListener('change', () => {
        const v = (document.getElementById('gt2-preset') as HTMLSelectElement).value;
        const presets: Record<string, number[]> = {
          'prisoners': [3, 3, 0, 5, 5, 0, 1, 1],
          'chicken':   [0, 0, -1, 1, 1, -1, -5, -5],
          'stag':      [4, 4, 0, 3, 3, 0, 3, 3],
          'matching':  [1, -1, -1, 1, -1, 1, 1, -1],
          'battle':    [3, 2, 0, 0, 0, 0, 2, 3],
        };
        if (presets[v]) {
          const p = presets[v];
          (document.getElementById('gt2-aa1') as HTMLInputElement).value = p[0].toString();
          (document.getElementById('gt2-aa2') as HTMLInputElement).value = p[1].toString();
          (document.getElementById('gt2-ab1') as HTMLInputElement).value = p[2].toString();
          (document.getElementById('gt2-ab2') as HTMLInputElement).value = p[3].toString();
          (document.getElementById('gt2-ba1') as HTMLInputElement).value = p[4].toString();
          (document.getElementById('gt2-ba2') as HTMLInputElement).value = p[5].toString();
          (document.getElementById('gt2-bb1') as HTMLInputElement).value = p[6].toString();
          (document.getElementById('gt2-bb2') as HTMLInputElement).value = p[7].toString();
          calcGT2();
        }
      });
      document.querySelectorAll('.gt2-in').forEach(el => { el.addEventListener('input', calcGT2); el.addEventListener('change', calcGT2); });
      calcGT2();
    }, 50);
  </script>
</CalculatorLayout>
