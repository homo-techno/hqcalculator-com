---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Probability Calculator - Event Probability & Combinations";
const description = "Calculate probability of single and multiple events. Includes conditional probability, combinations, permutations, and Bayes' theorem.";

const relatedCalcs = [
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Statistics." },
  { name: "Average Calculator", url: "/average-calculator", description: "Mean, median." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "Random Number", url: "/random-number-generator", description: "Random numbers." },
  { name: "Fraction Calculator", url: "/fraction-calculator", description: "Fractions." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Probability Calculator"
  keywords="probability calculator, event probability, combinations calculator, permutations, conditional probability, odds calculator"
  breadcrumbs={[{ name: "Probability Calculator", url: "/probability-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Probability Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate probability of events, combinations, and permutations.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="flex gap-2 mb-6 flex-wrap">
        <button class="prob-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-primary text-white" data-mode="single">Single Event</button>
        <button class="prob-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-surface-alt text-text-secondary" data-mode="two">Two Events</button>
        <button class="prob-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-surface-alt text-text-secondary" data-mode="combo">Combinations</button>
      </div>

      <!-- Single Event -->
      <div id="prob-single">
        <div class="grid grid-cols-2 gap-4 mb-5">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Favorable Outcomes</label>
            <input type="number" id="prob-fav" class="w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" value="1" min="0">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Total Outcomes</label>
            <input type="number" id="prob-total" class="w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" value="6" min="1">
          </div>
        </div>
        <div class="mb-5">
          <label class="block text-sm font-medium text-text mb-1">Number of Trials</label>
          <input type="number" id="prob-trials" class="w-full px-4 py-3 border border-border rounded-xl text-lg text-center" value="1" min="1" max="1000">
        </div>
      </div>

      <!-- Two Events -->
      <div id="prob-two" class="hidden">
        <div class="grid grid-cols-2 gap-4 mb-5">
          <div>
            <label class="block text-sm font-medium text-text mb-1">P(A)</label>
            <input type="number" id="prob-a" class="w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" value="0.5" min="0" max="1" step="0.01">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">P(B)</label>
            <input type="number" id="prob-b" class="w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" value="0.3" min="0" max="1" step="0.01">
          </div>
        </div>
        <div class="mb-5">
          <label class="flex items-center gap-2 text-sm font-medium text-text">
            <input type="checkbox" id="prob-independent" checked class="accent-primary">
            Events are independent
          </label>
        </div>
      </div>

      <!-- Combinations -->
      <div id="prob-combo" class="hidden">
        <div class="grid grid-cols-2 gap-4 mb-5">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Total Items (n)</label>
            <input type="number" id="prob-n" class="w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" value="10" min="0" max="170">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Choose (r)</label>
            <input type="number" id="prob-r" class="w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" value="3" min="0" max="170">
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1" id="prob-label">Probability</div>
        <div class="text-4xl font-extrabold" id="prob-result">16.67%</div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-6" id="prob-details"></div>

      <ShareButton calculatorId="probability" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Probability Formulas</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>P(A):</strong> Favorable / Total outcomes</p>
        <p><strong>P(A and B):</strong> P(A) × P(B) [independent]</p>
        <p><strong>P(A or B):</strong> P(A) + P(B) − P(A and B)</p>
        <p><strong>C(n,r):</strong> n! / (r! × (n−r)!)</p>
        <p><strong>P(n,r):</strong> n! / (n−r)!</p>
      </div>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>What's the difference between combinations and permutations?</strong> Combinations don't care about order (choosing a team). Permutations do care about order (assigning positions).</p>
      <p><strong>What does "independent" mean?</strong> Two events are independent if one doesn't affect the other's probability. Coin flips are independent; drawing cards without replacement are not.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let probMode = 'single';

    function factorial(n: number): number {
      if (n <= 1) return 1;
      let result = 1;
      for (let i = 2; i <= n; i++) result *= i;
      return result;
    }

    function combination(n: number, r: number): number {
      if (r > n || r < 0) return 0;
      return factorial(n) / (factorial(r) * factorial(n - r));
    }

    function permutation(n: number, r: number): number {
      if (r > n || r < 0) return 0;
      return factorial(n) / factorial(n - r);
    }

    function calcProb() {
      const details = document.getElementById('prob-details')!;
      let html = '';

      if (probMode === 'single') {
        const fav = parseFloat((document.getElementById('prob-fav') as HTMLInputElement).value) || 0;
        const total = parseFloat((document.getElementById('prob-total') as HTMLInputElement).value) || 1;
        const trials = parseInt((document.getElementById('prob-trials') as HTMLInputElement).value) || 1;

        const p = Math.min(1, fav / total);
        const pAtLeastOnce = 1 - Math.pow(1 - p, trials);
        const pNone = Math.pow(1 - p, trials);
        const expected = p * trials;
        const odds = p > 0 && p < 1 ? `${fav} : ${total - fav}` : '—';

        document.getElementById('prob-label')!.textContent = 'Probability';
        document.getElementById('prob-result')!.textContent = (p * 100).toFixed(2) + '%';

        html = `
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">As Fraction</div><div class="text-xl font-bold">${fav}/${total}</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">As Decimal</div><div class="text-xl font-bold">${p.toFixed(4)}</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Odds (for : against)</div><div class="text-xl font-bold">${odds}</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">P(NOT happening)</div><div class="text-xl font-bold">${((1 - p) * 100).toFixed(2)}%</div></div>`;
        if (trials > 1) {
          html += `
            <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">P(at least once in ${trials})</div><div class="text-xl font-bold">${(pAtLeastOnce * 100).toFixed(2)}%</div></div>
            <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Expected in ${trials} trials</div><div class="text-xl font-bold">${expected.toFixed(2)}</div></div>`;
        }
      } else if (probMode === 'two') {
        const pA = parseFloat((document.getElementById('prob-a') as HTMLInputElement).value) || 0;
        const pB = parseFloat((document.getElementById('prob-b') as HTMLInputElement).value) || 0;
        const independent = (document.getElementById('prob-independent') as HTMLInputElement).checked;

        const pAandB = independent ? pA * pB : Math.min(pA, pB);
        const pAorB = pA + pB - pAandB;
        const pNotA = 1 - pA;
        const pNotB = 1 - pB;

        document.getElementById('prob-label')!.textContent = 'P(A and B)';
        document.getElementById('prob-result')!.textContent = (pAandB * 100).toFixed(2) + '%';

        html = `
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">P(A and B)</div><div class="text-xl font-bold">${(pAandB * 100).toFixed(2)}%</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">P(A or B)</div><div class="text-xl font-bold">${(pAorB * 100).toFixed(2)}%</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">P(not A)</div><div class="text-xl font-bold">${(pNotA * 100).toFixed(2)}%</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">P(not B)</div><div class="text-xl font-bold">${(pNotB * 100).toFixed(2)}%</div></div>`;
      } else {
        const n = parseInt((document.getElementById('prob-n') as HTMLInputElement).value) || 0;
        const r = parseInt((document.getElementById('prob-r') as HTMLInputElement).value) || 0;
        const c = combination(n, r);
        const p = permutation(n, r);

        document.getElementById('prob-label')!.textContent = 'Combinations C(n,r)';
        document.getElementById('prob-result')!.textContent = c.toLocaleString();

        html = `
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Combinations C(${n},${r})</div><div class="text-xl font-bold">${c.toLocaleString()}</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Permutations P(${n},${r})</div><div class="text-xl font-bold">${p.toLocaleString()}</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">n!</div><div class="text-xl font-bold">${n <= 20 ? factorial(n).toLocaleString() : '—'}</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">r!</div><div class="text-xl font-bold">${r <= 20 ? factorial(r).toLocaleString() : '—'}</div></div>`;
      }

      details.innerHTML = html;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.prob-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.prob-mode-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white'); b.classList.add('bg-surface-alt', 'text-text-secondary'); });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary'); btn.classList.add('bg-primary', 'text-white');
          probMode = (btn as HTMLElement).dataset.mode || 'single';
          document.getElementById('prob-single')!.classList.toggle('hidden', probMode !== 'single');
          document.getElementById('prob-two')!.classList.toggle('hidden', probMode !== 'two');
          document.getElementById('prob-combo')!.classList.toggle('hidden', probMode !== 'combo');
          calcProb();
        });
      });

      ['prob-fav', 'prob-total', 'prob-trials', 'prob-a', 'prob-b', 'prob-n', 'prob-r'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calcProb);
      });
      document.getElementById('prob-independent')?.addEventListener('change', calcProb);

      calcProb();
    }, 50);
  </script>
</CalculatorLayout>
