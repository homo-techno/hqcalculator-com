---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Card Game Probability Calculator";
const description = "Calculate draw probabilities using hypergeometric distribution, mulligan odds, combo piece chances, and deck thinning effects for TCGs.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "General probability." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage math." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical analysis." },
  { name: "Average Calculator", url: "/average-calculator", description: "Calculate averages." },
  { name: "Random Number Generator", url: "/random-number-generator", description: "Random numbers." },
  { name: "Percentage Change", url: "/percentage-change-calculator", description: "Track changes." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Card Game Probability Calculator" keywords="card draw probability, hypergeometric calculator, tcg probability, mulligan odds, combo probability, deck thinning" breadcrumbs={[{ name: "Card Game Probability", url: "/card-game-probability-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Card Game Probability Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate the odds of drawing specific cards from your deck using hypergeometric distribution.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Deck Size</label>
          <input type="number" class="cg3-in w-full px-4 py-2 border border-border rounded-lg" id="cg3-deck" min="1" max="200" value="60">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Copies of Desired Card in Deck</label>
          <input type="number" class="cg3-in w-full px-4 py-2 border border-border rounded-lg" id="cg3-copies" min="0" max="60" value="4">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Cards Drawn (hand size)</label>
          <input type="number" class="cg3-in w-full px-4 py-2 border border-border rounded-lg" id="cg3-drawn" min="1" max="60" value="7">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Minimum Copies Needed</label>
          <input type="number" class="cg3-in w-full px-4 py-2 border border-border rounded-lg" id="cg3-need" min="1" max="10" value="1">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Cards Already Removed (deck thinning)</label>
          <input type="number" class="cg3-in w-full px-4 py-2 border border-border rounded-lg" id="cg3-removed" min="0" max="50" value="0">
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Probability of Drawing</div>
          <div class="text-5xl font-extrabold font-mono" id="cg3-result">--</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Exactly N Copies</div>
            <div class="text-xl font-bold font-mono" id="cg3-exact">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">At Least 1 Copy</div>
            <div class="text-xl font-bold font-mono" id="cg3-atleast1">--</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Expected Copies</div>
            <div class="text-xl font-bold font-mono" id="cg3-expected">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Mulligan Improvement</div>
            <div class="text-xl font-bold font-mono" id="cg3-mulligan">--</div>
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Draw Probability by Turn</h3>
          <div class="text-xs font-mono space-y-1" id="cg3-turns"></div>
        </div>
      </div>
      <ShareButton calculatorId="card-game-probability" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function choose(n: number, k: number): number {
      if (k < 0 || k > n) return 0;
      if (k === 0 || k === n) return 1;
      let result = 1;
      for (let i = 0; i < Math.min(k, n - k); i++) {
        result = result * (n - i) / (i + 1);
      }
      return Math.round(result);
    }

    function hypergeometric(N: number, K: number, n: number, k: number): number {
      return (choose(K, k) * choose(N - K, n - k)) / choose(N, n);
    }

    function calcCG3() {
      const deckBase = parseInt((document.getElementById('cg3-deck') as HTMLInputElement).value) || 60;
      const copies = parseInt((document.getElementById('cg3-copies') as HTMLInputElement).value) || 4;
      const drawn = parseInt((document.getElementById('cg3-drawn') as HTMLInputElement).value) || 7;
      const need = parseInt((document.getElementById('cg3-need') as HTMLInputElement).value) || 1;
      const removed = parseInt((document.getElementById('cg3-removed') as HTMLInputElement).value) || 0;

      const deck = deckBase - removed;
      const effectiveCopies = Math.min(copies, deck);

      // P(at least need copies in drawn cards)
      let probAtLeast = 0;
      for (let k = need; k <= Math.min(effectiveCopies, drawn); k++) {
        probAtLeast += hypergeometric(deck, effectiveCopies, drawn, k);
      }

      // P(exactly need)
      const probExact = hypergeometric(deck, effectiveCopies, drawn, need);

      // P(at least 1)
      let probAtLeast1 = 0;
      for (let k = 1; k <= Math.min(effectiveCopies, drawn); k++) {
        probAtLeast1 += hypergeometric(deck, effectiveCopies, drawn, k);
      }

      // Expected copies
      const expected = drawn * effectiveCopies / deck;

      // Mulligan: P(at least 1 in either of two 7-card hands) - simplified
      const probMiss = 1 - probAtLeast1;
      const probAfterMulligan = 1 - probMiss * probMiss;
      const mulliganImprove = probAfterMulligan - probAtLeast1;

      document.getElementById('cg3-result')!.textContent = (probAtLeast * 100).toFixed(2) + '%';
      document.getElementById('cg3-exact')!.textContent = (probExact * 100).toFixed(2) + '%';
      document.getElementById('cg3-atleast1')!.textContent = (probAtLeast1 * 100).toFixed(2) + '%';
      document.getElementById('cg3-expected')!.textContent = expected.toFixed(2);
      document.getElementById('cg3-mulligan')!.textContent = '+' + (mulliganImprove * 100).toFixed(1) + '%';

      // By turn (cumulative draws)
      let html = '';
      for (let turn = 0; turn <= 8; turn++) {
        const totalDrawn = Math.min(drawn + turn, deck);
        let turnProb = 0;
        for (let k = 1; k <= Math.min(effectiveCopies, totalDrawn); k++) {
          turnProb += hypergeometric(deck, effectiveCopies, totalDrawn, k);
        }
        const label = turn === 0 ? 'Opening hand' : 'Turn ' + turn;
        const barW = Math.round(turnProb * 100);
        html += '<div class="flex items-center gap-2"><span class="w-24">' + label + '</span><div class="flex-1 bg-gray-200 rounded-full h-3"><div class="bg-primary h-3 rounded-full" style="width:' + barW + '%"></div></div><span class="w-14 text-right">' + (turnProb * 100).toFixed(1) + '%</span></div>';
      }
      document.getElementById('cg3-turns')!.innerHTML = html;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.cg3-in').forEach(el => { el.addEventListener('input', calcCG3); el.addEventListener('change', calcCG3); });
      calcCG3();
    }, 50);
  </script>
</CalculatorLayout>
