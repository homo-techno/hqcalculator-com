---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Subnet Calculator - IP Subnet Mask & CIDR Calculator";
const description = "Calculate subnet masks, network addresses, broadcast addresses, and usable host ranges. Supports IPv4 CIDR notation and subnet division.";

const relatedCalcs = [
  { name: "Binary Calculator", url: "/binary-calculator", description: "Binary math." },
  { name: "Hex Calculator", url: "/hex-calculator", description: "Hexadecimal." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
  { name: "Exponent Calculator", url: "/exponent-calculator", description: "Powers." },
  { name: "Random Number", url: "/random-number-generator", description: "Random numbers." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Subnet Calculator"
  keywords="subnet calculator, IP subnet, CIDR calculator, subnet mask, network address, broadcast address, usable hosts"
  breadcrumbs={[{ name: "Subnet Calculator", url: "/subnet-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Subnet Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate IPv4 subnet details from an IP address and CIDR prefix or subnet mask.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-1">IP Address</label>
        <input type="text" id="sn-ip" class="w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold font-mono text-center" value="192.168.1.100" placeholder="192.168.1.100">
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-1">CIDR Prefix / Subnet Mask</label>
        <div class="flex gap-2">
          <span class="self-center text-text-muted font-bold text-xl">/</span>
          <input type="number" id="sn-cidr" class="w-20 px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" value="24" min="0" max="32">
          <span class="self-center text-text-muted px-2">or</span>
          <input type="text" id="sn-mask" class="flex-1 px-4 py-3 border border-border rounded-xl text-lg font-mono text-center" value="255.255.255.0" placeholder="255.255.255.0">
        </div>
        <div class="flex gap-2 mt-2 flex-wrap">
          <button class="sn-quick px-2 py-1 text-xs rounded-full border border-border hover:bg-surface-alt font-mono" data-cidr="8">/8</button>
          <button class="sn-quick px-2 py-1 text-xs rounded-full border border-border hover:bg-surface-alt font-mono" data-cidr="16">/16</button>
          <button class="sn-quick px-2 py-1 text-xs rounded-full border border-border hover:bg-surface-alt font-mono" data-cidr="24">/24</button>
          <button class="sn-quick px-2 py-1 text-xs rounded-full border border-border hover:bg-surface-alt font-mono" data-cidr="25">/25</button>
          <button class="sn-quick px-2 py-1 text-xs rounded-full border border-border hover:bg-surface-alt font-mono" data-cidr="26">/26</button>
          <button class="sn-quick px-2 py-1 text-xs rounded-full border border-border hover:bg-surface-alt font-mono" data-cidr="27">/27</button>
          <button class="sn-quick px-2 py-1 text-xs rounded-full border border-border hover:bg-surface-alt font-mono" data-cidr="28">/28</button>
          <button class="sn-quick px-2 py-1 text-xs rounded-full border border-border hover:bg-surface-alt font-mono" data-cidr="30">/30</button>
        </div>
      </div>

      <!-- Results -->
      <div class="space-y-2 mb-6" id="sn-results">
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">Network Address</span><span class="font-bold font-mono" id="sn-network">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">Broadcast Address</span><span class="font-bold font-mono" id="sn-broadcast">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-primary/10 rounded-xl"><span class="text-sm font-medium">Usable Host Range</span><span class="font-bold font-mono text-primary" id="sn-range">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">Subnet Mask</span><span class="font-bold font-mono" id="sn-mask-out">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">Wildcard Mask</span><span class="font-bold font-mono" id="sn-wildcard">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">Total Addresses</span><span class="font-bold" id="sn-total">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">Usable Hosts</span><span class="font-bold text-secondary" id="sn-hosts">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">CIDR Notation</span><span class="font-bold font-mono" id="sn-cidr-out">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">IP Class</span><span class="font-bold" id="sn-class">—</span></div>
        <div class="flex justify-between items-center py-2 px-4 bg-surface-alt rounded-xl"><span class="text-sm text-text-muted">Binary Subnet Mask</span><span class="font-bold font-mono text-xs" id="sn-binary">—</span></div>
      </div>

      <ShareButton calculatorId="subnet" />
      <FeedbackWidget />
    </div>

    <!-- CIDR Reference -->
    <div class="mt-12 bg-white border border-border rounded-2xl p-6 sm:p-8">
      <h2 class="text-2xl font-bold text-text mb-4">CIDR Reference Table</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead><tr class="border-b border-border text-left"><th class="py-2 pr-3 font-semibold">CIDR</th><th class="py-2 pr-3 font-semibold">Subnet Mask</th><th class="py-2 pr-3 font-semibold">Addresses</th><th class="py-2 font-semibold">Usable Hosts</th></tr></thead>
          <tbody id="sn-table"></tbody>
        </table>
      </div>
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How Subnetting Works</h2>
      <p>Subnetting divides a network into smaller subnetworks. The subnet mask determines which portion of an IP address identifies the network vs. the host.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>What is CIDR notation?</strong> CIDR (Classless Inter-Domain Routing) uses /prefix to denote the number of network bits. /24 means 24 network bits and 8 host bits = 256 addresses.</p>
      <p><strong>Why do I lose 2 addresses?</strong> The first address is the network address and the last is the broadcast address. Neither can be assigned to a host.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let updatingFromCidr = false;

    function ipToInt(ip: string): number {
      const parts = ip.split('.').map(Number);
      if (parts.length !== 4 || parts.some(p => isNaN(p) || p < 0 || p > 255)) return -1;
      return ((parts[0] << 24) | (parts[1] << 16) | (parts[2] << 8) | parts[3]) >>> 0;
    }

    function intToIp(n: number): string {
      return `${(n >>> 24) & 255}.${(n >>> 16) & 255}.${(n >>> 8) & 255}.${n & 255}`;
    }

    function cidrToMask(cidr: number): number {
      return cidr === 0 ? 0 : (~0 << (32 - cidr)) >>> 0;
    }

    function maskToCidr(mask: number): number {
      let bits = 0;
      let m = mask;
      while (m & 0x80000000) { bits++; m = (m << 1) >>> 0; }
      return bits;
    }

    function getClass(ip: number): string {
      const first = (ip >>> 24) & 255;
      if (first < 128) return 'A';
      if (first < 192) return 'B';
      if (first < 224) return 'C';
      if (first < 240) return 'D (Multicast)';
      return 'E (Reserved)';
    }

    function calcSubnet() {
      const ipStr = (document.getElementById('sn-ip') as HTMLInputElement).value.trim();
      const cidr = parseInt((document.getElementById('sn-cidr') as HTMLInputElement).value) || 24;
      const ip = ipToInt(ipStr);
      if (ip < 0) return;

      const mask = cidrToMask(cidr);
      const wildcard = (~mask) >>> 0;
      const network = (ip & mask) >>> 0;
      const broadcast = (network | wildcard) >>> 0;
      const totalAddresses = Math.pow(2, 32 - cidr);
      const usableHosts = Math.max(0, totalAddresses - 2);
      const firstHost = cidr < 31 ? network + 1 : network;
      const lastHost = cidr < 31 ? broadcast - 1 : broadcast;

      // Update mask input
      if (!updatingFromCidr) {
        (document.getElementById('sn-mask') as HTMLInputElement).value = intToIp(mask);
      }

      const binMask = mask.toString(2).padStart(32, '0').replace(/(.{8})/g, '$1.').slice(0, -1);

      document.getElementById('sn-network')!.textContent = intToIp(network);
      document.getElementById('sn-broadcast')!.textContent = intToIp(broadcast);
      document.getElementById('sn-range')!.textContent = usableHosts > 0 ? `${intToIp(firstHost)} – ${intToIp(lastHost)}` : 'Point-to-point';
      document.getElementById('sn-mask-out')!.textContent = intToIp(mask);
      document.getElementById('sn-wildcard')!.textContent = intToIp(wildcard);
      document.getElementById('sn-total')!.textContent = totalAddresses.toLocaleString();
      document.getElementById('sn-hosts')!.textContent = usableHosts.toLocaleString();
      document.getElementById('sn-cidr-out')!.textContent = `${intToIp(network)}/${cidr}`;
      document.getElementById('sn-class')!.textContent = `Class ${getClass(ip)}`;
      document.getElementById('sn-binary')!.textContent = binMask;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    function buildTable() {
      const cidrs = [8, 9, 10, 12, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32];
      document.getElementById('sn-table')!.innerHTML = cidrs.map(c => {
        const mask = cidrToMask(c);
        const total = Math.pow(2, 32 - c);
        const hosts = Math.max(0, total - 2);
        return `<tr class="border-b border-border/20 hover:bg-surface-alt/50 ${c === 24 ? 'font-bold bg-blue-50' : ''}">
          <td class="py-1 pr-3 font-mono">/${c}</td>
          <td class="py-1 pr-3 font-mono">${intToIp(mask)}</td>
          <td class="py-1 pr-3">${total.toLocaleString()}</td>
          <td class="py-1">${hosts.toLocaleString()}</td>
        </tr>`;
      }).join('');
    }

    setTimeout(() => {
      document.getElementById('sn-ip')!.addEventListener('input', calcSubnet);
      document.getElementById('sn-cidr')!.addEventListener('input', () => {
        updatingFromCidr = false;
        calcSubnet();
      });
      document.getElementById('sn-mask')!.addEventListener('input', () => {
        const maskInt = ipToInt((document.getElementById('sn-mask') as HTMLInputElement).value);
        if (maskInt >= 0) {
          updatingFromCidr = true;
          (document.getElementById('sn-cidr') as HTMLInputElement).value = String(maskToCidr(maskInt));
          calcSubnet();
          updatingFromCidr = false;
        }
      });

      document.querySelectorAll('.sn-quick').forEach(btn => {
        btn.addEventListener('click', () => {
          (document.getElementById('sn-cidr') as HTMLInputElement).value = (btn as HTMLElement).dataset.cidr || '24';
          calcSubnet();
        });
      });

      calcSubnet();
      buildTable();
    }, 50);
  </script>
</CalculatorLayout>
