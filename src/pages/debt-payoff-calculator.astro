---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Debt Payoff Calculator - Snowball & Avalanche Method";
const description = "Calculate how fast you can pay off debt. Compare snowball vs avalanche methods. See payoff dates, total interest, and monthly payment schedules.";

const relatedCalcs = [
  { name: "Loan Calculator", url: "/loan-calculator", description: "Loan payments." },
  { name: "Mortgage Calculator", url: "/mortgage-calculator", description: "Home loans." },
  { name: "Savings Calculator", url: "/savings-calculator", description: "Savings growth." },
  { name: "Compound Interest", url: "/compound-interest-calculator", description: "Compound growth." },
  { name: "Income Tax Calculator", url: "/income-tax-calculator", description: "Federal tax." },
  { name: "Paycheck Calculator", url: "/paycheck-calculator", description: "Take-home pay." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Debt Payoff Calculator"
  keywords="debt payoff calculator, debt snowball, debt avalanche, credit card payoff, debt free calculator, debt repayment"
  breadcrumbs={[{ name: "Debt Payoff", url: "/debt-payoff-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Debt Payoff Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">See how fast you can become debt-free with snowball or avalanche strategies.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <!-- Debts table -->
      <div class="overflow-x-auto mb-4">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-border text-left">
              <th class="py-2 pr-2 font-semibold">Debt Name</th>
              <th class="py-2 pr-2 font-semibold">Balance</th>
              <th class="py-2 pr-2 font-semibold">APR (%)</th>
              <th class="py-2 pr-2 font-semibold">Min Payment</th>
              <th class="py-2"></th>
            </tr>
          </thead>
          <tbody id="dp-tbody">
            <tr class="dp-row border-b border-border/30">
              <td class="py-2 pr-2"><input type="text" class="dp-name w-full px-2 py-1.5 border border-border rounded-lg" value="Credit Card 1"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-bal w-28 px-2 py-1.5 border border-border rounded-lg" value="5000" min="0"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-apr w-20 px-2 py-1.5 border border-border rounded-lg" value="22.99" min="0" step="0.01"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-min w-24 px-2 py-1.5 border border-border rounded-lg" value="100" min="0"></td>
              <td class="py-2"><button class="dp-rm text-danger text-lg hover:text-red-700">×</button></td>
            </tr>
            <tr class="dp-row border-b border-border/30">
              <td class="py-2 pr-2"><input type="text" class="dp-name w-full px-2 py-1.5 border border-border rounded-lg" value="Credit Card 2"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-bal w-28 px-2 py-1.5 border border-border rounded-lg" value="3000" min="0"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-apr w-20 px-2 py-1.5 border border-border rounded-lg" value="18.99" min="0" step="0.01"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-min w-24 px-2 py-1.5 border border-border rounded-lg" value="75" min="0"></td>
              <td class="py-2"><button class="dp-rm text-danger text-lg hover:text-red-700">×</button></td>
            </tr>
            <tr class="dp-row border-b border-border/30">
              <td class="py-2 pr-2"><input type="text" class="dp-name w-full px-2 py-1.5 border border-border rounded-lg" value="Car Loan"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-bal w-28 px-2 py-1.5 border border-border rounded-lg" value="12000" min="0"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-apr w-20 px-2 py-1.5 border border-border rounded-lg" value="6.5" min="0" step="0.01"></td>
              <td class="py-2 pr-2"><input type="number" class="dp-min w-24 px-2 py-1.5 border border-border rounded-lg" value="350" min="0"></td>
              <td class="py-2"><button class="dp-rm text-danger text-lg hover:text-red-700">×</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <button id="dp-add" class="px-4 py-2 border border-border rounded-xl text-sm font-semibold hover:bg-surface-alt mb-6">+ Add Debt</button>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-text mb-1">Extra Monthly Payment</label>
          <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span><input type="number" id="dp-extra" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-lg" value="200" min="0" step="25"></div>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Strategy</label>
          <div class="flex gap-2">
            <button class="dp-strat-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-primary text-white" data-strat="avalanche">Avalanche</button>
            <button class="dp-strat-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-surface-alt text-text-secondary" data-strat="snowball">Snowball</button>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Debt-Free Date</div>
          <div class="text-3xl font-extrabold" id="dp-date">—</div>
          <div class="text-sm text-blue-200 mt-1" id="dp-months">0 months</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Debt</div>
            <div class="text-xl font-bold" id="dp-total-debt">$0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Interest</div>
            <div class="text-xl font-bold text-danger" id="dp-total-int">$0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Paid</div>
            <div class="text-xl font-bold" id="dp-total-paid">$0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Interest Saved</div>
            <div class="text-xl font-bold text-secondary" id="dp-saved">$0</div>
          </div>
        </div>
      </div>

      <!-- Payoff order -->
      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h3 class="font-semibold text-sm text-text mb-3">Payoff Order</h3>
        <div id="dp-order" class="space-y-2 text-sm"></div>
      </div>

      <ShareButton calculatorId="debt-payoff" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Snowball vs. Avalanche Method</h2>
      <ul>
        <li><strong>Avalanche (recommended):</strong> Pay off highest interest rate first. Saves the most money mathematically.</li>
        <li><strong>Snowball:</strong> Pay off smallest balance first. Provides psychological wins to keep you motivated.</li>
      </ul>
      <p>Both methods: make minimum payments on all debts, then throw extra money at the target debt.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>Which method is better?</strong> Avalanche saves more in interest. Snowball provides faster "wins." Choose snowball if you need motivation; avalanche if you want to minimize costs.</p>
      <p><strong>How much extra should I pay?</strong> Any extra helps. Even $50-100/month extra can shave years off your debt and save thousands in interest.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let dpStrat = 'avalanche';
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString('en-US');

    type Debt = { name: string; balance: number; apr: number; minPay: number };

    function getDebts(): Debt[] {
      const debts: Debt[] = [];
      document.querySelectorAll('.dp-row').forEach(row => {
        const name = (row.querySelector('.dp-name') as HTMLInputElement).value || 'Debt';
        const balance = parseFloat((row.querySelector('.dp-bal') as HTMLInputElement).value) || 0;
        const apr = parseFloat((row.querySelector('.dp-apr') as HTMLInputElement).value) || 0;
        const minPay = parseFloat((row.querySelector('.dp-min') as HTMLInputElement).value) || 0;
        if (balance > 0) debts.push({ name, balance, apr, minPay });
      });
      return debts;
    }

    function simulate(debts: Debt[], extra: number, strategy: string): { months: number; totalInterest: number; totalPaid: number; order: { name: string; month: number }[] } {
      const balances = debts.map(d => d.balance);
      let months = 0;
      let totalInterest = 0;
      let totalPaid = 0;
      const order: { name: string; month: number }[] = [];
      const maxMonths = 600;

      while (balances.some(b => b > 0.01) && months < maxMonths) {
        months++;
        let extraLeft = extra;

        // Pay minimum on all
        for (let i = 0; i < debts.length; i++) {
          if (balances[i] <= 0) continue;
          const interest = balances[i] * debts[i].apr / 100 / 12;
          totalInterest += interest;
          balances[i] += interest;
          const payment = Math.min(balances[i], debts[i].minPay);
          balances[i] -= payment;
          totalPaid += payment;
        }

        // Determine priority order
        let priorityOrder: number[];
        if (strategy === 'snowball') {
          priorityOrder = debts.map((_, i) => i).filter(i => balances[i] > 0).sort((a, b) => balances[a] - balances[b]);
        } else {
          priorityOrder = debts.map((_, i) => i).filter(i => balances[i] > 0).sort((a, b) => debts[b].apr - debts[a].apr);
        }

        // Apply extra to priority
        for (const i of priorityOrder) {
          if (extraLeft <= 0) break;
          const payment = Math.min(balances[i], extraLeft);
          balances[i] -= payment;
          totalPaid += payment;
          extraLeft -= payment;
        }

        // Check for payoffs
        for (let i = 0; i < debts.length; i++) {
          if (balances[i] <= 0.01 && !order.find(o => o.name === debts[i].name)) {
            order.push({ name: debts[i].name, month: months });
            balances[i] = 0;
          }
        }
      }

      return { months, totalInterest, totalPaid, order };
    }

    function calcDebt() {
      const debts = getDebts();
      if (debts.length === 0) return;

      const extra = parseFloat((document.getElementById('dp-extra') as HTMLInputElement).value) || 0;
      const result = simulate(debts, extra, dpStrat);
      const baseResult = simulate(debts, 0, dpStrat);

      const totalDebt = debts.reduce((s, d) => s + d.balance, 0);
      const saved = baseResult.totalInterest - result.totalInterest;

      const now = new Date();
      const payoffDate = new Date(now.getFullYear(), now.getMonth() + result.months);
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      document.getElementById('dp-date')!.textContent = `${monthNames[payoffDate.getMonth()]} ${payoffDate.getFullYear()}`;
      document.getElementById('dp-months')!.textContent = `${result.months} months (${(result.months / 12).toFixed(1)} years)`;
      document.getElementById('dp-total-debt')!.textContent = fmt(totalDebt);
      document.getElementById('dp-total-int')!.textContent = fmt(result.totalInterest);
      document.getElementById('dp-total-paid')!.textContent = fmt(result.totalPaid);
      document.getElementById('dp-saved')!.textContent = fmt(saved);

      document.getElementById('dp-order')!.innerHTML = result.order.map((o, i) =>
        `<div class="flex justify-between items-center py-1.5 px-3 rounded-lg ${i === 0 ? 'bg-primary/10 font-semibold' : ''}">
          <span>${i + 1}. ${o.name}</span>
          <span class="text-text-muted">Month ${o.month} (${monthNames[new Date(now.getFullYear(), now.getMonth() + o.month).getMonth()]} ${new Date(now.getFullYear(), now.getMonth() + o.month).getFullYear()})</span>
        </div>`
      ).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    function addRow() {
      const tbody = document.getElementById('dp-tbody')!;
      const tr = document.createElement('tr');
      tr.className = 'dp-row border-b border-border/30';
      tr.innerHTML = `
        <td class="py-2 pr-2"><input type="text" class="dp-name w-full px-2 py-1.5 border border-border rounded-lg" value="New Debt"></td>
        <td class="py-2 pr-2"><input type="number" class="dp-bal w-28 px-2 py-1.5 border border-border rounded-lg" value="1000" min="0"></td>
        <td class="py-2 pr-2"><input type="number" class="dp-apr w-20 px-2 py-1.5 border border-border rounded-lg" value="15" min="0" step="0.01"></td>
        <td class="py-2 pr-2"><input type="number" class="dp-min w-24 px-2 py-1.5 border border-border rounded-lg" value="50" min="0"></td>
        <td class="py-2"><button class="dp-rm text-danger text-lg hover:text-red-700">×</button></td>`;
      tbody.appendChild(tr);
      tr.querySelectorAll('input').forEach(el => el.addEventListener('input', calcDebt));
      tr.querySelector('.dp-rm')!.addEventListener('click', () => { tr.remove(); calcDebt(); });
    }

    setTimeout(() => {
      document.querySelectorAll('.dp-strat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.dp-strat-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white'); b.classList.add('bg-surface-alt', 'text-text-secondary'); });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary'); btn.classList.add('bg-primary', 'text-white');
          dpStrat = (btn as HTMLElement).dataset.strat || 'avalanche';
          calcDebt();
        });
      });

      document.querySelectorAll('.dp-row input').forEach(el => el.addEventListener('input', calcDebt));
      document.querySelectorAll('.dp-rm').forEach(btn => {
        btn.addEventListener('click', () => { (btn as HTMLElement).closest('.dp-row')!.remove(); calcDebt(); });
      });
      document.getElementById('dp-add')!.addEventListener('click', addRow);
      document.getElementById('dp-extra')!.addEventListener('input', calcDebt);

      calcDebt();
    }, 50);
  </script>
</CalculatorLayout>
