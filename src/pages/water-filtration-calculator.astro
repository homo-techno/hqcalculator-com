---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Water Filtration Calculator - Filter Type & Replacement Schedule";
const description = "Select the right water filter type based on contaminants, calculate flow rate requirements, replacement schedules, and estimate annual filtration costs.";
const relatedCalcs = [
  { name: "Water Quality", url: "/water-quality-calculator", description: "Water quality analysis." },
  { name: "Water Usage", url: "/water-usage-calculator", description: "Daily water consumption." },
  { name: "Well Water", url: "/well-water-calculator", description: "Well water testing." },
  { name: "Water Intake", url: "/water-intake-calculator", description: "Personal water needs." },
  { name: "Electricity Cost", url: "/electricity-cost-calculator", description: "Energy cost estimates." },
  { name: "Pool Volume", url: "/pool-volume-calculator", description: "Water volume." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Water Filtration Calculator" keywords="water filter calculator, filtration cost, replacement schedule, contaminant removal, filter sizing" breadcrumbs={[{ name: "Water Filtration", url: "/water-filtration-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Water Filtration Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Find the right filtration system for your water quality concerns and calculate ongoing costs.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-text mb-1">Water Source</label>
          <select id="wf2-source" class="wf2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="muni" selected>Municipal (city water)</option>
            <option value="well">Well Water</option>
          </select>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-3">Primary Concerns (check all that apply)</h3>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="wf2-chlorine" class="wf2-in" checked> Chlorine/taste/odor</label>
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="wf2-lead" class="wf2-in"> Lead</label>
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="wf2-sediment" class="wf2-in" checked> Sediment</label>
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="wf2-bacteria" class="wf2-in"> Bacteria/viruses</label>
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="wf2-hardness" class="wf2-in"> Hardness/scale</label>
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="wf2-pfas" class="wf2-in"> PFAS/chemicals</label>
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="wf2-iron" class="wf2-in"> Iron/manganese</label>
            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="wf2-nitrate" class="wf2-in"> Nitrate</label>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Household Size (people)</label>
            <input type="number" id="wf2-people" class="wf2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="4" min="1" max="20" step="1">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Daily Usage (gallons)</label>
            <input type="number" id="wf2-usage" class="wf2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="80" min="10" step="10">
          </div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Recommended Filter System</div>
          <div class="text-4xl font-extrabold" id="wf2-system">--</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Flow Rate Needed</div><div class="text-xl font-bold" id="wf2-flow">0 GPM</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Filter Life</div><div class="text-xl font-bold" id="wf2-life">0 months</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Replacement Cost</div><div class="text-xl font-bold" id="wf2-repcost">$0</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Annual Cost</div><div class="text-xl font-bold" id="wf2-annual">$0</div></div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-3">System Details</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span>System Type</span><span class="font-bold" id="wf2-type">--</span></div>
            <div class="flex justify-between"><span>Stages</span><span class="font-bold" id="wf2-stages">--</span></div>
            <div class="flex justify-between"><span>Install Cost Estimate</span><span class="font-bold" id="wf2-install">$0</span></div>
            <div class="flex justify-between"><span>Annual Gallons Filtered</span><span class="font-bold" id="wf2-anngal">0</span></div>
            <div class="flex justify-between"><span>Cost Per Gallon</span><span class="font-bold" id="wf2-cpg">$0.00</span></div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="water-filtration" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcWF2() {
      const source = (document.getElementById('wf2-source') as HTMLSelectElement).value;
      const people = parseInt((document.getElementById('wf2-people') as HTMLInputElement).value) || 4;
      const usage = parseFloat((document.getElementById('wf2-usage') as HTMLInputElement).value) || 80;
      const chlorine = (document.getElementById('wf2-chlorine') as HTMLInputElement).checked;
      const lead = (document.getElementById('wf2-lead') as HTMLInputElement).checked;
      const sediment = (document.getElementById('wf2-sediment') as HTMLInputElement).checked;
      const bacteria = (document.getElementById('wf2-bacteria') as HTMLInputElement).checked;
      const hardness = (document.getElementById('wf2-hardness') as HTMLInputElement).checked;
      const pfas = (document.getElementById('wf2-pfas') as HTMLInputElement).checked;
      const iron = (document.getElementById('wf2-iron') as HTMLInputElement).checked;
      const nitrate = (document.getElementById('wf2-nitrate') as HTMLInputElement).checked;

      // Score concerns to determine system type
      let score = 0;
      if (chlorine) score += 1;
      if (lead) score += 2;
      if (sediment) score += 1;
      if (bacteria) score += 3;
      if (hardness) score += 2;
      if (pfas) score += 3;
      if (iron) score += 2;
      if (nitrate) score += 3;
      if (source === 'well') score += 2;

      let system = 'Carbon Filter';
      let type = 'Under-Sink Carbon Block';
      let stages = '1-2 stages';
      let installCost = 150;
      let filterCost = 30;
      let filterLife = 6; // months
      let filterCapacity = 10000; // gallons

      if (score >= 10 || (bacteria && pfas) || (nitrate && lead)) {
        system = 'Reverse Osmosis';
        type = 'Whole-house or under-sink RO system';
        stages = '4-5 stages (sediment + carbon + RO + post-carbon + remineralize)';
        installCost = 1500;
        filterCost = 120;
        filterLife = 12;
        filterCapacity = 50000;
      } else if (score >= 6 || bacteria || pfas || nitrate) {
        system = 'Multi-Stage RO';
        type = 'Under-sink reverse osmosis';
        stages = '3-4 stages (sediment + carbon + RO membrane)';
        installCost = 400;
        filterCost = 80;
        filterLife = 12;
        filterCapacity = 15000;
      } else if (hardness || iron) {
        system = 'Softener + Carbon';
        type = 'Whole-house softener with carbon pre-filter';
        stages = '2 stages (softener + carbon)';
        installCost = 1200;
        filterCost = 60;
        filterLife = 12;
        filterCapacity = 100000;
      } else if (score >= 3 || lead) {
        system = 'Multi-Stage Carbon';
        type = 'Under-sink multi-stage carbon';
        stages = '2-3 stages (sediment + carbon block + post-filter)';
        installCost = 250;
        filterCost = 50;
        filterLife = 6;
        filterCapacity = 15000;
      }

      const annualGallons = usage * 365;
      const flowRate = usage / (8 * 60); // spread over 8 active hours, in GPM
      const peakGPM = flowRate * 3; // peak is ~3x average

      // Actual filter life based on usage
      const actualLifeDays = filterCapacity / usage;
      const actualLifeMonths = Math.min(filterLife, actualLifeDays / 30);
      const replacementsPerYear = 12 / actualLifeMonths;
      const annualFilterCost = filterCost * replacementsPerYear;
      const costPerGallon = annualFilterCost / annualGallons;

      document.getElementById('wf2-system')!.textContent = system;
      document.getElementById('wf2-flow')!.textContent = peakGPM.toFixed(1) + ' GPM';
      document.getElementById('wf2-life')!.textContent = actualLifeMonths.toFixed(0) + ' months';
      document.getElementById('wf2-repcost')!.textContent = '$' + filterCost;
      document.getElementById('wf2-annual')!.textContent = '$' + Math.round(annualFilterCost);
      document.getElementById('wf2-type')!.textContent = type;
      document.getElementById('wf2-stages')!.textContent = stages;
      document.getElementById('wf2-install')!.textContent = '$' + installCost.toLocaleString();
      document.getElementById('wf2-anngal')!.textContent = annualGallons.toLocaleString();
      document.getElementById('wf2-cpg')!.textContent = '$' + costPerGallon.toFixed(4);

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.wf2-in').forEach(el => { el.addEventListener('input', calcWF2); el.addEventListener('change', calcWF2); });
      calcWF2();
    }, 50);
  </script>
</CalculatorLayout>
