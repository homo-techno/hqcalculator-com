---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Welding Rod Calculator - Electrode & Filler Rod Consumption";
const description = "Calculate electrode and filler rod consumption based on joint type, material thickness, weld length, and process. Estimate rods needed for your welding project.";

const relatedCalcs = [
  { name: "Welding Gas Calculator", url: "/welding-gas-calculator", description: "Shielding gas flow and duration." },
  { name: "Welding Heat Input", url: "/welding-heat-input-calculator", description: "Heat input from parameters." },
  { name: "Welding Cost Calculator", url: "/welding-cost-calculator", description: "Total welding job cost." },
  { name: "Metal Weight Calculator", url: "/metal-weight-calculator", description: "Weight of metal shapes." },
  { name: "Weld Symbol Calculator", url: "/weld-symbol-calculator", description: "Weld joint dimensions." },
  { name: "Structural Steel Calculator", url: "/structural-steel-calculator", description: "I-beam and section properties." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Welding Rod Calculator"
  keywords="welding rod calculator, electrode consumption, filler rod, welding rods needed, electrode usage, SMAW rod, MIG wire, TIG rod"
  breadcrumbs={[{ name: "Welding Rod Calculator", url: "/welding-rod-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Welding Rod Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate electrode and filler rod consumption based on joint type, material thickness, and weld length.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <!-- Welding Process -->
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Welding Process</label>
        <select id="wr2-process" class="wr2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="smaw">SMAW (Stick)</option>
          <option value="gmaw">GMAW (MIG)</option>
          <option value="gtaw">GTAW (TIG)</option>
          <option value="fcaw">FCAW (Flux-Core)</option>
        </select>
      </div>

      <!-- Joint Type -->
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Joint Type</label>
        <select id="wr2-joint" class="wr2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="butt">Butt Joint (V-Groove)</option>
          <option value="fillet">Fillet Weld (T-Joint)</option>
          <option value="lap">Lap Joint</option>
          <option value="corner">Corner Joint</option>
        </select>
      </div>

      <!-- Material Thickness -->
      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Material Thickness</label>
          <input type="number" id="wr2-thickness" class="wr2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="6" min="0.5" step="0.5">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Unit</label>
          <select id="wr2-unit" class="wr2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="mm">mm</option>
            <option value="in">inches</option>
          </select>
        </div>
      </div>

      <!-- Weld Length -->
      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Weld Length</label>
          <input type="number" id="wr2-length" class="wr2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="1000" min="1" step="10">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Length Unit</label>
          <select id="wr2-lunit" class="wr2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="mm">mm</option>
            <option value="in">inches</option>
            <option value="ft">feet</option>
            <option value="m">meters</option>
          </select>
        </div>
      </div>

      <!-- Rod Diameter -->
      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Rod/Wire Diameter</label>
          <select id="wr2-rod" class="wr2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="2.4">2.4 mm (3/32")</option>
            <option value="3.2" selected>3.2 mm (1/8")</option>
            <option value="4.0">4.0 mm (5/32")</option>
            <option value="5.0">5.0 mm (3/16")</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Deposition Efficiency (%)</label>
          <input type="number" id="wr2-eff" class="wr2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="65" min="30" max="98" step="1">
        </div>
      </div>

      <!-- Results -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Filler Metal Required</div>
        <div class="text-4xl font-extrabold" id="wr2-weight">--</div>
        <div class="text-sm text-blue-200 mt-1" id="wr2-weight-unit">kg</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Weld Volume</div>
          <div class="text-xl font-bold" id="wr2-volume">--</div>
          <div class="text-xs text-text-muted">cm³</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Deposited Weight</div>
          <div class="text-xl font-bold" id="wr2-deposited">--</div>
          <div class="text-xs text-text-muted">kg</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Rods/Sticks Needed</div>
          <div class="text-xl font-bold" id="wr2-rods">--</div>
          <div class="text-xs text-text-muted">350mm (14") rods</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Number of Passes</div>
          <div class="text-xl font-bold" id="wr2-passes">--</div>
          <div class="text-xs text-text-muted">estimated</div>
        </div>
      </div>

      <ShareButton calculatorId="welding-rod" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How to Calculate Welding Rod Consumption</h2>
      <p>The amount of filler metal depends on the cross-sectional area of the weld joint, the length of the weld, and the deposition efficiency of the welding process.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Weld Volume</strong> = Cross-Section Area x Weld Length</p>
        <p><strong>Deposited Metal Weight</strong> = Volume x Density (7.85 g/cm³ for steel)</p>
        <p><strong>Filler Metal Required</strong> = Deposited Weight / Deposition Efficiency</p>
      </div>
      <h3 class="text-xl font-semibold text-text mt-8">Deposition Efficiency by Process</h3>
      <ul>
        <li><strong>SMAW (Stick):</strong> 55-70% - stub loss and spatter reduce efficiency</li>
        <li><strong>GMAW (MIG):</strong> 90-97% - minimal waste with continuous wire feed</li>
        <li><strong>GTAW (TIG):</strong> 95-100% - very precise with minimal waste</li>
        <li><strong>FCAW (Flux-Core):</strong> 80-90% - flux adds to weight but reduces usable metal</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcWR2() {
      const process = (document.getElementById('wr2-process') as HTMLSelectElement).value;
      const joint = (document.getElementById('wr2-joint') as HTMLSelectElement).value;
      const thickness = parseFloat((document.getElementById('wr2-thickness') as HTMLInputElement).value) || 0;
      const thickUnit = (document.getElementById('wr2-unit') as HTMLSelectElement).value;
      const length = parseFloat((document.getElementById('wr2-length') as HTMLInputElement).value) || 0;
      const lUnit = (document.getElementById('wr2-lunit') as HTMLSelectElement).value;
      const rodDia = parseFloat((document.getElementById('wr2-rod') as HTMLSelectElement).value) || 3.2;
      const eff = (parseFloat((document.getElementById('wr2-eff') as HTMLInputElement).value) || 65) / 100;

      // Convert thickness to mm
      let t_mm = thickUnit === 'in' ? thickness * 25.4 : thickness;

      // Convert weld length to mm
      let l_mm = length;
      if (lUnit === 'in') l_mm = length * 25.4;
      else if (lUnit === 'ft') l_mm = length * 304.8;
      else if (lUnit === 'm') l_mm = length * 1000;

      // Cross-section area in mm² based on joint type
      let area_mm2 = 0;
      let passes = 1;
      if (joint === 'butt') {
        // V-groove: 60° included angle, root gap ~2mm
        const rootGap = 2;
        const grooveAngle = 60;
        const halfAngle = (grooveAngle / 2) * Math.PI / 180;
        area_mm2 = t_mm * rootGap + Math.tan(halfAngle) * t_mm * t_mm;
      } else if (joint === 'fillet') {
        // Fillet weld: leg size ~ 0.7 * thickness
        const leg = Math.min(t_mm, t_mm * 0.7);
        area_mm2 = 0.5 * leg * leg;
      } else if (joint === 'lap') {
        const leg = Math.min(t_mm, t_mm * 0.7);
        area_mm2 = 0.5 * leg * leg;
      } else if (joint === 'corner') {
        const leg = t_mm * 0.7;
        area_mm2 = 0.5 * leg * leg;
      }

      // Reinforcement factor (10% extra for crown)
      area_mm2 *= 1.1;

      // Volume in cm³
      const volume_cm3 = (area_mm2 * l_mm) / 1000;

      // Steel density 7.85 g/cm³
      const density = 7.85;
      const deposited_kg = (volume_cm3 * density) / 1000;

      // Filler metal required (accounting for efficiency)
      const filler_kg = deposited_kg / eff;

      // Number of passes: based on max single-pass cross-section area
      const maxPassArea = Math.PI * (rodDia / 2) * (rodDia / 2) * 1.5;
      passes = Math.max(1, Math.ceil(area_mm2 / maxPassArea));

      // Number of rods (SMAW: 350mm rod, ~60% usable)
      let rodsNeeded = 0;
      if (process === 'smaw') {
        const rodLength_mm = 350;
        const usableLength = rodLength_mm * 0.85;
        const rodCrossArea = Math.PI * (rodDia / 2) * (rodDia / 2);
        const rodVolume_cm3 = (rodCrossArea * usableLength) / 1000;
        const rodWeight_kg = (rodVolume_cm3 * density) / 1000;
        rodsNeeded = Math.ceil(filler_kg / rodWeight_kg);
      } else {
        // For wire processes, show equivalent in terms of rod lengths
        const rodCrossArea = Math.PI * (rodDia / 2) * (rodDia / 2);
        const rodVolume_cm3 = (rodCrossArea * 350) / 1000;
        const rodWeight_kg = (rodVolume_cm3 * density) / 1000;
        rodsNeeded = Math.ceil(filler_kg / rodWeight_kg);
      }

      document.getElementById('wr2-weight')!.textContent = filler_kg.toFixed(2);
      document.getElementById('wr2-volume')!.textContent = volume_cm3.toFixed(1);
      document.getElementById('wr2-deposited')!.textContent = deposited_kg.toFixed(2);
      document.getElementById('wr2-rods')!.textContent = String(rodsNeeded);
      document.getElementById('wr2-passes')!.textContent = String(passes);

      // Update efficiency based on process
      const effInput = document.getElementById('wr2-eff') as HTMLInputElement;
      if (process === 'smaw' && eff === 0.65) {} // default
      // Don't auto-change, user can override

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.wr2-in').forEach(el => {
        el.addEventListener('input', calcWR2);
        el.addEventListener('change', calcWR2);
      });
      calcWR2();
    }, 50);
  </script>
</CalculatorLayout>
