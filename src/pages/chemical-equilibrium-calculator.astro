---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Chemical Equilibrium Calculator - Kc, Kp, Q & Le Chatelier";
const description = "Calculate equilibrium constant Kc and Kp, reaction quotient Q, convert between Kc and Kp, and predict Le Chatelier shifts.";
const relatedCalcs = [
  { name: "Stoichiometry", url: "/stoichiometry-calculator", description: "Reaction stoichiometry." },
  { name: "Ideal Gas Law", url: "/ideal-gas-law-calculator", description: "Gas calculations." },
  { name: "Molarity Calculator", url: "/molarity-calculator", description: "Solution concentration." },
  { name: "pH Calculator", url: "/ph-calculator", description: "pH calculations." },
  { name: "Logarithm Calculator", url: "/logarithm-calculator", description: "Logarithm calculations." },
  { name: "Scientific Notation", url: "/scientific-notation-calculator", description: "Scientific notation." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Chemical Equilibrium Calculator" keywords="chemical equilibrium, Kc, Kp, reaction quotient, Le Chatelier, equilibrium constant, Gibbs energy" breadcrumbs={[{ name: "Chemical Equilibrium", url: "/chemical-equilibrium-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Chemical Equilibrium Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate Kc, Kp, reaction quotient Q, and predict equilibrium shifts.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="flex gap-2 mb-2">
          <button id="ce-m1" class="ce-mode flex-1 py-2 rounded-xl border-2 border-primary bg-blue-50 text-primary font-bold text-sm" data-mode="kc">Calculate Kc</button>
          <button id="ce-m2" class="ce-mode flex-1 py-2 rounded-xl border-2 border-border text-text-muted font-bold text-sm" data-mode="convert">Kc <-> Kp</button>
          <button id="ce-m3" class="ce-mode flex-1 py-2 rounded-xl border-2 border-border text-text-muted font-bold text-sm" data-mode="quotient">Q vs K</button>
        </div>

        <div id="ce-panel-kc">
          <p class="text-xs text-text-muted mb-2">For aA + bB <-> cC + dD: Kc = [C]^c[D]^d / [A]^a[B]^b</p>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="block text-xs font-medium text-text mb-1">[A] (M)</label><input type="number" id="ce-a" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" step="0.01"></div>
            <div><label class="block text-xs font-medium text-text mb-1">Coeff. a</label><input type="number" id="ce-ca" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="1" step="1"></div>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <div><label class="block text-xs font-medium text-text mb-1">[B] (M)</label><input type="number" id="ce-b" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" step="0.01"></div>
            <div><label class="block text-xs font-medium text-text mb-1">Coeff. b</label><input type="number" id="ce-cb" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" step="1"></div>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <div><label class="block text-xs font-medium text-text mb-1">[C] (M)</label><input type="number" id="ce-c" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" step="0.01"></div>
            <div><label class="block text-xs font-medium text-text mb-1">Coeff. c</label><input type="number" id="ce-cc" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="1" step="1"></div>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <div><label class="block text-xs font-medium text-text mb-1">[D] (M)</label><input type="number" id="ce-d" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" step="0.01"></div>
            <div><label class="block text-xs font-medium text-text mb-1">Coeff. d</label><input type="number" id="ce-cd" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="0" step="1"></div>
          </div>
        </div>

        <div id="ce-panel-convert" class="hidden">
          <div class="grid grid-cols-2 gap-3">
            <div><label class="block text-xs font-medium text-text mb-1">Kc Value</label><input type="number" id="ce-kc" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
            <div><label class="block text-xs font-medium text-text mb-1">Temperature (K)</label><input type="number" id="ce-temp" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="1" step="1"></div>
          </div>
          <div class="mt-3"><label class="block text-xs font-medium text-text mb-1">Delta n (moles gas products - moles gas reactants)</label><input type="number" id="ce-dn" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="1"></div>
        </div>

        <div id="ce-panel-quotient" class="hidden">
          <div class="grid grid-cols-2 gap-3">
            <div><label class="block text-xs font-medium text-text mb-1">Equilibrium Constant (K)</label><input type="number" id="ce-keq" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
            <div><label class="block text-xs font-medium text-text mb-1">Reaction Quotient (Q)</label><input type="number" id="ce-qval" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
          </div>
          <div class="mt-3"><label class="block text-xs font-medium text-text mb-1">Temperature (K)</label><input type="number" id="ce-tq" class="ce-in w-full px-4 py-3 border border-border rounded-xl font-bold" min="1" step="1"></div>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1" id="ce-label">Equilibrium Constant Kc</div>
          <div class="text-5xl font-extrabold font-mono" id="ce-result">--</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase" id="ce-s1l">ln(K)</div><div class="text-xl font-bold font-mono" id="ce-s1">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase" id="ce-s2l">Delta G° (kJ/mol)</div><div class="text-xl font-bold font-mono" id="ce-s2">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase" id="ce-s3l">Favors</div><div class="text-xl font-bold font-mono" id="ce-s3">--</div></div>
        </div>
      </div>
      <ShareButton calculatorId="chemical-equilibrium" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    const RG = 8.314;
    let ceMode = 'kc';

    function setCeMode(m: string) {
      ceMode = m;
      document.getElementById('ce-panel-kc')!.classList.toggle('hidden', m !== 'kc');
      document.getElementById('ce-panel-convert')!.classList.toggle('hidden', m !== 'convert');
      document.getElementById('ce-panel-quotient')!.classList.toggle('hidden', m !== 'quotient');
      document.querySelectorAll('.ce-mode').forEach(b => {
        const btn = b as HTMLButtonElement;
        const active = btn.dataset.mode === m;
        btn.className = `ce-mode flex-1 py-2 rounded-xl border-2 font-bold text-sm ${active ? 'border-primary bg-blue-50 text-primary' : 'border-border text-text-muted'}`;
      });
      calcCE();
    }

    function calcCE() {
      const label = document.getElementById('ce-label')!;
      const result = document.getElementById('ce-result')!;

      if (ceMode === 'kc') {
        const A = parseFloat((document.getElementById('ce-a') as HTMLInputElement).value) || 0.001;
        const ca = parseFloat((document.getElementById('ce-ca') as HTMLInputElement).value) || 1;
        const B = parseFloat((document.getElementById('ce-b') as HTMLInputElement).value) || 0.001;
        const cb = parseFloat((document.getElementById('ce-cb') as HTMLInputElement).value) || 0;
        const C = parseFloat((document.getElementById('ce-c') as HTMLInputElement).value) || 0.001;
        const cc = parseFloat((document.getElementById('ce-cc') as HTMLInputElement).value) || 1;
        const D = parseFloat((document.getElementById('ce-d') as HTMLInputElement).value) || 0.001;
        const cd = parseFloat((document.getElementById('ce-cd') as HTMLInputElement).value) || 0;
        const numerator = Math.pow(C, cc) * (cd > 0 ? Math.pow(D, cd) : 1);
        const denominator = Math.pow(A, ca) * (cb > 0 ? Math.pow(B, cb) : 1);
        const Kc = denominator > 0 ? numerator / denominator : 0;
        const lnK = Kc > 0 ? Math.log(Kc) : 0;
        const dG = -RG * 298 * lnK / 1000; // kJ/mol at 298K
        let favors: string;
        if (Kc > 1000) favors = 'Products >';
        else if (Kc > 1) favors = 'Products';
        else if (Kc > 0.001) favors = 'Reactants';
        else favors = 'Reactants >';
        label.textContent = 'Equilibrium Constant Kc';
        result.textContent = Kc >= 1e6 || Kc < 0.001 ? Kc.toExponential(4) : Kc.toFixed(4);
        document.getElementById('ce-s1l')!.textContent = 'ln(K)';
        document.getElementById('ce-s1')!.textContent = lnK.toFixed(4);
        document.getElementById('ce-s2l')!.textContent = '\u0394G\u00B0 (kJ/mol)';
        document.getElementById('ce-s2')!.textContent = dG.toFixed(2);
        document.getElementById('ce-s3l')!.textContent = 'Favors';
        document.getElementById('ce-s3')!.textContent = favors;
      } else if (ceMode === 'convert') {
        const Kc = parseFloat((document.getElementById('ce-kc') as HTMLInputElement).value) || 1;
        const T = parseFloat((document.getElementById('ce-temp') as HTMLInputElement).value) || 298;
        const dn = parseFloat((document.getElementById('ce-dn') as HTMLInputElement).value) || 0;
        // Kp = Kc * (RT)^dn, R = 0.08206 L·atm/(mol·K)
        const Kp = Kc * Math.pow(0.08206 * T, dn);
        const lnKp = Kp > 0 ? Math.log(Kp) : 0;
        const dG = -RG * T * lnKp / 1000;
        label.textContent = 'Kp (pressure-based)';
        result.textContent = Kp >= 1e6 || (Kp > 0 && Kp < 0.001) ? Kp.toExponential(4) : Kp.toFixed(4);
        document.getElementById('ce-s1l')!.textContent = 'Kc (given)';
        document.getElementById('ce-s1')!.textContent = Kc >= 1e6 ? Kc.toExponential(4) : Kc.toFixed(4);
        document.getElementById('ce-s2l')!.textContent = '\u0394G\u00B0 (kJ/mol)';
        document.getElementById('ce-s2')!.textContent = dG.toFixed(2);
        document.getElementById('ce-s3l')!.textContent = '(RT)^\u0394n';
        document.getElementById('ce-s3')!.textContent = Math.pow(0.08206 * T, dn).toFixed(4);
      } else {
        const K = parseFloat((document.getElementById('ce-keq') as HTMLInputElement).value) || 1;
        const Q = parseFloat((document.getElementById('ce-qval') as HTMLInputElement).value) || 1;
        const T = parseFloat((document.getElementById('ce-tq') as HTMLInputElement).value) || 298;
        let direction: string;
        if (Math.abs(Q - K) / Math.max(K, 1e-10) < 0.01) direction = 'At Equilibrium';
        else if (Q < K) direction = 'Shift RIGHT (toward products)';
        else direction = 'Shift LEFT (toward reactants)';
        const dG = RG * T * Math.log(Q / K) / 1000;
        label.textContent = 'Le Chatelier Prediction';
        result.textContent = direction;
        document.getElementById('ce-s1l')!.textContent = 'Q/K Ratio';
        document.getElementById('ce-s1')!.textContent = (Q / K).toFixed(4);
        document.getElementById('ce-s2l')!.textContent = '\u0394G (kJ/mol)';
        document.getElementById('ce-s2')!.textContent = dG.toFixed(2);
        document.getElementById('ce-s3l')!.textContent = 'Direction';
        document.getElementById('ce-s3')!.textContent = Q < K ? '\u2192 Products' : Q > K ? '\u2190 Reactants' : 'Balanced';
      }
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      (document.getElementById('ce-a') as HTMLInputElement).value = '0.5';
      (document.getElementById('ce-ca') as HTMLInputElement).value = '1';
      (document.getElementById('ce-b') as HTMLInputElement).value = '0.3';
      (document.getElementById('ce-cb') as HTMLInputElement).value = '1';
      (document.getElementById('ce-c') as HTMLInputElement).value = '0.8';
      (document.getElementById('ce-cc') as HTMLInputElement).value = '1';
      (document.getElementById('ce-d') as HTMLInputElement).value = '0.4';
      (document.getElementById('ce-cd') as HTMLInputElement).value = '1';
      (document.getElementById('ce-kc') as HTMLInputElement).value = '4.5';
      (document.getElementById('ce-temp') as HTMLInputElement).value = '298';
      (document.getElementById('ce-dn') as HTMLInputElement).value = '-2';
      (document.getElementById('ce-keq') as HTMLInputElement).value = '10';
      (document.getElementById('ce-qval') as HTMLInputElement).value = '5';
      (document.getElementById('ce-tq') as HTMLInputElement).value = '298';
      document.querySelectorAll('.ce-mode').forEach(b => b.addEventListener('click', () => setCeMode((b as HTMLButtonElement).dataset.mode!)));
      document.querySelectorAll('.ce-in').forEach(el => { el.addEventListener('input', calcCE); el.addEventListener('change', calcCE); });
      calcCE();
    }, 50);
  </script>
</CalculatorLayout>
