---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Link Budget Calculator - RF Link Budget Analysis 2026";
const description = "Free RF link budget calculator. Compute received signal strength from transmit power, antenna gains, cable losses, free-space path loss, and receiver sensitivity.";

const relatedCalcs = [
  { name: "Free Space Path Loss Calculator", url: "/free-space-path-loss-calculator", description: "Calculate FSPL from frequency and distance." },
  { name: "EIRP Calculator", url: "/eirp-calculator", description: "Effective isotropic radiated power." },
  { name: "Antenna Gain Calculator", url: "/antenna-gain-calculator", description: "Antenna gain from aperture and efficiency." },
  { name: "Fresnel Zone Calculator", url: "/fresnel-zone-calculator", description: "Fresnel zone clearance radius." },
  { name: "Microwave Link Calculator", url: "/microwave-link-calculator", description: "Point-to-point microwave feasibility." },
  { name: "Cable Attenuation Calculator", url: "/cable-attenuation-calculator", description: "Coaxial cable signal attenuation." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Link Budget Calculator"
  keywords="link budget calculator, RF link budget, transmit power, antenna gain, path loss, receiver sensitivity, fade margin, wireless link"
  breadcrumbs={[{ name: "Link Budget Calculator", url: "/link-budget-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Link Budget Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate the received signal power and fade margin for an RF wireless link by accounting for all gains and losses in the signal path.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <h2 class="text-lg font-bold text-text mb-4">Transmitter</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Transmit Power (dBm)</label>
        <input type="number" id="lbg-tx-power" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="30" step="0.1">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">TX Cable/Connector Loss (dB)</label>
        <input type="number" id="lbg-tx-loss" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="2" step="0.1" min="0">
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-text mb-1">TX Antenna Gain (dBi)</label>
        <input type="number" id="lbg-tx-gain" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="10" step="0.1">
      </div>

      <h2 class="text-lg font-bold text-text mb-4">Path</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Frequency (MHz)</label>
        <input type="number" id="lbg-freq" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="2400" step="1" min="1">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">Distance (km)</label>
        <input type="number" id="lbg-dist" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="5" step="0.1" min="0.001">
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-text mb-1">Additional Path Losses (dB) - rain, foliage, etc.</label>
        <input type="number" id="lbg-misc-loss" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0" step="0.1" min="0">
      </div>

      <h2 class="text-lg font-bold text-text mb-4">Receiver</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">RX Antenna Gain (dBi)</label>
        <input type="number" id="lbg-rx-gain" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="10" step="0.1">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-text mb-1">RX Cable/Connector Loss (dB)</label>
        <input type="number" id="lbg-rx-loss" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="2" step="0.1" min="0">
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-text mb-1">Receiver Sensitivity (dBm)</label>
        <input type="number" id="lbg-rx-sens" class="lbg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="-85" step="0.1">
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm font-medium text-blue-100 mb-1">Received Signal Power</div>
        <div class="text-4xl font-extrabold" id="lbg-rx-power">--</div>
        <div class="text-sm text-blue-200 mt-1">dBm</div>
      </div>

      <!-- Secondary Stats -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Free Space Path Loss</div>
          <div class="text-xl font-bold text-text" id="lbg-fspl">--</div>
          <div class="text-xs text-text-muted">dB</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">EIRP</div>
          <div class="text-xl font-bold text-text" id="lbg-eirp">--</div>
          <div class="text-xs text-text-muted">dBm</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Fade Margin</div>
          <div class="text-xl font-bold text-text" id="lbg-margin">--</div>
          <div class="text-xs text-text-muted">dB</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted mb-1">Link Status</div>
          <div class="text-xl font-bold" id="lbg-status">--</div>
        </div>
      </div>

      <ShareButton calculatorId="link-budget" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How RF Link Budget Works</h2>
      <p>A link budget accounts for all gains and losses in a wireless communication path, from transmitter to receiver. It determines whether a signal will arrive with enough power for the receiver to decode it.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono text-sm">
        P_rx = P_tx - L_tx_cable + G_tx - FSPL - L_misc + G_rx - L_rx_cable
      </div>
      <p>Where FSPL (Free Space Path Loss) = 20*log10(d) + 20*log10(f) + 32.44, with d in km and f in MHz.</p>
      <h3 class="text-xl font-semibold text-text mt-8">Fade Margin</h3>
      <p>The fade margin is the difference between the received signal power and the receiver sensitivity. A positive fade margin means the link can tolerate additional losses (rain, multipath, etc.). Typical designs target 10-20 dB of fade margin for reliable links.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcLBG() {
      const txPower = parseFloat((document.getElementById('lbg-tx-power') as HTMLInputElement).value) || 0;
      const txLoss = parseFloat((document.getElementById('lbg-tx-loss') as HTMLInputElement).value) || 0;
      const txGain = parseFloat((document.getElementById('lbg-tx-gain') as HTMLInputElement).value) || 0;
      const freq = parseFloat((document.getElementById('lbg-freq') as HTMLInputElement).value) || 1;
      const dist = parseFloat((document.getElementById('lbg-dist') as HTMLInputElement).value) || 0.001;
      const miscLoss = parseFloat((document.getElementById('lbg-misc-loss') as HTMLInputElement).value) || 0;
      const rxGain = parseFloat((document.getElementById('lbg-rx-gain') as HTMLInputElement).value) || 0;
      const rxLoss = parseFloat((document.getElementById('lbg-rx-loss') as HTMLInputElement).value) || 0;
      const rxSens = parseFloat((document.getElementById('lbg-rx-sens') as HTMLInputElement).value) || -85;

      const fspl = 20 * Math.log10(dist) + 20 * Math.log10(freq) + 32.44;
      const eirp = txPower - txLoss + txGain;
      const rxPower = eirp - fspl - miscLoss + rxGain - rxLoss;
      const margin = rxPower - rxSens;

      document.getElementById('lbg-rx-power')!.textContent = rxPower.toFixed(2);
      document.getElementById('lbg-fspl')!.textContent = fspl.toFixed(2);
      document.getElementById('lbg-eirp')!.textContent = eirp.toFixed(2);
      document.getElementById('lbg-margin')!.textContent = margin.toFixed(2);

      const statusEl = document.getElementById('lbg-status')!;
      if (margin >= 20) {
        statusEl.textContent = 'Excellent';
        statusEl.className = 'text-xl font-bold text-green-600';
      } else if (margin >= 10) {
        statusEl.textContent = 'Good';
        statusEl.className = 'text-xl font-bold text-green-500';
      } else if (margin >= 0) {
        statusEl.textContent = 'Marginal';
        statusEl.className = 'text-xl font-bold text-yellow-500';
      } else {
        statusEl.textContent = 'No Link';
        statusEl.className = 'text-xl font-bold text-red-500';
      }

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.lbg-in').forEach(el => { el.addEventListener('input', calcLBG); el.addEventListener('change', calcLBG); });
      calcLBG();
    }, 50);
  </script>
</CalculatorLayout>
