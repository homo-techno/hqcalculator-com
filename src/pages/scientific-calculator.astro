---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Scientific Calculator - Free Online Scientific Calculator";
const description = "Free online scientific calculator with trigonometry, logarithms, exponents, factorials, and more. Supports parentheses, memory functions, and degree/radian modes.";

const relatedCalcs = [
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Calculate percentages." },
  { name: "Fraction Calculator", url: "/fraction-calculator", description: "Fraction operations." },
  { name: "Square Root Calculator", url: "/square-root-calculator", description: "Find square roots." },
  { name: "Exponent Calculator", url: "/exponent-calculator", description: "Powers and exponents." },
  { name: "Logarithm Calculator", url: "/logarithm-calculator", description: "Log and natural log." },
  { name: "GPA Calculator", url: "/gpa-calculator", description: "Grade point average." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Scientific Calculator"
  keywords="scientific calculator, online calculator, trigonometry calculator, logarithm calculator, math calculator, advanced calculator"
  breadcrumbs={[{ name: "Scientific Calculator", url: "/scientific-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Scientific Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">A full-featured scientific calculator with trigonometry, logarithms, exponents, and more.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-lg mx-auto">
      <!-- Display -->
      <div class="bg-gray-900 rounded-xl p-4 mb-4">
        <div class="text-right text-gray-400 text-sm h-6 overflow-hidden" id="sci-expression">&nbsp;</div>
        <div class="text-right text-white text-4xl font-mono font-bold overflow-hidden" id="sci-display">0</div>
      </div>

      <!-- Mode Toggle -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex gap-2">
          <button id="sci-deg-btn" class="px-3 py-1 rounded-lg text-xs font-bold bg-primary text-white">DEG</button>
          <button id="sci-rad-btn" class="px-3 py-1 rounded-lg text-xs font-bold bg-surface-alt text-text-secondary">RAD</button>
        </div>
        <div class="flex gap-2">
          <button id="sci-2nd-btn" class="px-3 py-1 rounded-lg text-xs font-bold bg-surface-alt text-text-secondary">2nd</button>
          <span class="text-xs text-text-muted" id="sci-memory-indicator"></span>
        </div>
      </div>

      <!-- Buttons Grid -->
      <div class="grid grid-cols-5 gap-1.5" id="sci-buttons">
        <!-- Row 1: Scientific functions -->
        <button class="sci-btn sci-fn" data-fn="square">x²</button>
        <button class="sci-btn sci-fn" data-fn="cube">x³</button>
        <button class="sci-btn sci-fn" data-fn="power">x<sup>y</sup></button>
        <button class="sci-btn sci-fn" data-fn="sqrt">√x</button>
        <button class="sci-btn sci-fn" data-fn="cbrt">∛x</button>

        <!-- Row 2 -->
        <button class="sci-btn sci-fn" data-fn="sin">sin</button>
        <button class="sci-btn sci-fn" data-fn="cos">cos</button>
        <button class="sci-btn sci-fn" data-fn="tan">tan</button>
        <button class="sci-btn sci-fn" data-fn="ln">ln</button>
        <button class="sci-btn sci-fn" data-fn="log">log</button>

        <!-- Row 3 -->
        <button class="sci-btn sci-fn" data-fn="factorial">n!</button>
        <button class="sci-btn sci-fn" data-fn="pi">π</button>
        <button class="sci-btn sci-fn" data-fn="e">e</button>
        <button class="sci-btn sci-op" data-op="(">(</button>
        <button class="sci-btn sci-op" data-op=")">)</button>

        <!-- Row 4: Memory + operations -->
        <button class="sci-btn sci-mem" data-mem="mc">MC</button>
        <button class="sci-btn sci-num" data-val="7">7</button>
        <button class="sci-btn sci-num" data-val="8">8</button>
        <button class="sci-btn sci-num" data-val="9">9</button>
        <button class="sci-btn sci-operator" data-op="/">÷</button>

        <button class="sci-btn sci-mem" data-mem="mr">MR</button>
        <button class="sci-btn sci-num" data-val="4">4</button>
        <button class="sci-btn sci-num" data-val="5">5</button>
        <button class="sci-btn sci-num" data-val="6">6</button>
        <button class="sci-btn sci-operator" data-op="*">×</button>

        <button class="sci-btn sci-mem" data-mem="m+">M+</button>
        <button class="sci-btn sci-num" data-val="1">1</button>
        <button class="sci-btn sci-num" data-val="2">2</button>
        <button class="sci-btn sci-num" data-val="3">3</button>
        <button class="sci-btn sci-operator" data-op="-">−</button>

        <button class="sci-btn sci-mem" data-mem="m-">M−</button>
        <button class="sci-btn sci-num" data-val="0">0</button>
        <button class="sci-btn sci-num" data-val=".">.</button>
        <button class="sci-btn sci-equal" data-op="=">=</button>
        <button class="sci-btn sci-operator" data-op="+">+</button>
      </div>

      <!-- Control row -->
      <div class="grid grid-cols-3 gap-1.5 mt-1.5">
        <button class="sci-btn sci-clear" id="sci-clear">C</button>
        <button class="sci-btn sci-clear" id="sci-backspace">⌫</button>
        <button class="sci-btn sci-fn" data-fn="negate">±</button>
      </div>

      <div class="mt-6">
        <ShareButton calculatorId="scientific" />
        <FeedbackWidget />
      </div>
    </div>

    <!-- History -->
    <div class="mt-8 bg-white border border-border rounded-2xl p-6 sm:p-8 max-w-lg mx-auto">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-text">History</h2>
        <button id="sci-clear-history" class="text-sm text-text-muted hover:text-danger transition-colors">Clear</button>
      </div>
      <div id="sci-history" class="space-y-2 text-sm max-h-48 overflow-y-auto"></div>
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How to Use the Scientific Calculator</h2>
      <p>This online scientific calculator supports all standard mathematical operations plus advanced functions including trigonometry, logarithms, exponents, and factorials.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Available Functions</h3>
      <ul>
        <li><strong>Basic operations:</strong> Addition (+), subtraction (−), multiplication (×), division (÷)</li>
        <li><strong>Trigonometry:</strong> sin, cos, tan (toggle DEG/RAD mode)</li>
        <li><strong>Inverse trig (2nd):</strong> asin, acos, atan</li>
        <li><strong>Exponents:</strong> x², x³, x^y, square root (√), cube root (∛)</li>
        <li><strong>Logarithms:</strong> ln (natural log), log (base 10)</li>
        <li><strong>Constants:</strong> π (3.14159...), e (2.71828...)</li>
        <li><strong>Other:</strong> Factorial (n!), parentheses, negate (±)</li>
        <li><strong>Memory:</strong> MC (clear), MR (recall), M+ (add to memory), M− (subtract from memory)</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">Keyboard Shortcuts</h3>
      <p>You can use your keyboard: numbers (0-9), operators (+, -, *, /), Enter (=), Escape (clear), Backspace (delete), and period (decimal).</p>

      <h3 class="text-xl font-semibold text-text mt-8">Degree vs. Radian Mode</h3>
      <p>When working with trigonometric functions, make sure you're in the correct angle mode. Most everyday calculations use degrees (360° in a circle), while calculus and physics typically use radians (2π in a circle).</p>

      <h3 class="text-xl font-semibold text-text mt-8">Order of Operations</h3>
      <p>This calculator follows standard mathematical order of operations (PEMDAS/BODMAS): Parentheses first, then Exponents, Multiplication/Division (left to right), and finally Addition/Subtraction (left to right).</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <style>
    .sci-btn {
      padding: 0.625rem 0.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.1s;
      border: 1px solid var(--color-border, #e2e8f0);
      user-select: none;
    }
    .sci-btn:active { transform: scale(0.95); }
    .sci-num { background: #f8fafc; color: #1e293b; }
    .sci-num:hover { background: #e2e8f0; }
    .sci-operator { background: #3b82f6; color: white; border-color: #3b82f6; }
    .sci-operator:hover { background: #2563eb; }
    .sci-equal { background: #10b981; color: white; border-color: #10b981; }
    .sci-equal:hover { background: #059669; }
    .sci-fn { background: #f1f5f9; color: #475569; }
    .sci-fn:hover { background: #e2e8f0; }
    .sci-mem { background: #fef3c7; color: #92400e; border-color: #fde68a; font-size: 0.75rem; }
    .sci-mem:hover { background: #fde68a; }
    .sci-clear { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
    .sci-clear:hover { background: #fecaca; }
    .sci-op { background: #f1f5f9; color: #475569; }
  </style>

  <script>
    let display = '0';
    let expression = '';
    let newNumber = true;
    let memory = 0;
    let degMode = true;
    let secondMode = false;
    const history: string[] = [];

    const displayEl = document.getElementById('sci-display')!;
    const exprEl = document.getElementById('sci-expression')!;

    function updateDisplay() {
      displayEl.textContent = display;
      exprEl.textContent = expression || '\u00A0';
      document.getElementById('sci-memory-indicator')!.textContent = memory !== 0 ? 'M' : '';
    }

    function addHistory(expr: string, result: string) {
      history.unshift(`${expr} = ${result}`);
      if (history.length > 20) history.pop();
      const histEl = document.getElementById('sci-history')!;
      histEl.innerHTML = history.length > 0
        ? history.map(h => `<div class="py-1 px-2 bg-surface-alt rounded text-text-secondary">${h}</div>`).join('')
        : '<div class="text-text-muted">No history yet</div>';
    }

    function toRad(deg: number) { return deg * Math.PI / 180; }
    function toDeg(rad: number) { return rad * 180 / Math.PI; }

    function factorial(n: number): number {
      if (n < 0) return NaN;
      if (n === 0 || n === 1) return 1;
      if (n > 170) return Infinity;
      let result = 1;
      for (let i = 2; i <= Math.floor(n); i++) result *= i;
      return result;
    }

    function applyFunction(fn: string, val: number): number {
      switch (fn) {
        case 'sin': return secondMode ? (degMode ? toDeg(Math.asin(val)) : Math.asin(val)) : Math.sin(degMode ? toRad(val) : val);
        case 'cos': return secondMode ? (degMode ? toDeg(Math.acos(val)) : Math.acos(val)) : Math.cos(degMode ? toRad(val) : val);
        case 'tan': return secondMode ? (degMode ? toDeg(Math.atan(val)) : Math.atan(val)) : Math.tan(degMode ? toRad(val) : val);
        case 'ln': return secondMode ? Math.exp(val) : Math.log(val);
        case 'log': return secondMode ? Math.pow(10, val) : Math.log10(val);
        case 'sqrt': return Math.sqrt(val);
        case 'cbrt': return Math.cbrt(val);
        case 'square': return val * val;
        case 'cube': return val * val * val;
        case 'factorial': return factorial(val);
        case 'negate': return -val;
        default: return val;
      }
    }

    function handleNumber(val: string) {
      if (newNumber) {
        display = val === '.' ? '0.' : val;
        newNumber = false;
      } else {
        if (val === '.' && display.includes('.')) return;
        display += val;
      }
      updateDisplay();
    }

    function handleOperator(op: string) {
      if (op === '(' || op === ')') {
        expression += op;
        updateDisplay();
        return;
      }
      expression += display + ' ' + op + ' ';
      newNumber = true;
      updateDisplay();
    }

    function handleFunction(fn: string) {
      if (fn === 'pi') {
        display = String(Math.PI);
        newNumber = true;
        updateDisplay();
        return;
      }
      if (fn === 'e') {
        display = String(Math.E);
        newNumber = true;
        updateDisplay();
        return;
      }
      if (fn === 'power') {
        expression += display + ' ^ ';
        newNumber = true;
        updateDisplay();
        return;
      }

      const val = parseFloat(display);
      const result = applyFunction(fn, val);
      const fnName = secondMode ?
        (fn === 'sin' ? 'asin' : fn === 'cos' ? 'acos' : fn === 'tan' ? 'atan' : fn === 'ln' ? 'e^' : fn === 'log' ? '10^' : fn) : fn;

      expression = `${fnName}(${display})`;
      display = String(parseFloat(result.toFixed(10)));
      newNumber = true;
      updateDisplay();
    }

    function evaluate() {
      try {
        let expr = expression + display;
        // Replace display symbols
        expr = expr.replace(/÷/g, '/').replace(/×/g, '*').replace(/−/g, '-');
        expr = expr.replace(/\^/g, '**');
        // Safety check — only allow math characters
        if (/^[\d+\-*/().%\s*e]+$/.test(expr)) {
          const result = Function('"use strict"; return (' + expr + ')')();
          addHistory(expression + display, String(parseFloat(Number(result).toFixed(10))));
          expression = '';
          display = String(parseFloat(Number(result).toFixed(10)));
          newNumber = true;
          updateDisplay();
        }
      } catch {
        display = 'Error';
        expression = '';
        newNumber = true;
        updateDisplay();
      }
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    function handleMemory(action: string) {
      const val = parseFloat(display) || 0;
      switch (action) {
        case 'mc': memory = 0; break;
        case 'mr': display = String(memory); newNumber = true; break;
        case 'm+': memory += val; break;
        case 'm-': memory -= val; break;
      }
      updateDisplay();
    }

    setTimeout(() => {
      // Number buttons
      document.querySelectorAll('.sci-num').forEach(btn => {
        btn.addEventListener('click', () => handleNumber((btn as HTMLElement).dataset.val || ''));
      });

      // Operator buttons
      document.querySelectorAll('.sci-operator').forEach(btn => {
        btn.addEventListener('click', () => handleOperator((btn as HTMLElement).dataset.op || ''));
      });

      // Parentheses
      document.querySelectorAll('.sci-op').forEach(btn => {
        btn.addEventListener('click', () => handleOperator((btn as HTMLElement).dataset.op || ''));
      });

      // Function buttons
      document.querySelectorAll('.sci-fn').forEach(btn => {
        btn.addEventListener('click', () => handleFunction((btn as HTMLElement).dataset.fn || ''));
      });

      // Equal
      document.querySelector('.sci-equal')!.addEventListener('click', evaluate);

      // Memory
      document.querySelectorAll('.sci-mem').forEach(btn => {
        btn.addEventListener('click', () => handleMemory((btn as HTMLElement).dataset.mem || ''));
      });

      // Clear
      document.getElementById('sci-clear')!.addEventListener('click', () => {
        display = '0'; expression = ''; newNumber = true; updateDisplay();
      });

      // Backspace
      document.getElementById('sci-backspace')!.addEventListener('click', () => {
        if (display.length > 1) display = display.slice(0, -1);
        else { display = '0'; newNumber = true; }
        updateDisplay();
      });

      // DEG/RAD toggle
      document.getElementById('sci-deg-btn')!.addEventListener('click', () => {
        degMode = true;
        document.getElementById('sci-deg-btn')!.classList.replace('bg-surface-alt', 'bg-primary');
        document.getElementById('sci-deg-btn')!.classList.replace('text-text-secondary', 'text-white');
        document.getElementById('sci-rad-btn')!.classList.replace('bg-primary', 'bg-surface-alt');
        document.getElementById('sci-rad-btn')!.classList.replace('text-white', 'text-text-secondary');
      });
      document.getElementById('sci-rad-btn')!.addEventListener('click', () => {
        degMode = false;
        document.getElementById('sci-rad-btn')!.classList.replace('bg-surface-alt', 'bg-primary');
        document.getElementById('sci-rad-btn')!.classList.replace('text-text-secondary', 'text-white');
        document.getElementById('sci-deg-btn')!.classList.replace('bg-primary', 'bg-surface-alt');
        document.getElementById('sci-deg-btn')!.classList.replace('text-white', 'text-text-secondary');
      });

      // 2nd mode toggle
      document.getElementById('sci-2nd-btn')!.addEventListener('click', () => {
        secondMode = !secondMode;
        const btn = document.getElementById('sci-2nd-btn')!;
        if (secondMode) {
          btn.classList.replace('bg-surface-alt', 'bg-primary');
          btn.classList.replace('text-text-secondary', 'text-white');
          // Update button labels
          document.querySelector('[data-fn="sin"]')!.textContent = 'asin';
          document.querySelector('[data-fn="cos"]')!.textContent = 'acos';
          document.querySelector('[data-fn="tan"]')!.textContent = 'atan';
          document.querySelector('[data-fn="ln"]')!.textContent = 'eˣ';
          document.querySelector('[data-fn="log"]')!.textContent = '10ˣ';
        } else {
          btn.classList.replace('bg-primary', 'bg-surface-alt');
          btn.classList.replace('text-white', 'text-text-secondary');
          document.querySelector('[data-fn="sin"]')!.textContent = 'sin';
          document.querySelector('[data-fn="cos"]')!.textContent = 'cos';
          document.querySelector('[data-fn="tan"]')!.textContent = 'tan';
          document.querySelector('[data-fn="ln"]')!.textContent = 'ln';
          document.querySelector('[data-fn="log"]')!.textContent = 'log';
        }
      });

      // Clear history
      document.getElementById('sci-clear-history')!.addEventListener('click', () => {
        history.length = 0;
        document.getElementById('sci-history')!.innerHTML = '<div class="text-text-muted">No history yet</div>';
      });

      // Keyboard support
      document.addEventListener('keydown', (e) => {
        if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
        if (e.key >= '0' && e.key <= '9') handleNumber(e.key);
        else if (e.key === '.') handleNumber('.');
        else if (e.key === '+') handleOperator('+');
        else if (e.key === '-') handleOperator('-');
        else if (e.key === '*') handleOperator('*');
        else if (e.key === '/') { e.preventDefault(); handleOperator('/'); }
        else if (e.key === '(' || e.key === ')') handleOperator(e.key);
        else if (e.key === 'Enter' || e.key === '=') evaluate();
        else if (e.key === 'Escape') { display = '0'; expression = ''; newNumber = true; updateDisplay(); }
        else if (e.key === 'Backspace') {
          if (display.length > 1) display = display.slice(0, -1);
          else { display = '0'; newNumber = true; }
          updateDisplay();
        }
      });

      updateDisplay();
    }, 50);
  </script>
</CalculatorLayout>
