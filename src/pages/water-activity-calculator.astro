---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Water Activity Calculator - Food Preservation & Safety (aw)";
const description = "Estimate water activity (aw) for food products based on moisture content and solutes. Determine shelf life, microbial safety, and preservation needs.";
const relatedCalcs = [
  { name: "Food Preservation Calculator", url: "/food-preservation-calculator", description: "Canning, drying, and freezing calculations." },
  { name: "Sugar Syrup Calculator", url: "/sugar-syrup-calculator", description: "Sugar syrup concentrations." },
  { name: "Caramel Calculator", url: "/caramel-calculator", description: "Caramel temperature and scaling." },
  { name: "Bread Flour Calculator", url: "/bread-flour-calculator", description: "Flour protein and substitution." },
  { name: "Baking Conversion Calculator", url: "/baking-conversion-calculator", description: "Convert between baking units." },
  { name: "Baker's Percentage Calculator", url: "/baker-percentage-calculator", description: "Baker's percentages for recipes." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Water Activity Calculator" keywords="water activity, aw, food preservation, food safety, shelf life, moisture content, food science" breadcrumbs={[{ name: "Water Activity", url: "/water-activity-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Water Activity Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate water activity (aw) for food products to assess microbial safety, texture, and shelf life requirements.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-text mb-1">Estimation Method</label>
          <select id="wa2-method" class="wa2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="food">Select Food Type</option>
            <option value="manual">Manual (moisture + solute)</option>
          </select>
        </div>
        <div id="wa2-food-section">
          <label class="block text-xs font-medium text-text mb-1">Food Type</label>
          <select id="wa2-food" class="wa2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="bread">Fresh Bread (aw ~0.95-0.97)</option>
            <option value="cake">Cake (aw ~0.90-0.94)</option>
            <option value="cookies">Cookies (aw ~0.30-0.50)</option>
            <option value="jam">Jam / Preserves (aw ~0.75-0.82)</option>
            <option value="honey">Honey (aw ~0.55-0.62)</option>
            <option value="driedfruit">Dried Fruit (aw ~0.55-0.65)</option>
            <option value="jerky">Beef Jerky (aw ~0.70-0.80)</option>
            <option value="chocolate">Chocolate (aw ~0.35-0.45)</option>
            <option value="hardc">Hard Candy (aw ~0.20-0.30)</option>
            <option value="crackers">Crackers (aw ~0.20-0.35)</option>
          </select>
        </div>
        <div id="wa2-manual-section">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Moisture Content (%)</label>
              <input type="number" id="wa2-moisture" class="wa2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="35" min="0" max="100" step="1">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Sugar Content (% of total)</label>
              <input type="number" id="wa2-sugar" class="wa2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="15" min="0" max="80" step="1">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Salt Content (% of total)</label>
              <input type="number" id="wa2-salt" class="wa2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="1" min="0" max="30" step="0.1">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Temperature (&deg;C)</label>
              <input type="number" id="wa2-temp" class="wa2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="25" min="0" max="100" step="1">
            </div>
          </div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Estimated Water Activity (aw)</div>
          <div class="text-5xl font-extrabold font-mono" id="wa2-result">--</div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Microbial Safety</div>
            <div class="text-sm font-bold" id="wa2-safety">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Shelf Stability</div>
            <div class="text-sm font-bold" id="wa2-shelf">--</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Category</div>
            <div class="text-xl font-bold font-mono" id="wa2-category">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Organisms Inhibited Below</div>
            <div class="text-sm font-bold" id="wa2-organisms">--</div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="water-activity" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcWA2() {
      const method = (document.getElementById('wa2-method') as HTMLSelectElement).value;

      let aw = 0;

      if (method === 'food') {
        const food = (document.getElementById('wa2-food') as HTMLSelectElement).value;
        const awValues: Record<string, number> = {
          bread: 0.96, cake: 0.92, cookies: 0.40, jam: 0.80,
          honey: 0.58, driedfruit: 0.60, jerky: 0.75,
          chocolate: 0.40, hardc: 0.25, crackers: 0.28
        };
        aw = awValues[food] || 0.90;
        (document.getElementById('wa2-manual-section') as HTMLElement).style.display = 'none';
        (document.getElementById('wa2-food-section') as HTMLElement).style.display = 'block';
      } else {
        (document.getElementById('wa2-manual-section') as HTMLElement).style.display = 'block';
        (document.getElementById('wa2-food-section') as HTMLElement).style.display = 'none';

        const moisture = parseFloat((document.getElementById('wa2-moisture') as HTMLInputElement).value) || 0;
        const sugarPct = parseFloat((document.getElementById('wa2-sugar') as HTMLInputElement).value) || 0;
        const saltPct = parseFloat((document.getElementById('wa2-salt') as HTMLInputElement).value) || 0;

        // Simplified Raoult's law estimation
        // Water mole fraction considering sugar (MW 342) and salt (MW 58.4) as solutes
        const waterG = moisture;
        const sugarG = sugarPct;
        const saltG = saltPct;
        const waterMoles = waterG / 18.015;
        const sugarMoles = sugarG / 342.3;
        const saltMoles = saltG / 58.44 * 2; // NaCl dissociates into 2 ions

        if (waterMoles <= 0) {
          aw = 0;
        } else {
          const totalMoles = waterMoles + sugarMoles + saltMoles;
          aw = waterMoles / totalMoles;
        }
        // Clamp
        aw = Math.min(1.0, Math.max(0, aw));
      }

      document.getElementById('wa2-result')!.textContent = aw.toFixed(3);

      // Safety assessment
      let safety = '';
      if (aw >= 0.95) safety = 'Supports all pathogens. Refrigerate.';
      else if (aw >= 0.91) safety = 'Most bacteria inhibited. Some molds/yeast may grow.';
      else if (aw >= 0.86) safety = 'Staphylococcus aureus inhibited above 0.86.';
      else if (aw >= 0.80) safety = 'Most bacteria inhibited. Some molds possible.';
      else if (aw >= 0.65) safety = 'Most microorganisms inhibited.';
      else if (aw >= 0.60) safety = 'Osmophilic yeasts and some molds only.';
      else safety = 'Microbiologically stable.';

      let shelf = '';
      if (aw >= 0.90) shelf = 'Days to weeks (refrigerate)';
      else if (aw >= 0.80) shelf = 'Weeks to months';
      else if (aw >= 0.60) shelf = 'Months to 1 year';
      else shelf = '1+ years at room temp';

      let category = '';
      if (aw >= 0.85) category = 'High moisture';
      else if (aw >= 0.60) category = 'Intermediate moisture';
      else category = 'Low moisture';

      let organisms = '';
      if (aw >= 0.95) organisms = 'None - all can grow';
      else if (aw >= 0.91) organisms = 'C. botulinum, Salmonella';
      else if (aw >= 0.87) organisms = 'Most bacteria';
      else if (aw >= 0.80) organisms = 'Most bacteria + some yeasts';
      else if (aw >= 0.65) organisms = 'All bacteria, most yeasts';
      else if (aw >= 0.60) organisms = 'All bacteria & most fungi';
      else organisms = 'Nearly all microorganisms';

      document.getElementById('wa2-safety')!.textContent = safety;
      document.getElementById('wa2-shelf')!.textContent = shelf;
      document.getElementById('wa2-category')!.textContent = category;
      document.getElementById('wa2-organisms')!.textContent = organisms;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.wa2-in').forEach(el => { el.addEventListener('input', calcWA2); el.addEventListener('change', calcWA2); });
      calcWA2();
    }, 50);
  </script>
</CalculatorLayout>
