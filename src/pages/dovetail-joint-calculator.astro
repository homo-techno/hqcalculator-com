---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Dovetail Joint Calculator - Pin & Tail Layout Planner";
const description = "Calculate dovetail joint layout including pin count, tail spacing, angle, and pin width. Plan perfect hand-cut or machine-cut dovetails.";

const relatedCalcs = [
  { name: "Box Joint Calculator", url: "/box-joint-calculator", description: "Box/finger joint layout." },
  { name: "Mortise & Tenon Calculator", url: "/mortise-tenon-calculator", description: "M&T joint dimensions." },
  { name: "Wood Expansion Calculator", url: "/wood-expansion-calculator", description: "Wood movement calculator." },
  { name: "Dado Joint Calculator", url: "/dado-joint-calculator", description: "Dado/rabbet joint sizing." },
  { name: "Dowel Joint Calculator", url: "/dowel-joint-calculator", description: "Dowel joint spacing." },
  { name: "Board Foot Calculator", url: "/board-foot-calculator", description: "Board feet calculator." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Dovetail Joint Calculator"
  keywords="dovetail calculator, dovetail joint layout, pin spacing, tail spacing, dovetail angle, hand cut dovetails"
  breadcrumbs={[{ name: "Dovetail Joint Calculator", url: "/dovetail-joint-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Dovetail Joint Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Plan your dovetail joint layout with precise pin and tail dimensions.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Board Width (inches)</label>
        <input type="number" id="dvt-width" class="dvt-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="6" min="1" step="0.125">
      </div>

      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Board Thickness (inches)</label>
          <input type="number" id="dvt-thick" class="dvt-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.75" min="0.25" step="0.125">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Number of Tails</label>
          <input type="number" id="dvt-tails" class="dvt-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="3" min="1" max="20" step="1">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Dovetail Angle</label>
          <select id="dvt-angle" class="dvt-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="8">1:8 (Hardwood)</option>
            <option value="7">1:7 (General)</option>
            <option value="6" selected>1:6 (Softwood)</option>
            <option value="5">1:5 (Very Soft)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Half-Pin Width (inches)</label>
          <input type="number" id="dvt-halfpin" class="dvt-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.375" min="0.125" step="0.0625">
        </div>
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Tail Width (narrow face)</div>
        <div class="text-4xl font-extrabold" id="dvt-tw">--</div>
        <div class="text-sm text-blue-200 mt-1">inches</div>
      </div>

      <!-- Secondary Stats -->
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Pin Width (narrow)</div>
          <div class="text-xl font-bold" id="dvt-pw">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Tail Width (wide face)</div>
          <div class="text-xl font-bold" id="dvt-tww">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Joint Depth</div>
          <div class="text-xl font-bold" id="dvt-depth">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Dovetail Angle</div>
          <div class="text-xl font-bold" id="dvt-deg">--</div>
        </div>
      </div>

      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h4 class="font-semibold text-sm text-text mb-2">Layout Summary</h4>
        <div class="text-sm text-text-secondary space-y-1" id="dvt-summary">
          <p>--</p>
        </div>
      </div>

      <ShareButton calculatorId="dovetail-joint" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Dovetail Joint Design Guide</h2>
      <h3 class="text-xl font-semibold text-text mt-8">Choosing Your Angle</h3>
      <ul>
        <li><strong>1:8 ratio (~7.1 degrees):</strong> Best for hardwoods like oak, maple, walnut</li>
        <li><strong>1:7 ratio (~8.1 degrees):</strong> Good general-purpose angle</li>
        <li><strong>1:6 ratio (~9.5 degrees):</strong> Best for softwoods like pine, cedar</li>
        <li><strong>1:5 ratio (~11.3 degrees):</strong> Very soft woods, maximum mechanical lock</li>
      </ul>
      <h3 class="text-xl font-semibold text-text mt-8">Tips</h3>
      <ul>
        <li>Half-pins at the edges should be at least 1/4 of the board thickness</li>
        <li>Tails should generally be wider than pins for aesthetic appeal</li>
        <li>Mark your baseline at exactly the mating board's thickness plus 1/32"</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcDVT() {
      const boardWidth = parseFloat((document.getElementById('dvt-width') as HTMLInputElement).value) || 6;
      const thickness = parseFloat((document.getElementById('dvt-thick') as HTMLInputElement).value) || 0.75;
      const numTails = parseInt((document.getElementById('dvt-tails') as HTMLInputElement).value) || 3;
      const angleRatio = parseInt((document.getElementById('dvt-angle') as HTMLInputElement).value) || 6;
      const halfPinWidth = parseFloat((document.getElementById('dvt-halfpin') as HTMLInputElement).value) || 0.375;

      // Dovetail angle in degrees
      const angleDeg = Math.atan(1 / angleRatio) * (180 / Math.PI);

      // Joint depth = board thickness
      const jointDepth = thickness;

      // Pin taper per side due to angle: thickness * tan(angle)
      const taperPerSide = thickness / angleRatio;

      // Number of pins = numTails + 1 (counting half-pins as full equivalent)
      // Available width for tails and full pins = boardWidth - 2 * halfPinWidth
      const availableWidth = boardWidth - 2 * halfPinWidth;

      // With N tails, we have (N-1) full pins between them
      // Each tail narrow face + each pin narrow face = availableWidth
      // Tail wide face = tail narrow face + 2 * taperPerSide
      // Pin narrow face = pin wide face - 2 * taperPerSide

      // Simple even distribution: each tail gets equal share
      // Total segments = numTails (tails) + (numTails - 1) (pins)
      // Let pin narrow width = half of tail narrow width for aesthetic ratio
      const pinNarrowRatio = 0.5;
      const segmentCount = numTails + (numTails - 1) * pinNarrowRatio;
      const tailNarrow = availableWidth / segmentCount;
      const pinNarrow = tailNarrow * pinNarrowRatio;

      const tailWide = tailNarrow + 2 * taperPerSide;
      const pinWide = pinNarrow + 2 * taperPerSide;

      const fmt = (n: number) => n.toFixed(3);

      document.getElementById('dvt-tw')!.textContent = fmt(tailNarrow) + '"';
      document.getElementById('dvt-pw')!.textContent = fmt(pinNarrow) + '"';
      document.getElementById('dvt-tww')!.textContent = fmt(tailWide) + '"';
      document.getElementById('dvt-depth')!.textContent = fmt(jointDepth) + '"';
      document.getElementById('dvt-deg')!.textContent = angleDeg.toFixed(1) + '\u00B0';

      const summary = `Layout: ${halfPinWidth}" half-pin, then ${numTails} tails at ${fmt(tailNarrow)}" (narrow) with ${numTails - 1} pins at ${fmt(pinNarrow)}" (narrow), ending with ${halfPinWidth}" half-pin. Total: ${boardWidth}".`;
      document.getElementById('dvt-summary')!.innerHTML = '<p>' + summary + '</p>';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.dvt-in').forEach(el => {
        el.addEventListener('input', calcDVT);
        el.addEventListener('change', calcDVT);
      });
      calcDVT();
    }, 50);
  </script>
</CalculatorLayout>
