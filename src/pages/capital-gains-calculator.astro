---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Capital Gains Tax Calculator - Calculate Your Tax on Investments";
const description = "Calculate federal capital gains tax on stocks, real estate, and other investments. See short-term vs long-term rates.";

const relatedCalcs = [
  { name: "Stock Profit", url: "/stock-profit-calculator", description: "Stock returns." },
  { name: "Tax Bracket", url: "/tax-bracket-calculator", description: "Tax brackets." },
  { name: "Income Tax", url: "/income-tax-calculator", description: "Income tax." },
  { name: "ROI Calculator", url: "/roi-calculator", description: "Return on investment." },
  { name: "Crypto Profit", url: "/crypto-profit-calculator", description: "Crypto gains." },
  { name: "Investment Calculator", url: "/investment-calculator", description: "Investments." },
];
---

<CalculatorLayout title={title} description={description} calculatorName="Capital Gains Calculator" keywords="capital gains tax calculator, long term capital gains, short term capital gains, investment tax, stock tax" breadcrumbs={[{ name: "Capital Gains", url: "/capital-gains-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Capital Gains Tax Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate federal capital gains tax on your investment profits.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Purchase Price</label>
              <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                <input type="number" id="cg-buy" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="50000" min="0" step="1000">
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Sale Price</label>
              <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                <input type="number" id="cg-sell" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="80000" min="0" step="1000">
              </div>
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Holding Period</label>
            <select id="cg-term" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="short">Short-term (1 year or less)</option>
              <option value="long" selected>Long-term (more than 1 year)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Taxable Income (for tax bracket)</label>
            <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
              <input type="number" id="cg-income" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="85000" min="0" step="1000">
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Filing Status</label>
            <select id="cg-status" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="single">Single</option>
              <option value="married" selected>Married Filing Jointly</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">State Tax Rate (%)</label>
            <input type="number" id="cg-state" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="5" min="0" max="15" step="0.5">
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Total Tax on Gain</div>
            <div class="text-5xl font-extrabold" id="cg-tax">$0</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Capital Gain</div>
              <div class="text-xl font-bold text-secondary" id="cg-gain">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Federal Tax Rate</div>
              <div class="text-xl font-bold" id="cg-fed-rate">0%</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Federal Tax</div>
              <div class="text-xl font-bold" id="cg-fed-tax">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">State Tax</div>
              <div class="text-xl font-bold" id="cg-state-tax">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">After-Tax Proceeds</div>
              <div class="text-xl font-bold" id="cg-after">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Effective Tax Rate</div>
              <div class="text-xl font-bold" id="cg-eff">0%</div>
            </div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="capital-gains" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Capital Gains Tax Rates (2024)</h2>
      <p><strong>Short-term</strong> gains (held â‰¤ 1 year) are taxed as ordinary income (10-37%). <strong>Long-term</strong> gains (held > 1 year) get preferential rates: 0%, 15%, or 20% depending on income.</p>
    </article>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString();

    function calcCapGains() {
      const buy = parseFloat((document.getElementById('cg-buy') as HTMLInputElement).value) || 0;
      const sell = parseFloat((document.getElementById('cg-sell') as HTMLInputElement).value) || 0;
      const term = (document.getElementById('cg-term') as HTMLSelectElement).value;
      const income = parseFloat((document.getElementById('cg-income') as HTMLInputElement).value) || 0;
      const status = (document.getElementById('cg-status') as HTMLSelectElement).value;
      const stateRate = (parseFloat((document.getElementById('cg-state') as HTMLInputElement).value) || 0) / 100;

      const gain = Math.max(0, sell - buy);

      let fedRate: number;
      if (term === 'short') {
        // Use ordinary income brackets (simplified)
        const totalIncome = income + gain;
        if (status === 'married') {
          if (totalIncome > 731200) fedRate = 0.37;
          else if (totalIncome > 487450) fedRate = 0.35;
          else if (totalIncome > 383900) fedRate = 0.32;
          else if (totalIncome > 201050) fedRate = 0.24;
          else if (totalIncome > 94300) fedRate = 0.22;
          else if (totalIncome > 23200) fedRate = 0.12;
          else fedRate = 0.10;
        } else {
          if (totalIncome > 609350) fedRate = 0.37;
          else if (totalIncome > 243725) fedRate = 0.35;
          else if (totalIncome > 191950) fedRate = 0.32;
          else if (totalIncome > 100525) fedRate = 0.24;
          else if (totalIncome > 47150) fedRate = 0.22;
          else if (totalIncome > 11600) fedRate = 0.12;
          else fedRate = 0.10;
        }
      } else {
        // Long-term capital gains rates
        if (status === 'married') {
          if (income > 583750) fedRate = 0.20;
          else if (income > 89250) fedRate = 0.15;
          else fedRate = 0;
        } else {
          if (income > 518900) fedRate = 0.20;
          else if (income > 47025) fedRate = 0.15;
          else fedRate = 0;
        }
      }

      // NIIT (3.8% on high earners)
      const niitThreshold = status === 'married' ? 250000 : 200000;
      const niit = income > niitThreshold ? gain * 0.038 : 0;

      const fedTax = gain * fedRate + niit;
      const stateTax = gain * stateRate;
      const totalTax = fedTax + stateTax;
      const afterTax = sell - totalTax;
      const effRate = gain > 0 ? (totalTax / gain) * 100 : 0;

      document.getElementById('cg-gain')!.textContent = fmt(gain);
      document.getElementById('cg-fed-rate')!.textContent = (fedRate * 100) + '%' + (niit > 0 ? ' + 3.8% NIIT' : '');
      document.getElementById('cg-fed-tax')!.textContent = fmt(fedTax);
      document.getElementById('cg-state-tax')!.textContent = fmt(stateTax);
      document.getElementById('cg-tax')!.textContent = fmt(totalTax);
      document.getElementById('cg-after')!.textContent = fmt(afterTax);
      document.getElementById('cg-eff')!.textContent = effRate.toFixed(1) + '%';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      ['cg-buy', 'cg-sell', 'cg-income', 'cg-state'].forEach(id => document.getElementById(id)!.addEventListener('input', calcCapGains));
      ['cg-term', 'cg-status'].forEach(id => document.getElementById(id)!.addEventListener('change', calcCapGains));
      calcCapGains();
    }, 50);
  </script>
</CalculatorLayout>
