---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Panorama Calculator - Shots, Overlap & Multi-Row Coverage";
const description = "Calculate the number of shots needed for a panorama from field of view and overlap percentage. Plan multi-row panoramas and total coverage.";
const relatedCalcs = [
  { name: "Focal Length", url: "/focal-length-calculator", description: "Field of view calculations." },
  { name: "Photo Resolution", url: "/photo-resolution-calculator", description: "Image resolution and size." },
  { name: "Camera Sensor", url: "/camera-sensor-calculator", description: "Sensor sizes and crop." },
  { name: "Aspect Ratio", url: "/aspect-ratio-calculator", description: "Image aspect ratios." },
  { name: "Depth of Field", url: "/depth-of-field-calculator", description: "Focus for panoramas." },
  { name: "Print Size", url: "/print-size-calculator", description: "Print from mega-panoramas." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Panorama Calculator" keywords="panorama calculator, panorama shots needed, overlap percentage, multi-row panorama, field of view, panorama stitching" breadcrumbs={[{ name: "Panorama", url: "/panorama-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Panorama Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Plan your panorama shots: calculate number of images, overlap, and multi-row coverage.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-1">Focal Length (mm, 35mm equiv.)</label>
          <input type="number" id="pn-focal" class="pn-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="50" min="8" max="600" step="1">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Camera Orientation</label>
          <select id="pn-orient" class="pn-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="landscape">Landscape (horizontal)</option>
            <option value="portrait" selected>Portrait (vertical) - recommended</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Desired Horizontal Coverage (degrees)</label>
          <input type="number" id="pn-coverage" class="pn-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="180" min="30" max="360" step="5">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Overlap (%)</label>
          <input type="number" id="pn-overlap" class="pn-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="30" min="10" max="70" step="5">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Number of Rows</label>
          <input type="number" id="pn-rows" class="pn-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="1" min="1" max="10" step="1">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Image Resolution (MP)</label>
          <input type="number" id="pn-mp" class="pn-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="24" min="1" max="200" step="1">
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Total Shots Needed</div>
          <div class="text-4xl font-extrabold" id="pn-shots"></div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary uppercase tracking-wide">Shots per Row</div>
            <div class="text-xl font-bold text-text" id="pn-per-row"></div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary uppercase tracking-wide">Horizontal FoV per Shot</div>
            <div class="text-xl font-bold text-text" id="pn-hfov"></div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary uppercase tracking-wide">Rotation per Shot</div>
            <div class="text-xl font-bold text-text" id="pn-rotation"></div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary uppercase tracking-wide">Vertical Coverage</div>
            <div class="text-xl font-bold text-text" id="pn-vcov"></div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary uppercase tracking-wide">Est. Final Resolution</div>
            <div class="text-xl font-bold text-text" id="pn-final-res"></div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary uppercase tracking-wide">Est. Final Megapixels</div>
            <div class="text-xl font-bold text-text" id="pn-final-mp"></div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="panorama" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Panorama Shooting Tips</h2>
      <p>Use portrait orientation for more vertical coverage per row. Aim for 25-35% overlap for reliable stitching. Use manual exposure and focus to maintain consistency across frames.</p>
      <p><strong>Nodal point:</strong> Rotate the camera around the lens nodal point (not the tripod mount) to minimize parallax errors, especially for close subjects.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcPN() {
      const focal = parseFloat((document.getElementById('pn-focal') as HTMLInputElement).value) || 50;
      const orient = (document.getElementById('pn-orient') as HTMLSelectElement).value;
      const coverage = parseFloat((document.getElementById('pn-coverage') as HTMLInputElement).value) || 180;
      const overlap = parseFloat((document.getElementById('pn-overlap') as HTMLInputElement).value) || 30;
      const rows = parseInt((document.getElementById('pn-rows') as HTMLInputElement).value) || 1;
      const mp = parseFloat((document.getElementById('pn-mp') as HTMLInputElement).value) || 24;

      // FF sensor: 36x24mm
      const sensorW = orient === 'portrait' ? 24 : 36;
      const sensorH = orient === 'portrait' ? 36 : 24;

      const hFovRad = 2 * Math.atan(sensorW / (2 * focal));
      const vFovRad = 2 * Math.atan(sensorH / (2 * focal));
      const hFovDeg = hFovRad * (180 / Math.PI);
      const vFovDeg = vFovRad * (180 / Math.PI);

      const effectiveHFov = hFovDeg * (1 - overlap / 100);
      const shotsPerRow = Math.ceil(coverage / effectiveHFov);
      const totalShots = shotsPerRow * rows;

      document.getElementById('pn-shots')!.textContent = totalShots + ' shots';
      document.getElementById('pn-per-row')!.textContent = shotsPerRow.toString();
      document.getElementById('pn-hfov')!.textContent = hFovDeg.toFixed(1) + '\u00B0';
      document.getElementById('pn-rotation')!.textContent = effectiveHFov.toFixed(1) + '\u00B0';

      const totalVCov = vFovDeg + (rows - 1) * vFovDeg * (1 - overlap / 100);
      document.getElementById('pn-vcov')!.textContent = totalVCov.toFixed(1) + '\u00B0';

      // Estimate final resolution
      const pixelsPerShot = mp * 1000000;
      const aspectRatio = sensorW / sensorH;
      const shotW = Math.sqrt(pixelsPerShot * aspectRatio);
      const shotH = shotW / aspectRatio;

      const effectivePixelsPerShot = shotW * (1 - overlap / 100);
      const finalW = Math.round(effectivePixelsPerShot * shotsPerRow + shotW * (overlap / 100));
      const effectiveVPixelsPerRow = shotH * (1 - overlap / 100);
      const finalH = Math.round(rows === 1 ? shotH : effectiveVPixelsPerRow * rows + shotH * (overlap / 100));
      const finalMP = (finalW * finalH) / 1000000;

      document.getElementById('pn-final-res')!.textContent = Math.round(finalW) + ' x ' + Math.round(finalH);
      document.getElementById('pn-final-mp')!.textContent = finalMP.toFixed(0) + ' MP';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.pn-in').forEach(el => {
        el.addEventListener('input', calcPN);
        el.addEventListener('change', calcPN);
      });
      calcPN();
    }, 50);
  </script>
</CalculatorLayout>
