---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Expected Value Calculator - EV, Variance & Risk";
const description = "Calculate expected value from outcomes and probabilities. Includes variance, standard deviation, and risk assessment for decisions and bets.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "Event probability." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Spread analysis." },
  { name: "Average Calculator", url: "/average-calculator", description: "Mean calculation." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage math." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical tools." },
  { name: "ROI Calculator", url: "/roi-calculator", description: "Return on investment." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Expected Value Calculator" keywords="expected value, EV calculator, variance, standard deviation, risk assessment, probability outcomes" breadcrumbs={[{ name: "Expected Value", url: "/expected-value-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Expected Value Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Enter outcomes and their probabilities to calculate expected value, variance, and risk metrics.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold text-text">Outcomes</h3>
          <button id="ev3-add" class="px-3 py-1 bg-primary text-white text-sm rounded-lg hover:bg-blue-700">+ Add Outcome</button>
        </div>
        <div id="ev3-rows" class="space-y-3"></div>

        <div class="text-sm text-text-secondary text-right" id="ev3-probsum"></div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Expected Value (EV)</div>
          <div class="text-5xl font-extrabold font-mono" id="ev3-ev">--</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Variance</div>
            <div class="text-xl font-bold font-mono" id="ev3-var">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Std Deviation</div>
            <div class="text-xl font-bold font-mono" id="ev3-sd">--</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Best Outcome</div>
            <div class="text-xl font-bold font-mono" id="ev3-best">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Worst Outcome</div>
            <div class="text-xl font-bold font-mono" id="ev3-worst">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Risk Assessment</div>
          <div class="text-lg font-bold" id="ev3-risk">--</div>
        </div>
      </div>
      <ShareButton calculatorId="expected-value" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Expected Value Formulas</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>EV:</strong> Sum of (value x probability) for all outcomes</p>
        <p><strong>Variance:</strong> Sum of (probability x (value - EV)^2)</p>
        <p><strong>Std Dev:</strong> Square root of variance</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let ev3Rows = [
      { value: 100, prob: 0.3 },
      { value: -50, prob: 0.7 }
    ];

    function renderEV3Rows() {
      const container = document.getElementById('ev3-rows')!;
      let html = '';
      for (let i = 0; i < ev3Rows.length; i++) {
        html += '<div class="grid grid-cols-[1fr_1fr_auto] gap-2 items-end">' +
          '<div><label class="block text-xs font-medium text-text mb-1">Value ($)</label>' +
          '<input type="number" class="ev3-in w-full px-3 py-2 border border-border rounded-lg text-center" data-idx="' + i + '" data-field="value" value="' + ev3Rows[i].value + '" step="any"></div>' +
          '<div><label class="block text-xs font-medium text-text mb-1">Probability</label>' +
          '<input type="number" class="ev3-in w-full px-3 py-2 border border-border rounded-lg text-center" data-idx="' + i + '" data-field="prob" value="' + ev3Rows[i].prob + '" min="0" max="1" step="0.01"></div>' +
          '<button class="ev3-del px-2 py-2 text-red-500 hover:bg-red-50 rounded-lg text-sm" data-idx="' + i + '">X</button></div>';
      }
      container.innerHTML = html;
      container.querySelectorAll('.ev3-in').forEach(el => {
        el.addEventListener('input', (e) => {
          const t = e.target as HTMLInputElement;
          const idx = parseInt(t.dataset.idx || '0');
          const field = t.dataset.field as 'value' | 'prob';
          ev3Rows[idx][field] = parseFloat(t.value) || 0;
          calcEV3();
        });
      });
      container.querySelectorAll('.ev3-del').forEach(el => {
        el.addEventListener('click', (e) => {
          const idx = parseInt((e.target as HTMLElement).dataset.idx || '0');
          if (ev3Rows.length > 1) { ev3Rows.splice(idx, 1); renderEV3Rows(); calcEV3(); }
        });
      });
    }

    function calcEV3() {
      const probSum = ev3Rows.reduce((s, r) => s + r.prob, 0);
      document.getElementById('ev3-probsum')!.textContent = 'Total probability: ' + probSum.toFixed(4) + (Math.abs(probSum - 1) > 0.001 ? ' (should be 1.0)' : ' OK');

      const ev = ev3Rows.reduce((s, r) => s + r.value * r.prob, 0);
      const variance = ev3Rows.reduce((s, r) => s + r.prob * Math.pow(r.value - ev, 2), 0);
      const sd = Math.sqrt(variance);
      const values = ev3Rows.map(r => r.value);
      const best = Math.max(...values);
      const worst = Math.min(...values);

      document.getElementById('ev3-ev')!.textContent = (ev >= 0 ? '+' : '') + ev.toFixed(2);
      document.getElementById('ev3-var')!.textContent = variance.toFixed(2);
      document.getElementById('ev3-sd')!.textContent = sd.toFixed(2);
      document.getElementById('ev3-best')!.textContent = '$' + best.toFixed(2);
      document.getElementById('ev3-worst')!.textContent = '$' + worst.toFixed(2);

      let risk = 'Neutral';
      if (ev > 0 && sd < ev) risk = 'Favorable - Low Risk';
      else if (ev > 0 && sd >= ev) risk = 'Favorable - High Variance';
      else if (ev < 0 && Math.abs(ev) > sd) risk = 'Unfavorable - High Risk';
      else if (ev < 0) risk = 'Unfavorable - Moderate Risk';
      document.getElementById('ev3-risk')!.textContent = risk;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.getElementById('ev3-add')!.addEventListener('click', () => {
        ev3Rows.push({ value: 0, prob: 0 });
        renderEV3Rows();
        calcEV3();
      });
      renderEV3Rows();
      calcEV3();
    }, 50);
  </script>
</CalculatorLayout>
