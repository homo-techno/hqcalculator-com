---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Sleep Calculator - Bedtime & Wake Up Time Calculator";
const description = "Calculate the best bedtime or wake time based on sleep cycles. Wake up refreshed by timing your sleep to complete full 90-minute cycles.";

const relatedCalcs = [
  { name: "Age Calculator", url: "/age-calculator", description: "Exact age." },
  { name: "Time Calculator", url: "/time-calculator", description: "Time math." },
  { name: "Calorie Calculator", url: "/calorie-calculator", description: "Daily calories." },
  { name: "BMI Calculator", url: "/bmi-calculator", description: "Body Mass Index." },
  { name: "Water Intake", url: "/water-intake-calculator", description: "Hydration." },
  { name: "Date Calculator", url: "/date-calculator", description: "Date math." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Sleep Calculator"
  keywords="sleep calculator, bedtime calculator, wake up time, sleep cycles, best time to sleep, sleep schedule"
  breadcrumbs={[{ name: "Sleep Calculator", url: "/sleep-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Sleep Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Find the best times to sleep and wake up based on 90-minute sleep cycles.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="flex gap-2 mb-6">
        <button class="sl-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-primary text-white" data-mode="wake">I need to wake at...</button>
        <button class="sl-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-surface-alt text-text-secondary" data-mode="sleep">I want to sleep at...</button>
        <button class="sl-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-surface-alt text-text-secondary" data-mode="now">Sleep now</button>
      </div>

      <div id="sl-wake-mode" class="mb-5">
        <label class="block text-sm font-medium text-text mb-1">Wake Up Time</label>
        <input type="time" id="sl-wake" class="w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold text-center" value="07:00">
      </div>

      <div id="sl-sleep-mode" class="mb-5 hidden">
        <label class="block text-sm font-medium text-text mb-1">Bedtime</label>
        <input type="time" id="sl-sleep" class="w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold text-center" value="23:00">
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-1">Time to Fall Asleep</label>
        <div class="flex gap-2">
          <input type="number" id="sl-fallasleep" class="flex-1 px-4 py-3 border border-border rounded-xl text-lg text-center" value="15" min="0" max="60">
          <span class="self-center text-text-muted font-semibold">minutes</span>
        </div>
      </div>

      <!-- Results -->
      <div class="p-4 bg-primary/10 rounded-xl mb-4">
        <h3 class="font-semibold text-sm text-text mb-3" id="sl-result-title">Go to bed at one of these times:</h3>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6" id="sl-results"></div>

      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h3 class="font-semibold text-sm text-text mb-3">Sleep Duration by Age</h3>
        <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-sm">
          <div class="flex justify-between py-0.5 text-text-secondary"><span>Newborn (0-3 mo)</span><span class="font-semibold">14-17 hrs</span></div>
          <div class="flex justify-between py-0.5 text-text-secondary"><span>Infant (4-11 mo)</span><span class="font-semibold">12-15 hrs</span></div>
          <div class="flex justify-between py-0.5 text-text-secondary"><span>Toddler (1-2 yr)</span><span class="font-semibold">11-14 hrs</span></div>
          <div class="flex justify-between py-0.5 text-text-secondary"><span>Preschool (3-5)</span><span class="font-semibold">10-13 hrs</span></div>
          <div class="flex justify-between py-0.5 text-text-secondary"><span>School Age (6-13)</span><span class="font-semibold">9-11 hrs</span></div>
          <div class="flex justify-between py-0.5 text-text-secondary"><span>Teen (14-17)</span><span class="font-semibold">8-10 hrs</span></div>
          <div class="flex justify-between py-0.5 font-bold text-primary"><span>Adult (18-64)</span><span>7-9 hrs</span></div>
          <div class="flex justify-between py-0.5 text-text-secondary"><span>Senior (65+)</span><span class="font-semibold">7-8 hrs</span></div>
        </div>
      </div>

      <ShareButton calculatorId="sleep" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How Sleep Cycles Work</h2>
      <p>Sleep occurs in cycles of approximately 90 minutes, moving through stages: light sleep → deep sleep → REM sleep. Waking up between cycles (rather than in the middle of one) helps you feel more refreshed.</p>

      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono">Optimal Sleep = 5 or 6 complete cycles = 7.5 or 9 hours</div>

      <h3 class="text-xl font-semibold text-text mt-8">Tips for Better Sleep</h3>
      <ul>
        <li>Keep a consistent sleep schedule — even on weekends</li>
        <li>Avoid screens 30-60 minutes before bed (blue light suppresses melatonin)</li>
        <li>Keep your bedroom cool (65-68°F / 18-20°C)</li>
        <li>Limit caffeine after 2 PM</li>
        <li>Exercise regularly, but not within 3 hours of bedtime</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>Why do I feel tired after 8 hours of sleep?</strong> You may be waking in the middle of a sleep cycle. Try sleeping 7.5 or 9 hours instead to complete full cycles.</p>
      <p><strong>Is 6 hours of sleep enough?</strong> For most adults, no. The CDC recommends 7-9 hours. Consistently sleeping less than 7 hours increases health risks.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let slMode = 'wake';
    const CYCLE = 90; // minutes

    function timeToMin(t: string): number {
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    }

    function minToTime(m: number): string {
      const mins = ((m % 1440) + 1440) % 1440;
      const h = Math.floor(mins / 60);
      const mm = mins % 60;
      const ampm = h >= 12 ? 'PM' : 'AM';
      const hh = h === 0 ? 12 : h > 12 ? h - 12 : h;
      return `${hh}:${String(mm).padStart(2, '0')} ${ampm}`;
    }

    function calcSleep() {
      const fallAsleep = parseInt((document.getElementById('sl-fallasleep') as HTMLInputElement).value) || 15;
      const container = document.getElementById('sl-results')!;
      let results: { time: string; cycles: number; hours: number; quality: string }[] = [];

      if (slMode === 'wake') {
        const wakeMin = timeToMin((document.getElementById('sl-wake') as HTMLInputElement).value);
        document.getElementById('sl-result-title')!.textContent = 'Go to bed at one of these times:';
        for (let c = 6; c >= 3; c--) {
          const sleepMin = wakeMin - (c * CYCLE) - fallAsleep;
          const hours = (c * CYCLE) / 60;
          const quality = c >= 5 ? 'Recommended' : c === 4 ? 'Okay' : 'Minimum';
          results.push({ time: minToTime(sleepMin), cycles: c, hours, quality });
        }
      } else if (slMode === 'sleep') {
        const sleepMin = timeToMin((document.getElementById('sl-sleep') as HTMLInputElement).value);
        document.getElementById('sl-result-title')!.textContent = 'Set your alarm for one of these times:';
        for (let c = 3; c <= 6; c++) {
          const wakeMin = sleepMin + fallAsleep + (c * CYCLE);
          const hours = (c * CYCLE) / 60;
          const quality = c >= 5 ? 'Recommended' : c === 4 ? 'Okay' : 'Minimum';
          results.push({ time: minToTime(wakeMin), cycles: c, hours, quality });
        }
      } else {
        const now = new Date();
        const nowMin = now.getHours() * 60 + now.getMinutes();
        document.getElementById('sl-result-title')!.textContent = 'If you sleep now, wake up at:';
        for (let c = 3; c <= 6; c++) {
          const wakeMin = nowMin + fallAsleep + (c * CYCLE);
          const hours = (c * CYCLE) / 60;
          const quality = c >= 5 ? 'Recommended' : c === 4 ? 'Okay' : 'Minimum';
          results.push({ time: minToTime(wakeMin), cycles: c, hours, quality });
        }
      }

      container.innerHTML = results.map(r => {
        const bg = r.quality === 'Recommended' ? 'bg-green-50 border-green-200' : r.quality === 'Okay' ? 'bg-yellow-50 border-yellow-200' : 'bg-surface-alt border-border';
        const badge = r.quality === 'Recommended' ? 'bg-green-100 text-green-700' : r.quality === 'Okay' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600';
        return `<div class="p-4 rounded-xl border ${bg} text-center">
          <div class="text-2xl font-extrabold">${r.time}</div>
          <div class="text-xs text-text-muted mt-1">${r.cycles} cycles · ${r.hours}h</div>
          <span class="inline-block mt-1 px-2 py-0.5 text-xs rounded-full ${badge}">${r.quality}</span>
        </div>`;
      }).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.sl-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.sl-mode-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white'); b.classList.add('bg-surface-alt', 'text-text-secondary'); });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary'); btn.classList.add('bg-primary', 'text-white');
          slMode = (btn as HTMLElement).dataset.mode || 'wake';
          document.getElementById('sl-wake-mode')!.classList.toggle('hidden', slMode !== 'wake');
          document.getElementById('sl-sleep-mode')!.classList.toggle('hidden', slMode !== 'sleep');
          calcSleep();
        });
      });

      ['sl-wake', 'sl-sleep'].forEach(id => document.getElementById(id)?.addEventListener('input', calcSleep));
      document.getElementById('sl-fallasleep')!.addEventListener('input', calcSleep);

      calcSleep();
    }, 50);
  </script>
</CalculatorLayout>
