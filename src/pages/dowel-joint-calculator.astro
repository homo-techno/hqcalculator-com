---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Dowel Joint Calculator - Diameter, Depth & Spacing for Edge/Face Joints";
const description = "Calculate dowel diameter, depth, spacing, and count for edge and face joints. Get drill bit size and jig setup recommendations.";

const relatedCalcs = [
  { name: "Mortise & Tenon Calculator", url: "/mortise-tenon-calculator", description: "M&T joint dimensions." },
  { name: "Dovetail Joint Calculator", url: "/dovetail-joint-calculator", description: "Dovetail layout." },
  { name: "Wood Screw Calculator", url: "/wood-screw-calculator", description: "Screw sizing guide." },
  { name: "Wood Glue Calculator", url: "/wood-glue-calculator", description: "Glue coverage." },
  { name: "Box Joint Calculator", url: "/box-joint-calculator", description: "Box joint layout." },
  { name: "Board Foot Calculator", url: "/board-foot-calculator", description: "Board feet calculator." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Dowel Joint Calculator"
  keywords="dowel joint calculator, dowel diameter, dowel spacing, edge joint, face joint, doweling jig, dowel depth"
  breadcrumbs={[{ name: "Dowel Joint Calculator", url: "/dowel-joint-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Dowel Joint Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate optimal dowel size, depth, and spacing for strong edge and face joints.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Joint Type</label>
        <select id="dwj-type" class="dwj-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="edge" selected>Edge Joint (panel glue-up)</option>
          <option value="face">Face Joint (T-joint / frame)</option>
          <option value="miter">Miter Joint (reinforcement)</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Board Thickness (inches)</label>
          <input type="number" id="dwj-thick" class="dwj-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="0.75" min="0.25" step="0.125">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Joint Length (inches)</label>
          <input type="number" id="dwj-length" class="dwj-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="24" min="2" step="1">
        </div>
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Dowel Diameter (inches)</label>
        <select id="dwj-diam" class="dwj-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="0">Auto (based on stock)</option>
          <option value="0.25">1/4"</option>
          <option value="0.3125">5/16"</option>
          <option value="0.375">3/8"</option>
          <option value="0.5">1/2"</option>
        </select>
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Recommended Dowel Count</div>
        <div class="text-4xl font-extrabold" id="dwj-count">--</div>
        <div class="text-sm text-blue-200 mt-1" id="dwj-count-sub">--</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Dowel Diameter</div>
          <div class="text-xl font-bold" id="dwj-dd">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Dowel Length</div>
          <div class="text-xl font-bold" id="dwj-dl">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Hole Depth (each side)</div>
          <div class="text-xl font-bold" id="dwj-hd">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Spacing (center-to-center)</div>
          <div class="text-xl font-bold" id="dwj-space">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Drill Bit Size</div>
          <div class="text-xl font-bold" id="dwj-bit">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Edge Distance (min)</div>
          <div class="text-xl font-bold" id="dwj-edge">--</div>
        </div>
      </div>

      <ShareButton calculatorId="dowel-joint" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Dowel Joint Design Rules</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Dowel diameter = 1/3 to 1/2 of board thickness</strong></p>
        <p><strong>Dowel length = 5x diameter (2.5x each side)</strong></p>
        <p><strong>Spacing = 6" to 8" apart along the joint</strong></p>
      </div>
      <h3 class="text-xl font-semibold text-text mt-8">Tips</h3>
      <ul>
        <li>Use fluted or spiral-grooved dowels for better glue distribution</li>
        <li>Drill holes 1/16" deeper than needed for glue reservoir</li>
        <li>Use a doweling jig for precise alignment</li>
        <li>Chamfer dowel ends for easier insertion</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcDWJ() {
      const jointType = (document.getElementById('dwj-type') as HTMLSelectElement).value;
      const thick = parseFloat((document.getElementById('dwj-thick') as HTMLInputElement).value) || 0.75;
      const length = parseFloat((document.getElementById('dwj-length') as HTMLInputElement).value) || 24;
      let dowelDiam = parseFloat((document.getElementById('dwj-diam') as HTMLSelectElement).value) || 0;

      // Auto-select dowel diameter: ~1/3 to 1/2 of stock thickness, nearest standard
      if (dowelDiam === 0) {
        const ideal = thick * 0.4;
        const sizes = [0.25, 0.3125, 0.375, 0.5];
        dowelDiam = sizes[0];
        let minDiff = Math.abs(ideal - sizes[0]);
        for (const s of sizes) {
          if (s <= thick * 0.5) {
            const diff = Math.abs(ideal - s);
            if (diff <= minDiff) { minDiff = diff; dowelDiam = s; }
          }
        }
      }

      // Dowel length: 5x diameter for edge joints, 4x for face joints
      const lengthMultiplier = jointType === 'edge' ? 5 : jointType === 'face' ? 4 : 4;
      const dowelLength = Math.round(dowelDiam * lengthMultiplier * 16) / 16;

      // Hole depth each side
      const holeDepth = dowelLength / 2 + 0.0625; // add 1/16" for glue room

      // Spacing: 6-8" for edge joints, closer for miters
      const idealSpacing = jointType === 'miter' ? 4 : 6;
      const dowelCount = Math.max(2, Math.ceil(length / idealSpacing) + 1);
      const actualSpacing = length / (dowelCount - 1);

      // Edge distance
      const edgeDist = Math.max(2, actualSpacing / 2);

      const frac = (n: number) => {
        const fracs: Record<number, string> = {0.25:'1/4"',0.3125:'5/16"',0.375:'3/8"',0.5:'1/2"'};
        return fracs[n] || n.toFixed(3) + '"';
      };

      document.getElementById('dwj-count')!.textContent = dowelCount.toString();
      document.getElementById('dwj-count-sub')!.textContent = 'dowels along ' + length + '" joint';
      document.getElementById('dwj-dd')!.textContent = frac(dowelDiam);
      document.getElementById('dwj-dl')!.textContent = dowelLength.toFixed(3) + '"';
      document.getElementById('dwj-hd')!.textContent = holeDepth.toFixed(3) + '"';
      document.getElementById('dwj-space')!.textContent = actualSpacing.toFixed(1) + '"';
      document.getElementById('dwj-bit')!.textContent = frac(dowelDiam) + ' brad point';
      document.getElementById('dwj-edge')!.textContent = edgeDist.toFixed(1) + '"';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.dwj-in').forEach(el => {
        el.addEventListener('input', calcDWJ);
        el.addEventListener('change', calcDWJ);
      });
      calcDWJ();
    }, 50);
  </script>
</CalculatorLayout>
