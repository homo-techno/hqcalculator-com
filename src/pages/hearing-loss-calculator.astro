---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Hearing Loss Calculator";
const description = "Classify hearing loss level (mild, moderate, severe, profound) from dB HL thresholds, identify frequency pattern, and visualize on the speech banana.";
const relatedCalcs = [
  { name: "Hearing Aid Calculator", url: "/hearing-aid-calculator", description: "Hearing aid cost estimate." },
  { name: "Tinnitus Frequency Calculator", url: "/tinnitus-frequency-calculator", description: "Tinnitus frequency matching." },
  { name: "Snoring Risk Calculator", url: "/snoring-risk-calculator", description: "Snoring and OSA risk score." },
  { name: "Eye Exam Calculator", url: "/eye-exam-calculator", description: "Eye exam cost by type." },
  { name: "BMI Calculator", url: "/bmi-calculator", description: "Body mass index calculator." },
  { name: "Blood Pressure Calculator", url: "/blood-pressure-calculator", description: "Blood pressure classification." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Hearing Loss Calculator" keywords="hearing loss calculator, dB HL, hearing level, mild hearing loss, severe hearing loss, speech banana, audiogram" breadcrumbs={[{ name: "Hearing Loss", url: "/hearing-loss-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Hearing Loss Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Enter your audiogram thresholds to classify hearing loss severity and understand which sounds you may miss.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="p-3 bg-blue-50 rounded-xl text-center text-xs font-semibold text-blue-900 uppercase tracking-wide">Enter Hearing Thresholds (dB HL) - Lower is Better</div>
        <div class="grid grid-cols-3 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">250 Hz</label><input type="number" id="hl-250" class="hl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="15" min="-10" max="120" step="5"></div>
          <div><label class="block text-xs font-medium text-text mb-1">500 Hz</label><input type="number" id="hl-500" class="hl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="20" min="-10" max="120" step="5"></div>
          <div><label class="block text-xs font-medium text-text mb-1">1000 Hz</label><input type="number" id="hl-1k" class="hl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="25" min="-10" max="120" step="5"></div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">2000 Hz</label><input type="number" id="hl-2k" class="hl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="30" min="-10" max="120" step="5"></div>
          <div><label class="block text-xs font-medium text-text mb-1">4000 Hz</label><input type="number" id="hl-4k" class="hl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="40" min="-10" max="120" step="5"></div>
          <div><label class="block text-xs font-medium text-text mb-1">8000 Hz</label><input type="number" id="hl-8k" class="hl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="45" min="-10" max="120" step="5"></div>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Ear</label>
          <select id="hl-ear" class="hl-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
            <option value="right" selected>Right Ear</option>
            <option value="left">Left Ear</option>
            <option value="better">Better Ear</option>
          </select>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Hearing Loss Classification</div>
          <div class="text-4xl font-extrabold font-mono" id="hl-class">Normal</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">PTA (Pure Tone Avg)</div><div class="text-xl font-bold font-mono" id="hl-pta">0 dB</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">High-Freq Average</div><div class="text-xl font-bold font-mono" id="hl-hfa">0 dB</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Pattern</div><div class="text-xl font-bold font-mono" id="hl-pattern">-</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Speech Understanding</div><div class="text-xl font-bold font-mono" id="hl-speech">-</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Recommendation</div><div class="text-xl font-bold font-mono" id="hl-rec">-</div></div>
        </div>
        <div class="p-3 bg-amber-50 rounded-xl text-center text-xs text-amber-800 font-semibold">
          This tool is for educational purposes. Please see an audiologist for professional hearing evaluation.
        </div>
      </div>
      <ShareButton calculatorId="hearing-loss" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcHL() {
      const f250 = parseFloat((document.getElementById('hl-250') as HTMLInputElement).value) || 0;
      const f500 = parseFloat((document.getElementById('hl-500') as HTMLInputElement).value) || 0;
      const f1k = parseFloat((document.getElementById('hl-1k') as HTMLInputElement).value) || 0;
      const f2k = parseFloat((document.getElementById('hl-2k') as HTMLInputElement).value) || 0;
      const f4k = parseFloat((document.getElementById('hl-4k') as HTMLInputElement).value) || 0;
      const f8k = parseFloat((document.getElementById('hl-8k') as HTMLInputElement).value) || 0;

      // PTA: average of 500, 1000, 2000 Hz (standard)
      const pta = (f500 + f1k + f2k) / 3;
      // High-frequency average: 2000, 4000, 8000
      const hfa = (f2k + f4k + f8k) / 3;

      // Classification based on PTA (WHO / ASHA)
      let classification: string;
      if (pta <= 15) classification = 'Normal';
      else if (pta <= 25) classification = 'Slight';
      else if (pta <= 40) classification = 'Mild';
      else if (pta <= 55) classification = 'Moderate';
      else if (pta <= 70) classification = 'Moderately Severe';
      else if (pta <= 90) classification = 'Severe';
      else classification = 'Profound';

      // Pattern detection
      const lowAvg = (f250 + f500) / 2;
      const midAvg = (f1k + f2k) / 2;
      const highAvg = (f4k + f8k) / 2;
      let pattern: string;
      if (highAvg - lowAvg > 20) pattern = 'High-Freq Sloping';
      else if (lowAvg - highAvg > 20) pattern = 'Low-Freq (Rising)';
      else if (Math.abs(highAvg - lowAvg) <= 20 && midAvg < lowAvg - 15) pattern = 'Cookie-Bite';
      else if (highAvg > 60 && f4k > f2k + 15) pattern = 'Noise Notch (4kHz)';
      else pattern = 'Flat';

      // Speech understanding impact
      let speech: string;
      if (pta <= 15) speech = 'No difficulty';
      else if (pta <= 25) speech = 'Faint speech difficulty';
      else if (pta <= 40) speech = 'Soft speech missed';
      else if (pta <= 55) speech = 'Normal speech missed';
      else if (pta <= 70) speech = 'Loud speech difficult';
      else if (pta <= 90) speech = 'Cannot hear most speech';
      else speech = 'Cannot hear speech';

      // Recommendation
      let rec: string;
      if (pta <= 15) rec = 'Annual monitoring';
      else if (pta <= 25) rec = 'Monitor, consider aids';
      else if (pta <= 55) rec = 'Hearing aids recommended';
      else if (pta <= 90) rec = 'Power hearing aids';
      else rec = 'Cochlear implant eval';

      document.getElementById('hl-class')!.textContent = classification;
      document.getElementById('hl-pta')!.textContent = pta.toFixed(0) + ' dB HL';
      document.getElementById('hl-hfa')!.textContent = hfa.toFixed(0) + ' dB HL';
      document.getElementById('hl-pattern')!.textContent = pattern;
      document.getElementById('hl-speech')!.textContent = speech;
      document.getElementById('hl-rec')!.textContent = rec;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.hl-in').forEach(el => { el.addEventListener('input', calcHL); el.addEventListener('change', calcHL); });
      calcHL();
    }, 50);
  </script>
</CalculatorLayout>
