---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Timber Span Calculator - Maximum Beam & Joist Span Tables";
const description = "Calculate maximum beam and joist span for wood species, size, and load conditions. Get deflection estimates and code-compliant span recommendations.";

const relatedCalcs = [
  { name: "Board Foot Calculator", url: "/board-foot-calculator", description: "Board feet calculator." },
  { name: "Wood Weight Calculator", url: "/wood-weight-calculator", description: "Wood weight estimator." },
  { name: "Wood Moisture Calculator", url: "/wood-moisture-calculator", description: "Moisture content." },
  { name: "Wood Bending Calculator", url: "/wood-bending-calculator", description: "Bending radius." },
  { name: "Wood Screw Calculator", url: "/wood-screw-calculator", description: "Screw sizing." },
  { name: "Concrete Calculator", url: "/concrete-calculator", description: "Concrete calculator." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Timber Span Calculator"
  keywords="timber span calculator, beam span, joist span, lumber span table, max span, deflection calculator, structural wood"
  breadcrumbs={[{ name: "Timber Span Calculator", url: "/timber-span-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Timber Span Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate maximum beam and joist spans based on species, size, load, and spacing. For reference only - consult a structural engineer for critical applications.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Member Type</label>
        <select id="tsp-type" class="tsp-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="joist" selected>Floor Joist</option>
          <option value="rafter">Roof Rafter</option>
          <option value="beam">Beam / Header</option>
          <option value="deck">Deck Joist</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Lumber Size (nominal)</label>
          <select id="tsp-size" class="tsp-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="2x4">2x4</option>
            <option value="2x6">2x6</option>
            <option value="2x8" selected>2x8</option>
            <option value="2x10">2x10</option>
            <option value="2x12">2x12</option>
            <option value="4x6">4x6 (beam)</option>
            <option value="4x8">4x8 (beam)</option>
            <option value="6x6">6x6 (post/beam)</option>
            <option value="6x8">6x8 (beam)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Species / Grade</label>
          <select id="tsp-species" class="tsp-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="df-ss">Douglas Fir - Select Structural</option>
            <option value="df-2" selected>Douglas Fir - #2</option>
            <option value="syp-ss">Southern Pine - Select Structural</option>
            <option value="syp-2">Southern Pine - #2</option>
            <option value="spruce-2">Spruce-Pine-Fir - #2</option>
            <option value="hem-2">Hem-Fir - #2</option>
            <option value="cedar-2">Western Cedar - #2</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-5">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Spacing (inches o.c.)</label>
          <select id="tsp-spacing" class="tsp-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="12">12" o.c.</option>
            <option value="16" selected>16" o.c.</option>
            <option value="24">24" o.c.</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-2">Live Load (psf)</label>
          <select id="tsp-load" class="tsp-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="30">30 psf (sleeping areas)</option>
            <option value="40" selected>40 psf (living areas)</option>
            <option value="50">50 psf (public areas)</option>
            <option value="20">20 psf (roof, no snow)</option>
          </select>
        </div>
      </div>

      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-2">Deflection Limit</label>
        <select id="tsp-defl" class="tsp-in w-full px-4 py-3 border border-border rounded-xl text-lg">
          <option value="240">L/240 (floors under plaster)</option>
          <option value="360" selected>L/360 (standard floors)</option>
          <option value="180">L/180 (roof, no ceiling)</option>
        </select>
      </div>

      <!-- Primary Result -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Maximum Span</div>
        <div class="text-4xl font-extrabold" id="tsp-span">--</div>
        <div class="text-sm text-blue-200 mt-1" id="tsp-span-sub">--</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Bending Span (Fb)</div>
          <div class="text-xl font-bold" id="tsp-bend-span">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Deflection Span</div>
          <div class="text-xl font-bold" id="tsp-defl-span">--</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Actual Dimensions</div>
          <div class="text-xl font-bold" id="tsp-actual">--</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Modulus of Elasticity</div>
          <div class="text-xl font-bold" id="tsp-moe">--</div>
        </div>
      </div>

      <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl mb-6">
        <p class="text-sm text-yellow-800"><strong>Disclaimer:</strong> This calculator provides estimates for reference only. Always consult local building codes and a licensed structural engineer for load-bearing applications.</p>
      </div>

      <ShareButton calculatorId="timber-span" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Timber Span Basics</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Bending: M = wL^2/8, S = bd^2/6, Fb = M/S</strong></p>
        <p><strong>Deflection: d = 5wL^4 / (384EI), I = bd^3/12</strong></p>
      </div>
      <h3 class="text-xl font-semibold text-text mt-8">Key Factors</h3>
      <ul>
        <li><strong>Species and grade</strong> determine allowable stress and stiffness</li>
        <li><strong>Deeper members span farther</strong> - doubling depth doubles the span</li>
        <li><strong>Closer spacing</strong> allows slightly longer spans</li>
        <li><strong>Live load</strong> varies by occupancy type and jurisdiction</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcTSP() {
      const memberType = (document.getElementById('tsp-type') as HTMLSelectElement).value;
      const sizeKey = (document.getElementById('tsp-size') as HTMLSelectElement).value;
      const speciesKey = (document.getElementById('tsp-species') as HTMLSelectElement).value;
      const spacing = parseFloat((document.getElementById('tsp-spacing') as HTMLSelectElement).value) || 16;
      const liveLoad = parseFloat((document.getElementById('tsp-load') as HTMLSelectElement).value) || 40;
      const deflLimit = parseFloat((document.getElementById('tsp-defl') as HTMLSelectElement).value) || 360;

      // Actual dimensions (inches) for nominal sizes
      const sizes: Record<string, [number, number]> = {
        '2x4': [1.5, 3.5], '2x6': [1.5, 5.5], '2x8': [1.5, 7.25],
        '2x10': [1.5, 9.25], '2x12': [1.5, 11.25],
        '4x6': [3.5, 5.5], '4x8': [3.5, 7.25],
        '6x6': [5.5, 5.5], '6x8': [5.5, 7.25],
      };

      // Species data: [Fb psi (allowable bending), E psi (modulus of elasticity)]
      const speciesData: Record<string, [number, number]> = {
        'df-ss': [1500, 1900000], 'df-2': [900, 1600000],
        'syp-ss': [1600, 1800000], 'syp-2': [1000, 1400000],
        'spruce-2': [875, 1400000], 'hem-2': [850, 1300000],
        'cedar-2': [700, 1000000],
      };

      const dim = sizes[sizeKey] || [1.5, 7.25];
      const b = dim[0]; // width
      const d = dim[1]; // depth
      const sp = speciesData[speciesKey] || [900, 1600000];
      const Fb = sp[0];
      const E = sp[1];

      // Dead load assumption
      const deadLoad = memberType === 'rafter' ? 10 : 10; // psf
      const totalLoad = liveLoad + deadLoad;
      const w = totalLoad * spacing / 12 / 144; // load per inch of span (psi per in)

      // Section modulus and moment of inertia
      const S = (b * d * d) / 6;
      const I = (b * d * d * d) / 12;

      // Max span from bending: Fb >= wL^2/(8S) => L = sqrt(8*Fb*S/w)
      const wPLI = totalLoad * spacing / 12; // lb per linear foot converted below
      const wPLI_inlb = totalLoad * (spacing / 12) / 12; // lb per linear inch

      const bendSpanIn = Math.sqrt(8 * Fb * S / wPLI_inlb);
      const bendSpanFt = bendSpanIn / 12;

      // Max span from deflection: d = 5wL^4/(384EI) <= L/deflLimit
      // 5wL^4/(384EI) = L/deflLimit => 5wL^3 = 384EI/deflLimit => L = (384EI/(5w*deflLimit))^(1/3)
      const deflSpanIn = Math.pow((384 * E * I) / (5 * wPLI_inlb * deflLimit), 1/3);
      const deflSpanFt = deflSpanIn / 12;

      // Governing span is the smaller
      const maxSpanFt = Math.min(bendSpanFt, deflSpanFt);
      const maxSpanFtIn = Math.floor(maxSpanFt);
      const maxSpanRemIn = Math.round((maxSpanFt - maxSpanFtIn) * 12);

      const governing = bendSpanFt < deflSpanFt ? 'bending' : 'deflection';

      document.getElementById('tsp-span')!.textContent = maxSpanFtIn + "' " + maxSpanRemIn + '"';
      document.getElementById('tsp-span-sub')!.textContent = maxSpanFt.toFixed(1) + ' ft (governed by ' + governing + ')';
      document.getElementById('tsp-bend-span')!.textContent = bendSpanFt.toFixed(1) + ' ft';
      document.getElementById('tsp-defl-span')!.textContent = deflSpanFt.toFixed(1) + ' ft';
      document.getElementById('tsp-actual')!.textContent = b + '" x ' + d + '"';
      document.getElementById('tsp-moe')!.textContent = (E / 1000000).toFixed(1) + 'M psi';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.tsp-in').forEach(el => {
        el.addEventListener('input', calcTSP);
        el.addEventListener('change', calcTSP);
      });
      calcTSP();
    }, 50);
  </script>
</CalculatorLayout>
