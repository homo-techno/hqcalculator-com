---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "T-Test Calculator - One-Sample T-Test";
const description = "Perform a one-sample t-test. Enter sample mean, population mean, standard deviation, and sample size to get the t-statistic and significance.";

const relatedCalcs = [
  { name: "Chi-Square Calculator", url: "/chi-square-calculator", description: "Chi-square test." },
  { name: "ANOVA Calculator", url: "/anova-calculator", description: "Analysis of variance." },
  { name: "Correlation Calculator", url: "/correlation-calculator", description: "Pearson correlation." },
  { name: "Regression Calculator", url: "/regression-calculator", description: "Linear regression." },
  { name: "Average Calculator", url: "/average-calculator", description: "Mean, median, mode." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Spread of data." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="T-Test Calculator"
  keywords="t-test calculator, one sample t-test, t statistic, p value, significance test, hypothesis testing"
  breadcrumbs={[{ name: "T-Test Calculator", url: "/t-test-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">T-Test Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">One-sample t-test: determine whether a sample mean differs significantly from a population mean.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Sample Mean (x&#772;)</label>
            <input type="number" id="tt-xbar" class="tt-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="105" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Population Mean (&mu;)</label>
            <input type="number" id="tt-mu" class="tt-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="100" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Standard Deviation (s)</label>
            <input type="number" id="tt-sd" class="tt-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="15" step="any" min="0.001" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Sample Size (n)</label>
            <input type="number" id="tt-n" class="tt-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="30" min="2" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-text mb-1">Significance Level (&alpha;)</label>
          <select id="tt-alpha" class="tt-in w-full px-4 py-2 border border-border rounded-xl text-lg">
            <option value="0.01">0.01</option>
            <option value="0.05" selected>0.05</option>
            <option value="0.10">0.10</option>
          </select>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">T-Statistic</div>
          <div class="text-5xl font-extrabold font-mono" id="tt-result">0</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Degrees of Freedom</div>
            <div class="text-xl font-bold" id="tt-df">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Approx. p-value (two-tailed)</div>
            <div class="text-xl font-bold" id="tt-pval">—</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Standard Error</div>
            <div class="text-xl font-bold" id="tt-se">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Significant?</div>
            <div class="text-xl font-bold" id="tt-sig">—</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Interpretation</h3>
          <div class="text-sm text-text-secondary" id="tt-interpret"></div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Confidence Interval</h3>
          <div class="text-sm text-text-secondary font-mono" id="tt-ci"></div>
        </div>
      </div>

      <ShareButton calculatorId="t-test" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">One-Sample T-Test</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm">
        <p>t = (x&#772; - &mu;) / (s / &radic;n)</p>
      </div>
      <h3 class="text-xl font-semibold text-text mt-8">When to Use</h3>
      <ul>
        <li>Testing if a sample mean differs from a known population mean</li>
        <li>When population standard deviation is unknown</li>
        <li>Sample size is small (though works for any size)</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcTT() {
      const xbar = parseFloat((document.getElementById('tt-xbar') as HTMLInputElement).value) || 0;
      const mu = parseFloat((document.getElementById('tt-mu') as HTMLInputElement).value) || 0;
      const sd = parseFloat((document.getElementById('tt-sd') as HTMLInputElement).value) || 1;
      const n = parseInt((document.getElementById('tt-n') as HTMLInputElement).value) || 2;
      const alpha = parseFloat((document.getElementById('tt-alpha') as HTMLSelectElement).value);
      const fmt = (v: number) => Number.isInteger(v) ? String(v) : v.toFixed(4);

      if (n < 2 || sd <= 0) {
        document.getElementById('tt-result')!.textContent = '—';
        document.dispatchEvent(new CustomEvent('calc-update'));
        return;
      }

      const se = sd / Math.sqrt(n);
      const t = (xbar - mu) / se;
      const df = n - 1;

      // Approximate p-value using a simple approximation for two-tailed test
      // Using the approximation: p ≈ 2 * (1 - Φ(|t| * sqrt(df/(df-2+t²))))  for large df
      // For a better approximation, use regularized incomplete beta function
      const absT = Math.abs(t);
      let pValue: number;
      if (df >= 30) {
        // Normal approximation for large df
        const z = absT;
        pValue = 2 * (1 - normalCDF(z));
      } else {
        // Simple approximation using Hill's method
        const x = df / (df + t * t);
        pValue = incompleteBeta(df / 2, 0.5, x);
      }

      // t critical values approximation
      const tCrit: Record<string, Record<number, number>> = {
        '0.05': {1:12.706,2:4.303,3:3.182,4:2.776,5:2.571,6:2.447,7:2.365,8:2.306,9:2.262,10:2.228,15:2.131,20:2.086,25:2.060,29:2.045,30:2.042},
        '0.01': {1:63.657,2:9.925,3:5.841,4:4.604,5:4.032,6:3.707,7:3.499,8:3.355,9:3.250,10:3.169,15:2.947,20:2.845,25:2.787,29:2.756,30:2.750},
        '0.10': {1:6.314,2:2.920,3:2.353,4:2.132,5:2.015,6:1.943,7:1.895,8:1.860,9:1.833,10:1.812,15:1.753,20:1.725,25:1.708,29:1.699,30:1.697}
      };

      // Find closest df in table
      const alphaStr = String(alpha);
      let critVal = 1.96; // default
      if (tCrit[alphaStr]) {
        const table = tCrit[alphaStr];
        const keys = Object.keys(table).map(Number).sort((a, b) => a - b);
        let closest = keys[0];
        for (const k of keys) {
          if (Math.abs(k - df) < Math.abs(closest - df)) closest = k;
        }
        critVal = table[closest];
      }

      const isSignificant = absT > critVal;
      const marginOfError = critVal * se;

      document.getElementById('tt-result')!.textContent = fmt(t);
      document.getElementById('tt-df')!.textContent = String(df);
      document.getElementById('tt-se')!.textContent = fmt(se);
      document.getElementById('tt-pval')!.textContent = pValue < 0.0001 ? '< 0.0001' : fmt(pValue);
      document.getElementById('tt-sig')!.textContent = isSignificant ? `Yes (|t| > ${fmt(critVal)})` : `No (|t| < ${fmt(critVal)})`;

      if (isSignificant) {
        document.getElementById('tt-interpret')!.textContent =
          `The sample mean (${xbar}) is significantly different from the population mean (${mu}) at the α = ${alpha} level. The difference of ${fmt(xbar - mu)} is statistically significant.`;
      } else {
        document.getElementById('tt-interpret')!.textContent =
          `The sample mean (${xbar}) is NOT significantly different from the population mean (${mu}) at the α = ${alpha} level. The observed difference could be due to chance.`;
      }

      document.getElementById('tt-ci')!.textContent =
        `${(1 - alpha) * 100}% CI: [${fmt(xbar - marginOfError)}, ${fmt(xbar + marginOfError)}]`;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    function normalCDF(z: number): number {
      const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429;
      const p = 0.3275911;
      const sign = z < 0 ? -1 : 1;
      z = Math.abs(z) / Math.sqrt(2);
      const t = 1.0 / (1.0 + p * z);
      const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-z * z);
      return 0.5 * (1.0 + sign * y);
    }

    function incompleteBeta(a: number, b: number, x: number): number {
      // Simple series approximation of regularized incomplete beta
      if (x < 0 || x > 1) return 0;
      if (x === 0) return 0;
      if (x === 1) return 1;
      // Use continued fraction approximation
      const lnBeta = lgamma(a) + lgamma(b) - lgamma(a + b);
      const front = Math.exp(Math.log(x) * a + Math.log(1 - x) * b - lnBeta);
      let sum = 1, val = 1;
      for (let i = 1; i <= 200; i++) {
        val *= (i - b) * x / (a + i);
        sum += val;
        if (Math.abs(val) < 1e-10) break;
      }
      return Math.min(1, Math.max(0, front * sum / a));
    }

    function lgamma(z: number): number {
      const c = [76.18009172947146, -86.50532032941677, 24.01409824083091, -1.231739572450155, 0.001208650973866179, -0.000005395239384953];
      let x = z, y = z;
      let tmp = x + 5.5;
      tmp -= (x + 0.5) * Math.log(tmp);
      let ser = 1.000000000190015;
      for (let j = 0; j < 6; j++) ser += c[j] / ++y;
      return -tmp + Math.log(2.5066282746310005 * ser / x);
    }

    setTimeout(() => {
      document.querySelectorAll('.tt-in').forEach(el => {
        el.addEventListener('input', calcTT);
        el.addEventListener('change', calcTT);
      });
      calcTT();
    }, 50);
  </script>
</CalculatorLayout>
