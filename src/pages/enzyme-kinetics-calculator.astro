---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Enzyme Kinetics Calculator - Michaelis-Menten & Lineweaver-Burk";
const description = "Calculate Michaelis-Menten kinetics including Vmax, Km, Lineweaver-Burk plot values, turnover number (kcat), and catalytic efficiency.";
const relatedCalcs = [
  { name: "Molarity Calculator", url: "/molarity-calculator", description: "Solution concentration." },
  { name: "Logarithm Calculator", url: "/logarithm-calculator", description: "Logarithm calculations." },
  { name: "Scientific Notation", url: "/scientific-notation-calculator", description: "Scientific notation." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage calculations." },
  { name: "Half-Life Calculator", url: "/half-life-calculator", description: "Half-life calculations." },
  { name: "Mole Calculator", url: "/mole-calculator", description: "Mole conversions." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Enzyme Kinetics Calculator" keywords="enzyme kinetics, Michaelis-Menten, Vmax, Km, Lineweaver-Burk, kcat, turnover number, catalytic efficiency" breadcrumbs={[{ name: "Enzyme Kinetics", url: "/enzyme-kinetics-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Enzyme Kinetics Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Michaelis-Menten: v = Vmax[S] / (Km + [S])</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="flex gap-2 mb-2">
          <button id="ek-m1" class="ek-mode flex-1 py-2 rounded-xl border-2 border-primary bg-blue-50 text-primary font-bold text-sm" data-mode="velocity">Reaction Rate</button>
          <button id="ek-m2" class="ek-mode flex-1 py-2 rounded-xl border-2 border-border text-text-muted font-bold text-sm" data-mode="params">Find Km/Vmax</button>
        </div>

        <div id="ek-panel-velocity">
          <div class="grid grid-cols-2 gap-3">
            <div><label class="block text-xs font-medium text-text mb-1">Vmax (mol/L/s)</label><input type="number" id="ek-vmax" class="ek-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
            <div><label class="block text-xs font-medium text-text mb-1">Km (mol/L)</label><input type="number" id="ek-km" class="ek-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <div><label class="block text-xs font-medium text-text mb-1">[S] Substrate (mol/L)</label><input type="number" id="ek-s" class="ek-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
            <div><label class="block text-xs font-medium text-text mb-1">[E]total (mol/L)</label><input type="number" id="ek-et" class="ek-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
          </div>
        </div>

        <div id="ek-panel-params" class="hidden">
          <p class="text-xs text-text-muted mb-2">Enter two data points (substrate concentration and velocity) to estimate Km and Vmax</p>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="block text-xs font-medium text-text mb-1">[S]₁ (mol/L)</label><input type="number" id="ek-s1" class="ek-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
            <div><label class="block text-xs font-medium text-text mb-1">v₁ (mol/L/s)</label><input type="number" id="ek-v1" class="ek-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <div><label class="block text-xs font-medium text-text mb-1">[S]₂ (mol/L)</label><input type="number" id="ek-s2" class="ek-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
            <div><label class="block text-xs font-medium text-text mb-1">v₂ (mol/L/s)</label><input type="number" id="ek-v2" class="ek-in w-full px-4 py-3 border border-border rounded-xl font-bold" step="any"></div>
          </div>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1" id="ek-label">Reaction Velocity (v)</div>
          <div class="text-5xl font-extrabold font-mono" id="ek-result">--</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase" id="ek-s1l">% of Vmax</div><div class="text-xl font-bold font-mono" id="ek-r1">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase" id="ek-s2l">kcat (s⁻¹)</div><div class="text-xl font-bold font-mono" id="ek-r2">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase" id="ek-s3l">kcat/Km (M⁻¹s⁻¹)</div><div class="text-xl font-bold font-mono" id="ek-r3">--</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">1/v (Lineweaver-Burk)</div><div class="text-xl font-bold font-mono" id="ek-lb1">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">1/[S] (Lineweaver-Burk)</div><div class="text-xl font-bold font-mono" id="ek-lb2">--</div></div>
        </div>
      </div>
      <ShareButton calculatorId="enzyme-kinetics" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    let ekMode = 'velocity';

    function setEkMode(m: string) {
      ekMode = m;
      document.getElementById('ek-panel-velocity')!.classList.toggle('hidden', m !== 'velocity');
      document.getElementById('ek-panel-params')!.classList.toggle('hidden', m !== 'params');
      document.querySelectorAll('.ek-mode').forEach(b => {
        const btn = b as HTMLButtonElement;
        const active = btn.dataset.mode === m;
        btn.className = `ek-mode flex-1 py-2 rounded-xl border-2 font-bold text-sm ${active ? 'border-primary bg-blue-50 text-primary' : 'border-border text-text-muted'}`;
      });
      calcEK();
    }

    function calcEK() {
      const label = document.getElementById('ek-label')!;
      const result = document.getElementById('ek-result')!;

      if (ekMode === 'velocity') {
        const Vmax = parseFloat((document.getElementById('ek-vmax') as HTMLInputElement).value) || 0;
        const Km = parseFloat((document.getElementById('ek-km') as HTMLInputElement).value) || 1;
        const S = parseFloat((document.getElementById('ek-s') as HTMLInputElement).value) || 0;
        const Et = parseFloat((document.getElementById('ek-et') as HTMLInputElement).value) || 1e-6;
        const v = Vmax * S / (Km + S);
        const pctVmax = Vmax > 0 ? (v / Vmax) * 100 : 0;
        const kcat = Et > 0 ? Vmax / Et : 0;
        const catEff = Km > 0 ? kcat / Km : 0;
        label.textContent = 'Reaction Velocity (v)';
        result.textContent = v.toExponential(4) + ' M/s';
        document.getElementById('ek-r1')!.textContent = pctVmax.toFixed(1) + '%';
        document.getElementById('ek-r2')!.textContent = kcat.toExponential(3);
        document.getElementById('ek-r3')!.textContent = catEff.toExponential(3);
        document.getElementById('ek-s1l')!.textContent = '% of Vmax';
        document.getElementById('ek-s2l')!.textContent = 'kcat (s\u207B\u00B9)';
        document.getElementById('ek-s3l')!.textContent = 'kcat/Km';
        document.getElementById('ek-lb1')!.textContent = v > 0 ? (1/v).toExponential(4) : '--';
        document.getElementById('ek-lb2')!.textContent = S > 0 ? (1/S).toExponential(4) : '--';
      } else {
        const S1 = parseFloat((document.getElementById('ek-s1') as HTMLInputElement).value) || 0;
        const v1 = parseFloat((document.getElementById('ek-v1') as HTMLInputElement).value) || 0;
        const S2 = parseFloat((document.getElementById('ek-s2') as HTMLInputElement).value) || 0;
        const v2 = parseFloat((document.getElementById('ek-v2') as HTMLInputElement).value) || 0;
        // Lineweaver-Burk: 1/v = (Km/Vmax)(1/[S]) + 1/Vmax
        // Two points: solve for slope and intercept
        if (v1 > 0 && v2 > 0 && S1 > 0 && S2 > 0 && S1 !== S2) {
          const x1 = 1 / S1, y1 = 1 / v1;
          const x2 = 1 / S2, y2 = 1 / v2;
          const slope = (y2 - y1) / (x2 - x1);
          const intercept = y1 - slope * x1;
          const Vmax = intercept > 0 ? 1 / intercept : 0;
          const Km = slope * Vmax;
          label.textContent = 'Estimated Parameters';
          result.textContent = 'Km = ' + Km.toExponential(3) + ' M';
          document.getElementById('ek-r1')!.textContent = Vmax.toExponential(3);
          document.getElementById('ek-s1l')!.textContent = 'Vmax (M/s)';
          document.getElementById('ek-r2')!.textContent = slope.toExponential(3);
          document.getElementById('ek-s2l')!.textContent = 'LB Slope';
          document.getElementById('ek-r3')!.textContent = intercept.toExponential(3);
          document.getElementById('ek-s3l')!.textContent = 'LB Intercept';
          document.getElementById('ek-lb1')!.textContent = 'y = ' + slope.toExponential(2) + 'x';
          document.getElementById('ek-lb2')!.textContent = '+ ' + intercept.toExponential(2);
        } else {
          label.textContent = 'Estimated Parameters';
          result.textContent = 'Need 2 valid points';
          document.getElementById('ek-r1')!.textContent = '--';
          document.getElementById('ek-r2')!.textContent = '--';
          document.getElementById('ek-r3')!.textContent = '--';
          document.getElementById('ek-lb1')!.textContent = '--';
          document.getElementById('ek-lb2')!.textContent = '--';
        }
      }
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      (document.getElementById('ek-vmax') as HTMLInputElement).value = '0.001';
      (document.getElementById('ek-km') as HTMLInputElement).value = '0.0005';
      (document.getElementById('ek-s') as HTMLInputElement).value = '0.001';
      (document.getElementById('ek-et') as HTMLInputElement).value = '1e-7';
      (document.getElementById('ek-s1') as HTMLInputElement).value = '0.0001';
      (document.getElementById('ek-v1') as HTMLInputElement).value = '0.000167';
      (document.getElementById('ek-s2') as HTMLInputElement).value = '0.001';
      (document.getElementById('ek-v2') as HTMLInputElement).value = '0.000667';
      document.querySelectorAll('.ek-mode').forEach(b => b.addEventListener('click', () => setEkMode((b as HTMLButtonElement).dataset.mode!)));
      document.querySelectorAll('.ek-in').forEach(el => { el.addEventListener('input', calcEK); el.addEventListener('change', calcEK); });
      calcEK();
    }, 50);
  </script>
</CalculatorLayout>
