---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Pipe Sizing Calculator - Diameter from Flow Rate & Velocity";
const description = "Calculate the correct pipe diameter from flow rate, velocity, fixture units, DFU to GPM conversion, and pipe material selection for plumbing systems.";
const relatedCalcs = [
  { name: "Plumbing Pipe", url: "/plumbing-pipe-calculator", description: "Pipe length and fittings." },
  { name: "Pipe Flow", url: "/pipe-flow-calculator", description: "Flow rate in pipes." },
  { name: "Fluid Flow", url: "/fluid-flow-calculator", description: "Fluid dynamics." },
  { name: "Reynolds Number", url: "/reynolds-number-calculator", description: "Flow regime analysis." },
  { name: "Bernoulli Equation", url: "/bernoulli-equation-calculator", description: "Fluid energy." },
  { name: "Drainage", url: "/drainage-calculator", description: "Drainage system sizing." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Pipe Sizing Calculator" keywords="pipe sizing calculator, pipe diameter, fixture units, DFU to GPM, flow rate velocity" breadcrumbs={[{ name: "Pipe Sizing", url: "/pipe-sizing-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Pipe Sizing Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Determine the correct pipe diameter based on flow rate, velocity limits, fixture units, and material.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-text mb-1">Sizing Method</label>
          <select id="ps4-method" class="ps4-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="flow" selected>Flow Rate &amp; Velocity</option>
            <option value="dfu">Fixture Units (DFU)</option>
          </select>
        </div>
        <div id="ps4-flow-inputs">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Flow Rate (GPM)</label>
              <input type="number" id="ps4-gpm" class="ps4-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="12" min="0.5" step="0.5">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Max Velocity (ft/s)</label>
              <input type="number" id="ps4-vel" class="ps4-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="8" min="1" max="15" step="0.5">
            </div>
          </div>
        </div>
        <div id="ps4-dfu-inputs" style="display:none">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Total Fixture Units (DFU)</label>
            <input type="number" id="ps4-dfu" class="ps4-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="30" min="1" step="1">
          </div>
          <div class="mt-3">
            <label class="block text-xs font-medium text-text mb-1">System Type</label>
            <select id="ps4-systype" class="ps4-in w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="supply" selected>Water Supply</option>
              <option value="drain">Drain/Waste</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Pipe Material</label>
          <select id="ps4-mat" class="ps4-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="copper" selected>Copper (Type L)</option>
            <option value="pex">PEX</option>
            <option value="cpvc">CPVC</option>
            <option value="pvc">PVC (Schedule 40)</option>
            <option value="galv">Galvanized Steel</option>
          </select>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Recommended Pipe Diameter</div>
          <div class="text-4xl font-extrabold" id="ps4-result">0"</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Actual Velocity</div><div class="text-xl font-bold" id="ps4-actvel">0 ft/s</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Flow Rate</div><div class="text-xl font-bold" id="ps4-actflow">0 GPM</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Min Pipe ID</div><div class="text-xl font-bold" id="ps4-minid">0"</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Friction Loss</div><div class="text-xl font-bold" id="ps4-frloss">0 PSI/100ft</div></div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-3">Pipe Size Comparison</h3>
          <div class="space-y-1 text-sm" id="ps4-compare"></div>
        </div>
      </div>
      <ShareButton calculatorId="pipe-sizing" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcPS4() {
      const method = (document.getElementById('ps4-method') as HTMLSelectElement).value;
      document.getElementById('ps4-flow-inputs')!.style.display = method === 'flow' ? '' : 'none';
      document.getElementById('ps4-dfu-inputs')!.style.display = method === 'dfu' ? '' : 'none';

      const mat = (document.getElementById('ps4-mat') as HTMLSelectElement).value;
      let flowGPM: number;
      let maxVel: number;

      if (method === 'dfu') {
        const dfu = parseInt((document.getElementById('ps4-dfu') as HTMLInputElement).value) || 30;
        const systype = (document.getElementById('ps4-systype') as HTMLSelectElement).value;
        // Hunter's curve: GPM = 1.0 * sqrt(DFU) for supply, approx
        if (systype === 'supply') {
          if (dfu <= 5) flowGPM = dfu * 1.0;
          else if (dfu <= 20) flowGPM = 5 + (dfu - 5) * 0.8;
          else if (dfu <= 100) flowGPM = 17 + (dfu - 20) * 0.5;
          else flowGPM = 57 + (dfu - 100) * 0.3;
        } else {
          flowGPM = Math.max(1, dfu * 0.5);
        }
        maxVel = 8;
      } else {
        flowGPM = parseFloat((document.getElementById('ps4-gpm') as HTMLInputElement).value) || 12;
        maxVel = parseFloat((document.getElementById('ps4-vel') as HTMLInputElement).value) || 8;
      }

      // Nominal pipe sizes (inches) and their approximate IDs
      const pipeSizes: Record<string, number[][]> = {
        copper: [[0.5, 0.545], [0.75, 0.785], [1, 1.025], [1.25, 1.265], [1.5, 1.505], [2, 1.985], [2.5, 2.465], [3, 2.945]],
        pex: [[0.5, 0.475], [0.75, 0.681], [1, 0.862], [1.25, 1.062], [1.5, 1.262], [2, 1.662]],
        cpvc: [[0.5, 0.536], [0.75, 0.720], [1, 0.950], [1.25, 1.188], [1.5, 1.406], [2, 1.846]],
        pvc: [[0.5, 0.622], [0.75, 0.824], [1, 1.049], [1.25, 1.380], [1.5, 1.610], [2, 2.067], [3, 3.068], [4, 4.026]],
        galv: [[0.5, 0.622], [0.75, 0.824], [1, 1.049], [1.25, 1.380], [1.5, 1.610], [2, 2.067]]
      };

      const sizes = pipeSizes[mat] || pipeSizes.copper;

      // Min diameter: d = sqrt(0.4085 * Q / V) where Q in GPM, V in ft/s
      const minDiam = Math.sqrt(0.4085 * flowGPM / maxVel);

      // Find smallest pipe that keeps velocity under limit
      let selected = sizes[sizes.length - 1];
      for (const s of sizes) {
        if (s[1] >= minDiam) { selected = s; break; }
      }

      const actualVel = 0.4085 * flowGPM / (selected[1] * selected[1]);

      // Friction loss using Hazen-Williams (PSI per 100 ft)
      const cVal: Record<string, number> = { copper: 140, pex: 150, cpvc: 140, pvc: 150, galv: 100 };
      const C = cVal[mat] || 140;
      const Q_cfs = flowGPM / 448.831;
      const d_ft = selected[1] / 12;
      const hf_per100 = 10.67 * 100 * Math.pow(Q_cfs, 1.852) / (Math.pow(C, 1.852) * Math.pow(d_ft, 4.87));
      const frPSI = hf_per100 * 0.433;

      // Nominal size label
      const nomLabels: Record<number, string> = { 0.5: '1/2"', 0.75: '3/4"', 1: '1"', 1.25: '1-1/4"', 1.5: '1-1/2"', 2: '2"', 2.5: '2-1/2"', 3: '3"', 4: '4"' };

      document.getElementById('ps4-result')!.textContent = nomLabels[selected[0]] || selected[0] + '"';
      document.getElementById('ps4-actvel')!.textContent = actualVel.toFixed(1) + ' ft/s';
      document.getElementById('ps4-actflow')!.textContent = flowGPM.toFixed(1) + ' GPM';
      document.getElementById('ps4-minid')!.textContent = minDiam.toFixed(3) + '"';
      document.getElementById('ps4-frloss')!.textContent = frPSI.toFixed(2) + ' PSI/100ft';

      // Comparison table
      let compHTML = '';
      for (const s of sizes) {
        const v = 0.4085 * flowGPM / (s[1] * s[1]);
        const ok = v <= maxVel;
        const label = nomLabels[s[0]] || s[0] + '"';
        const cls = s[0] === selected[0] ? 'font-bold text-primary' : (ok ? '' : 'text-text-muted');
        compHTML += '<div class="flex justify-between ' + cls + '"><span>' + label + ' (ID: ' + s[1].toFixed(3) + '")</span><span>' + v.toFixed(1) + ' ft/s' + (s[0] === selected[0] ? ' *' : '') + '</span></div>';
      }
      document.getElementById('ps4-compare')!.innerHTML = compHTML;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.ps4-in').forEach(el => { el.addEventListener('input', calcPS4); el.addEventListener('change', calcPS4); });
      calcPS4();
    }, 50);
  </script>
</CalculatorLayout>
