---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Water Bill Calculator - Usage Tiers, Sewer & Cost Estimate";
const description = "Calculate your water bill from usage tiers, sewer charges, base fees, and compare seasonal costs to find savings opportunities.";
const relatedCalcs = [
  { name: "Electricity Bill", url: "/electricity-bill-calculator", description: "Electric bill estimate." },
  { name: "Water Usage", url: "/water-usage-calculator", description: "Daily water consumption." },
  { name: "Gas Cost", url: "/gas-cost-calculator", description: "Natural gas costs." },
  { name: "Electricity Cost", url: "/electricity-cost-calculator", description: "Power consumption costs." },
  { name: "Cost of Living", url: "/cost-of-living-calculator", description: "Living expense comparison." },
  { name: "Pool Cost", url: "/pool-cost-calculator", description: "Pool operating costs." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Water Bill Calculator" keywords="water bill calculator, water cost, sewer charges, usage tiers, monthly water bill" breadcrumbs={[{ name: "Water Bill", url: "/water-bill-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Water Bill Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate your monthly water bill including tiered usage rates, sewer charges, and base fees.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-text mb-1">Monthly Water Usage (gallons)</label>
          <input type="number" id="wb4-usage" class="wb4-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="6000" min="0" step="100">
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Usage Unit on Bill</label>
          <select id="wb4-unit" class="wb4-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="gal" selected>Gallons</option>
            <option value="ccf">CCF (100 cubic feet)</option>
            <option value="1000gal">Thousands of Gallons</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Monthly Base/Service Fee ($)</label>
          <input type="number" id="wb4-base" class="wb4-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="15" min="0" step="1">
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-3">Water Rate Tiers (per 1000 gallons)</h3>
          <div class="space-y-2">
            <div class="grid grid-cols-3 gap-2">
              <div><label class="block text-xs text-text-muted">Tier 1 up to (gal)</label><input type="number" id="wb4-t1limit" class="wb4-in w-full px-3 py-2 border border-border rounded-lg text-sm" value="3000" step="100"></div>
              <div><label class="block text-xs text-text-muted">Rate ($/1000 gal)</label><input type="number" id="wb4-t1rate" class="wb4-in w-full px-3 py-2 border border-border rounded-lg text-sm" value="5" step="0.5"></div>
              <div class="flex items-end"><span class="text-sm text-text-muted pb-2" id="wb4-t1cost">$0</span></div>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <div><label class="block text-xs text-text-muted">Tier 2 up to (gal)</label><input type="number" id="wb4-t2limit" class="wb4-in w-full px-3 py-2 border border-border rounded-lg text-sm" value="8000" step="100"></div>
              <div><label class="block text-xs text-text-muted">Rate ($/1000 gal)</label><input type="number" id="wb4-t2rate" class="wb4-in w-full px-3 py-2 border border-border rounded-lg text-sm" value="8" step="0.5"></div>
              <div class="flex items-end"><span class="text-sm text-text-muted pb-2" id="wb4-t2cost">$0</span></div>
            </div>
            <div class="grid grid-cols-3 gap-2">
              <div><label class="block text-xs text-text-muted">Tier 3 (excess)</label><input type="number" class="w-full px-3 py-2 border border-border rounded-lg text-sm bg-gray-100" disabled></div>
              <div><label class="block text-xs text-text-muted">Rate ($/1000 gal)</label><input type="number" id="wb4-t3rate" class="wb4-in w-full px-3 py-2 border border-border rounded-lg text-sm" value="12" step="0.5"></div>
              <div class="flex items-end"><span class="text-sm text-text-muted pb-2" id="wb4-t3cost">$0</span></div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Sewer Charge Method</label>
            <select id="wb4-sewer" class="wb4-in w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="pct" selected>% of Water Bill</option>
              <option value="flat">Flat Fee</option>
              <option value="usage">Per 1000 gal</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Sewer Rate/Amount</label>
            <input type="number" id="wb4-seweramt" class="wb4-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="100" min="0" step="1">
          </div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Total Monthly Water Bill</div>
          <div class="text-4xl font-extrabold" id="wb4-total">$0.00</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Water Charges</div><div class="text-xl font-bold" id="wb4-water">$0</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Sewer Charges</div><div class="text-xl font-bold" id="wb4-sewercost">$0</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Cost Per Gallon</div><div class="text-xl font-bold" id="wb4-pergal">$0.000</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Annual Estimate</div><div class="text-xl font-bold" id="wb4-annual">$0</div></div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-3">Seasonal Comparison</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span>Summer Bill (1.5x usage)</span><span class="font-bold" id="wb4-summer">$0</span></div>
            <div class="flex justify-between"><span>Winter Bill (0.7x usage)</span><span class="font-bold" id="wb4-winter">$0</span></div>
            <div class="flex justify-between"><span>If You Cut 20% Usage</span><span class="font-bold" id="wb4-save20">$0</span></div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="water-bill" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcBill(usageGal: number, base: number, t1limit: number, t1rate: number, t2limit: number, t2rate: number, t3rate: number, sewerMethod: string, sewerAmt: number) {
      let waterCost = 0;
      let t1c = 0, t2c = 0, t3c = 0;
      const u = usageGal;
      if (u <= t1limit) {
        t1c = (u / 1000) * t1rate;
      } else if (u <= t2limit) {
        t1c = (t1limit / 1000) * t1rate;
        t2c = ((u - t1limit) / 1000) * t2rate;
      } else {
        t1c = (t1limit / 1000) * t1rate;
        t2c = ((t2limit - t1limit) / 1000) * t2rate;
        t3c = ((u - t2limit) / 1000) * t3rate;
      }
      waterCost = base + t1c + t2c + t3c;

      let sewerCost = 0;
      if (sewerMethod === 'pct') sewerCost = (waterCost - base) * sewerAmt / 100;
      else if (sewerMethod === 'flat') sewerCost = sewerAmt;
      else sewerCost = (u / 1000) * sewerAmt;

      return { waterCost, sewerCost, total: waterCost + sewerCost, t1c, t2c, t3c };
    }

    function calcWB4() {
      const usage = parseFloat((document.getElementById('wb4-usage') as HTMLInputElement).value) || 0;
      const unit = (document.getElementById('wb4-unit') as HTMLSelectElement).value;
      const base = parseFloat((document.getElementById('wb4-base') as HTMLInputElement).value) || 0;
      const t1limit = parseFloat((document.getElementById('wb4-t1limit') as HTMLInputElement).value) || 3000;
      const t1rate = parseFloat((document.getElementById('wb4-t1rate') as HTMLInputElement).value) || 5;
      const t2limit = parseFloat((document.getElementById('wb4-t2limit') as HTMLInputElement).value) || 8000;
      const t2rate = parseFloat((document.getElementById('wb4-t2rate') as HTMLInputElement).value) || 8;
      const t3rate = parseFloat((document.getElementById('wb4-t3rate') as HTMLInputElement).value) || 12;
      const sewerMethod = (document.getElementById('wb4-sewer') as HTMLSelectElement).value;
      const sewerAmt = parseFloat((document.getElementById('wb4-seweramt') as HTMLInputElement).value) || 0;

      // Convert to gallons
      let usageGal = usage;
      if (unit === 'ccf') usageGal = usage * 748.052;
      else if (unit === '1000gal') usageGal = usage * 1000;

      const r = calcBill(usageGal, base, t1limit, t1rate, t2limit, t2rate, t3rate, sewerMethod, sewerAmt);
      const summer = calcBill(usageGal * 1.5, base, t1limit, t1rate, t2limit, t2rate, t3rate, sewerMethod, sewerAmt);
      const winter = calcBill(usageGal * 0.7, base, t1limit, t1rate, t2limit, t2rate, t3rate, sewerMethod, sewerAmt);
      const save20 = calcBill(usageGal * 0.8, base, t1limit, t1rate, t2limit, t2rate, t3rate, sewerMethod, sewerAmt);

      document.getElementById('wb4-total')!.textContent = '$' + r.total.toFixed(2);
      document.getElementById('wb4-water')!.textContent = '$' + r.waterCost.toFixed(2);
      document.getElementById('wb4-sewercost')!.textContent = '$' + r.sewerCost.toFixed(2);
      document.getElementById('wb4-pergal')!.textContent = usageGal > 0 ? '$' + (r.total / usageGal).toFixed(4) : '$0.00';
      document.getElementById('wb4-annual')!.textContent = '$' + Math.round(r.total * 12).toLocaleString();
      document.getElementById('wb4-t1cost')!.textContent = '$' + r.t1c.toFixed(2);
      document.getElementById('wb4-t2cost')!.textContent = '$' + r.t2c.toFixed(2);
      document.getElementById('wb4-t3cost')!.textContent = '$' + r.t3c.toFixed(2);
      document.getElementById('wb4-summer')!.textContent = '$' + summer.total.toFixed(2);
      document.getElementById('wb4-winter')!.textContent = '$' + winter.total.toFixed(2);
      document.getElementById('wb4-save20')!.textContent = '$' + save20.total.toFixed(2) + ' (save $' + (r.total - save20.total).toFixed(2) + '/mo)';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.wb4-in').forEach(el => { el.addEventListener('input', calcWB4); el.addEventListener('change', calcWB4); });
      calcWB4();
    }, 50);
  </script>
</CalculatorLayout>
