---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Random Walk Calculator - Displacement & Return Probability";
const description = "Analyze random walks: expected displacement, return probability, steps to boundary, and diffusion coefficient for 1D and 2D walks.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "Event probability." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical tools." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Spread analysis." },
  { name: "Average Calculator", url: "/average-calculator", description: "Calculate averages." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
  { name: "Random Number", url: "/random-number-generator", description: "Random numbers." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Random Walk Calculator" keywords="random walk, brownian motion, expected displacement, return probability, diffusion, gambler ruin" breadcrumbs={[{ name: "Random Walk", url: "/random-walk-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Random Walk Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Analyze random walks and Brownian motion: displacement, boundary hitting, and return probabilities.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Dimension</label>
          <select class="rw2-in w-full px-4 py-2 border border-border rounded-xl" id="rw2-dim">
            <option value="1">1D (line)</option>
            <option value="2">2D (plane)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Number of Steps</label>
          <input type="number" class="rw2-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="rw2-steps" min="1" max="1000000" value="100">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Step Size</label>
          <input type="number" class="rw2-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" id="rw2-size" min="0.01" step="0.01" value="1">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">P(move right/up) - bias</label>
          <input type="number" class="rw2-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" id="rw2-bias" min="0" max="1" step="0.01" value="0.5">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Boundary Distance (for ruin/absorption)</label>
          <input type="number" class="rw2-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" id="rw2-boundary" min="1" value="10">
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Expected RMS Displacement</div>
          <div class="text-5xl font-extrabold font-mono" id="rw2-rms">--</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Expected Position</div>
            <div class="text-xl font-bold font-mono" id="rw2-mean">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Std Dev of Position</div>
            <div class="text-xl font-bold font-mono" id="rw2-sd">--</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Return to Origin Prob</div>
            <div class="text-xl font-bold font-mono" id="rw2-return">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Diffusion Coefficient</div>
            <div class="text-xl font-bold font-mono" id="rw2-diff">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Boundary / Gambler's Ruin Analysis</h3>
          <div class="text-xs font-mono space-y-1" id="rw2-ruin"></div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Displacement by Step Count</h3>
          <div class="text-xs font-mono space-y-1" id="rw2-table"></div>
        </div>
      </div>
      <ShareButton calculatorId="random-walk" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Random Walk Theory</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>RMS displacement:</strong> step_size x sqrt(N)</p>
        <p><strong>Mean position (biased):</strong> N x step_size x (2p - 1)</p>
        <p><strong>1D return probability:</strong> 1 (symmetric walk returns infinitely often)</p>
        <p><strong>2D return probability:</strong> 1 (Polya's theorem)</p>
        <p><strong>3D+ return probability:</strong> less than 1</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcRW2() {
      const dim = parseInt((document.getElementById('rw2-dim') as HTMLSelectElement).value);
      const steps = parseInt((document.getElementById('rw2-steps') as HTMLInputElement).value) || 100;
      const size = parseFloat((document.getElementById('rw2-size') as HTMLInputElement).value) || 1;
      const p = parseFloat((document.getElementById('rw2-bias') as HTMLInputElement).value) || 0.5;
      const boundary = parseInt((document.getElementById('rw2-boundary') as HTMLInputElement).value) || 10;

      const q = 1 - p;

      // 1D analysis
      const meanPos = steps * size * (2 * p - 1);
      const variance1D = 4 * p * q * steps * size * size;
      const sd = Math.sqrt(variance1D);
      const rms = size * Math.sqrt(steps);

      // Diffusion coefficient D = step^2 / (2 * dt), normalized D = step^2 * dim / 2
      const diffCoeff = (size * size) / (2 * dim);

      // Return probability
      let returnProb = '100% (recurrent)';
      if (dim >= 3) {
        returnProb = '~34% (transient)';
      }

      document.getElementById('rw2-rms')!.textContent = rms.toFixed(2);
      document.getElementById('rw2-mean')!.textContent = meanPos.toFixed(2);
      document.getElementById('rw2-sd')!.textContent = sd.toFixed(2);
      document.getElementById('rw2-return')!.textContent = returnProb;
      document.getElementById('rw2-diff')!.textContent = diffCoeff.toFixed(4);

      // Gambler's ruin (1D): starting at 0, boundaries at -boundary and +boundary
      // P(reach +boundary before -boundary) with bias p
      let ruinHtml = '';
      if (Math.abs(p - 0.5) < 0.0001) {
        // Symmetric: P(reach +B) = 0.5
        const expectedSteps = boundary * boundary;
        ruinHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>P(reach +' + boundary + ' first)</span><span>50.00%</span></div>';
        ruinHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>P(reach -' + boundary + ' first)</span><span>50.00%</span></div>';
        ruinHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>Expected steps to boundary</span><span>' + expectedSteps.toLocaleString() + '</span></div>';
      } else {
        const ratio = q / p;
        const pWin = (1 - Math.pow(ratio, boundary)) / (1 - Math.pow(ratio, 2 * boundary));
        const pLose = 1 - pWin;
        ruinHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>P(reach +' + boundary + ' first)</span><span>' + (pWin * 100).toFixed(2) + '%</span></div>';
        ruinHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>P(reach -' + boundary + ' first)</span><span>' + (pLose * 100).toFixed(2) + '%</span></div>';
      }
      document.getElementById('rw2-ruin')!.innerHTML = ruinHtml;

      // Displacement table
      const checkSteps = [1, 10, 50, 100, 500, 1000, 5000, 10000].filter(s => s <= steps * 2);
      let thtml = '';
      for (const s of checkSteps) {
        const r = size * Math.sqrt(s);
        const mean = s * size * (2 * p - 1);
        const marker = s === steps ? ' font-bold text-primary' : '';
        thtml += '<div class="flex justify-between py-0.5 border-b border-border' + marker + '"><span>' + s.toLocaleString() + ' steps</span><span>RMS: ' + r.toFixed(2) + ' | Mean: ' + mean.toFixed(2) + '</span></div>';
      }
      document.getElementById('rw2-table')!.innerHTML = thtml;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.rw2-in').forEach(el => { el.addEventListener('input', calcRW2); el.addEventListener('change', calcRW2); });
      calcRW2();
    }, 50);
  </script>
</CalculatorLayout>
