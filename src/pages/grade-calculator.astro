---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Grade Calculator - Final Grade & GPA Calculator";
const description = "Calculate your weighted grade, final exam score needed, and GPA. Supports multiple assignments with custom weights.";

const relatedCalcs = [
  { name: "GPA Calculator", url: "/gpa-calculator", description: "Grade points." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "Average Calculator", url: "/average-calculator", description: "Mean & median." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
  { name: "Probability Calculator", url: "/probability-calculator", description: "Probability." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Statistics." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Grade Calculator"
  keywords="grade calculator, final grade calculator, weighted grade, GPA calculator, what grade do I need, final exam calculator"
  breadcrumbs={[{ name: "Grade Calculator", url: "/grade-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Grade Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate your weighted grade and find out what you need on your final exam.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <!-- Mode tabs -->
          <div class="flex gap-2 mb-5">
            <button class="gc-mode-btn px-4 py-2 rounded-xl text-sm font-semibold border border-primary bg-blue-50 text-primary" data-mode="weighted">Weighted Grade</button>
            <button class="gc-mode-btn px-4 py-2 rounded-xl text-sm font-semibold border border-border" data-mode="final">Final Exam Needed</button>
          </div>

          <!-- Weighted grade mode -->
          <div id="gc-weighted">
            <h3 class="font-semibold text-text mb-3">Assignments</h3>
            <div class="space-y-2 mb-4" id="gc-rows">
              <div class="grid grid-cols-12 gap-2 text-xs font-medium text-text-muted">
                <div class="col-span-4">Category</div>
                <div class="col-span-3">Score (%)</div>
                <div class="col-span-3">Weight (%)</div>
                <div class="col-span-2"></div>
              </div>
            </div>
            <button id="gc-add" class="px-4 py-2 border border-border rounded-xl text-sm font-semibold hover:bg-surface-alt">+ Add Category</button>
          </div>

          <!-- Final exam mode -->
          <div id="gc-final" class="hidden">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-text mb-1">Current Grade (%)</label>
                <input type="number" id="gc-current" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="85" min="0" max="100" step="0.1">
              </div>
              <div>
                <label class="block text-sm font-medium text-text mb-1">Desired Final Grade (%)</label>
                <input type="number" id="gc-desired" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="90" min="0" max="100" step="0.1">
              </div>
              <div>
                <label class="block text-sm font-medium text-text mb-1">Final Exam Weight (%)</label>
                <input type="number" id="gc-final-weight" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="30" min="0" max="100" step="1">
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1" id="gc-result-label">Weighted Grade</div>
            <div class="text-5xl font-extrabold" id="gc-result">0%</div>
          </div>

          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Letter Grade</div>
            <div class="text-3xl font-bold" id="gc-letter">F</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">GPA Equivalent</div>
              <div class="text-xl font-bold" id="gc-gpa">0.0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Weight</div>
              <div class="text-xl font-bold" id="gc-total-weight">0%</div>
            </div>
          </div>

          <!-- Grade scale -->
          <div class="p-4 bg-surface-alt rounded-xl">
            <h3 class="font-semibold text-sm text-text mb-2">Grade Scale</h3>
            <div class="grid grid-cols-5 gap-1 text-xs text-center">
              <div class="p-1 bg-green-100 rounded"><strong>A</strong><br>90-100</div>
              <div class="p-1 bg-blue-100 rounded"><strong>B</strong><br>80-89</div>
              <div class="p-1 bg-yellow-100 rounded"><strong>C</strong><br>70-79</div>
              <div class="p-1 bg-orange-100 rounded"><strong>D</strong><br>60-69</div>
              <div class="p-1 bg-red-100 rounded"><strong>F</strong><br>0-59</div>
            </div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="grade" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How to Calculate Weighted Grades</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm">
        <p><strong>Weighted Grade</strong> = Σ (Score × Weight) / Σ Weight</p>
        <p class="mt-2"><strong>Final Needed</strong> = (Desired − Current × (1 − Final Weight)) / Final Weight</p>
      </div>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>What is a weighted grade?</strong> Different assignments count differently toward your final grade. A final exam worth 30% counts more than homework worth 10%.</p>
      <p><strong>What grade do I need on my final?</strong> Use the "Final Exam Needed" mode. Enter your current grade, desired grade, and the final's weight to find out.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let gcMode = 'weighted';
    let rowId = 0;

    interface GradeRow { id: number; name: string; score: number; weight: number; }

    const defaultRows: GradeRow[] = [
      { id: 0, name: 'Homework', score: 95, weight: 20 },
      { id: 1, name: 'Midterm', score: 82, weight: 25 },
      { id: 2, name: 'Quizzes', score: 88, weight: 15 },
      { id: 3, name: 'Project', score: 90, weight: 10 },
    ];

    function getLetterGrade(pct: number): { letter: string; gpa: string } {
      if (pct >= 97) return { letter: 'A+', gpa: '4.0' };
      if (pct >= 93) return { letter: 'A', gpa: '4.0' };
      if (pct >= 90) return { letter: 'A-', gpa: '3.7' };
      if (pct >= 87) return { letter: 'B+', gpa: '3.3' };
      if (pct >= 83) return { letter: 'B', gpa: '3.0' };
      if (pct >= 80) return { letter: 'B-', gpa: '2.7' };
      if (pct >= 77) return { letter: 'C+', gpa: '2.3' };
      if (pct >= 73) return { letter: 'C', gpa: '2.0' };
      if (pct >= 70) return { letter: 'C-', gpa: '1.7' };
      if (pct >= 67) return { letter: 'D+', gpa: '1.3' };
      if (pct >= 63) return { letter: 'D', gpa: '1.0' };
      if (pct >= 60) return { letter: 'D-', gpa: '0.7' };
      return { letter: 'F', gpa: '0.0' };
    }

    function renderRows() {
      const container = document.getElementById('gc-rows')!;
      const header = container.querySelector('.grid:first-child');
      container.innerHTML = '';
      if (header) container.appendChild(header);

      defaultRows.forEach((r, idx) => {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-12 gap-2 items-center';
        div.innerHTML = `
          <input type="text" value="${r.name}" class="gc-name col-span-4 px-2 py-2 border border-border rounded-lg text-sm" data-idx="${idx}">
          <input type="number" value="${r.score}" class="gc-score col-span-3 px-2 py-2 border border-border rounded-lg text-sm text-center" data-idx="${idx}" min="0" max="100" step="0.1">
          <input type="number" value="${r.weight}" class="gc-weight col-span-3 px-2 py-2 border border-border rounded-lg text-sm text-center" data-idx="${idx}" min="0" max="100" step="1">
          <button class="gc-remove col-span-2 text-danger text-xs hover:underline" data-idx="${idx}">Remove</button>
        `;
        container.appendChild(div);
      });

      container.querySelectorAll('.gc-name').forEach(el => el.addEventListener('input', (e) => {
        defaultRows[parseInt((e.target as HTMLElement).dataset.idx || '0')].name = (e.target as HTMLInputElement).value;
      }));
      container.querySelectorAll('.gc-score').forEach(el => el.addEventListener('input', (e) => {
        defaultRows[parseInt((e.target as HTMLElement).dataset.idx || '0')].score = parseFloat((e.target as HTMLInputElement).value) || 0;
        calcGrade();
      }));
      container.querySelectorAll('.gc-weight').forEach(el => el.addEventListener('input', (e) => {
        defaultRows[parseInt((e.target as HTMLElement).dataset.idx || '0')].weight = parseFloat((e.target as HTMLInputElement).value) || 0;
        calcGrade();
      }));
      container.querySelectorAll('.gc-remove').forEach(el => el.addEventListener('click', (e) => {
        defaultRows.splice(parseInt((e.target as HTMLElement).dataset.idx || '0'), 1);
        renderRows();
        calcGrade();
      }));
    }

    function calcGrade() {
      let result = 0;

      if (gcMode === 'weighted') {
        let totalWeight = 0;
        let weightedSum = 0;
        defaultRows.forEach(r => {
          weightedSum += r.score * r.weight;
          totalWeight += r.weight;
        });
        result = totalWeight > 0 ? weightedSum / totalWeight : 0;
        document.getElementById('gc-result-label')!.textContent = 'Weighted Grade';
        document.getElementById('gc-total-weight')!.textContent = totalWeight + '%';
      } else {
        const current = parseFloat((document.getElementById('gc-current') as HTMLInputElement).value) || 0;
        const desired = parseFloat((document.getElementById('gc-desired') as HTMLInputElement).value) || 0;
        const finalWeight = (parseFloat((document.getElementById('gc-final-weight') as HTMLInputElement).value) || 0) / 100;
        result = finalWeight > 0 ? (desired - current * (1 - finalWeight)) / finalWeight : 0;
        document.getElementById('gc-result-label')!.textContent = 'Score Needed on Final';
        document.getElementById('gc-total-weight')!.textContent = (finalWeight * 100) + '%';
      }

      document.getElementById('gc-result')!.textContent = result.toFixed(1) + '%';
      const grade = getLetterGrade(result);
      document.getElementById('gc-letter')!.textContent = grade.letter;
      document.getElementById('gc-gpa')!.textContent = grade.gpa;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      rowId = defaultRows.length;
      renderRows();

      document.querySelectorAll('.gc-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.gc-mode-btn').forEach(b => { b.classList.remove('border-primary', 'bg-blue-50', 'text-primary'); b.classList.add('border-border'); });
          btn.classList.remove('border-border'); btn.classList.add('border-primary', 'bg-blue-50', 'text-primary');
          gcMode = (btn as HTMLElement).dataset.mode || 'weighted';
          document.getElementById('gc-weighted')!.classList.toggle('hidden', gcMode !== 'weighted');
          document.getElementById('gc-final')!.classList.toggle('hidden', gcMode !== 'final');
          calcGrade();
        });
      });

      document.getElementById('gc-add')!.addEventListener('click', () => {
        defaultRows.push({ id: rowId++, name: `Category ${defaultRows.length + 1}`, score: 0, weight: 0 });
        renderRows();
        calcGrade();
      });

      ['gc-current', 'gc-desired', 'gc-final-weight'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calcGrade);
      });

      calcGrade();
    }, 50);
  </script>
</CalculatorLayout>
