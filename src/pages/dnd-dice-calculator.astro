---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "D&D Dice Calculator";
const description = "Roll multiple dice (NdX+modifier), calculate averages, min/max values, probability distributions, and advantage/disadvantage rolls for tabletop RPGs.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "General probability math." },
  { name: "Random Number Generator", url: "/random-number-generator", description: "Generate random numbers." },
  { name: "Average Calculator", url: "/average-calculator", description: "Calculate averages." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage math." },
  { name: "Number Sequence", url: "/number-sequence-calculator", description: "Number patterns." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical analysis." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="D&D Dice Calculator" keywords="dnd dice roller, dice calculator, NdX, advantage disadvantage, tabletop rpg dice, d20, d6" breadcrumbs={[{ name: "D&D Dice", url: "/dnd-dice-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">D&amp;D Dice Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Roll multiple dice with modifiers, view statistics, and calculate advantage/disadvantage probabilities.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Number of Dice</label>
          <input type="number" class="dd-in w-full px-4 py-2 border border-border rounded-lg" id="dd-count" min="1" max="100" value="1">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Dice Type</label>
          <select class="dd-in w-full px-4 py-2 border border-border rounded-lg" id="dd-type">
            <option value="4">d4</option>
            <option value="6">d6</option>
            <option value="8">d8</option>
            <option value="10">d10</option>
            <option value="12">d12</option>
            <option value="20" selected>d20</option>
            <option value="100">d100</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Modifier (+/-)</label>
          <input type="number" class="dd-in w-full px-4 py-2 border border-border rounded-lg" id="dd-mod" value="0">
        </div>
        <div>
          <label class="block text-sm font-semibold text-text mb-1">Roll Mode</label>
          <select class="dd-in w-full px-4 py-2 border border-border rounded-lg" id="dd-mode">
            <option value="normal">Normal</option>
            <option value="advantage">Advantage (roll 2, keep highest)</option>
            <option value="disadvantage">Disadvantage (roll 2, keep lowest)</option>
          </select>
        </div>
        <button class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-blue-700 transition" id="dd-roll-btn">Roll Dice</button>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Roll Result</div>
          <div class="text-5xl font-extrabold font-mono" id="dd-result">--</div>
          <div class="text-sm text-blue-200 mt-1" id="dd-rolls-detail"></div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Minimum</div>
            <div class="text-xl font-bold font-mono" id="dd-min">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Average</div>
            <div class="text-xl font-bold font-mono" id="dd-avg">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Maximum</div>
            <div class="text-xl font-bold font-mono" id="dd-max">--</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Notation</div>
            <div class="text-lg font-bold font-mono" id="dd-notation">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Std Deviation</div>
            <div class="text-lg font-bold font-mono" id="dd-stddev">--</div>
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Probability Distribution</h3>
          <div class="text-xs font-mono space-y-1" id="dd-dist"></div>
        </div>
      </div>
      <ShareButton calculatorId="dnd-dice" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcDD() {
      const count = Math.max(1, parseInt((document.getElementById('dd-count') as HTMLInputElement).value) || 1);
      const sides = parseInt((document.getElementById('dd-type') as HTMLSelectElement).value) || 20;
      const mod = parseInt((document.getElementById('dd-mod') as HTMLInputElement).value) || 0;
      const mode = (document.getElementById('dd-mode') as HTMLSelectElement).value;

      const minVal = count * 1 + mod;
      const maxVal = count * sides + mod;
      let avg = count * (sides + 1) / 2 + mod;

      if (mode === 'advantage') {
        avg = count * (sides * (2 * sides + 1) / (3 * (sides + 1))) + mod + (count > 0 ? count * (sides - 1) / (3 * (sides + 1)) * 2 : 0);
        avg = count * ((2 * sides + 1) / 3 - (sides - 1) * (sides - 1) / (3 * sides * 2)) + mod;
      } else if (mode === 'disadvantage') {
        avg = count * ((sides + 1) / 2 - ((2 * sides + 1) / 3 - (sides + 1) / 2)) + mod;
      }

      const stddev = Math.sqrt(count * (sides * sides - 1) / 12);
      const modStr = mod >= 0 ? (mod > 0 ? '+' + mod : '') : mod.toString();
      const notation = count + 'd' + sides + modStr;

      document.getElementById('dd-min')!.textContent = minVal.toString();
      document.getElementById('dd-avg')!.textContent = avg.toFixed(1);
      document.getElementById('dd-max')!.textContent = maxVal.toString();
      document.getElementById('dd-notation')!.textContent = notation;
      document.getElementById('dd-stddev')!.textContent = stddev.toFixed(2);

      // Simple probability distribution for small dice
      let distHtml = '';
      if (count <= 4 && sides <= 20) {
        const total = Math.pow(sides, count);
        const outcomes: Record<number, number> = {};
        if (count === 1) {
          for (let i = 1; i <= sides; i++) outcomes[i + mod] = 1;
        } else if (count === 2) {
          for (let a = 1; a <= sides; a++) for (let b = 1; b <= sides; b++) {
            const s = a + b + mod;
            outcomes[s] = (outcomes[s] || 0) + 1;
          }
        } else {
          // approximate
          for (let v = minVal; v <= maxVal; v++) {
            const z = (v - avg) / (stddev || 1);
            outcomes[v] = Math.max(1, Math.round(total * Math.exp(-z * z / 2) / (stddev * Math.sqrt(2 * Math.PI))));
          }
        }
        const maxCount = Math.max(...Object.values(outcomes));
        const keys = Object.keys(outcomes).map(Number).sort((a, b) => a - b);
        const showKeys = keys.length > 20 ? keys.filter((_, i) => i % Math.ceil(keys.length / 15) === 0) : keys;
        for (const v of showKeys) {
          const pct = ((outcomes[v] || 0) / total * 100);
          const barW = Math.round((outcomes[v] || 0) / maxCount * 100);
          distHtml += '<div class="flex items-center gap-2"><span class="w-8 text-right">' + v + '</span><div class="flex-1 bg-gray-200 rounded-full h-3"><div class="bg-primary h-3 rounded-full" style="width:' + barW + '%"></div></div><span class="w-14 text-right">' + pct.toFixed(1) + '%</span></div>';
        }
      } else {
        distHtml = '<div class="text-text-muted">Distribution too large to display. Use statistics above.</div>';
      }
      document.getElementById('dd-dist')!.innerHTML = distHtml;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    function rollDD() {
      const count = Math.max(1, parseInt((document.getElementById('dd-count') as HTMLInputElement).value) || 1);
      const sides = parseInt((document.getElementById('dd-type') as HTMLSelectElement).value) || 20;
      const mod = parseInt((document.getElementById('dd-mod') as HTMLInputElement).value) || 0;
      const mode = (document.getElementById('dd-mode') as HTMLSelectElement).value;

      let rolls: number[] = [];
      let total = 0;

      if (mode === 'advantage' || mode === 'disadvantage') {
        for (let i = 0; i < count; i++) {
          const r1 = Math.floor(Math.random() * sides) + 1;
          const r2 = Math.floor(Math.random() * sides) + 1;
          const kept = mode === 'advantage' ? Math.max(r1, r2) : Math.min(r1, r2);
          rolls.push(kept);
          total += kept;
        }
      } else {
        for (let i = 0; i < count; i++) {
          const r = Math.floor(Math.random() * sides) + 1;
          rolls.push(r);
          total += r;
        }
      }
      total += mod;
      document.getElementById('dd-result')!.textContent = total.toString();
      document.getElementById('dd-rolls-detail')!.textContent = 'Rolls: [' + rolls.join(', ') + ']' + (mod !== 0 ? ' ' + (mod > 0 ? '+' : '') + mod : '');
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.dd-in').forEach(el => {
        el.addEventListener('input', calcDD);
        el.addEventListener('change', calcDD);
      });
      document.getElementById('dd-roll-btn')!.addEventListener('click', rollDD);
      calcDD();
    }, 50);
  </script>
</CalculatorLayout>
