---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import SliderInput from '../components/SliderInput.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Auto Loan Calculator - Car Payment Calculator 2026";
const description = "Calculate your monthly car payment, total interest, and see the full amortization schedule. Factor in down payment, trade-in value, and sales tax.";

const relatedCalcs = [
  { name: "Loan Calculator", url: "/loan-calculator", description: "General loan calculator." },
  { name: "Mortgage Calculator", url: "/mortgage-calculator", description: "Home loan payments." },
  { name: "Compound Interest Calculator", url: "/compound-interest-calculator", description: "Savings growth." },
  { name: "Salary Calculator", url: "/salary-calculator", description: "Annual & monthly salary." },
  { name: "Insurance Calculator", url: "/insurance-calculator", description: "Insurance cost estimator." },
  { name: "Debt Payoff Calculator", url: "/debt-payoff-calculator", description: "Debt payoff strategy." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Auto Loan Calculator"
  keywords="auto loan calculator, car payment calculator, car loan calculator, vehicle loan, car financing, monthly car payment"
  breadcrumbs={[{ name: "Auto Loan Calculator", url: "/auto-loan-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Auto Loan Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate your monthly car payment and total cost of financing. Factor in down payment, trade-in, and taxes.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <SliderInput id="auto-price" label="Vehicle Price" min={5000} max={150000} step={500} value={35000} prefix="$" tooltip="Sticker or negotiated price" />
          <SliderInput id="auto-down" label="Down Payment" min={0} max={50000} step={500} value={5000} prefix="$" tooltip="Cash down payment" />
          <SliderInput id="auto-trade" label="Trade-in Value" min={0} max={50000} step={500} value={0} prefix="$" tooltip="Value of your trade-in vehicle" />
          <SliderInput id="auto-rate" label="Interest Rate (APR)" min={0} max={25} step={0.1} value={6.5} suffix="%" tooltip="Annual percentage rate" />

          <div class="mt-4 mb-4">
            <label class="block text-sm font-medium text-text mb-2">Loan Term</label>
            <div class="flex gap-2">
              <button class="auto-term-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-surface-alt border border-border" data-months="36">36 mo</button>
              <button class="auto-term-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-surface-alt border border-border" data-months="48">48 mo</button>
              <button class="auto-term-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-primary text-white border border-primary" data-months="60">60 mo</button>
              <button class="auto-term-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-surface-alt border border-border" data-months="72">72 mo</button>
              <button class="auto-term-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-surface-alt border border-border" data-months="84">84 mo</button>
            </div>
          </div>

          <SliderInput id="auto-tax" label="Sales Tax Rate" min={0} max={15} step={0.25} value={7} suffix="%" tooltip="State/local sales tax on vehicle" />
        </div>

        <div class="space-y-4">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Monthly Payment</div>
            <div class="text-4xl sm:text-5xl font-extrabold" id="auto-monthly">$0</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Loan Amount</div>
              <div class="text-xl font-bold" id="auto-loan-amt">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Interest</div>
              <div class="text-xl font-bold text-danger" id="auto-interest">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Cost</div>
              <div class="text-xl font-bold" id="auto-total">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Sales Tax</div>
              <div class="text-xl font-bold" id="auto-tax-amt">$0</div>
            </div>
          </div>
          <div class="chart-container p-4 bg-surface-alt rounded-xl">
            <canvas id="auto-donut" width="220" height="220"></canvas>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="auto-loan" />
      <FeedbackWidget />
    </div>

    <!-- Amortization -->
    <div class="mt-12 bg-white border border-border rounded-2xl p-6 sm:p-8">
      <h2 class="text-2xl font-bold text-text mb-4">Amortization Schedule</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-border text-left">
              <th class="py-2 pr-3 font-semibold">Year</th>
              <th class="py-2 pr-3 font-semibold text-right">Payment</th>
              <th class="py-2 pr-3 font-semibold text-right">Principal</th>
              <th class="py-2 pr-3 font-semibold text-right">Interest</th>
              <th class="py-2 font-semibold text-right">Balance</th>
            </tr>
          </thead>
          <tbody id="auto-amort-tbody"></tbody>
        </table>
      </div>
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Auto Loans Work</h2>
      <p>An auto loan is a secured loan where the vehicle serves as collateral. Monthly payments are calculated using the same amortization formula as other installment loans. Your payment covers both principal and interest, with more going toward interest in early payments.</p>

      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono">
        Loan Amount = Vehicle Price + Sales Tax − Down Payment − Trade-in
      </div>

      <h3 class="text-xl font-semibold text-text mt-8">New vs. Used Car Rates</h3>
      <ul>
        <li><strong>New cars:</strong> Typically 4-7% APR for good credit, sometimes 0% promotional rates from manufacturers</li>
        <li><strong>Used cars:</strong> Usually 1-2% higher than new car rates, typically 5-10% APR</li>
        <li><strong>Credit score impact:</strong> Excellent (750+): 4-5%, Good (700-749): 5-7%, Fair (650-699): 7-12%, Poor (&lt;650): 12-20%+</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">How to Get a Better Rate</h3>
      <ul>
        <li><strong>Improve credit score:</strong> Even a small improvement can save thousands</li>
        <li><strong>Larger down payment:</strong> Reduces the loan amount and shows lender commitment</li>
        <li><strong>Shorter loan term:</strong> 36-48 months usually has lower rates than 72-84 months</li>
        <li><strong>Shop multiple lenders:</strong> Compare banks, credit unions, and dealer financing</li>
        <li><strong>Get pre-approved:</strong> Know your rate before visiting the dealership</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">The True Cost of a Longer Loan</h3>
      <p>While longer loan terms (72-84 months) lower your monthly payment, they significantly increase the total interest paid. A $35,000 car at 6.5% costs $4,072 in interest over 48 months, but $7,853 over 84 months — nearly double.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>Should I put money down?</strong> Yes. A 20% down payment is ideal. It reduces your loan amount, can get you a better rate, and prevents being "upside down" (owing more than the car is worth).</p>
      <p><strong>Is sales tax included in the loan?</strong> Usually yes — most buyers finance the sales tax as part of the loan. Some states don't charge sales tax on vehicles (Montana, Oregon, New Hampshire, Alaska, Delaware).</p>
      <p><strong>Can I pay off my auto loan early?</strong> Most auto loans allow early payoff without penalties. Check your loan agreement for prepayment penalty clauses.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    import Chart from 'chart.js/auto';
    let autoChart: Chart | null = null;
    let autoTermMonths = 60;

    function getVal(id: string): number {
      const s = document.getElementById(`${id}-slider`) as HTMLInputElement;
      return parseFloat(s?.value || '0');
    }
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString('en-US');

    function calcAuto() {
      const price = getVal('auto-price');
      const down = getVal('auto-down');
      const trade = getVal('auto-trade');
      const annualRate = getVal('auto-rate');
      const taxRate = getVal('auto-tax');
      const n = autoTermMonths;

      const salesTax = price * taxRate / 100;
      const loanAmount = Math.max(0, price + salesTax - down - trade);
      const r = annualRate / 100 / 12;

      let M: number;
      if (r > 0) {
        M = loanAmount * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
      } else {
        M = n > 0 ? loanAmount / n : 0;
      }

      const totalPayment = M * n;
      const totalInterest = totalPayment - loanAmount;

      document.getElementById('auto-monthly')!.textContent = fmt(M);
      document.getElementById('auto-loan-amt')!.textContent = fmt(loanAmount);
      document.getElementById('auto-interest')!.textContent = fmt(totalInterest);
      document.getElementById('auto-total')!.textContent = fmt(totalPayment + down + trade);
      document.getElementById('auto-tax-amt')!.textContent = fmt(salesTax);

      // Donut
      const ctx = (document.getElementById('auto-donut') as HTMLCanvasElement).getContext('2d')!;
      if (autoChart) autoChart.destroy();
      autoChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Principal', 'Interest', 'Tax', 'Down Payment'],
          datasets: [{
            data: [loanAmount, totalInterest, salesTax, down + trade],
            backgroundColor: ['#3b82f6', '#ef4444', '#f59e0b', '#10b981'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true, cutout: '65%',
          plugins: {
            legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true, font: { size: 11 } } },
            tooltip: { callbacks: { label: (c) => `${c.label}: ${fmt(c.parsed)}` } }
          }
        }
      });

      // Amortization (yearly)
      let balance = loanAmount;
      const years = Math.ceil(n / 12);
      let html = '';
      for (let y = 1; y <= years; y++) {
        let yPay = 0, yPrinc = 0, yInt = 0;
        const monthsThisYear = Math.min(12, n - (y - 1) * 12);
        for (let m = 0; m < monthsThisYear; m++) {
          const interest = balance * r;
          const princ = M - interest;
          balance = Math.max(0, balance - princ);
          yPay += M; yPrinc += princ; yInt += interest;
        }
        html += `<tr class="border-b border-border/30 hover:bg-surface-alt/50">
          <td class="py-2 pr-3 text-text-secondary">Year ${y}</td>
          <td class="py-2 pr-3 text-right">${fmt(yPay)}</td>
          <td class="py-2 pr-3 text-right text-primary">${fmt(yPrinc)}</td>
          <td class="py-2 pr-3 text-right text-danger">${fmt(yInt)}</td>
          <td class="py-2 text-right font-medium">${fmt(balance)}</td>
        </tr>`;
      }
      document.getElementById('auto-amort-tbody')!.innerHTML = html;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      ['auto-price-slider', 'auto-down-slider', 'auto-trade-slider', 'auto-rate-slider', 'auto-tax-slider'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calcAuto);
      });
      ['auto-price-input', 'auto-down-input', 'auto-trade-input', 'auto-rate-input', 'auto-tax-input'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', () => setTimeout(calcAuto, 120));
      });

      // Term buttons
      document.querySelectorAll('.auto-term-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.auto-term-btn').forEach(b => {
            b.classList.remove('bg-primary', 'text-white', 'border-primary');
            b.classList.add('bg-surface-alt', 'border-border');
          });
          btn.classList.remove('bg-surface-alt', 'border-border');
          btn.classList.add('bg-primary', 'text-white', 'border-primary');
          autoTermMonths = parseInt((btn as HTMLElement).dataset.months || '60');
          calcAuto();
        });
      });

      calcAuto();
    }, 50);
  </script>
</CalculatorLayout>
