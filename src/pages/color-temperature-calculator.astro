---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Color Temperature Calculator - Kelvin to Mired, CTO/CTB Gels & White Balance";
const description = "Convert between Kelvin and mired values, select CTO/CTB correction gels, and calculate white balance shift for photography and film.";
const relatedCalcs = [
  { name: "Photo Lighting", url: "/photo-lighting-calculator", description: "Lighting output calculations." },
  { name: "Exposure Calculator", url: "/exposure-calculator", description: "Exposure settings." },
  { name: "Flash Guide Number", url: "/flash-guide-number-calculator", description: "Flash power calculations." },
  { name: "Color Converter", url: "/color-converter", description: "Color space conversions." },
  { name: "Camera Sensor", url: "/camera-sensor-calculator", description: "Camera sensor comparisons." },
  { name: "Lighting Calculator", url: "/lighting-calculator", description: "Room lighting needs." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Color Temperature Calculator" keywords="color temperature calculator, kelvin mired converter, CTO CTB gel, white balance shift, color correction, film gels" breadcrumbs={[{ name: "Color Temperature", url: "/color-temperature-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Color Temperature Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Convert Kelvin to mired, select color correction gels, and calculate white balance shifts.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-1">Light Source Presets</label>
          <div class="flex flex-wrap gap-2">
            <button class="ct-preset px-3 py-1.5 rounded-lg text-xs font-semibold border border-border hover:bg-surface-alt" data-k="1800">Candle</button>
            <button class="ct-preset px-3 py-1.5 rounded-lg text-xs font-semibold border border-border hover:bg-surface-alt" data-k="2700">Tungsten</button>
            <button class="ct-preset px-3 py-1.5 rounded-lg text-xs font-semibold border border-border hover:bg-surface-alt" data-k="3200">Halogen</button>
            <button class="ct-preset px-3 py-1.5 rounded-lg text-xs font-semibold border border-border hover:bg-surface-alt" data-k="4000">Fluorescent</button>
            <button class="ct-preset px-3 py-1.5 rounded-lg text-xs font-semibold border border-border hover:bg-surface-alt" data-k="5500">Daylight</button>
            <button class="ct-preset px-3 py-1.5 rounded-lg text-xs font-semibold border border-border hover:bg-surface-alt" data-k="6500">Overcast</button>
            <button class="ct-preset px-3 py-1.5 rounded-lg text-xs font-semibold border border-border hover:bg-surface-alt" data-k="7500">Shade</button>
            <button class="ct-preset px-3 py-1.5 rounded-lg text-xs font-semibold border border-border hover:bg-surface-alt" data-k="10000">Blue Sky</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Source Color Temperature (Kelvin)</label>
          <input type="number" id="ct-source" class="ct-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="5500" min="1000" max="20000" step="100">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Target Color Temperature (Kelvin)</label>
          <input type="number" id="ct-target" class="ct-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="3200" min="1000" max="20000" step="100">
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Mired Shift Required</div>
          <div class="text-4xl font-extrabold" id="ct-shift"></div>
          <div class="text-sm text-blue-200 mt-1" id="ct-direction"></div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary uppercase tracking-wide">Source (Mired)</div>
            <div class="text-xl font-bold text-text" id="ct-source-mired"></div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary uppercase tracking-wide">Target (Mired)</div>
            <div class="text-xl font-bold text-text" id="ct-target-mired"></div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h4 class="font-semibold text-sm text-text mb-2">Recommended Gel</h4>
          <div class="text-lg font-bold text-text" id="ct-gel"></div>
          <div class="text-sm text-text-secondary" id="ct-gel-detail"></div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h4 class="font-semibold text-sm text-text mb-2">Common CTO/CTB Gels</h4>
          <div class="text-sm text-text-secondary space-y-1" id="ct-gel-table"></div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h4 class="font-semibold text-sm text-text mb-2">Color Preview</h4>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-3 rounded-lg text-center text-white text-sm font-bold" id="ct-source-preview">Source</div>
            <div class="p-3 rounded-lg text-center text-white text-sm font-bold" id="ct-target-preview">Target</div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="color-temperature" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Understanding Color Temperature</h2>
      <p>Color temperature in Kelvin describes the hue of light. Lower values (2700K) are warm/orange, while higher values (6500K+) are cool/blue.</p>
      <p><strong>Mired (Micro Reciprocal Degrees):</strong> Mired = 1,000,000 / Kelvin. Mired shift is more perceptually uniform, making it the standard for gel selection.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function kelvinToRGB(k: number): [number, number, number] {
      k = k / 100;
      let r: number, g: number, b: number;
      if (k <= 66) {
        r = 255;
        g = 99.4708025861 * Math.log(k) - 161.1195681661;
        b = k <= 19 ? 0 : 138.5177312231 * Math.log(k - 10) - 305.0447927307;
      } else {
        r = 329.698727446 * Math.pow(k - 60, -0.1332047592);
        g = 288.1221695283 * Math.pow(k - 60, -0.0755148492);
        b = 255;
      }
      return [Math.max(0, Math.min(255, Math.round(r))), Math.max(0, Math.min(255, Math.round(g))), Math.max(0, Math.min(255, Math.round(b)))];
    }

    function calcCT() {
      const sourceK = parseFloat((document.getElementById('ct-source') as HTMLInputElement).value) || 5500;
      const targetK = parseFloat((document.getElementById('ct-target') as HTMLInputElement).value) || 3200;

      const sourceMired = 1000000 / sourceK;
      const targetMired = 1000000 / targetK;
      const shift = targetMired - sourceMired;

      document.getElementById('ct-source-mired')!.textContent = sourceMired.toFixed(0) + ' MRD';
      document.getElementById('ct-target-mired')!.textContent = targetMired.toFixed(0) + ' MRD';
      document.getElementById('ct-shift')!.textContent = (shift >= 0 ? '+' : '') + shift.toFixed(0) + ' MRD';

      let direction = '';
      if (shift > 10) direction = 'Warming (CTO gel needed)';
      else if (shift < -10) direction = 'Cooling (CTB gel needed)';
      else direction = 'Negligible shift';
      document.getElementById('ct-direction')!.textContent = direction;

      const gels = [
        { name: 'Full CTO', mired: 131, desc: '5500K to 2900K, -1 stop' },
        { name: '3/4 CTO', mired: 109, desc: '5500K to 3200K, -2/3 stop' },
        { name: '1/2 CTO', mired: 81, desc: '5500K to 3800K, -1/2 stop' },
        { name: '1/4 CTO', mired: 42, desc: '5500K to 4500K, -1/3 stop' },
        { name: '1/8 CTO', mired: 20, desc: '5500K to 4900K, -1/8 stop' },
        { name: 'Full CTB', mired: -131, desc: '3200K to 5500K, -1.5 stops' },
        { name: '3/4 CTB', mired: -77, desc: '3200K to 4100K, -1 stop' },
        { name: '1/2 CTB', mired: -68, desc: '3200K to 4300K, -2/3 stop' },
        { name: '1/4 CTB', mired: -30, desc: '3200K to 3600K, -1/3 stop' },
        { name: '1/8 CTB', mired: -15, desc: '3200K to 3400K, -1/8 stop' },
      ];

      let bestGel = gels[0];
      let bestDiff = 999;
      gels.forEach(g => {
        const d = Math.abs(g.mired - shift);
        if (d < bestDiff) { bestDiff = d; bestGel = g; }
      });

      document.getElementById('ct-gel')!.textContent = bestGel.name;
      document.getElementById('ct-gel-detail')!.textContent = bestGel.desc + ' (mired shift: ' + bestGel.mired + ')';

      let html = '';
      gels.forEach(g => {
        const marker = g.name === bestGel.name ? ' \u2190 best match' : '';
        html += '<div class="flex justify-between"><span>' + g.name + '</span><span class="font-bold">' + (g.mired >= 0 ? '+' : '') + g.mired + ' MRD' + marker + '</span></div>';
      });
      document.getElementById('ct-gel-table')!.innerHTML = html;

      const srcRGB = kelvinToRGB(sourceK);
      const tgtRGB = kelvinToRGB(targetK);
      const srcEl = document.getElementById('ct-source-preview')!;
      const tgtEl = document.getElementById('ct-target-preview')!;
      srcEl.style.backgroundColor = 'rgb(' + srcRGB[0] + ',' + srcRGB[1] + ',' + srcRGB[2] + ')';
      tgtEl.style.backgroundColor = 'rgb(' + tgtRGB[0] + ',' + tgtRGB[1] + ',' + tgtRGB[2] + ')';
      srcEl.textContent = sourceK + 'K';
      tgtEl.textContent = targetK + 'K';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.ct-in').forEach(el => {
        el.addEventListener('input', calcCT);
        el.addEventListener('change', calcCT);
      });
      document.querySelectorAll('.ct-preset').forEach(btn => {
        btn.addEventListener('click', () => {
          (document.getElementById('ct-source') as HTMLInputElement).value = (btn as HTMLElement).dataset.k || '5500';
          calcCT();
        });
      });
      calcCT();
    }, 50);
  </script>
</CalculatorLayout>
