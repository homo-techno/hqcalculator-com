---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Regression Calculator - Linear Regression Analysis";
const description = "Perform linear regression on paired data. Find slope, intercept, r-squared, regression equation, and predict y values.";

const relatedCalcs = [
  { name: "Correlation Calculator", url: "/correlation-calculator", description: "Pearson correlation coefficient." },
  { name: "Average Calculator", url: "/average-calculator", description: "Mean, median, mode." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Spread of data." },
  { name: "Interpolation Calculator", url: "/interpolation-calculator", description: "Linear interpolation." },
  { name: "T-Test Calculator", url: "/t-test-calculator", description: "Statistical significance." },
  { name: "Chi-Square Calculator", url: "/chi-square-calculator", description: "Chi-square test." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Regression Calculator"
  keywords="linear regression calculator, regression analysis, slope intercept, r squared, best fit line, predict y"
  breadcrumbs={[{ name: "Regression Calculator", url: "/regression-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Linear Regression Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Enter X and Y data sets to find the best-fit line and make predictions.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-1">X Values <span class="text-text-muted">(comma-separated)</span></label>
          <textarea id="rg-x" class="rg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-mono" rows="2" placeholder="1, 2, 3, 4, 5">1, 2, 3, 4, 5, 6, 7, 8, 9, 10</textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Y Values <span class="text-text-muted">(comma-separated)</span></label>
          <textarea id="rg-y" class="rg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-mono" rows="2" placeholder="2, 4, 6, 8, 10">2.1, 3.9, 6.2, 8.1, 9.8, 12.1, 14.0, 15.9, 18.2, 20.1</textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Predict y for x = <span class="text-text-muted">(optional)</span></label>
          <input type="number" id="rg-predict" class="rg-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="12" />
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Regression Equation</div>
          <div class="text-3xl font-extrabold font-mono" id="rg-result">y = 0x + 0</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Slope (m)</div>
            <div class="text-xl font-bold" id="rg-slope">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Intercept (b)</div>
            <div class="text-xl font-bold" id="rg-intercept">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">r&sup2;</div>
            <div class="text-xl font-bold" id="rg-r2">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Correlation (r)</div>
            <div class="text-xl font-bold" id="rg-r">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center col-span-2">
            <div class="text-xs text-text-muted uppercase">Predicted y</div>
            <div class="text-xl font-bold" id="rg-predicted">—</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Summary</h3>
          <div class="text-sm text-text-secondary font-mono whitespace-pre-wrap" id="rg-summary"></div>
        </div>
      </div>

      <ShareButton calculatorId="regression" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Linear Regression</h2>
      <p>Linear regression finds the best-fit line y = mx + b through a set of data points by minimizing the sum of squared residuals.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Slope:</strong> m = (n&Sigma;xy - &Sigma;x&Sigma;y) / (n&Sigma;x&sup2; - (&Sigma;x)&sup2;)</p>
        <p><strong>Intercept:</strong> b = y&#772; - m&times;x&#772;</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function parseNums(input: string): number[] {
      return input.split(/[\s,]+/).map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
    }

    function calcRG() {
      const xVals = parseNums((document.getElementById('rg-x') as HTMLTextAreaElement).value);
      const yVals = parseNums((document.getElementById('rg-y') as HTMLTextAreaElement).value);
      const n = Math.min(xVals.length, yVals.length);
      const fmt = (v: number) => Number.isInteger(v) ? String(v) : v.toFixed(4);

      if (n < 2) {
        document.getElementById('rg-result')!.textContent = 'Need 2+ points';
        document.getElementById('rg-slope')!.textContent = '—';
        document.getElementById('rg-intercept')!.textContent = '—';
        document.getElementById('rg-r2')!.textContent = '—';
        document.getElementById('rg-r')!.textContent = '—';
        document.getElementById('rg-predicted')!.textContent = '—';
        document.getElementById('rg-summary')!.textContent = '';
        document.dispatchEvent(new CustomEvent('calc-update'));
        return;
      }

      const x = xVals.slice(0, n);
      const y = yVals.slice(0, n);

      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
      for (let i = 0; i < n; i++) {
        sumX += x[i];
        sumY += y[i];
        sumXY += x[i] * y[i];
        sumX2 += x[i] * x[i];
        sumY2 += y[i] * y[i];
      }

      const denom = n * sumX2 - sumX * sumX;
      if (denom === 0) {
        document.getElementById('rg-result')!.textContent = 'Undefined (vertical line)';
        document.dispatchEvent(new CustomEvent('calc-update'));
        return;
      }

      const slope = (n * sumXY - sumX * sumY) / denom;
      const intercept = (sumY - slope * sumX) / n;

      const meanY = sumY / n;
      let ssTot = 0, ssRes = 0;
      for (let i = 0; i < n; i++) {
        const pred = slope * x[i] + intercept;
        ssTot += (y[i] - meanY) ** 2;
        ssRes += (y[i] - pred) ** 2;
      }
      const r2 = ssTot === 0 ? 1 : 1 - ssRes / ssTot;
      const r = slope >= 0 ? Math.sqrt(Math.max(0, r2)) : -Math.sqrt(Math.max(0, r2));

      const sign = intercept >= 0 ? '+' : '-';
      document.getElementById('rg-result')!.textContent = `y = ${fmt(slope)}x ${sign} ${fmt(Math.abs(intercept))}`;
      document.getElementById('rg-slope')!.textContent = fmt(slope);
      document.getElementById('rg-intercept')!.textContent = fmt(intercept);
      document.getElementById('rg-r2')!.textContent = fmt(r2);
      document.getElementById('rg-r')!.textContent = fmt(r);

      const predX = parseFloat((document.getElementById('rg-predict') as HTMLInputElement).value);
      if (!isNaN(predX)) {
        const predY = slope * predX + intercept;
        document.getElementById('rg-predicted')!.textContent = `y(${predX}) = ${fmt(predY)}`;
      } else {
        document.getElementById('rg-predicted')!.textContent = '—';
      }

      const se = Math.sqrt(ssRes / (n - 2));
      document.getElementById('rg-summary')!.textContent =
        `n = ${n} data points\nSum X = ${fmt(sumX)}   Sum Y = ${fmt(sumY)}\nMean X = ${fmt(sumX / n)}   Mean Y = ${fmt(meanY)}\nStandard Error = ${n > 2 ? fmt(se) : '—'}`;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.rg-in').forEach(el => {
        el.addEventListener('input', calcRG);
        el.addEventListener('change', calcRG);
      });
      calcRG();
    }, 50);
  </script>
</CalculatorLayout>
