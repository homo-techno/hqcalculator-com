---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Rent vs Buy Calculator - Should You Rent or Buy a Home?";
const description = "Compare the total cost of renting vs buying a home over time. Factor in mortgage, taxes, appreciation, investment returns, and more.";

const relatedCalcs = [
  { name: "Mortgage Calculator", url: "/mortgage-calculator", description: "Home loans." },
  { name: "Down Payment", url: "/down-payment-calculator", description: "Down payment." },
  { name: "Loan Calculator", url: "/loan-calculator", description: "Loan payments." },
  { name: "Investment Calculator", url: "/investment-calculator", description: "Returns." },
  { name: "Savings Calculator", url: "/savings-calculator", description: "Savings growth." },
  { name: "Retirement Calculator", url: "/retirement-calculator", description: "Retirement." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Rent vs Buy Calculator"
  keywords="rent vs buy calculator, should I buy a house, rent or buy comparison, home buying calculator, renting vs owning"
  breadcrumbs={[{ name: "Rent vs Buy", url: "/rent-vs-buy-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Rent vs Buy Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Find out whether renting or buying is better for your financial situation.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <h3 class="font-semibold text-text mb-3">Home Details</h3>
          <div class="space-y-3 mb-5">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Home Price</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                <input type="number" id="rb-price" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="350000" min="0" step="10000">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-text mb-1">Down Payment (%)</label>
                <input type="number" id="rb-down" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="20" min="0" max="100" step="1">
              </div>
              <div>
                <label class="block text-xs font-medium text-text mb-1">Mortgage Rate (%)</label>
                <input type="number" id="rb-rate" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="6.5" min="0" max="20" step="0.125">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-text mb-1">Loan Term (years)</label>
                <input type="number" id="rb-term" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="30" min="1" max="50">
              </div>
              <div>
                <label class="block text-xs font-medium text-text mb-1">Time Horizon (years)</label>
                <input type="number" id="rb-years" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="7" min="1" max="50">
              </div>
            </div>
          </div>

          <h3 class="font-semibold text-text mb-3">Buying Costs</h3>
          <div class="grid grid-cols-2 gap-3 mb-5">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Property Tax (%/yr)</label>
              <input type="number" id="rb-tax" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="1.2" min="0" max="5" step="0.1">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Insurance ($/yr)</label>
              <input type="number" id="rb-ins" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="1800" min="0" step="100">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Maintenance (%/yr)</label>
              <input type="number" id="rb-maint" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="1" min="0" max="5" step="0.1">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Appreciation (%/yr)</label>
              <input type="number" id="rb-appr" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="3" min="0" max="15" step="0.5">
            </div>
          </div>

          <h3 class="font-semibold text-text mb-3">Renting Details</h3>
          <div class="grid grid-cols-2 gap-3 mb-5">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Monthly Rent</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                <input type="number" id="rb-rent" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="1800" min="0" step="50">
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Rent Increase (%/yr)</label>
              <input type="number" id="rb-rent-inc" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="3" min="0" max="15" step="0.5">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Renter's Insurance ($/yr)</label>
              <input type="number" id="rb-rent-ins" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="200" min="0" step="50">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Investment Return (%/yr)</label>
              <input type="number" id="rb-invest" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="7" min="0" max="20" step="0.5">
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 rounded-2xl text-white text-center" id="rb-verdict-box" style="background: var(--color-primary);">
            <div class="text-sm uppercase tracking-wide mb-1 opacity-80" id="rb-verdict-label">After 7 Years</div>
            <div class="text-2xl sm:text-3xl font-extrabold" id="rb-verdict">Calculating...</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-blue-50 rounded-xl text-center border-2 border-blue-200">
              <div class="text-xs text-text-muted uppercase">Total Cost of Buying</div>
              <div class="text-xl font-bold text-blue-700" id="rb-buy-cost">$0</div>
            </div>
            <div class="p-4 bg-green-50 rounded-xl text-center border-2 border-green-200">
              <div class="text-xs text-text-muted uppercase">Total Cost of Renting</div>
              <div class="text-xl font-bold text-green-700" id="rb-rent-cost">$0</div>
            </div>
          </div>

          <div class="p-4 bg-surface-alt rounded-xl">
            <h3 class="font-semibold text-sm text-text mb-3">Buying Breakdown</h3>
            <div class="space-y-1 text-sm" id="rb-buy-detail"></div>
          </div>

          <div class="p-4 bg-surface-alt rounded-xl">
            <h3 class="font-semibold text-sm text-text mb-3">Renting Breakdown</h3>
            <div class="space-y-1 text-sm" id="rb-rent-detail"></div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="rent-vs-buy" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Rent vs Buy: Key Factors</h2>
      <p>The decision to rent or buy depends on home prices, interest rates, how long you plan to stay, and local market conditions. This calculator compares the total cost of each option including opportunity cost of your down payment.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>How long should I plan to stay?</strong> Buying typically becomes better after 5-7 years due to closing costs, agent fees, and the way mortgage amortization front-loads interest.</p>
      <p><strong>What about the tax benefits of buying?</strong> The standard deduction is now $30,000 (married), so many homeowners no longer itemize. This calculator uses a simplified model without tax deductions.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString();

    function calcRentVsBuy() {
      const price = parseFloat((document.getElementById('rb-price') as HTMLInputElement).value) || 0;
      const downPct = (parseFloat((document.getElementById('rb-down') as HTMLInputElement).value) || 0) / 100;
      const rate = (parseFloat((document.getElementById('rb-rate') as HTMLInputElement).value) || 0) / 100;
      const term = parseInt((document.getElementById('rb-term') as HTMLInputElement).value) || 30;
      const years = parseInt((document.getElementById('rb-years') as HTMLInputElement).value) || 7;
      const taxRate = (parseFloat((document.getElementById('rb-tax') as HTMLInputElement).value) || 0) / 100;
      const insurance = parseFloat((document.getElementById('rb-ins') as HTMLInputElement).value) || 0;
      const maintRate = (parseFloat((document.getElementById('rb-maint') as HTMLInputElement).value) || 0) / 100;
      const apprRate = (parseFloat((document.getElementById('rb-appr') as HTMLInputElement).value) || 0) / 100;
      const rent = parseFloat((document.getElementById('rb-rent') as HTMLInputElement).value) || 0;
      const rentInc = (parseFloat((document.getElementById('rb-rent-inc') as HTMLInputElement).value) || 0) / 100;
      const rentIns = parseFloat((document.getElementById('rb-rent-ins') as HTMLInputElement).value) || 0;
      const investReturn = (parseFloat((document.getElementById('rb-invest') as HTMLInputElement).value) || 0) / 100;

      const downPayment = price * downPct;
      const loanAmount = price - downPayment;
      const monthlyRate = rate / 12;
      const totalPayments = term * 12;
      const monthlyPayment = monthlyRate > 0
        ? loanAmount * monthlyRate * Math.pow(1 + monthlyRate, totalPayments) / (Math.pow(1 + monthlyRate, totalPayments) - 1)
        : loanAmount / totalPayments;

      // Buying costs over years
      let totalMortgagePayments = 0;
      let totalInterest = 0;
      let totalPropertyTax = 0;
      let totalInsurance = 0;
      let totalMaintenance = 0;
      let balance = loanAmount;

      const months = Math.min(years * 12, totalPayments);
      for (let m = 1; m <= months; m++) {
        const interestPayment = balance * monthlyRate;
        const principalPayment = monthlyPayment - interestPayment;
        totalMortgagePayments += monthlyPayment;
        totalInterest += interestPayment;
        balance -= principalPayment;
      }

      for (let y = 0; y < years; y++) {
        const homeVal = price * Math.pow(1 + apprRate, y);
        totalPropertyTax += homeVal * taxRate;
        totalMaintenance += homeVal * maintRate;
        totalInsurance += insurance;
      }

      const closingCostsBuy = price * 0.03;
      const closingCostsSell = price * Math.pow(1 + apprRate, years) * 0.06;
      const homeValueEnd = price * Math.pow(1 + apprRate, years);
      const equity = homeValueEnd - Math.max(0, balance);
      const netBuyCost = totalMortgagePayments + totalPropertyTax + totalInsurance + totalMaintenance + closingCostsBuy + closingCostsSell + downPayment - equity;

      // Renting costs over years
      let totalRent = 0;
      let totalRentIns = 0;
      for (let y = 0; y < years; y++) {
        totalRent += rent * 12 * Math.pow(1 + rentInc, y);
        totalRentIns += rentIns;
      }

      // Opportunity cost: invest down payment + monthly savings
      let investmentValue = downPayment;
      const monthlyInvestReturn = investReturn / 12;
      for (let m = 0; m < years * 12; m++) {
        investmentValue *= (1 + monthlyInvestReturn);
        const currentRent = rent * Math.pow(1 + rentInc, Math.floor(m / 12));
        const monthlySaving = monthlyPayment + (totalPropertyTax + totalInsurance + totalMaintenance) / (years * 12) - currentRent - rentIns / 12;
        if (monthlySaving > 0) investmentValue += monthlySaving;
      }
      const investmentGain = investmentValue - downPayment;

      const netRentCost = totalRent + totalRentIns - investmentGain;

      const diff = netRentCost - netBuyCost;
      const buyIsBetter = diff > 0;

      const verdictBox = document.getElementById('rb-verdict-box')!;
      verdictBox.style.background = buyIsBetter ? '#2563eb' : '#16a34a';
      document.getElementById('rb-verdict-label')!.textContent = `After ${years} years`;
      document.getElementById('rb-verdict')!.textContent = buyIsBetter
        ? `Buying saves ${fmt(Math.abs(diff))}`
        : `Renting saves ${fmt(Math.abs(diff))}`;

      document.getElementById('rb-buy-cost')!.textContent = fmt(netBuyCost);
      document.getElementById('rb-rent-cost')!.textContent = fmt(netRentCost);

      document.getElementById('rb-buy-detail')!.innerHTML = [
        ['Down Payment', downPayment],
        ['Mortgage Payments', totalMortgagePayments],
        ['Interest Paid', totalInterest],
        ['Property Tax', totalPropertyTax],
        ['Insurance', totalInsurance],
        ['Maintenance', totalMaintenance],
        ['Closing Costs (buy+sell)', closingCostsBuy + closingCostsSell],
        ['− Home Equity', -equity],
      ].map(([label, val]) =>
        `<div class="flex justify-between"><span class="text-text-secondary">${label}</span><span class="font-semibold ${(val as number) < 0 ? 'text-secondary' : ''}">${fmt(Math.abs(val as number))}</span></div>`
      ).join('');

      document.getElementById('rb-rent-detail')!.innerHTML = [
        ['Total Rent Paid', totalRent],
        ['Renter\'s Insurance', totalRentIns],
        ['− Investment Gains', -investmentGain],
      ].map(([label, val]) =>
        `<div class="flex justify-between"><span class="text-text-secondary">${label}</span><span class="font-semibold ${(val as number) < 0 ? 'text-secondary' : ''}">${fmt(Math.abs(val as number))}</span></div>`
      ).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      ['rb-price', 'rb-down', 'rb-rate', 'rb-term', 'rb-years', 'rb-tax', 'rb-ins', 'rb-maint', 'rb-appr', 'rb-rent', 'rb-rent-inc', 'rb-rent-ins', 'rb-invest'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calcRentVsBuy);
      });
      calcRentVsBuy();
    }, 50);
  </script>
</CalculatorLayout>
