---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Pupillary Distance Calculator";
const description = "Estimate pupillary distance (PD) using measurement method, calculate monocular PD, near vs far PD, and get online ordering recommendations.";
const relatedCalcs = [
  { name: "Glasses Cost Calculator", url: "/glasses-cost-calculator", description: "Total eyeglasses cost estimate." },
  { name: "Lens Thickness Calculator", url: "/lens-thickness-calculator", description: "Lens thickness by index." },
  { name: "Contact Lens Calculator", url: "/contact-lens-calculator", description: "Annual contact lens costs." },
  { name: "Eye Exam Calculator", url: "/eye-exam-calculator", description: "Eye exam cost by type." },
  { name: "Vision Prescription Calculator", url: "/vision-prescription-calculator", description: "Understand your prescription." },
  { name: "BMI Calculator", url: "/bmi-calculator", description: "Body mass index calculator." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Pupillary Distance Calculator" keywords="pupillary distance, PD measurement, monocular PD, near PD, far PD, online glasses PD" breadcrumbs={[{ name: "Pupillary Distance", url: "/pupillary-distance-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Pupillary Distance Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate your PD from ruler measurement or estimate from age and gender. Essential for ordering glasses online.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Measurement Method</label>
            <select id="pd-method" class="pd-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
              <option value="ruler" selected>Ruler Measurement (mm)</option>
              <option value="estimate">Estimate from Age/Gender</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Gender</label>
            <select id="pd-gender" class="pd-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
              <option value="male" selected>Male</option>
              <option value="female">Female</option>
              <option value="child">Child</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Right Eye to Center (mm)</label><input type="number" id="pd-right" class="pd-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="31.5" min="20" max="45" step="0.5"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Left Eye to Center (mm)</label><input type="number" id="pd-left" class="pd-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="31.5" min="20" max="45" step="0.5"></div>
        </div>
        <div><label class="block text-xs font-medium text-text mb-1">Age (for estimation)</label><input type="number" id="pd-age" class="pd-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="30" min="1" max="100" step="1"></div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Binocular PD (Far Distance)</div>
          <div class="text-5xl font-extrabold font-mono" id="pd-far">63 mm</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Right Eye PD</div><div class="text-xl font-bold font-mono" id="pd-rval">31.5 mm</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Left Eye PD</div><div class="text-xl font-bold font-mono" id="pd-lval">31.5 mm</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Near PD</div><div class="text-xl font-bold font-mono" id="pd-near">60 mm</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Normal Range</div><div class="text-xl font-bold font-mono" id="pd-range">-</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Online Ordering</div><div class="text-xl font-bold font-mono" id="pd-tip">-</div></div>
        </div>
        <div class="p-3 bg-amber-50 rounded-xl text-center text-xs text-amber-800 font-semibold">
          For most accurate results, have someone measure your PD using a millimeter ruler while you look at a distant object.
        </div>
      </div>
      <ShareButton calculatorId="pupillary-distance" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcPD() {
      const method = (document.getElementById('pd-method') as HTMLSelectElement).value;
      const gender = (document.getElementById('pd-gender') as HTMLSelectElement).value;
      const rightPD = parseFloat((document.getElementById('pd-right') as HTMLInputElement).value) || 31.5;
      const leftPD = parseFloat((document.getElementById('pd-left') as HTMLInputElement).value) || 31.5;
      const age = parseFloat((document.getElementById('pd-age') as HTMLInputElement).value) || 30;

      let farPD: number;
      let rPD: number;
      let lPD: number;

      if (method === 'ruler') {
        rPD = rightPD;
        lPD = leftPD;
        farPD = rPD + lPD;
      } else {
        // Estimate based on age and gender
        // Average PDs: Adult male ~64mm, female ~62mm, children grow from ~43mm to adult
        let basePD: number;
        if (gender === 'child') {
          basePD = age < 5 ? 43 : age < 10 ? 50 : age < 15 ? 55 : 60;
        } else if (gender === 'male') {
          basePD = age < 20 ? 60 + (age - 15) * 0.4 : 64;
        } else {
          basePD = age < 20 ? 58 + (age - 15) * 0.4 : 62;
        }
        farPD = Math.round(basePD * 2) / 2;
        rPD = Math.round(farPD / 2 * 2) / 2;
        lPD = farPD - rPD;
      }

      // Near PD is typically 3-4mm less than far PD
      const nearPD = farPD - 3;

      // Normal ranges
      let rangeText: string;
      if (gender === 'child') {
        rangeText = '43-58 mm';
      } else if (gender === 'male') {
        rangeText = '59-68 mm';
      } else {
        rangeText = '57-65 mm';
      }

      // Online ordering tip
      let tip: string;
      if (Math.abs(rPD - lPD) > 2) {
        tip = 'Use monocular PD';
      } else {
        tip = 'Use single PD value';
      }

      document.getElementById('pd-far')!.textContent = farPD.toFixed(1) + ' mm';
      document.getElementById('pd-rval')!.textContent = rPD.toFixed(1) + ' mm';
      document.getElementById('pd-lval')!.textContent = lPD.toFixed(1) + ' mm';
      document.getElementById('pd-near')!.textContent = nearPD.toFixed(1) + ' mm';
      document.getElementById('pd-range')!.textContent = rangeText;
      document.getElementById('pd-tip')!.textContent = tip;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.pd-in').forEach(el => { el.addEventListener('input', calcPD); el.addEventListener('change', calcPD); });
      calcPD();
    }, 50);
  </script>
</CalculatorLayout>
