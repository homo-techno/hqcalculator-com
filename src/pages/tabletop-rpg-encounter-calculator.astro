---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Tabletop RPG Encounter Calculator";
const description = "Calculate encounter difficulty from party level and size vs monster Challenge Rating, XP thresholds, and adjusted XP for D&D 5e.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "General probability." },
  { name: "Average Calculator", url: "/average-calculator", description: "Calculate averages." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentage math." },
  { name: "Random Number Generator", url: "/random-number-generator", description: "Random numbers." },
  { name: "Statistics Calculator", url: "/statistics-calculator", description: "Statistical analysis." },
  { name: "Grade Calculator", url: "/grade-calculator", description: "Score tracking." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Tabletop RPG Encounter Calculator" keywords="dnd encounter calculator, encounter difficulty, challenge rating, xp threshold, adjusted xp, party vs monsters" breadcrumbs={[{ name: "RPG Encounter", url: "/tabletop-rpg-encounter-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Tabletop RPG Encounter Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate D&amp;D 5e encounter difficulty based on party composition and monsters.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold text-text mb-1">Party Size</label>
            <input type="number" class="te2-in w-full px-4 py-2 border border-border rounded-lg" id="te2-party" min="1" max="10" value="4">
          </div>
          <div>
            <label class="block text-sm font-semibold text-text mb-1">Average Party Level</label>
            <input type="number" class="te2-in w-full px-4 py-2 border border-border rounded-lg" id="te2-level" min="1" max="20" value="5">
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Monsters</h3>
          <div class="space-y-2" id="te2-monsters">
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="text-xs text-text-muted">CR</label>
                <select class="te2-in te2-cr w-full px-2 py-1 border border-border rounded text-sm">
                  <option value="0">0</option>
                  <option value="0.125">1/8</option>
                  <option value="0.25">1/4</option>
                  <option value="0.5">1/2</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3" selected>3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option>
                  <option value="12">12</option>
                  <option value="13">13</option>
                  <option value="14">14</option>
                  <option value="15">15</option>
                  <option value="17">17</option>
                  <option value="20">20</option>
                  <option value="24">24</option>
                  <option value="30">30</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-text-muted">Count</label>
                <input type="number" class="te2-in te2-count w-full px-2 py-1 border border-border rounded text-sm" min="0" max="30" value="2">
              </div>
              <div class="flex items-end">
                <button class="te2-add px-3 py-1 bg-primary text-white rounded text-sm hover:bg-blue-700">+ Row</button>
              </div>
            </div>
          </div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Encounter Difficulty</div>
          <div class="text-4xl font-extrabold font-mono" id="te2-result">--</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Monster XP</div>
            <div class="text-xl font-bold font-mono" id="te2-totalxp">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Adjusted XP</div>
            <div class="text-xl font-bold font-mono" id="te2-adjxp">--</div>
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Party XP Thresholds</h3>
          <div class="text-xs font-mono space-y-1" id="te2-thresholds"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">XP per Player</div>
            <div class="text-xl font-bold font-mono" id="te2-perplayer">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Monster Count</div>
            <div class="text-xl font-bold font-mono" id="te2-moncount">--</div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="tabletop-rpg-encounter" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    // D&D 5e XP thresholds by level
    const xpThresholds: Record<number, number[]> = {
      1:[25,50,75,100],2:[50,100,150,200],3:[75,150,225,400],4:[125,250,375,500],
      5:[250,500,750,1100],6:[300,600,900,1400],7:[350,750,1100,1700],8:[450,900,1400,2100],
      9:[550,1100,1600,2400],10:[600,1200,1900,2800],11:[800,1600,2400,3600],
      12:[1000,2000,3000,4500],13:[1100,2200,3400,5100],14:[1250,2500,3800,5700],
      15:[1400,2800,4300,6400],16:[1600,3200,4800,7200],17:[2000,3900,5900,8800],
      18:[2100,4200,6300,9500],19:[2400,4900,7300,10900],20:[2800,5700,8500,12700]
    };
    // XP by CR
    const crXp: Record<string, number> = {
      '0':0,'0.125':25,'0.25':50,'0.5':100,'1':200,'2':450,'3':700,'4':1100,
      '5':1800,'6':2300,'7':2900,'8':3900,'9':5000,'10':5900,'11':7200,'12':8400,
      '13':10000,'14':11500,'15':13000,'17':18000,'20':25000,'24':62000,'30':155000
    };
    // Encounter multipliers
    function getMultiplier(numMonsters: number, partySize: number): number {
      let idx: number;
      if (numMonsters === 1) idx = 0;
      else if (numMonsters === 2) idx = 1;
      else if (numMonsters <= 6) idx = 2;
      else if (numMonsters <= 10) idx = 3;
      else if (numMonsters <= 14) idx = 4;
      else idx = 5;
      const mults = [1, 1.5, 2, 2.5, 3, 4];
      let mult = mults[idx];
      if (partySize < 3) mult = mults[Math.min(idx + 1, 5)];
      else if (partySize > 5) mult = mults[Math.max(idx - 1, 0)];
      return mult;
    }

    function addMonsterRow() {
      const container = document.getElementById('te2-monsters')!;
      const row = document.createElement('div');
      row.className = 'grid grid-cols-3 gap-2';
      row.innerHTML = '<div><select class="te2-in te2-cr w-full px-2 py-1 border border-border rounded text-sm"><option value="0">0</option><option value="0.125">1/8</option><option value="0.25">1/4</option><option value="0.5">1/2</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="17">17</option><option value="20">20</option><option value="24">24</option><option value="30">30</option></select></div><div><input type="number" class="te2-in te2-count w-full px-2 py-1 border border-border rounded text-sm" min="0" max="30" value="1"></div><div class="flex items-end"><button class="te2-rm px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">Remove</button></div>';
      container.appendChild(row);
      row.querySelectorAll('.te2-in').forEach(el => { el.addEventListener('input', calcTE2); el.addEventListener('change', calcTE2); });
      row.querySelector('.te2-rm')!.addEventListener('click', () => { row.remove(); calcTE2(); });
      calcTE2();
    }

    function calcTE2() {
      const partySize = Math.max(1, parseInt((document.getElementById('te2-party') as HTMLInputElement).value) || 4);
      const partyLevel = Math.max(1, Math.min(20, parseInt((document.getElementById('te2-level') as HTMLInputElement).value) || 5));

      // Gather monsters
      const crs = document.querySelectorAll('.te2-cr');
      const counts = document.querySelectorAll('.te2-count');
      let totalXP = 0;
      let totalMonsters = 0;
      for (let i = 0; i < crs.length; i++) {
        const cr = (crs[i] as HTMLSelectElement).value;
        const count = parseInt((counts[i] as HTMLInputElement).value) || 0;
        totalXP += (crXp[cr] || 0) * count;
        totalMonsters += count;
      }

      const mult = getMultiplier(totalMonsters, partySize);
      const adjustedXP = Math.round(totalXP * mult);

      // Party thresholds
      const thresholdNames = ['Easy', 'Medium', 'Hard', 'Deadly'];
      const partyThresholds = [0, 0, 0, 0];
      const lvlThresh = xpThresholds[partyLevel] || [0, 0, 0, 0];
      for (let i = 0; i < 4; i++) partyThresholds[i] = lvlThresh[i] * partySize;

      // Determine difficulty
      let difficulty = 'Trivial';
      if (adjustedXP >= partyThresholds[3]) difficulty = 'Deadly';
      else if (adjustedXP >= partyThresholds[2]) difficulty = 'Hard';
      else if (adjustedXP >= partyThresholds[1]) difficulty = 'Medium';
      else if (adjustedXP >= partyThresholds[0]) difficulty = 'Easy';

      document.getElementById('te2-result')!.textContent = difficulty;
      document.getElementById('te2-totalxp')!.textContent = totalXP.toLocaleString();
      document.getElementById('te2-adjxp')!.textContent = adjustedXP.toLocaleString() + ' (x' + mult + ')';
      document.getElementById('te2-perplayer')!.textContent = partySize > 0 ? Math.floor(totalXP / partySize).toLocaleString() : '0';
      document.getElementById('te2-moncount')!.textContent = totalMonsters.toString();

      let thHtml = '';
      for (let i = 0; i < 4; i++) {
        const marker = difficulty === thresholdNames[i] ? ' <-' : '';
        thHtml += '<div class="flex justify-between py-0.5 border-b border-border"><span>' + thresholdNames[i] + '</span><span>' + partyThresholds[i].toLocaleString() + ' XP' + marker + '</span></div>';
      }
      document.getElementById('te2-thresholds')!.innerHTML = thHtml;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.te2-in').forEach(el => { el.addEventListener('input', calcTE2); el.addEventListener('change', calcTE2); });
      document.querySelector('.te2-add')!.addEventListener('click', addMonsterRow);
      calcTE2();
    }, 50);
  </script>
</CalculatorLayout>
