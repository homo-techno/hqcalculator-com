---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Standard Deviation Calculator - Variance & Statistics";
const description = "Calculate standard deviation, variance, and other statistics for any data set. Population and sample standard deviation with step-by-step.";

const relatedCalcs = [
  { name: "Average Calculator", url: "/average-calculator", description: "Mean, median, mode." },
  { name: "Probability Calculator", url: "/probability-calculator", description: "Probability." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "GPA Calculator", url: "/gpa-calculator", description: "Grade point average." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math." },
  { name: "Fraction Calculator", url: "/fraction-calculator", description: "Fractions." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Standard Deviation Calculator"
  keywords="standard deviation calculator, variance calculator, statistics calculator, population standard deviation, sample standard deviation"
  breadcrumbs={[{ name: "Standard Deviation", url: "/standard-deviation-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Standard Deviation Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate standard deviation, variance, and other statistical measures for your data set.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-1">Enter Data Set <span class="text-text-muted">(comma, space, or newline separated)</span></label>
        <textarea id="sd-input" class="w-full px-4 py-3 border border-border rounded-xl text-lg font-mono" rows="3" placeholder="10, 20, 30, 40, 50">4, 8, 6, 5, 3, 7, 2, 9, 5, 6</textarea>
      </div>

      <div class="flex gap-2 mb-6">
        <button class="sd-type-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-primary text-white" data-type="population">Population (σ)</button>
        <button class="sd-type-btn flex-1 py-2 rounded-lg text-sm font-semibold bg-surface-alt text-text-secondary" data-type="sample">Sample (s)</button>
      </div>

      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1" id="sd-label">Population Std Dev (σ)</div>
        <div class="text-5xl font-extrabold" id="sd-result">0</div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Variance (σ²)</div>
          <div class="text-xl font-bold" id="sd-variance">0</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Mean (μ)</div>
          <div class="text-xl font-bold" id="sd-mean">0</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Count (N)</div>
          <div class="text-xl font-bold" id="sd-count">0</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Sum of Squares</div>
          <div class="text-xl font-bold" id="sd-ss">0</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Coeff of Variation</div>
          <div class="text-xl font-bold" id="sd-cv">0%</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Std Error</div>
          <div class="text-xl font-bold" id="sd-se">0</div>
        </div>
      </div>

      <!-- Step by step -->
      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h3 class="font-semibold text-sm text-text mb-3">Step-by-Step Calculation</h3>
        <div class="text-sm text-text-secondary space-y-1 font-mono overflow-x-auto" id="sd-steps"></div>
      </div>

      <ShareButton calculatorId="standard-deviation" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How Standard Deviation Works</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Population:</strong> σ = √(Σ(xᵢ − μ)² / N)</p>
        <p><strong>Sample:</strong> s = √(Σ(xᵢ − x̄)² / (N − 1))</p>
      </div>
      <p>Standard deviation measures the spread of data around the mean. A low SD means data points are close to the mean; a high SD means they're spread out.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Population vs. Sample</h3>
      <ul>
        <li><strong>Population (σ):</strong> Use when you have ALL data points in the group (entire class, all employees)</li>
        <li><strong>Sample (s):</strong> Use when you have a subset (a survey, an experiment). Divides by N−1 (Bessel's correction) for an unbiased estimate.</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>What does standard deviation tell you?</strong> About 68% of data falls within 1 SD of the mean, 95% within 2 SDs, and 99.7% within 3 SDs (for normal distributions).</p>
      <p><strong>Is a high standard deviation bad?</strong> Not necessarily. It depends on context. Investment returns with high SD mean more risk. Manufacturing with high SD means poor quality control.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let sdType = 'population';

    function parseNumbers(input: string): number[] {
      return input.split(/[\s,;\n]+/).map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
    }

    function calcSD() {
      const nums = parseNumbers((document.getElementById('sd-input') as HTMLTextAreaElement).value);
      if (nums.length === 0) return;

      const n = nums.length;
      const mean = nums.reduce((a, b) => a + b, 0) / n;
      const diffs = nums.map(x => x - mean);
      const squaredDiffs = diffs.map(d => d * d);
      const sumSquares = squaredDiffs.reduce((a, b) => a + b, 0);
      const divisor = sdType === 'sample' ? n - 1 : n;
      const variance = divisor > 0 ? sumSquares / divisor : 0;
      const sd = Math.sqrt(variance);
      const se = sd / Math.sqrt(n);
      const cv = mean !== 0 ? (sd / Math.abs(mean) * 100) : 0;

      const fmt = (v: number) => Number.isInteger(v) ? String(v) : v.toFixed(4);

      document.getElementById('sd-label')!.textContent = sdType === 'population' ? 'Population Std Dev (σ)' : 'Sample Std Dev (s)';
      document.getElementById('sd-result')!.textContent = fmt(sd);
      document.getElementById('sd-variance')!.textContent = fmt(variance);
      document.getElementById('sd-mean')!.textContent = fmt(mean);
      document.getElementById('sd-count')!.textContent = String(n);
      document.getElementById('sd-ss')!.textContent = fmt(sumSquares);
      document.getElementById('sd-cv')!.textContent = cv.toFixed(2) + '%';
      document.getElementById('sd-se')!.textContent = fmt(se);

      // Steps
      const steps = [
        `1. Mean (μ) = (${nums.join(' + ')}) / ${n} = ${fmt(mean)}`,
        `2. Deviations: [${diffs.map(d => fmt(d)).join(', ')}]`,
        `3. Squared: [${squaredDiffs.map(d => fmt(d)).join(', ')}]`,
        `4. Sum of squares = ${fmt(sumSquares)}`,
        `5. ${sdType === 'sample' ? 'Variance = SS / (N-1)' : 'Variance = SS / N'} = ${fmt(sumSquares)} / ${divisor} = ${fmt(variance)}`,
        `6. Std Dev = √${fmt(variance)} = ${fmt(sd)}`,
      ];
      document.getElementById('sd-steps')!.innerHTML = steps.map(s => `<div>${s}</div>`).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.sd-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.sd-type-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white'); b.classList.add('bg-surface-alt', 'text-text-secondary'); });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary'); btn.classList.add('bg-primary', 'text-white');
          sdType = (btn as HTMLElement).dataset.type || 'population';
          calcSD();
        });
      });

      document.getElementById('sd-input')!.addEventListener('input', calcSD);
      calcSD();
    }, 50);
  </script>
</CalculatorLayout>
