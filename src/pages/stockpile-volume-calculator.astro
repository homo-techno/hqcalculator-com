---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Stockpile Volume Calculator - Conical Pile Tonnage";
const description = "Calculate conical stockpile volume from height and base diameter, tonnage from bulk density, and angle of repose for mining materials.";
const relatedCalcs = [
  { name: "Volume Calculator", url: "/volume-calculator", description: "Volume shapes." },
  { name: "Gravel Calculator", url: "/gravel-calculator", description: "Material tonnage." },
  { name: "Concrete Calculator", url: "/concrete-calculator", description: "Concrete volume." },
  { name: "Density Calculator", url: "/density-calculator", description: "Material density." },
  { name: "Excavation Calculator", url: "/excavation-calculator", description: "Earthwork volumes." },
  { name: "Area Calculator", url: "/area-calculator", description: "Area calculations." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Stockpile Volume Calculator" keywords="stockpile volume, conical pile, tonnage, bulk density, angle of repose, mining stockpile" breadcrumbs={[{ name: "Stockpile Volume", url: "/stockpile-volume-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Stockpile Volume Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate conical stockpile volume and tonnage from height, base dimensions, bulk density, and angle of repose.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-1">Input Method</label>
          <select id="sv2-method" class="sv2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="hd">Height + Base Diameter</option>
            <option value="ha">Height + Angle of Repose</option>
            <option value="da">Base Diameter + Angle of Repose</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div id="sv2-h-wrap">
            <label class="block text-sm font-medium text-text mb-1">Stockpile Height (m)</label>
            <input type="number" id="sv2-height" class="sv2-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="12" min="0" step="0.5">
          </div>
          <div id="sv2-d-wrap">
            <label class="block text-sm font-medium text-text mb-1">Base Diameter (m)</label>
            <input type="number" id="sv2-diam" class="sv2-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="30" min="0" step="0.5">
          </div>
        </div>
        <div id="sv2-a-wrap">
          <label class="block text-sm font-medium text-text mb-1">Angle of Repose (degrees)</label>
          <input type="number" id="sv2-angle" class="sv2-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="38" min="0" max="90" step="1">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Bulk Density (t/m³)</label>
          <input type="number" id="sv2-bulk" class="sv2-in w-full px-4 py-3 border border-border rounded-xl text-lg" value="1.60" min="0" step="0.05">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Material Preset</label>
          <select id="sv2-material" class="sv2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="0|0">-- Custom --</option>
            <option value="1.60|38">Crushed Rock (1.60 t/m³, 38°)</option>
            <option value="1.50|35">Gravel (1.50 t/m³, 35°)</option>
            <option value="1.55|34">Sand (1.55 t/m³, 34°)</option>
            <option value="1.40|37">Iron Ore (1.40 t/m³, 37°)</option>
            <option value="0.80|40">Coal (0.80 t/m³, 40°)</option>
            <option value="1.20|32">Topsoil (1.20 t/m³, 32°)</option>
          </select>
        </div>
      </div>

      <div class="mt-6 space-y-3">
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Stockpile Volume</div>
          <div class="text-4xl font-extrabold" id="sv2-vol">0</div>
          <div class="text-sm text-blue-200 mt-1">cubic meters</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Tonnage</div>
            <div class="text-xl font-bold" id="sv2-tons">0 t</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Base Area</div>
            <div class="text-xl font-bold" id="sv2-area">0 m²</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Calc Height</div>
            <div class="text-xl font-bold" id="sv2-calch">0 m</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Calc Diameter</div>
            <div class="text-xl font-bold" id="sv2-calcd">0 m</div>
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Volume (cubic yards)</div>
          <div class="text-xl font-bold" id="sv2-yards">0 yd³</div>
        </div>
      </div>

      <ShareButton calculatorId="stockpile-volume" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">Stockpile Volume Formula</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Volume (cone)</strong> = (1/3) x pi x r² x h</p>
        <p><strong>Tonnage</strong> = Volume x Bulk Density</p>
        <p><strong>Angle of Repose</strong> = arctan(h / r)</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcSV2() {
      const method = (document.getElementById('sv2-method') as HTMLSelectElement).value;
      let h = parseFloat((document.getElementById('sv2-height') as HTMLInputElement).value) || 0;
      let d = parseFloat((document.getElementById('sv2-diam') as HTMLInputElement).value) || 0;
      let angle = parseFloat((document.getElementById('sv2-angle') as HTMLInputElement).value) || 0;
      const bulk = parseFloat((document.getElementById('sv2-bulk') as HTMLInputElement).value) || 0;

      const matVal = (document.getElementById('sv2-material') as HTMLSelectElement).value;
      if (matVal !== '0|0') {
        const parts = matVal.split('|');
        (document.getElementById('sv2-bulk') as HTMLInputElement).value = parts[0];
        (document.getElementById('sv2-angle') as HTMLInputElement).value = parts[1];
        angle = parseFloat(parts[1]);
      }

      if (method === 'ha') {
        const r = angle > 0 ? h / Math.tan(angle * Math.PI / 180) : 0;
        d = r * 2;
      } else if (method === 'da') {
        const r = d / 2;
        h = r * Math.tan(angle * Math.PI / 180);
      }

      const r = d / 2;
      const volume = (1 / 3) * Math.PI * r * r * h;
      const tonnage = volume * bulk;
      const baseArea = Math.PI * r * r;
      const yards = volume * 1.30795;

      const calcAngle = r > 0 ? Math.atan(h / r) * (180 / Math.PI) : 0;

      const fmt = (n: number) => n.toLocaleString('en-US', { maximumFractionDigits: 2 });

      document.getElementById('sv2-vol')!.textContent = fmt(volume);
      document.getElementById('sv2-tons')!.textContent = fmt(tonnage) + ' t';
      document.getElementById('sv2-area')!.textContent = fmt(baseArea) + ' m\u00B2';
      document.getElementById('sv2-calch')!.textContent = fmt(h) + ' m';
      document.getElementById('sv2-calcd')!.textContent = fmt(d) + ' m';
      document.getElementById('sv2-yards')!.textContent = fmt(yards) + ' yd\u00B3';

      document.getElementById('sv2-h-wrap')!.classList.toggle('hidden', method === 'da');
      document.getElementById('sv2-d-wrap')!.classList.toggle('hidden', method === 'ha');
      document.getElementById('sv2-a-wrap')!.classList.toggle('hidden', method === 'hd');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.sv2-in').forEach(el => { el.addEventListener('input', calcSV2); el.addEventListener('change', calcSV2); });
      calcSV2();
    }, 50);
  </script>
</CalculatorLayout>
