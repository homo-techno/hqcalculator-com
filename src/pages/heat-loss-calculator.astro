---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Heat Loss Calculator - Building Heat Loss Through Walls, Windows & Roof";
const description = "Calculate building heat loss through walls, windows, roof, floor, and infiltration. Determine furnace/boiler size needed in BTU/hr for heating design.";

const relatedCalcs = [
  { name: "Cooling Load Calculator", url: "/cooling-load-calculator", description: "Cooling loads." },
  { name: "Thermal Resistance Calculator", url: "/thermal-resistance-calculator", description: "R-value/U-value." },
  { name: "Radiant Floor Calculator", url: "/radiant-floor-calculator", description: "Radiant heating." },
  { name: "Ventilation Rate Calculator", url: "/ventilation-rate-calculator", description: "ASHRAE rates." },
  { name: "Economizer Calculator", url: "/economizer-calculator", description: "Free cooling." },
  { name: "Coil Sizing Calculator", url: "/coil-sizing-calculator", description: "Coil selection." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Heat Loss Calculator"
  keywords="heat loss calculator, building heat loss, BTU heat loss, furnace sizing, wall heat loss, window heat loss, infiltration, U-value"
  breadcrumbs={[{ name: "Heat Loss Calculator", url: "/heat-loss-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Heat Loss Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate heat loss through building envelope components to size your heating system.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-5">
        <h3 class="text-lg font-bold text-text">Temperature Design</h3>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Indoor Temp (°F)</label>
            <input type="number" id="hl2-indoor" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="70" step="1">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Outdoor Design Temp (°F)</label>
            <input type="number" id="hl2-outdoor" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="5" step="1">
          </div>
        </div>

        <h3 class="text-lg font-bold text-text">Walls</h3>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Wall Area (sq ft)</label>
            <input type="number" id="hl2-wallarea" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="800" min="0" step="10">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Wall R-Value</label>
            <select id="hl2-wallr" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="4">Uninsulated (R-4)</option>
              <option value="11">2x4 w/ R-11</option>
              <option value="13" selected>2x4 w/ R-13</option>
              <option value="19">2x6 w/ R-19</option>
              <option value="21">2x6 w/ R-21</option>
            </select>
          </div>
        </div>

        <h3 class="text-lg font-bold text-text">Windows</h3>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Window Area (sq ft)</label>
            <input type="number" id="hl2-winarea" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="80" min="0" step="5">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Window Type</label>
            <select id="hl2-winr" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="0.9">Single Pane (R-0.9)</option>
              <option value="1.7" selected>Double Pane (R-1.7)</option>
              <option value="2.5">Double Low-E (R-2.5)</option>
              <option value="3.5">Triple Pane (R-3.5)</option>
            </select>
          </div>
        </div>

        <h3 class="text-lg font-bold text-text">Roof / Ceiling</h3>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Roof Area (sq ft)</label>
            <input type="number" id="hl2-roofarea" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="450" min="0" step="10">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Roof R-Value</label>
            <select id="hl2-roofr" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="11">R-11</option>
              <option value="19">R-19</option>
              <option value="30" selected>R-30</option>
              <option value="38">R-38</option>
              <option value="49">R-49</option>
            </select>
          </div>
        </div>

        <h3 class="text-lg font-bold text-text">Floor</h3>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Floor Area (sq ft)</label>
            <input type="number" id="hl2-floorarea" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="450" min="0" step="10">
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Floor Type</label>
            <select id="hl2-floorr" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
              <option value="5">Slab on Grade (R-5)</option>
              <option value="11" selected>Insulated Crawl (R-11)</option>
              <option value="19">Well Insulated (R-19)</option>
              <option value="30">Over Garage (R-30)</option>
            </select>
          </div>
        </div>

        <h3 class="text-lg font-bold text-text">Infiltration</h3>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Building Tightness</label>
          <select id="hl2-infil" class="hl2-in w-full px-4 py-3 border border-border rounded-xl text-lg">
            <option value="1.5">Leaky (1.5 ACH)</option>
            <option value="0.75" selected>Average (0.75 ACH)</option>
            <option value="0.35">Tight (0.35 ACH)</option>
            <option value="0.15">Very Tight / Passive (0.15 ACH)</option>
          </select>
        </div>

        <!-- Results -->
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Total Heat Loss</div>
          <div class="text-4xl font-extrabold" id="hl2-total">--</div>
          <div class="text-sm text-blue-200 mt-1">BTU/hr</div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Wall Loss</div>
            <div class="text-xl font-bold" id="hl2-wallloss">--</div>
            <div class="text-xs text-text-muted">BTU/hr</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Window Loss</div>
            <div class="text-xl font-bold" id="hl2-winloss">--</div>
            <div class="text-xs text-text-muted">BTU/hr</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Roof Loss</div>
            <div class="text-xl font-bold" id="hl2-roofloss">--</div>
            <div class="text-xs text-text-muted">BTU/hr</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Floor + Infiltration</div>
            <div class="text-xl font-bold" id="hl2-otherloss">--</div>
            <div class="text-xs text-text-muted">BTU/hr</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Recommended Furnace Size</div>
          <div class="text-xl font-bold" id="hl2-furnace">--</div>
        </div>
      </div>

      <ShareButton calculatorId="heat-loss" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl mx-auto prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Heat Loss Is Calculated</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm">
        <p>Q = U x A x Delta-T = (1/R) x Area x (T_indoor - T_outdoor)</p>
        <p>Infiltration = 0.018 x ACH x Volume x Delta-T</p>
      </div>
      <p>The total heat loss is the sum of conduction losses through each component plus infiltration losses from air leakage. Furnaces are typically sized at 125% of the design heat loss.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcHL2() {
      const indoor = parseFloat((document.getElementById('hl2-indoor') as HTMLInputElement).value) || 70;
      const outdoor = parseFloat((document.getElementById('hl2-outdoor') as HTMLInputElement).value) || 5;
      const deltaT = indoor - outdoor;

      const wallArea = parseFloat((document.getElementById('hl2-wallarea') as HTMLInputElement).value) || 0;
      const wallR = parseFloat((document.getElementById('hl2-wallr') as HTMLSelectElement).value) || 13;
      const winArea = parseFloat((document.getElementById('hl2-winarea') as HTMLInputElement).value) || 0;
      const winR = parseFloat((document.getElementById('hl2-winr') as HTMLSelectElement).value) || 1.7;
      const roofArea = parseFloat((document.getElementById('hl2-roofarea') as HTMLInputElement).value) || 0;
      const roofR = parseFloat((document.getElementById('hl2-roofr') as HTMLSelectElement).value) || 30;
      const floorArea = parseFloat((document.getElementById('hl2-floorarea') as HTMLInputElement).value) || 0;
      const floorR = parseFloat((document.getElementById('hl2-floorr') as HTMLSelectElement).value) || 11;
      const ach = parseFloat((document.getElementById('hl2-infil') as HTMLSelectElement).value) || 0.75;

      // Net wall area (subtract windows)
      const netWall = Math.max(0, wallArea - winArea);

      // Q = A * deltaT / R
      const wallLoss = netWall * deltaT / wallR;
      const winLoss = winArea * deltaT / winR;
      const roofLoss = roofArea * deltaT / roofR;
      const floorLoss = floorArea * deltaT / floorR;

      // Infiltration: Q = 0.018 * ACH * Volume * deltaT
      // Estimate volume from floor area * 9ft ceiling
      const volume = floorArea * 9;
      const infilLoss = 0.018 * ach * volume * deltaT;

      const otherLoss = floorLoss + infilLoss;
      const totalLoss = wallLoss + winLoss + roofLoss + otherLoss;

      // Furnace sizing at 125%
      const furnaceSize = totalLoss * 1.25;
      let furnaceRec = '';
      const stdSizes = [40000, 60000, 80000, 100000, 120000, 140000, 160000, 200000];
      for (const s of stdSizes) {
        if (s >= furnaceSize) { furnaceRec = (s / 1000) + ',000 BTU/hr'; break; }
      }
      if (!furnaceRec) furnaceRec = Math.ceil(furnaceSize / 10000) * 10000 / 1000 + ',000 BTU/hr';

      document.getElementById('hl2-total')!.textContent = Math.round(totalLoss).toLocaleString();
      document.getElementById('hl2-wallloss')!.textContent = Math.round(wallLoss).toLocaleString();
      document.getElementById('hl2-winloss')!.textContent = Math.round(winLoss).toLocaleString();
      document.getElementById('hl2-roofloss')!.textContent = Math.round(roofLoss).toLocaleString();
      document.getElementById('hl2-otherloss')!.textContent = Math.round(otherLoss).toLocaleString();
      document.getElementById('hl2-furnace')!.textContent = furnaceRec;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.hl2-in').forEach(el => {
        el.addEventListener('input', calcHL2);
        el.addEventListener('change', calcHL2);
      });
      calcHL2();
    }, 50);
  </script>
</CalculatorLayout>
