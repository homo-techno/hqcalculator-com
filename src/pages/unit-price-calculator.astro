---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Unit Price Calculator - Compare Prices & Find Best Deal";
const description = "Compare unit prices of products to find the best deal. Calculate price per unit, ounce, pound, or any measurement.";

const relatedCalcs = [
  { name: "Discount Calculator", url: "/discount-calculator", description: "Discounts." },
  { name: "Sales Tax Calculator", url: "/sales-tax-calculator", description: "Sales tax." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "Profit Margin", url: "/profit-margin-calculator", description: "Margins." },
  { name: "Tip Calculator", url: "/tip-calculator", description: "Tip splitting." },
  { name: "Ratio Calculator", url: "/ratio-calculator", description: "Ratios." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Unit Price Calculator"
  keywords="unit price calculator, price per unit, compare prices, best deal, cost per ounce, price comparison"
  breadcrumbs={[{ name: "Unit Price", url: "/unit-price-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Unit Price Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Compare prices and find the best deal by calculating the price per unit.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-3xl mx-auto">
      <div class="mb-4 flex justify-between items-center">
        <h3 class="font-semibold text-text">Products to Compare</h3>
        <div>
          <label class="text-xs font-medium text-text mr-2">Unit:</label>
          <select id="up-unit" class="px-3 py-1.5 border border-border rounded-lg text-sm">
            <option value="oz">ounces (oz)</option>
            <option value="lb">pounds (lb)</option>
            <option value="g">grams (g)</option>
            <option value="kg">kilograms (kg)</option>
            <option value="ml">milliliters (ml)</option>
            <option value="L">liters (L)</option>
            <option value="fl oz">fluid oz</option>
            <option value="gal">gallons</option>
            <option value="ct" selected>count (ct)</option>
            <option value="pack">packs</option>
            <option value="roll">rolls</option>
            <option value="sheet">sheets</option>
          </select>
        </div>
      </div>

      <div class="space-y-3 mb-4" id="up-items"></div>
      <button id="up-add" class="px-4 py-2 border border-border rounded-xl text-sm font-semibold hover:bg-surface-alt mb-6">+ Add Product</button>

      <!-- Results -->
      <div class="p-4 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Best Deal</div>
        <div class="text-2xl font-extrabold" id="up-best">—</div>
        <div class="text-sm text-blue-200 mt-1" id="up-best-detail"></div>
      </div>

      <div class="space-y-2 mb-6" id="up-results"></div>

      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h3 class="font-semibold text-sm text-text mb-2">Savings Summary</h3>
        <div class="text-sm" id="up-savings"></div>
      </div>

      <ShareButton calculatorId="unit-price" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How to Compare Unit Prices</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-center">
        Unit Price = Total Price ÷ Quantity
      </div>
      <p>The product with the lowest unit price gives you the best value. However, consider storage, shelf life, and actual usage — the cheapest per unit isn't always the best choice if you can't use it all.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>Is bigger always cheaper?</strong> Usually, but not always. Bulk sizes sometimes cost more per unit due to convenience pricing. Always check the unit price.</p>
      <p><strong>How do stores calculate unit price?</strong> Stores are required (in most US states) to display unit prices on shelf tags. They divide the total price by the quantity in a standard unit.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    interface Item { name: string; price: number; qty: number; }

    let items: Item[] = [
      { name: 'Product A', price: 5.99, qty: 12 },
      { name: 'Product B', price: 8.49, qty: 24 },
      { name: 'Product C', price: 3.29, qty: 6 },
    ];

    function renderItems() {
      const unit = (document.getElementById('up-unit') as HTMLSelectElement).value;
      document.getElementById('up-items')!.innerHTML = items.map((item, i) =>
        `<div class="grid grid-cols-12 gap-2 items-center">
          <input type="text" value="${item.name}" class="up-name col-span-4 px-3 py-2.5 border border-border rounded-xl text-sm" data-idx="${i}">
          <div class="col-span-3 relative">
            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-text-muted text-sm">$</span>
            <input type="number" value="${item.price}" class="up-price w-full pl-6 pr-2 py-2.5 border border-border rounded-xl text-sm" data-idx="${i}" min="0" step="0.01">
          </div>
          <div class="col-span-3 relative">
            <input type="number" value="${item.qty}" class="up-qty w-full px-2 py-2.5 border border-border rounded-xl text-sm text-center" data-idx="${i}" min="0.01" step="any">
            <span class="absolute right-2 top-1/2 -translate-y-1/2 text-text-muted text-xs">${unit}</span>
          </div>
          <button class="up-remove col-span-2 text-danger text-xs hover:underline text-center" data-idx="${i}">Remove</button>
        </div>`
      ).join('');

      document.querySelectorAll('.up-name').forEach(el => el.addEventListener('input', (e) => {
        items[parseInt((e.target as HTMLElement).dataset.idx!)].name = (e.target as HTMLInputElement).value;
        calcUnitPrice();
      }));
      document.querySelectorAll('.up-price').forEach(el => el.addEventListener('input', (e) => {
        items[parseInt((e.target as HTMLElement).dataset.idx!)].price = parseFloat((e.target as HTMLInputElement).value) || 0;
        calcUnitPrice();
      }));
      document.querySelectorAll('.up-qty').forEach(el => el.addEventListener('input', (e) => {
        items[parseInt((e.target as HTMLElement).dataset.idx!)].qty = parseFloat((e.target as HTMLInputElement).value) || 0;
        calcUnitPrice();
      }));
      document.querySelectorAll('.up-remove').forEach(el => el.addEventListener('click', (e) => {
        items.splice(parseInt((e.target as HTMLElement).dataset.idx!), 1);
        renderItems();
        calcUnitPrice();
      }));
    }

    function calcUnitPrice() {
      const unit = (document.getElementById('up-unit') as HTMLSelectElement).value;
      const results = items.map((item, i) => ({
        ...item,
        idx: i,
        unitPrice: item.qty > 0 ? item.price / item.qty : Infinity
      })).sort((a, b) => a.unitPrice - b.unitPrice);

      if (results.length === 0 || results[0].unitPrice === Infinity) {
        document.getElementById('up-best')!.textContent = '—';
        document.getElementById('up-best-detail')!.textContent = 'Add products above';
        document.getElementById('up-results')!.innerHTML = '';
        document.getElementById('up-savings')!.innerHTML = '';
        return;
      }

      const best = results[0];
      document.getElementById('up-best')!.textContent = best.name;
      document.getElementById('up-best-detail')!.textContent = `$${best.unitPrice.toFixed(4)} per ${unit}`;

      document.getElementById('up-results')!.innerHTML = results.map((r, rank) =>
        `<div class="flex items-center gap-3 p-3 rounded-xl ${rank === 0 ? 'bg-green-50 border-2 border-green-300' : 'bg-surface-alt'}">
          <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${rank === 0 ? 'bg-green-500 text-white' : 'bg-white text-text-muted'}">${rank + 1}</div>
          <div class="flex-1">
            <div class="font-semibold text-sm">${r.name}</div>
            <div class="text-xs text-text-muted">$${r.price.toFixed(2)} for ${r.qty} ${unit}</div>
          </div>
          <div class="text-right">
            <div class="font-bold ${rank === 0 ? 'text-green-700' : ''}">${r.unitPrice === Infinity ? '—' : '$' + r.unitPrice.toFixed(4)}</div>
            <div class="text-xs text-text-muted">per ${unit}</div>
          </div>
        </div>`
      ).join('');

      // Savings
      if (results.length >= 2) {
        const worst = results[results.length - 1];
        const pctSaved = worst.unitPrice > 0 && worst.unitPrice !== Infinity
          ? ((1 - best.unitPrice / worst.unitPrice) * 100).toFixed(1)
          : '0';
        document.getElementById('up-savings')!.innerHTML =
          `<div class="text-text-secondary">Best: <strong>${best.name}</strong> at $${best.unitPrice.toFixed(4)}/${unit}</div>
           <div class="text-text-secondary">Worst: <strong>${worst.name}</strong> at $${worst.unitPrice === Infinity ? '—' : worst.unitPrice.toFixed(4)}/${unit}</div>
           <div class="font-bold text-secondary mt-1">You save ${pctSaved}% by choosing ${best.name}</div>`;
      }

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      renderItems();
      calcUnitPrice();

      document.getElementById('up-add')!.addEventListener('click', () => {
        items.push({ name: `Product ${String.fromCharCode(65 + items.length)}`, price: 0, qty: 0 });
        renderItems();
        calcUnitPrice();
      });

      document.getElementById('up-unit')!.addEventListener('change', () => {
        renderItems();
        calcUnitPrice();
      });
    }, 50);
  </script>
</CalculatorLayout>
