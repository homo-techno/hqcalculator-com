---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Lease Calculator - Car Lease Payment Estimator";
const description = "Calculate monthly car lease payments, total cost, and compare leasing vs buying. Factor in down payment, residual value, and money factor.";

const relatedCalcs = [
  { name: "Auto Loan Calculator", url: "/auto-loan-calculator", description: "Auto loans." },
  { name: "Loan Calculator", url: "/loan-calculator", description: "Loan payments." },
  { name: "Mortgage Calculator", url: "/mortgage-calculator", description: "Home loans." },
  { name: "Gas Mileage", url: "/gas-mileage-calculator", description: "Fuel economy." },
  { name: "Savings Calculator", url: "/savings-calculator", description: "Savings growth." },
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Lease Calculator"
  keywords="lease calculator, car lease, monthly lease payment, lease vs buy, residual value, money factor"
  breadcrumbs={[{ name: "Lease Calculator", url: "/lease-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Lease Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate your monthly car lease payment and total cost.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-text mb-1">Vehicle MSRP</label>
              <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span>
                <input type="number" id="ls-msrp" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="35000" min="0" step="500">
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Negotiated Price (Cap Cost)</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                <input type="number" id="ls-price" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="33000" min="0" step="500">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-text mb-1">Down Payment</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                  <input type="number" id="ls-down" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="2000" min="0" step="500">
                </div>
              </div>
              <div>
                <label class="block text-xs font-medium text-text mb-1">Trade-In Value</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                  <input type="number" id="ls-trade" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="0" min="0" step="500">
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-text mb-1">Lease Term (months)</label>
                <select id="ls-term" class="w-full px-3 py-3 border border-border rounded-xl text-lg">
                  <option value="24">24 months</option>
                  <option value="36" selected>36 months</option>
                  <option value="39">39 months</option>
                  <option value="48">48 months</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-text mb-1">Residual Value (%)</label>
                <input type="number" id="ls-residual" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="55" min="20" max="80" step="1">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-text mb-1">Money Factor</label>
                <input type="number" id="ls-mf" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="0.00125" min="0" max="0.01" step="0.00001">
                <div class="text-xs text-text-muted mt-1" id="ls-apr">= 3.00% APR</div>
              </div>
              <div>
                <label class="block text-xs font-medium text-text mb-1">Sales Tax (%)</label>
                <input type="number" id="ls-tax" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="6" min="0" max="15" step="0.1">
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Dealer Fees</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted">$</span>
                <input type="number" id="ls-fees" class="w-full pl-7 pr-3 py-3 border border-border rounded-xl text-lg" value="800" min="0" step="100">
              </div>
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Monthly Payment</div>
            <div class="text-5xl font-extrabold" id="ls-payment">$0</div>
            <div class="text-sm text-blue-200 mt-1" id="ls-tax-note">including tax</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Due at Signing</div>
              <div class="text-xl font-bold" id="ls-due">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Lease Cost</div>
              <div class="text-xl font-bold text-secondary" id="ls-total">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Depreciation</div>
              <div class="text-xl font-bold" id="ls-deprec">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Interest</div>
              <div class="text-xl font-bold" id="ls-interest">$0</div>
            </div>
          </div>

          <div class="p-4 bg-surface-alt rounded-xl">
            <h3 class="font-semibold text-sm text-text mb-3">Payment Breakdown</h3>
            <div class="space-y-1 text-sm" id="ls-breakdown"></div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="lease" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Car Leases Work</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Depreciation:</strong> (Cap Cost − Residual) ÷ Term</p>
        <p><strong>Finance Charge:</strong> (Cap Cost + Residual) × Money Factor</p>
        <p><strong>Monthly:</strong> Depreciation + Finance Charge + Tax</p>
      </div>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>What is a money factor?</strong> The money factor is the interest component of a lease. Multiply by 2,400 to convert to an approximate APR. For example, 0.00125 × 2400 = 3% APR.</p>
      <p><strong>What is residual value?</strong> The predicted value of the car at lease end, expressed as a percentage of MSRP. Higher residual = lower monthly payment.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString();

    function calcLease() {
      const msrp = parseFloat((document.getElementById('ls-msrp') as HTMLInputElement).value) || 0;
      const price = parseFloat((document.getElementById('ls-price') as HTMLInputElement).value) || 0;
      const down = parseFloat((document.getElementById('ls-down') as HTMLInputElement).value) || 0;
      const trade = parseFloat((document.getElementById('ls-trade') as HTMLInputElement).value) || 0;
      const term = parseInt((document.getElementById('ls-term') as HTMLSelectElement).value) || 36;
      const residualPct = (parseFloat((document.getElementById('ls-residual') as HTMLInputElement).value) || 55) / 100;
      const mf = parseFloat((document.getElementById('ls-mf') as HTMLInputElement).value) || 0;
      const taxRate = (parseFloat((document.getElementById('ls-tax') as HTMLInputElement).value) || 0) / 100;
      const fees = parseFloat((document.getElementById('ls-fees') as HTMLInputElement).value) || 0;

      // APR display
      document.getElementById('ls-apr')!.textContent = `= ${(mf * 2400).toFixed(2)}% APR`;

      const residual = msrp * residualPct;
      const capCost = price + fees - down - trade;
      const depreciation = (capCost - residual) / term;
      const financeCharge = (capCost + residual) * mf;
      const preTaxPayment = depreciation + financeCharge;
      const tax = preTaxPayment * taxRate;
      const monthlyPayment = preTaxPayment + tax;

      const totalPayments = monthlyPayment * term;
      const totalCost = totalPayments + down + trade;
      const totalInterest = financeCharge * term;
      const totalDeprec = depreciation * term;

      document.getElementById('ls-payment')!.textContent = fmt(monthlyPayment);
      document.getElementById('ls-due')!.textContent = fmt(down + monthlyPayment + fees);
      document.getElementById('ls-total')!.textContent = fmt(totalCost);
      document.getElementById('ls-deprec')!.textContent = fmt(totalDeprec);
      document.getElementById('ls-interest')!.textContent = fmt(totalInterest);

      document.getElementById('ls-breakdown')!.innerHTML = [
        ['Depreciation', depreciation],
        ['Finance Charge', financeCharge],
        ['Sales Tax', tax],
        ['Monthly Total', monthlyPayment],
      ].map(([label, val]) =>
        `<div class="flex justify-between ${label === 'Monthly Total' ? 'pt-1 border-t border-border font-bold' : ''}">
          <span class="text-text-secondary">${label}</span>
          <span class="font-semibold">${fmt(val as number)}</span>
        </div>`
      ).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      ['ls-msrp', 'ls-price', 'ls-down', 'ls-trade', 'ls-residual', 'ls-mf', 'ls-tax', 'ls-fees'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calcLease);
      });
      document.getElementById('ls-term')!.addEventListener('change', calcLease);
      calcLease();
    }, 50);
  </script>
</CalculatorLayout>
