---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Discount Calculator - Sale Price & Savings Calculator";
const description = "Calculate sale prices, discount amounts, and savings instantly. Double discount, price before discount, and discount percentage calculator.";

const relatedCalcs = [
  { name: "Percentage Calculator", url: "/percentage-calculator", description: "Percentages." },
  { name: "Sales Tax Calculator", url: "/sales-tax-calculator", description: "Sales tax." },
  { name: "Tip Calculator", url: "/tip-calculator", description: "Restaurant tips." },
  { name: "Profit Margin", url: "/profit-margin-calculator", description: "Business margins." },
  { name: "Savings Calculator", url: "/savings-calculator", description: "Savings growth." },
  { name: "Inflation Calculator", url: "/inflation-calculator", description: "Purchasing power." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Discount Calculator"
  keywords="discount calculator, sale price calculator, percent off, savings calculator, double discount, markdown calculator"
  breadcrumbs={[{ name: "Discount Calculator", url: "/discount-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Discount Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate sale prices, savings, and double discounts instantly.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <!-- Mode -->
      <div class="flex gap-2 mb-6">
        <button class="dc-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-primary text-white" data-mode="price">Sale Price</button>
        <button class="dc-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-surface-alt text-text-secondary" data-mode="percent">Find % Off</button>
        <button class="dc-mode-btn px-4 py-2 rounded-full text-sm font-semibold bg-surface-alt text-text-secondary" data-mode="original">Original Price</button>
      </div>

      <!-- Sale Price mode -->
      <div id="dc-price-mode">
        <div class="mb-5">
          <label class="block text-sm font-medium text-text mb-1">Original Price</label>
          <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span><input type="number" id="dc-orig" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="100" min="0" step="0.01"></div>
        </div>
        <div class="mb-5">
          <label class="block text-sm font-medium text-text mb-1">Discount</label>
          <div class="flex gap-2">
            <input type="number" id="dc-pct" class="flex-1 px-4 py-3 border border-border rounded-xl text-2xl font-bold" value="25" min="0" max="100" step="0.5">
            <span class="self-center text-text-muted font-bold text-xl">%</span>
          </div>
          <div class="flex gap-2 mt-2">
            <button class="dc-quick px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-pct="10">10%</button>
            <button class="dc-quick px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-pct="15">15%</button>
            <button class="dc-quick px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-pct="20">20%</button>
            <button class="dc-quick px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-pct="25">25%</button>
            <button class="dc-quick px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-pct="30">30%</button>
            <button class="dc-quick px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-pct="40">40%</button>
            <button class="dc-quick px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-pct="50">50%</button>
            <button class="dc-quick px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-pct="75">75%</button>
          </div>
        </div>
        <div class="mb-5">
          <label class="block text-sm font-medium text-text mb-1">Second Discount <span class="text-text-muted">(optional)</span></label>
          <div class="flex gap-2">
            <input type="number" id="dc-pct2" class="flex-1 px-4 py-3 border border-border rounded-xl text-lg" value="0" min="0" max="100" step="0.5">
            <span class="self-center text-text-muted font-bold">%</span>
          </div>
        </div>
      </div>

      <!-- Find % mode -->
      <div id="dc-percent-mode" class="hidden">
        <div class="mb-5">
          <label class="block text-sm font-medium text-text mb-1">Original Price</label>
          <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span><input type="number" id="dc-fp-orig" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="80" min="0" step="0.01"></div>
        </div>
        <div class="mb-5">
          <label class="block text-sm font-medium text-text mb-1">Sale Price</label>
          <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span><input type="number" id="dc-fp-sale" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="60" min="0" step="0.01"></div>
        </div>
      </div>

      <!-- Original Price mode -->
      <div id="dc-original-mode" class="hidden">
        <div class="mb-5">
          <label class="block text-sm font-medium text-text mb-1">Sale Price</label>
          <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span><input type="number" id="dc-op-sale" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="75" min="0" step="0.01"></div>
        </div>
        <div class="mb-5">
          <label class="block text-sm font-medium text-text mb-1">Discount Applied</label>
          <div class="flex gap-2">
            <input type="number" id="dc-op-pct" class="flex-1 px-4 py-3 border border-border rounded-xl text-2xl font-bold" value="25" min="0" max="100" step="0.5">
            <span class="self-center text-text-muted font-bold text-xl">%</span>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1" id="dc-label">Sale Price</div>
        <div class="text-5xl font-extrabold" id="dc-result">$75.00</div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-6">
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">You Save</div>
          <div class="text-xl font-bold text-secondary" id="dc-savings">$25.00</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Total Discount</div>
          <div class="text-xl font-bold" id="dc-total-pct">25%</div>
        </div>
      </div>

      <!-- Quick table -->
      <div class="bg-surface-alt rounded-xl p-4 mb-6">
        <h3 class="font-semibold text-sm text-text mb-3">Discount Table</h3>
        <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-sm" id="dc-table"></div>
      </div>

      <ShareButton calculatorId="discount" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How to Calculate Discounts</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono">Sale Price = Original Price × (1 − Discount%/100)</div>
      <p>For a $100 item at 25% off: $100 × (1 − 0.25) = $75. You save $25.</p>

      <h3 class="text-xl font-semibold text-text mt-8">Double Discounts</h3>
      <p>When two discounts are stacked, the second applies to the already-discounted price, not the original. A 20% + 10% discount is NOT 30% — it's actually 28%.</p>
      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono">$100 × 0.80 × 0.90 = $72 (28% total, not 30%)</div>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>Is 20% off then 10% off the same as 30% off?</strong> No. 20%+10% stacked = 28% total. The order doesn't matter — the result is the same either way.</p>
      <p><strong>How do I find what % off something is?</strong> Discount % = (Original − Sale) / Original × 100. If $80 is now $60: (80−60)/80 × 100 = 25% off.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let dcMode = 'price';
    const fmt = (n: number) => '$' + n.toFixed(2);

    function calcDiscount() {
      let origPrice = 0, salePrice = 0, savings = 0, pctOff = 0;

      if (dcMode === 'price') {
        origPrice = parseFloat((document.getElementById('dc-orig') as HTMLInputElement).value) || 0;
        const pct1 = (parseFloat((document.getElementById('dc-pct') as HTMLInputElement).value) || 0) / 100;
        const pct2 = (parseFloat((document.getElementById('dc-pct2') as HTMLInputElement).value) || 0) / 100;
        salePrice = origPrice * (1 - pct1) * (1 - pct2);
        savings = origPrice - salePrice;
        pctOff = origPrice > 0 ? (savings / origPrice * 100) : 0;
        document.getElementById('dc-label')!.textContent = 'Sale Price';
        document.getElementById('dc-result')!.textContent = fmt(salePrice);
      } else if (dcMode === 'percent') {
        origPrice = parseFloat((document.getElementById('dc-fp-orig') as HTMLInputElement).value) || 0;
        salePrice = parseFloat((document.getElementById('dc-fp-sale') as HTMLInputElement).value) || 0;
        savings = origPrice - salePrice;
        pctOff = origPrice > 0 ? (savings / origPrice * 100) : 0;
        document.getElementById('dc-label')!.textContent = 'Discount Percentage';
        document.getElementById('dc-result')!.textContent = pctOff.toFixed(1) + '% OFF';
      } else {
        salePrice = parseFloat((document.getElementById('dc-op-sale') as HTMLInputElement).value) || 0;
        const pct = (parseFloat((document.getElementById('dc-op-pct') as HTMLInputElement).value) || 0) / 100;
        origPrice = pct < 1 ? salePrice / (1 - pct) : 0;
        savings = origPrice - salePrice;
        pctOff = pct * 100;
        document.getElementById('dc-label')!.textContent = 'Original Price';
        document.getElementById('dc-result')!.textContent = fmt(origPrice);
      }

      document.getElementById('dc-savings')!.textContent = fmt(savings);
      document.getElementById('dc-total-pct')!.textContent = pctOff.toFixed(1) + '%';

      // Table
      const basePrice = origPrice || 100;
      const pcts = [5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 60, 75];
      document.getElementById('dc-table')!.innerHTML = pcts.map(p => {
        const sp = basePrice * (1 - p / 100);
        const highlight = Math.abs(p - pctOff) < 1;
        return `<div class="flex justify-between py-0.5 ${highlight ? 'font-bold text-primary' : 'text-text-secondary'}"><span>${p}% off</span><span>${fmt(sp)}</span></div>`;
      }).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.dc-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.dc-mode-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white'); b.classList.add('bg-surface-alt', 'text-text-secondary'); });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary'); btn.classList.add('bg-primary', 'text-white');
          dcMode = (btn as HTMLElement).dataset.mode || 'price';
          document.getElementById('dc-price-mode')!.classList.toggle('hidden', dcMode !== 'price');
          document.getElementById('dc-percent-mode')!.classList.toggle('hidden', dcMode !== 'percent');
          document.getElementById('dc-original-mode')!.classList.toggle('hidden', dcMode !== 'original');
          calcDiscount();
        });
      });

      document.querySelectorAll('.dc-quick').forEach(btn => {
        btn.addEventListener('click', () => {
          (document.getElementById('dc-pct') as HTMLInputElement).value = (btn as HTMLElement).dataset.pct || '25';
          calcDiscount();
        });
      });

      ['dc-orig', 'dc-pct', 'dc-pct2', 'dc-fp-orig', 'dc-fp-sale', 'dc-op-sale', 'dc-op-pct'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', calcDiscount);
      });

      calcDiscount();
    }, 50);
  </script>
</CalculatorLayout>
