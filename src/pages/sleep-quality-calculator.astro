---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Sleep Quality Calculator - PSQI Sleep Assessment";
const description = "Assess your sleep quality using a simplified Pittsburgh Sleep Quality Index (PSQI). Calculate sleep efficiency, latency score, and disturbance score.";
const relatedCalcs = [
  { name: "Sleep Calculator", url: "/sleep-calculator", description: "Optimize sleep cycles." },
  { name: "Caffeine Calculator", url: "/caffeine-calculator", description: "Caffeine intake." },
  { name: "BMI Calculator", url: "/bmi-calculator", description: "Body mass index." },
  { name: "Calorie Calculator", url: "/calorie-calculator", description: "Daily calorie needs." },
  { name: "Age Calculator", url: "/age-calculator", description: "Calculate exact age." },
  { name: "Heart Rate Calculator", url: "/heart-rate-calculator", description: "Heart rate zones." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Sleep Quality Calculator" keywords="sleep quality, PSQI, Pittsburgh Sleep Quality Index, sleep efficiency, sleep latency, sleep disturbance, insomnia" breadcrumbs={[{ name: "Sleep Quality", url: "/sleep-quality-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Sleep Quality Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Assess your sleep quality with a simplified PSQI-based evaluation over the past month.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-1">Usual bedtime (e.g. 11:00 PM)</label>
          <input type="time" id="sq-bed" class="sq-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Minutes to fall asleep (sleep latency)</label>
          <input type="number" id="sq-latency" class="sq-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" min="0" max="180" step="1">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Usual wake-up time</label>
          <input type="time" id="sq-wake" class="sq-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Actual hours of sleep per night</label>
          <input type="number" id="sq-hours" class="sq-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" min="0" max="16" step="0.5">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Number of nighttime awakenings</label>
          <input type="number" id="sq-awake" class="sq-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" min="0" max="20" step="1">
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Subjective sleep quality (0 = Very good, 3 = Very bad)</label>
          <input type="range" id="sq-subj" class="sq-in w-full" min="0" max="3" step="1">
          <div class="flex justify-between text-xs text-text-secondary"><span>Very good (0)</span><span>Very bad (3)</span></div>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Sleep medication use (0 = None, 3 = 3+ times/week)</label>
          <input type="range" id="sq-meds" class="sq-in w-full" min="0" max="3" step="1">
          <div class="flex justify-between text-xs text-text-secondary"><span>None (0)</span><span>3+/week (3)</span></div>
        </div>
        <div>
          <label class="block text-sm font-medium text-text mb-1">Daytime dysfunction (0 = None, 3 = Very much)</label>
          <input type="range" id="sq-day" class="sq-in w-full" min="0" max="3" step="1">
          <div class="flex justify-between text-xs text-text-secondary"><span>None (0)</span><span>Very much (3)</span></div>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm opacity-80">Overall Sleep Quality</div>
          <div class="text-2xl font-extrabold mt-1" id="sq-quality">--</div>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Sleep Efficiency</div>
            <div class="text-xl font-bold text-text mt-1" id="sq-eff">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Latency Score</div>
            <div class="text-xl font-bold text-text mt-1" id="sq-latscore">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Disturbance Score</div>
            <div class="text-xl font-bold text-text mt-1" id="sq-dist">--</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">PSQI Global Score</div>
            <div class="text-xl font-bold text-text mt-1" id="sq-global">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-secondary">Time in Bed</div>
            <div class="text-xl font-bold text-text mt-1" id="sq-tib">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <div class="text-xs text-text-secondary mb-2">Recommendations</div>
          <div class="text-sm text-text" id="sq-recs">--</div>
        </div>
      </div>

      <ShareButton calculatorId="sleep-quality" />
      <FeedbackWidget />
    </div>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcSQ() {
      const bedStr = (document.getElementById('sq-bed') as HTMLInputElement).value || '23:00';
      const wakeStr = (document.getElementById('sq-wake') as HTMLInputElement).value || '07:00';
      const latency = parseFloat((document.getElementById('sq-latency') as HTMLInputElement).value) || 15;
      const sleepHours = parseFloat((document.getElementById('sq-hours') as HTMLInputElement).value) || 7;
      const awakenings = parseInt((document.getElementById('sq-awake') as HTMLInputElement).value) || 1;
      const subjective = parseInt((document.getElementById('sq-subj') as HTMLInputElement).value) || 0;
      const meds = parseInt((document.getElementById('sq-meds') as HTMLInputElement).value) || 0;
      const dayDys = parseInt((document.getElementById('sq-day') as HTMLInputElement).value) || 0;

      // Calculate time in bed
      const [bH, bM] = bedStr.split(':').map(Number);
      const [wH, wM] = wakeStr.split(':').map(Number);
      let bedMin = bH * 60 + bM;
      let wakeMin = wH * 60 + wM;
      if (wakeMin <= bedMin) wakeMin += 1440;
      const tibMinutes = wakeMin - bedMin;
      const tibHours = tibMinutes / 60;

      // Sleep efficiency
      const efficiency = tibHours > 0 ? (sleepHours / tibHours) * 100 : 0;

      // PSQI Component scoring
      // C1: Subjective quality (0-3)
      const c1 = subjective;

      // C2: Sleep latency (0-3)
      let c2 = 0;
      if (latency <= 15) c2 = 0;
      else if (latency <= 30) c2 = 1;
      else if (latency <= 60) c2 = 2;
      else c2 = 3;

      // C3: Sleep duration (0-3)
      let c3 = 0;
      if (sleepHours >= 7) c3 = 0;
      else if (sleepHours >= 6) c3 = 1;
      else if (sleepHours >= 5) c3 = 2;
      else c3 = 3;

      // C4: Sleep efficiency (0-3)
      let c4 = 0;
      if (efficiency >= 85) c4 = 0;
      else if (efficiency >= 75) c4 = 1;
      else if (efficiency >= 65) c4 = 2;
      else c4 = 3;

      // C5: Sleep disturbances (0-3)
      let c5 = 0;
      if (awakenings === 0) c5 = 0;
      else if (awakenings <= 1) c5 = 1;
      else if (awakenings <= 3) c5 = 2;
      else c5 = 3;

      // C6: Sleep medication (0-3)
      const c6 = meds;

      // C7: Daytime dysfunction (0-3)
      const c7 = dayDys;

      const globalScore = c1 + c2 + c3 + c4 + c5 + c6 + c7;

      let qualityLabel = 'Good';
      let recs = '';
      if (globalScore <= 5) {
        qualityLabel = 'Good Sleep Quality';
        recs = 'Your sleep quality is good. Maintain your current sleep habits. Keep a consistent schedule and limit screen time before bed.';
      } else if (globalScore <= 10) {
        qualityLabel = 'Poor Sleep Quality';
        recs = 'Your sleep quality needs improvement. Focus on: consistent bed/wake times, a cool dark bedroom (65-68F), avoiding caffeine after 2 PM, and a wind-down routine 30 min before bed.';
      } else if (globalScore <= 15) {
        qualityLabel = 'Very Poor Sleep Quality';
        recs = 'Significant sleep problems detected. Consider consulting a sleep specialist. CBT for insomnia (CBT-I) is the first-line treatment. Avoid relying on sleep medication long-term.';
      } else {
        qualityLabel = 'Severely Impaired Sleep';
        recs = 'Your sleep is severely impaired. Professional evaluation is strongly recommended. A sleep study may be warranted to rule out sleep apnea or other disorders.';
      }

      document.getElementById('sq-quality')!.textContent = qualityLabel;
      document.getElementById('sq-eff')!.textContent = efficiency.toFixed(1) + '%';
      document.getElementById('sq-latscore')!.textContent = c2 + '/3 (' + latency + ' min)';
      document.getElementById('sq-dist')!.textContent = c5 + '/3 (' + awakenings + ' awakenings)';
      document.getElementById('sq-global')!.textContent = globalScore + ' / 21';
      document.getElementById('sq-tib')!.textContent = tibHours.toFixed(1) + ' hrs';
      document.getElementById('sq-recs')!.textContent = recs;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      (document.getElementById('sq-bed') as HTMLInputElement).value = '23:00';
      (document.getElementById('sq-wake') as HTMLInputElement).value = '07:00';
      (document.getElementById('sq-latency') as HTMLInputElement).value = '15';
      (document.getElementById('sq-hours') as HTMLInputElement).value = '7';
      (document.getElementById('sq-awake') as HTMLInputElement).value = '1';
      (document.getElementById('sq-subj') as HTMLInputElement).value = '1';
      (document.getElementById('sq-meds') as HTMLInputElement).value = '0';
      (document.getElementById('sq-day') as HTMLInputElement).value = '0';
      document.querySelectorAll('.sq-in').forEach(el => {
        el.addEventListener('input', calcSQ);
        el.addEventListener('change', calcSQ);
      });
      calcSQ();
    }, 50);
  </script>
</CalculatorLayout>
