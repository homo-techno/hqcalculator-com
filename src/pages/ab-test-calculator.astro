---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "A/B Test Calculator - Statistical Significance & Power";
const description = "Calculate A/B test statistical significance, required sample size, lift percentage, confidence level, minimum detectable effect, and statistical power.";
const relatedCalcs = [
  { name: "Probability Calculator", url: "/probability-calculator", description: "Event probability." },
  { name: "Confidence Interval", url: "/confidence-interval-calculator", description: "Confidence ranges." },
  { name: "Sample Size Calculator", url: "/sample-size-calculator", description: "Sample sizing." },
  { name: "Chi-Square Calculator", url: "/chi-square-calculator", description: "Chi-square test." },
  { name: "Z-Score Calculator", url: "/z-score-calculator", description: "Z-score analysis." },
  { name: "Standard Deviation", url: "/standard-deviation-calculator", description: "Spread analysis." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="A/B Test Calculator" keywords="ab test calculator, statistical significance, sample size, conversion rate, lift, power analysis, minimum detectable effect" breadcrumbs={[{ name: "A/B Test", url: "/ab-test-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">A/B Test Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Determine if your A/B test results are statistically significant and plan the right sample size for future tests.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="flex gap-2 mb-4 flex-wrap">
          <button class="ab-mode px-4 py-2 rounded-full text-sm font-semibold bg-primary text-white" data-mode="results">Analyze Results</button>
          <button class="ab-mode px-4 py-2 rounded-full text-sm font-semibold bg-surface-alt text-text-secondary" data-mode="plan">Plan Sample Size</button>
        </div>

        <div id="ab-results-section">
          <h3 class="font-semibold text-text text-sm mb-3">Control (A)</h3>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold text-text mb-1">Visitors</label>
              <input type="number" class="ab-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="ab-va" min="1" value="5000">
            </div>
            <div>
              <label class="block text-sm font-semibold text-text mb-1">Conversions</label>
              <input type="number" class="ab-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="ab-ca" min="0" value="150">
            </div>
          </div>

          <h3 class="font-semibold text-text text-sm mb-3">Variant (B)</h3>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-semibold text-text mb-1">Visitors</label>
              <input type="number" class="ab-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="ab-vb" min="1" value="5000">
            </div>
            <div>
              <label class="block text-sm font-semibold text-text mb-1">Conversions</label>
              <input type="number" class="ab-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="ab-cb" min="0" value="185">
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-text mb-1">Confidence Level</label>
            <select class="ab-in w-full px-4 py-2 border border-border rounded-xl" id="ab-conf">
              <option value="0.90">90%</option>
              <option value="0.95" selected>95%</option>
              <option value="0.99">99%</option>
            </select>
          </div>
        </div>

        <div id="ab-plan-section" class="hidden">
          <div>
            <label class="block text-sm font-semibold text-text mb-1">Baseline Conversion Rate (%)</label>
            <input type="number" class="ab-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="ab-baseline" min="0.01" max="100" step="0.01" value="3">
          </div>
          <div class="mt-3">
            <label class="block text-sm font-semibold text-text mb-1">Minimum Detectable Effect (relative %)</label>
            <input type="number" class="ab-in w-full px-4 py-3 border border-border rounded-xl text-xl font-bold text-center" id="ab-mde" min="0.1" step="0.1" value="10">
          </div>
          <div class="mt-3 grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold text-text mb-1">Confidence Level</label>
              <select class="ab-in w-full px-4 py-2 border border-border rounded-xl" id="ab-planconf">
                <option value="0.90">90%</option>
                <option value="0.95" selected>95%</option>
                <option value="0.99">99%</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-text mb-1">Statistical Power</label>
              <select class="ab-in w-full px-4 py-2 border border-border rounded-xl" id="ab-power">
                <option value="0.80" selected>80%</option>
                <option value="0.90">90%</option>
                <option value="0.95">95%</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-semibold text-text mb-1">Daily Visitors (per variant)</label>
            <input type="number" class="ab-in w-full px-4 py-3 border border-border rounded-xl text-lg text-center" id="ab-daily" min="1" value="1000">
          </div>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1" id="ab-mainlabel">Statistical Significance</div>
          <div class="text-4xl font-extrabold" id="ab-main">--</div>
          <div class="text-sm text-blue-200 mt-1" id="ab-subtitle">--</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase" id="ab-s1l">Control Rate</div>
            <div class="text-xl font-bold font-mono" id="ab-s1">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase" id="ab-s2l">Variant Rate</div>
            <div class="text-xl font-bold font-mono" id="ab-s2">--</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase" id="ab-s3l">Relative Lift</div>
            <div class="text-xl font-bold font-mono" id="ab-s3">--</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase" id="ab-s4l">P-value</div>
            <div class="text-xl font-bold font-mono" id="ab-s4">--</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2" id="ab-tableh">Details</h3>
          <div class="text-xs font-mono space-y-1" id="ab-details"></div>
        </div>
      </div>
      <ShareButton calculatorId="ab-test" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">A/B Testing Statistics</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Z-test:</strong> z = (pB - pA) / sqrt(p*(1-p)*(1/nA + 1/nB))</p>
        <p><strong>p-value:</strong> 2 * (1 - Phi(|z|)) for two-tailed test</p>
        <p><strong>Sample size:</strong> n = (z_alpha + z_beta)^2 * (p1(1-p1) + p2(1-p2)) / (p2-p1)^2</p>
        <p><strong>Lift:</strong> (pB - pA) / pA * 100%</p>
      </div>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let abMode = 'results';

    // Standard normal CDF approximation
    function normalCDF(z: number): number {
      if (z < -8) return 0;
      if (z > 8) return 1;
      let sum = 0;
      let term = z;
      for (let i = 3; sum + term !== sum; i += 2) {
        sum += term;
        term = term * z * z / i;
      }
      return 0.5 + sum * Math.exp(-0.5 * z * z) / Math.sqrt(2 * Math.PI);
    }

    // Inverse normal approximation (Beasley-Springer-Moro)
    function normalInv(p: number): number {
      if (p <= 0) return -8;
      if (p >= 1) return 8;
      if (p === 0.5) return 0;
      if (p > 0.5) return -normalInv(1 - p);
      const t = Math.sqrt(-2 * Math.log(p));
      const c0 = 2.515517, c1 = 0.802853, c2 = 0.010328;
      const d1 = 1.432788, d2 = 0.189269, d3 = 0.001308;
      return -(t - (c0 + c1 * t + c2 * t * t) / (1 + d1 * t + d2 * t * t + d3 * t * t * t));
    }

    function calcAB() {
      if (abMode === 'results') {
        const va = parseInt((document.getElementById('ab-va') as HTMLInputElement).value) || 1;
        const ca = parseInt((document.getElementById('ab-ca') as HTMLInputElement).value) || 0;
        const vb = parseInt((document.getElementById('ab-vb') as HTMLInputElement).value) || 1;
        const cb = parseInt((document.getElementById('ab-cb') as HTMLInputElement).value) || 0;
        const confLevel = parseFloat((document.getElementById('ab-conf') as HTMLSelectElement).value);

        const pA = ca / va;
        const pB = cb / vb;
        const pPooled = (ca + cb) / (va + vb);
        const se = Math.sqrt(pPooled * (1 - pPooled) * (1 / va + 1 / vb));
        const z = se > 0 ? (pB - pA) / se : 0;
        const pValue = 2 * (1 - normalCDF(Math.abs(z)));
        const lift = pA > 0 ? ((pB - pA) / pA) * 100 : 0;
        const isSignificant = pValue < (1 - confLevel);

        // Confidence interval for difference
        const seDiff = Math.sqrt(pA * (1 - pA) / va + pB * (1 - pB) / vb);
        const zAlpha = normalInv(1 - (1 - confLevel) / 2);
        const ciLow = (pB - pA) - zAlpha * seDiff;
        const ciHigh = (pB - pA) + zAlpha * seDiff;

        document.getElementById('ab-mainlabel')!.textContent = 'Statistical Significance';
        document.getElementById('ab-main')!.textContent = isSignificant ? 'SIGNIFICANT' : 'NOT Significant';
        document.getElementById('ab-subtitle')!.textContent = isSignificant
          ? 'Confident that B is ' + (pB > pA ? 'better' : 'worse') + ' than A'
          : 'Not enough evidence to declare a winner';

        document.getElementById('ab-s1l')!.textContent = 'Control Rate (A)';
        document.getElementById('ab-s1')!.textContent = (pA * 100).toFixed(2) + '%';
        document.getElementById('ab-s2l')!.textContent = 'Variant Rate (B)';
        document.getElementById('ab-s2')!.textContent = (pB * 100).toFixed(2) + '%';
        document.getElementById('ab-s3l')!.textContent = 'Relative Lift';
        document.getElementById('ab-s3')!.textContent = (lift >= 0 ? '+' : '') + lift.toFixed(2) + '%';
        document.getElementById('ab-s4l')!.textContent = 'P-value';
        document.getElementById('ab-s4')!.textContent = pValue < 0.001 ? pValue.toExponential(3) : pValue.toFixed(4);

        let html = '';
        html += '<div class="flex justify-between py-0.5 border-b border-border"><span>Z-score</span><span>' + z.toFixed(4) + '</span></div>';
        html += '<div class="flex justify-between py-0.5 border-b border-border"><span>Standard Error</span><span>' + se.toFixed(6) + '</span></div>';
        html += '<div class="flex justify-between py-0.5 border-b border-border"><span>Absolute Difference</span><span>' + ((pB - pA) * 100).toFixed(3) + ' pp</span></div>';
        html += '<div class="flex justify-between py-0.5 border-b border-border"><span>' + (confLevel * 100) + '% CI for Difference</span><span>' + (ciLow * 100).toFixed(3) + ' to ' + (ciHigh * 100).toFixed(3) + ' pp</span></div>';
        html += '<div class="flex justify-between py-0.5 border-b border-border"><span>Pooled Conversion Rate</span><span>' + (pPooled * 100).toFixed(3) + '%</span></div>';
        html += '<div class="flex justify-between py-0.5 border-b border-border"><span>Total Sample Size</span><span>' + (va + vb).toLocaleString() + '</span></div>';

        // Post-hoc power
        const effectSize = Math.abs(pB - pA) / Math.sqrt(pPooled * (1 - pPooled));
        const power = 1 - normalCDF(zAlpha - effectSize * Math.sqrt(va));
        html += '<div class="flex justify-between py-0.5 border-b border-border"><span>Statistical Power</span><span>' + (power * 100).toFixed(1) + '%</span></div>';

        document.getElementById('ab-tableh')!.textContent = 'Test Details';
        document.getElementById('ab-details')!.innerHTML = html;

      } else {
        // Sample size planning
        const baseline = (parseFloat((document.getElementById('ab-baseline') as HTMLInputElement).value) || 3) / 100;
        const mde = (parseFloat((document.getElementById('ab-mde') as HTMLInputElement).value) || 10) / 100;
        const confLevel = parseFloat((document.getElementById('ab-planconf') as HTMLSelectElement).value);
        const power = parseFloat((document.getElementById('ab-power') as HTMLSelectElement).value);
        const daily = parseInt((document.getElementById('ab-daily') as HTMLInputElement).value) || 1000;

        const p1 = baseline;
        const p2 = baseline * (1 + mde);
        const zAlpha = normalInv(1 - (1 - confLevel) / 2);
        const zBeta = normalInv(power);

        const num = Math.pow(zAlpha + zBeta, 2) * (p1 * (1 - p1) + p2 * (1 - p2));
        const den = Math.pow(p2 - p1, 2);
        const samplePerVariant = Math.ceil(num / den);
        const totalSample = samplePerVariant * 2;
        const daysNeeded = Math.ceil(samplePerVariant / daily);

        document.getElementById('ab-mainlabel')!.textContent = 'Required Sample Size (per variant)';
        document.getElementById('ab-main')!.textContent = samplePerVariant.toLocaleString();
        document.getElementById('ab-subtitle')!.textContent = totalSample.toLocaleString() + ' total visitors needed';

        document.getElementById('ab-s1l')!.textContent = 'Baseline Rate';
        document.getElementById('ab-s1')!.textContent = (p1 * 100).toFixed(2) + '%';
        document.getElementById('ab-s2l')!.textContent = 'Target Rate (B)';
        document.getElementById('ab-s2')!.textContent = (p2 * 100).toFixed(2) + '%';
        document.getElementById('ab-s3l')!.textContent = 'MDE (relative)';
        document.getElementById('ab-s3')!.textContent = (mde * 100).toFixed(1) + '%';
        document.getElementById('ab-s4l')!.textContent = 'Days Needed';
        document.getElementById('ab-s4')!.textContent = daysNeeded + ' days';

        // MDE sensitivity table
        const mdes = [2, 5, 10, 15, 20, 25, 30, 50];
        let html = '';
        for (const m of mdes) {
          const mp = m / 100;
          const tp2 = baseline * (1 + mp);
          const tn = Math.pow(zAlpha + zBeta, 2) * (p1 * (1 - p1) + tp2 * (1 - tp2)) / Math.pow(tp2 - p1, 2);
          const ts = Math.ceil(tn);
          const td = Math.ceil(ts / daily);
          const marker = Math.abs(m - mde * 100) < 0.5 ? ' font-bold text-primary' : '';
          html += '<div class="flex justify-between py-0.5 border-b border-border' + marker + '"><span>MDE ' + m + '%</span><span>' + ts.toLocaleString() + '/variant | ' + td + ' days</span></div>';
        }
        document.getElementById('ab-tableh')!.textContent = 'Sample Size by MDE';
        document.getElementById('ab-details')!.innerHTML = html;
      }

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.ab-mode').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.ab-mode').forEach(b => { b.classList.remove('bg-primary', 'text-white'); b.classList.add('bg-surface-alt', 'text-text-secondary'); });
          btn.classList.remove('bg-surface-alt', 'text-text-secondary'); btn.classList.add('bg-primary', 'text-white');
          abMode = (btn as HTMLElement).dataset.mode || 'results';
          document.getElementById('ab-results-section')!.classList.toggle('hidden', abMode !== 'results');
          document.getElementById('ab-plan-section')!.classList.toggle('hidden', abMode !== 'plan');
          calcAB();
        });
      });
      document.querySelectorAll('.ab-in').forEach(el => { el.addEventListener('input', calcAB); el.addEventListener('change', calcAB); });
      calcAB();
    }, 50);
  </script>
</CalculatorLayout>
