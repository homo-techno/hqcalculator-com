---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Bathroom Vent Calculator - CFM, Duct Size & Fan Rating";
const description = "Calculate the exhaust fan CFM needed for your bathroom size, determine duct diameter, noise sone rating, and HVI ventilation recommendations.";
const relatedCalcs = [
  { name: "HVAC", url: "/hvac-calculator", description: "HVAC sizing." },
  { name: "BTU", url: "/btu-calculator", description: "BTU requirements." },
  { name: "Square Footage", url: "/square-footage-calculator", description: "Area calculation." },
  { name: "Electricity Cost", url: "/electricity-cost-calculator", description: "Energy costs." },
  { name: "Lighting", url: "/lighting-calculator", description: "Lighting design." },
  { name: "Insulation", url: "/insulation-calculator", description: "Insulation R-value." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Bathroom Vent Calculator" keywords="bathroom vent calculator, exhaust fan CFM, bathroom fan size, duct diameter, sone rating, HVI ventilation" breadcrumbs={[{ name: "Bathroom Vent", url: "/bathroom-vent-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Bathroom Vent Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Determine the right exhaust fan CFM and duct size for your bathroom per HVI/ASHRAE standards.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Length (feet)</label>
            <input type="number" id="bv-len" class="bv-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="10" min="3" step="0.5">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Width (feet)</label>
            <input type="number" id="bv-wid" class="bv-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="8" min="3" step="0.5">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Ceiling Height (ft)</label>
            <input type="number" id="bv-ht" class="bv-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="8" min="7" step="0.5">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Bathroom Type</label>
            <select id="bv-type" class="bv-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
              <option value="half">Half Bath (toilet + sink)</option>
              <option value="full" selected>Full Bath (tub/shower)</option>
              <option value="master">Master Bath (tub + shower)</option>
              <option value="spa">Spa Bath (steam/jetted tub)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Duct Run Length (feet)</label>
            <input type="number" id="bv-duct" class="bv-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="10" min="1" step="1">
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Number of 90-degree Elbows</label>
          <input type="number" id="bv-elbow" class="bv-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="2" min="0" step="1">
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Recommended Fan CFM</div>
          <div class="text-5xl font-extrabold font-mono" id="bv-result">0 CFM</div>
          <div class="text-sm text-blue-200 mt-1" id="bv-note">-</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Bathroom Area</div>
            <div class="text-xl font-bold font-mono" id="bv-area">0 ftÂ²</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Min Duct Size</div>
            <div class="text-xl font-bold font-mono" id="bv-ductsize">0"</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Max Sones</div>
            <div class="text-xl font-bold font-mono" id="bv-sones">-</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Air Changes/Hr</div>
            <div class="text-xl font-bold font-mono" id="bv-ach">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Effective Duct Length</div>
            <div class="text-xl font-bold font-mono" id="bv-effduct">0 ft</div>
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Installation Notes</h3>
          <div class="text-sm" id="bv-notes">-</div>
        </div>
      </div>
      <ShareButton calculatorId="bathroom-vent" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcBV() {
      const len = parseFloat((document.getElementById('bv-len') as HTMLInputElement).value) || 10;
      const wid = parseFloat((document.getElementById('bv-wid') as HTMLInputElement).value) || 8;
      const ht = parseFloat((document.getElementById('bv-ht') as HTMLInputElement).value) || 8;
      const bathType = (document.getElementById('bv-type') as HTMLSelectElement).value;
      const ductRun = parseFloat((document.getElementById('bv-duct') as HTMLInputElement).value) || 10;
      const elbows = parseInt((document.getElementById('bv-elbow') as HTMLInputElement).value) || 0;

      const area = len * wid;
      const volume = area * ht;

      // HVI/ASHRAE 62.2: minimum 1 CFM per sq ft for bathrooms up to 100 sq ft
      // For larger bathrooms, calculate by fixture count
      let baseCFM: number;
      if (area <= 100) {
        baseCFM = Math.max(50, area); // Minimum 50 CFM per code
      } else {
        // Fixture method for large bathrooms
        let fixtureCFM = 0;
        if (bathType === 'half') fixtureCFM = 50;
        else if (bathType === 'full') fixtureCFM = 50 + 50; // toilet + shower
        else if (bathType === 'master') fixtureCFM = 50 + 50 + 50; // toilet + shower + tub
        else fixtureCFM = 50 + 50 + 50 + 50; // spa: additional for steam
        baseCFM = Math.max(fixtureCFM, area);
      }

      // Add CFM for long duct runs (friction loss)
      // Each elbow = ~10 ft equivalent length
      const effectiveDuct = ductRun + elbows * 10;
      let ductFactor = 1.0;
      if (effectiveDuct > 15) ductFactor = 1.1;
      if (effectiveDuct > 25) ductFactor = 1.2;
      if (effectiveDuct > 40) ductFactor = 1.3;

      const recCFM = Math.ceil(baseCFM * ductFactor / 10) * 10;

      // Duct size recommendation
      let ductSize: string;
      if (recCFM <= 50) ductSize = '4"';
      else if (recCFM <= 80) ductSize = '4"';
      else if (recCFM <= 110) ductSize = '5"';
      else if (recCFM <= 150) ductSize = '6"';
      else ductSize = '6" or dual 4"';

      // Sone recommendation
      let sones: string;
      if (bathType === 'spa' || bathType === 'master') sones = '0.3-1.0';
      else sones = '1.0-2.0';

      // Air changes per hour
      const achVal = volume > 0 ? (recCFM * 60) / volume : 0;

      document.getElementById('bv-result')!.textContent = recCFM + ' CFM';
      document.getElementById('bv-note')!.textContent = area + ' sq ft ' + bathType + ' bathroom';
      document.getElementById('bv-area')!.textContent = area + ' ft\u00B2';
      document.getElementById('bv-ductsize')!.textContent = ductSize;
      document.getElementById('bv-sones')!.textContent = sones;
      document.getElementById('bv-ach')!.textContent = achVal.toFixed(1);
      document.getElementById('bv-effduct')!.textContent = effectiveDuct + ' ft';

      let notes = 'Vent must exhaust to outdoors (not attic). Use rigid or semi-rigid duct for best airflow. ';
      if (effectiveDuct > 25) notes += 'Long duct run - consider inline booster fan. ';
      if (bathType === 'spa') notes += 'Steam/spa baths need continuous ventilation and moisture-rated fan. ';
      notes += 'Timer or humidity sensor switch recommended for automatic operation.';
      document.getElementById('bv-notes')!.textContent = notes;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.bv-in').forEach(el => {
        el.addEventListener('input', calcBV);
        el.addEventListener('change', calcBV);
      });
      calcBV();
    }, 50);
  </script>
</CalculatorLayout>
