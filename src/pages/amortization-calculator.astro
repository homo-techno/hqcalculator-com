---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Amortization Calculator - Loan Amortization Schedule";
const description = "Generate a complete amortization schedule for any loan. See monthly payments, principal vs interest breakdown, and payoff timeline.";

const relatedCalcs = [
  { name: "Mortgage Calculator", url: "/mortgage-calculator", description: "Home loans." },
  { name: "Loan Calculator", url: "/loan-calculator", description: "Loan payments." },
  { name: "Auto Loan Calculator", url: "/auto-loan-calculator", description: "Car loans." },
  { name: "Debt Payoff Calculator", url: "/debt-payoff-calculator", description: "Debt strategies." },
  { name: "Compound Interest", url: "/compound-interest-calculator", description: "Compound growth." },
  { name: "Savings Calculator", url: "/savings-calculator", description: "Savings growth." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Amortization Calculator"
  keywords="amortization calculator, amortization schedule, loan amortization, mortgage amortization, payment schedule, principal interest"
  breadcrumbs={[{ name: "Amortization Calculator", url: "/amortization-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Amortization Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Generate a complete amortization schedule and see how extra payments save interest.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <div class="mb-5">
            <label class="block text-sm font-medium text-text mb-1">Loan Amount</label>
            <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span><input type="number" id="am-amount" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-2xl font-bold" value="250000" min="0" step="1000"></div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-5">
            <div>
              <label class="block text-sm font-medium text-text mb-1">Interest Rate</label>
              <div class="flex gap-1"><input type="number" id="am-rate" class="flex-1 px-4 py-3 border border-border rounded-xl text-lg" value="6.5" min="0" max="30" step="0.125"><span class="self-center text-text-muted font-bold">%</span></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-text mb-1">Loan Term</label>
              <div class="flex gap-1"><input type="number" id="am-term" class="flex-1 px-4 py-3 border border-border rounded-xl text-lg" value="30" min="1" max="50"><span class="self-center text-text-muted font-bold">yrs</span></div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-5">
            <div>
              <label class="block text-sm font-medium text-text mb-1">Extra Monthly Payment</label>
              <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-text-muted font-bold">$</span><input type="number" id="am-extra" class="w-full pl-8 pr-4 py-3 border border-border rounded-xl text-lg" value="0" min="0" step="50"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-text mb-1">Start Date</label>
              <input type="month" id="am-start" class="w-full px-4 py-3 border border-border rounded-xl text-lg" value="2026-03">
            </div>
          </div>

          <div class="flex gap-2 flex-wrap">
            <button class="am-term-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-term="10">10yr</button>
            <button class="am-term-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-term="15">15yr</button>
            <button class="am-term-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-term="20">20yr</button>
            <button class="am-term-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-term="30">30yr</button>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Monthly Payment</div>
            <div class="text-4xl sm:text-5xl font-extrabold" id="am-payment">$0</div>
            <div class="text-sm text-blue-200 mt-1" id="am-with-extra"></div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Interest</div>
              <div class="text-xl font-bold text-danger" id="am-total-int">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Paid</div>
              <div class="text-xl font-bold" id="am-total-paid">$0</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Payoff Date</div>
              <div class="text-xl font-bold" id="am-payoff">—</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Interest Saved</div>
              <div class="text-xl font-bold text-secondary" id="am-saved">$0</div>
            </div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="amortization" />
      <FeedbackWidget />
    </div>

    <!-- Amortization Schedule -->
    <div class="mt-12 bg-white border border-border rounded-2xl p-6 sm:p-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-text">Amortization Schedule</h2>
        <div class="flex gap-2">
          <button class="am-view-btn px-3 py-1 text-xs rounded-full border border-primary bg-blue-50 text-primary font-semibold" data-view="yearly">Yearly</button>
          <button class="am-view-btn px-3 py-1 text-xs rounded-full border border-border font-semibold" data-view="monthly">Monthly</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-border text-left">
              <th class="py-2 pr-3 font-semibold" id="am-col-period">Year</th>
              <th class="py-2 pr-3 font-semibold text-right">Payment</th>
              <th class="py-2 pr-3 font-semibold text-right">Principal</th>
              <th class="py-2 pr-3 font-semibold text-right">Interest</th>
              <th class="py-2 font-semibold text-right">Balance</th>
            </tr>
          </thead>
          <tbody id="am-tbody"></tbody>
        </table>
      </div>
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How Amortization Works</h2>
      <p>With an amortizing loan, each payment is split between interest and principal. Early payments are mostly interest; later payments are mostly principal. This schedule shows exactly how each payment is divided.</p>

      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono">M = P × [r(1+r)ⁿ] / [(1+r)ⁿ − 1]</div>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>Why does so much go to interest early on?</strong> Interest is charged on the remaining balance. Since the balance is highest at the start, more of each early payment goes to interest.</p>
      <p><strong>How much does extra payment save?</strong> Even $100/month extra on a $250K mortgage at 6.5% saves over $65,000 in interest and pays off 5+ years early.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    let amView = 'yearly';
    const fmt = (n: number) => '$' + Math.round(n).toLocaleString('en-US');

    function calcAmort() {
      const P = parseFloat((document.getElementById('am-amount') as HTMLInputElement).value) || 0;
      const annualRate = (parseFloat((document.getElementById('am-rate') as HTMLInputElement).value) || 0) / 100;
      const termYears = parseInt((document.getElementById('am-term') as HTMLInputElement).value) || 30;
      const extra = parseFloat((document.getElementById('am-extra') as HTMLInputElement).value) || 0;
      const startStr = (document.getElementById('am-start') as HTMLInputElement).value;
      const startDate = startStr ? new Date(startStr + '-01') : new Date();

      const r = annualRate / 12;
      const n = termYears * 12;
      const monthlyPayment = r > 0 ? P * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1) : P / n;

      // Generate schedule
      let balance = P;
      let totalInterest = 0;
      let totalPaid = 0;
      let actualMonths = 0;

      type Row = { period: string; payment: number; principal: number; interest: number; balance: number };
      const monthly: Row[] = [];
      const yearly: Row[] = [];
      let yearPayment = 0, yearPrincipal = 0, yearInterest = 0;

      for (let m = 1; m <= n && balance > 0.01; m++) {
        const interest = balance * r;
        let principal = Math.min(balance, monthlyPayment - interest + extra);
        const payment = interest + principal;
        balance = Math.max(0, balance - principal);
        totalInterest += interest;
        totalPaid += payment;
        actualMonths = m;

        const date = new Date(startDate.getFullYear(), startDate.getMonth() + m);
        monthly.push({
          period: `${date.toLocaleString('en-US', { month: 'short' })} ${date.getFullYear()}`,
          payment, principal, interest, balance
        });

        yearPayment += payment;
        yearPrincipal += principal;
        yearInterest += interest;

        if (m % 12 === 0 || balance <= 0.01) {
          yearly.push({
            period: `Year ${Math.ceil(m / 12)}`,
            payment: yearPayment, principal: yearPrincipal, interest: yearInterest, balance
          });
          yearPayment = 0; yearPrincipal = 0; yearInterest = 0;
        }
      }

      // Compare with no extra
      let baseInterest = 0;
      let baseBal = P;
      for (let m = 1; m <= n && baseBal > 0.01; m++) {
        const interest = baseBal * r;
        baseBal -= (monthlyPayment - interest);
        baseInterest += interest;
      }
      const saved = baseInterest - totalInterest;

      const payoffDate = new Date(startDate.getFullYear(), startDate.getMonth() + actualMonths);

      document.getElementById('am-payment')!.textContent = fmt(monthlyPayment);
      document.getElementById('am-with-extra')!.textContent = extra > 0 ? `(${fmt(monthlyPayment + extra)} with extra)` : '';
      document.getElementById('am-total-int')!.textContent = fmt(totalInterest);
      document.getElementById('am-total-paid')!.textContent = fmt(totalPaid);
      document.getElementById('am-payoff')!.textContent = `${payoffDate.toLocaleString('en-US', { month: 'short' })} ${payoffDate.getFullYear()}`;
      document.getElementById('am-saved')!.textContent = fmt(saved);

      // Table
      const rows = amView === 'yearly' ? yearly : monthly;
      document.getElementById('am-col-period')!.textContent = amView === 'yearly' ? 'Year' : 'Month';
      document.getElementById('am-tbody')!.innerHTML = rows.map(row =>
        `<tr class="border-b border-border/30 hover:bg-surface-alt/50">
          <td class="py-2 pr-3 text-text-secondary">${row.period}</td>
          <td class="py-2 pr-3 text-right">${fmt(row.payment)}</td>
          <td class="py-2 pr-3 text-right text-primary">${fmt(row.principal)}</td>
          <td class="py-2 pr-3 text-right text-danger">${fmt(row.interest)}</td>
          <td class="py-2 text-right font-medium">${fmt(row.balance)}</td>
        </tr>`
      ).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.am-term-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          (document.getElementById('am-term') as HTMLInputElement).value = (btn as HTMLElement).dataset.term || '30';
          calcAmort();
        });
      });

      document.querySelectorAll('.am-view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.am-view-btn').forEach(b => { b.classList.remove('border-primary', 'bg-blue-50', 'text-primary'); b.classList.add('border-border'); });
          btn.classList.remove('border-border'); btn.classList.add('border-primary', 'bg-blue-50', 'text-primary');
          amView = (btn as HTMLElement).dataset.view || 'yearly';
          calcAmort();
        });
      });

      ['am-amount', 'am-rate', 'am-term', 'am-extra'].forEach(id => document.getElementById(id)!.addEventListener('input', calcAmort));
      document.getElementById('am-start')!.addEventListener('change', calcAmort);

      calcAmort();
    }, 50);
  </script>
</CalculatorLayout>
