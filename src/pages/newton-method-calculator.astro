---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Newton's Method Calculator - Root Finder";
const description = "Find roots of f(x) = ax² + bx + c using Newton's method. Shows convergence steps and iteration history.";

const relatedCalcs = [
  { name: "Trapezoidal Rule", url: "/trapezoidal-rule-calculator", description: "Numerical integration." },
  { name: "Interpolation Calculator", url: "/interpolation-calculator", description: "Linear interpolation." },
  { name: "Scientific Calculator", url: "/scientific-calculator", description: "Advanced math operations." },
  { name: "Regression Calculator", url: "/regression-calculator", description: "Linear regression." },
  { name: "Average Calculator", url: "/average-calculator", description: "Mean, median, mode." },
  { name: "Number Sequence", url: "/number-sequence-calculator", description: "Sequence pattern detection." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Newton's Method Calculator"
  keywords="newton method calculator, root finder, newton raphson, iterative method, convergence, polynomial roots"
  breadcrumbs={[{ name: "Newton's Method Calculator", url: "/newton-method-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Newton's Method Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Find roots of a quadratic function using Newton-Raphson iteration with step-by-step convergence.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="p-3 bg-surface-alt rounded-xl text-center font-mono text-lg">
          f(x) = <span id="nm-eq">ax&sup2; + bx + c</span>
        </div>

        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">a (x&sup2; coefficient)</label>
            <input type="number" id="nm-a" class="nm-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="1" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">b (x coefficient)</label>
            <input type="number" id="nm-b" class="nm-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="-3" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">c (constant)</label>
            <input type="number" id="nm-c" class="nm-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="2" step="any" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-text mb-1">Initial Guess (x<sub>0</sub>)</label>
            <input type="number" id="nm-x0" class="nm-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="0" step="any" />
          </div>
          <div>
            <label class="block text-sm font-medium text-text mb-1">Max Iterations</label>
            <input type="number" id="nm-iter" class="nm-in w-full px-4 py-2 border border-border rounded-xl text-lg" value="20" min="1" max="100" />
          </div>
        </div>

        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Root Found</div>
          <div class="text-5xl font-extrabold font-mono" id="nm-result">0</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Iterations Used</div>
            <div class="text-xl font-bold" id="nm-iters">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">f(root)</div>
            <div class="text-xl font-bold" id="nm-froot">0</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Converged?</div>
            <div class="text-xl font-bold" id="nm-converged">—</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Exact Roots (Quadratic)</div>
            <div class="text-lg font-bold" id="nm-exact">—</div>
          </div>
        </div>

        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Iteration Steps</h3>
          <div class="text-sm text-text-secondary font-mono whitespace-pre-wrap overflow-auto max-h-64" id="nm-steps"></div>
        </div>
      </div>

      <ShareButton calculatorId="newton-method" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">Newton-Raphson Method</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm">
        <p>x<sub>n+1</sub> = x<sub>n</sub> - f(x<sub>n</sub>) / f'(x<sub>n</sub>)</p>
        <p>For f(x) = ax&sup2; + bx + c: f'(x) = 2ax + b</p>
      </div>
      <h3 class="text-xl font-semibold text-text mt-8">Convergence</h3>
      <ul>
        <li>Newton's method converges quadratically near a root</li>
        <li>May fail if f'(x) = 0 at an iteration point</li>
        <li>Choice of initial guess affects which root is found</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function calcNM() {
      const a = parseFloat((document.getElementById('nm-a') as HTMLInputElement).value) || 0;
      const b = parseFloat((document.getElementById('nm-b') as HTMLInputElement).value) || 0;
      const c = parseFloat((document.getElementById('nm-c') as HTMLInputElement).value) || 0;
      let x = parseFloat((document.getElementById('nm-x0') as HTMLInputElement).value) || 0;
      const maxIter = parseInt((document.getElementById('nm-iter') as HTMLInputElement).value) || 20;
      const fmt = (v: number) => Number.isInteger(v) ? String(v) : v.toFixed(8);

      const f = (x: number) => a * x * x + b * x + c;
      const fp = (x: number) => 2 * a * x + b;

      // Update equation display
      document.getElementById('nm-eq')!.textContent = `f(x) = ${a}x² + ${b >= 0 ? '+' : ''}${b}x + ${c >= 0 ? '+' : ''}${c}`;

      // Exact roots via quadratic formula
      const disc = b * b - 4 * a * c;
      let exactStr = '';
      if (a === 0) {
        if (b !== 0) exactStr = `x = ${fmt(-c / b)} (linear)`;
        else exactStr = c === 0 ? 'All x (trivial)' : 'No roots';
      } else if (disc > 0) {
        const r1 = (-b + Math.sqrt(disc)) / (2 * a);
        const r2 = (-b - Math.sqrt(disc)) / (2 * a);
        exactStr = `x = ${fmt(r1)}, ${fmt(r2)}`;
      } else if (disc === 0) {
        exactStr = `x = ${fmt(-b / (2 * a))} (double root)`;
      } else {
        const real = -b / (2 * a);
        const imag = Math.sqrt(-disc) / (2 * a);
        exactStr = `${fmt(real)} ± ${fmt(Math.abs(imag))}i (complex)`;
      }
      document.getElementById('nm-exact')!.textContent = exactStr;

      // Newton iteration
      let steps = 'n  |  x_n             |  f(x_n)          |  f\'(x_n)\n';
      steps += '-'.repeat(62) + '\n';

      let converged = false;
      let iterUsed = 0;
      const tol = 1e-12;

      for (let i = 0; i <= maxIter; i++) {
        const fx = f(x);
        const fpx = fp(x);
        steps += `${String(i).padStart(2)} | ${fmt(x).padStart(16)} | ${fmt(fx).padStart(16)} | ${fmt(fpx)}\n`;

        if (Math.abs(fx) < tol) {
          converged = true;
          iterUsed = i;
          break;
        }

        if (Math.abs(fpx) < 1e-15) {
          steps += `\n** f\'(x) ≈ 0 — derivative too small, method fails at this point.`;
          iterUsed = i;
          break;
        }

        const xNew = x - fx / fpx;
        if (Math.abs(xNew - x) < tol) {
          converged = true;
          x = xNew;
          iterUsed = i + 1;
          steps += `${String(i + 1).padStart(2)} | ${fmt(xNew).padStart(16)} | ${fmt(f(xNew)).padStart(16)} | ${fmt(fp(xNew))}\n`;
          break;
        }

        x = xNew;
        iterUsed = i + 1;
      }

      document.getElementById('nm-result')!.textContent = fmt(x);
      document.getElementById('nm-iters')!.textContent = String(iterUsed);
      document.getElementById('nm-froot')!.textContent = fmt(f(x));
      document.getElementById('nm-converged')!.textContent = converged ? 'Yes' : 'No (max iterations)';
      document.getElementById('nm-steps')!.textContent = steps;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.nm-in').forEach(el => {
        el.addEventListener('input', calcNM);
        el.addEventListener('change', calcNM);
      });
      calcNM();
    }, 50);
  </script>
</CalculatorLayout>
