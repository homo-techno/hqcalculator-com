---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Coral Reef Calculator - Reef Health Index & Bleaching Threshold";
const description = "Calculate reef health index from coral cover, diversity, algae levels, and fish biomass. Assess bleaching threshold and conservation status.";
const relatedCalcs = [
  { name: "Water Quality", url: "/water-quality-calculator", description: "Water quality analysis." },
  { name: "Biodiversity Index", url: "/biodiversity-index-calculator", description: "Biodiversity metrics." },
  { name: "Aquarium", url: "/aquarium-calculator", description: "Aquarium calculations." },
  { name: "Aquaponics", url: "/aquaponics-calculator", description: "Aquaponics system design." },
  { name: "Buoyancy", url: "/buoyancy-calculator", description: "Buoyancy force calculations." },
  { name: "Dive Planning", url: "/dive-planning-calculator", description: "Dive planning tools." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Coral Reef Calculator" keywords="coral reef calculator, reef health index, coral cover, bleaching threshold, reef diversity, algae cover, fish biomass, reef conservation" breadcrumbs={[{ name: "Coral Reef", url: "/coral-reef-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Coral Reef Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Assess coral reef health using key ecological indicators including coral cover, species diversity, algae levels, and fish biomass.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Live Coral Cover (%)</label><input type="number" id="co-coral" class="co-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" min="0" max="100" step="1"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Macroalgae Cover (%)</label><input type="number" id="co-algae" class="co-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" min="0" max="100" step="1"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Species Richness (# species)</label><input type="number" id="co-species" class="co-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" min="0" step="1"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Fish Biomass (g/m2)</label><input type="number" id="co-fish" class="co-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" min="0" step="5"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Water Temp (C)</label><input type="number" id="co-temp" class="co-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" min="15" max="38" step="0.5"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Max Monthly Mean Temp (C)</label><input type="number" id="co-mmm" class="co-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" min="20" max="32" step="0.5"></div>
        </div>
        <div><label class="block text-xs font-medium text-text mb-1">Herbivore Density (fish/100m2)</label><input type="number" id="co-herb" class="co-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" min="0" step="5"></div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Reef Health Index</div>
          <div class="text-5xl font-extrabold font-mono" id="co-rhi">--</div>
          <div class="text-sm text-blue-200 mt-1" id="co-grade">--</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Coral Score</div><div class="text-xl font-bold" id="co-cscore">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Algae Score</div><div class="text-xl font-bold" id="co-ascore">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Fish Score</div><div class="text-xl font-bold" id="co-fscore">--</div></div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Bleaching Risk</div><div class="text-xl font-bold" id="co-bleach">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">DHW</div><div class="text-xl font-bold" id="co-dhw">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Resilience</div><div class="text-xl font-bold" id="co-resil">--</div></div>
        </div>
      </div>
      <ShareButton calculatorId="coral-reef" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcCO() {
      const coralCover = parseFloat((document.getElementById('co-coral') as HTMLInputElement).value) || 0;
      const algaeCover = parseFloat((document.getElementById('co-algae') as HTMLInputElement).value) || 0;
      const species = parseFloat((document.getElementById('co-species') as HTMLInputElement).value) || 0;
      const fishBiomass = parseFloat((document.getElementById('co-fish') as HTMLInputElement).value) || 0;
      const waterTemp = parseFloat((document.getElementById('co-temp') as HTMLInputElement).value) || 27;
      const mmm = parseFloat((document.getElementById('co-mmm') as HTMLInputElement).value) || 28;
      const herbivore = parseFloat((document.getElementById('co-herb') as HTMLInputElement).value) || 0;

      // Coral cover score (1-5): >40%=5, 20-40%=4, 10-20%=3, 5-10%=2, <5%=1
      let coralScore: number;
      if (coralCover >= 40) coralScore = 5;
      else if (coralCover >= 20) coralScore = 4;
      else if (coralCover >= 10) coralScore = 3;
      else if (coralCover >= 5) coralScore = 2;
      else coralScore = 1;

      // Algae score (1-5): <5%=5, 5-12%=4, 12-25%=3, 25-50%=2, >50%=1
      let algaeScore: number;
      if (algaeCover <= 5) algaeScore = 5;
      else if (algaeCover <= 12) algaeScore = 4;
      else if (algaeCover <= 25) algaeScore = 3;
      else if (algaeCover <= 50) algaeScore = 2;
      else algaeScore = 1;

      // Fish biomass score (1-5): >60=5, 40-60=4, 20-40=3, 10-20=2, <10=1
      let fishScore: number;
      if (fishBiomass >= 60) fishScore = 5;
      else if (fishBiomass >= 40) fishScore = 4;
      else if (fishBiomass >= 20) fishScore = 3;
      else if (fishBiomass >= 10) fishScore = 2;
      else fishScore = 1;

      // Reef Health Index: weighted average
      const rhi = (coralScore * 0.35 + algaeScore * 0.25 + fishScore * 0.40);

      let grade = '';
      if (rhi >= 4.5) grade = 'Very Good';
      else if (rhi >= 3.5) grade = 'Good';
      else if (rhi >= 2.5) grade = 'Fair';
      else if (rhi >= 1.5) grade = 'Poor';
      else grade = 'Critical';

      // Bleaching: Degree Heating Weeks (DHW) proxy
      const tempAnomaly = Math.max(0, waterTemp - mmm);
      const dhw = tempAnomaly * 4; // simplified: 4 weeks exposure
      let bleachRisk = 'Low';
      if (dhw >= 8) bleachRisk = 'Severe';
      else if (dhw >= 4) bleachRisk = 'High';
      else if (dhw >= 1) bleachRisk = 'Moderate';

      // Resilience score
      const resilience = herbivore >= 30 && coralCover >= 20 && species >= 20 ? 'High'
        : herbivore >= 15 && coralCover >= 10 ? 'Moderate' : 'Low';

      document.getElementById('co-rhi')!.textContent = rhi.toFixed(1);
      document.getElementById('co-grade')!.textContent = grade;
      document.getElementById('co-cscore')!.textContent = coralScore + '/5';
      document.getElementById('co-ascore')!.textContent = algaeScore + '/5';
      document.getElementById('co-fscore')!.textContent = fishScore + '/5';
      document.getElementById('co-bleach')!.textContent = bleachRisk;
      document.getElementById('co-dhw')!.textContent = dhw.toFixed(1) + ' C-wks';
      document.getElementById('co-resil')!.textContent = resilience;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      (document.getElementById('co-coral') as HTMLInputElement).value = '25';
      (document.getElementById('co-algae') as HTMLInputElement).value = '15';
      (document.getElementById('co-species') as HTMLInputElement).value = '30';
      (document.getElementById('co-fish') as HTMLInputElement).value = '35';
      (document.getElementById('co-temp') as HTMLInputElement).value = '28';
      (document.getElementById('co-mmm') as HTMLInputElement).value = '28.5';
      (document.getElementById('co-herb') as HTMLInputElement).value = '20';
      document.querySelectorAll('.co-in').forEach(el => { el.addEventListener('input', calcCO); el.addEventListener('change', calcCO); });
      calcCO();
    }, 50);
  </script>
</CalculatorLayout>
