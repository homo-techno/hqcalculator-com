---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Electrical Panel Calculator - Load & Capacity Planning";
const description = "Calculate total panel load, available capacity, used spaces, and determine if a panel upgrade is needed for your home electrical system.";
const relatedCalcs = [
  { name: "Electrical Load", url: "/electrical-load-calculator", description: "Load calculation." },
  { name: "Wire Gauge", url: "/wire-gauge-calculator", description: "Wire sizing." },
  { name: "Electricity Bill", url: "/electricity-bill-calculator", description: "Bill estimates." },
  { name: "HVAC", url: "/hvac-calculator", description: "HVAC sizing." },
  { name: "Ohm's Law", url: "/ohms-law-calculator", description: "Voltage, current, resistance." },
  { name: "Solar Panel", url: "/solar-panel-calculator", description: "Solar sizing." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Electrical Panel Calculator" keywords="electrical panel calculator, panel load, breaker spaces, panel upgrade, service size, amps" breadcrumbs={[{ name: "Electrical Panel", url: "/electrical-panel-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Electrical Panel Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate total panel load, available spaces, and whether you need a panel upgrade.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Panel Size (Amps)</label>
            <select id="ep2-panel" class="ep2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
              <option value="100">100A</option>
              <option value="125">125A</option>
              <option value="150">150A</option>
              <option value="200" selected>200A</option>
              <option value="400">400A</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Panel Voltage</label>
            <select id="ep2-volt" class="ep2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
              <option value="240" selected>240V (Residential)</option>
              <option value="208">208V (Commercial)</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-text mb-1">Total Panel Spaces</label>
            <input type="number" id="ep2-spaces" class="ep2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="40" min="4" step="2">
          </div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Used Spaces</label>
            <input type="number" id="ep2-used" class="ep2-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="28" min="0" step="1">
          </div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl">
          <h3 class="font-semibold text-sm text-text mb-2">Connected Loads (Watts)</h3>
          <div class="grid grid-cols-2 gap-2">
            <div><label class="block text-xs text-text-muted">General Lighting/Receptacles</label><input type="number" id="ep2-gen" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="3000" step="100"></div>
            <div><label class="block text-xs text-text-muted">Kitchen Circuits</label><input type="number" id="ep2-kit" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="6000" step="100"></div>
            <div><label class="block text-xs text-text-muted">Laundry Circuit</label><input type="number" id="ep2-laun" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="1500" step="100"></div>
            <div><label class="block text-xs text-text-muted">Range/Oven</label><input type="number" id="ep2-range" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="8000" step="100"></div>
            <div><label class="block text-xs text-text-muted">HVAC/Heating</label><input type="number" id="ep2-hvac" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="5000" step="100"></div>
            <div><label class="block text-xs text-text-muted">Water Heater</label><input type="number" id="ep2-wh" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="4500" step="100"></div>
            <div><label class="block text-xs text-text-muted">Dryer</label><input type="number" id="ep2-dryer" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="5000" step="100"></div>
            <div><label class="block text-xs text-text-muted">EV Charger</label><input type="number" id="ep2-ev" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="7200" step="100"></div>
            <div><label class="block text-xs text-text-muted">Other Loads</label><input type="number" id="ep2-other" class="ep2-in w-full px-2 py-2 border border-border rounded-xl text-lg font-bold text-center" value="2000" step="100"></div>
          </div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Calculated Demand Load</div>
          <div class="text-5xl font-extrabold font-mono" id="ep2-result">0 A</div>
          <div class="text-sm text-blue-200 mt-1" id="ep2-note">-</div>
        </div>
        <div class="p-4 rounded-xl text-center" id="ep2-status-box">
          <div class="font-bold text-sm" id="ep2-status">-</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Connected</div>
            <div class="text-xl font-bold font-mono" id="ep2-total">0 W</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Available Amps</div>
            <div class="text-xl font-bold font-mono" id="ep2-avail">0 A</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Open Spaces</div>
            <div class="text-xl font-bold font-mono" id="ep2-open">0</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Panel Utilization</div>
            <div class="text-xl font-bold font-mono" id="ep2-util">0%</div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Recommended Panel</div>
            <div class="text-xl font-bold font-mono" id="ep2-rec">-</div>
          </div>
        </div>
      </div>
      <ShareButton calculatorId="electrical-panel" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcEP2() {
      const panelAmps = parseFloat((document.getElementById('ep2-panel') as HTMLSelectElement).value);
      const volt = parseFloat((document.getElementById('ep2-volt') as HTMLSelectElement).value);
      const totalSpaces = parseInt((document.getElementById('ep2-spaces') as HTMLInputElement).value) || 40;
      const usedSpaces = parseInt((document.getElementById('ep2-used') as HTMLInputElement).value) || 0;

      const gen = parseFloat((document.getElementById('ep2-gen') as HTMLInputElement).value) || 0;
      const kit = parseFloat((document.getElementById('ep2-kit') as HTMLInputElement).value) || 0;
      const laun = parseFloat((document.getElementById('ep2-laun') as HTMLInputElement).value) || 0;
      const range = parseFloat((document.getElementById('ep2-range') as HTMLInputElement).value) || 0;
      const hvac = parseFloat((document.getElementById('ep2-hvac') as HTMLInputElement).value) || 0;
      const wh = parseFloat((document.getElementById('ep2-wh') as HTMLInputElement).value) || 0;
      const dryer = parseFloat((document.getElementById('ep2-dryer') as HTMLInputElement).value) || 0;
      const ev = parseFloat((document.getElementById('ep2-ev') as HTMLInputElement).value) || 0;
      const other = parseFloat((document.getElementById('ep2-other') as HTMLInputElement).value) || 0;

      const totalConnected = gen + kit + laun + range + hvac + wh + dryer + ev + other;

      // NEC demand calculation (simplified standard method)
      // First 10kW at 100%, remainder at 40%
      const generalLoads = gen + kit + laun;
      let demandW: number;
      if (generalLoads <= 10000) {
        demandW = generalLoads;
      } else {
        demandW = 10000 + (generalLoads - 10000) * 0.4;
      }
      // Add appliance loads (range at 80% if > 12kW otherwise nameplate)
      demandW += range <= 12000 ? range * 0.8 : range * 0.65;
      // Largest of HVAC or heat (not both per NEC)
      demandW += Math.max(hvac, 0);
      demandW += wh + dryer * 0.7 + ev + other;

      const demandAmps = volt > 0 ? demandW / volt : 0;
      const panelCapacity = panelAmps * 0.8;
      const availAmps = Math.max(0, panelCapacity - demandAmps);
      const openSpaces = Math.max(0, totalSpaces - usedSpaces);
      const utilPct = panelAmps > 0 ? (demandAmps / panelAmps) * 100 : 0;

      const panelSizes = [100, 125, 150, 200, 400];
      const recPanel = panelSizes.find(p => p * 0.8 >= demandAmps) || 400;

      document.getElementById('ep2-result')!.textContent = Math.round(demandAmps) + ' A';
      document.getElementById('ep2-total')!.textContent = totalConnected.toLocaleString() + ' W';
      document.getElementById('ep2-avail')!.textContent = availAmps.toFixed(0) + ' A';
      document.getElementById('ep2-open')!.textContent = openSpaces.toString();
      document.getElementById('ep2-util')!.textContent = utilPct.toFixed(0) + '%';
      document.getElementById('ep2-rec')!.textContent = recPanel + 'A';
      document.getElementById('ep2-note')!.textContent = 'Demand: ' + Math.round(demandW).toLocaleString() + 'W at ' + volt + 'V';

      let status: string, color: string;
      if (demandAmps > panelAmps) {
        status = 'Panel overloaded — upgrade to ' + recPanel + 'A panel required';
        color = 'bg-red-50 text-red-800';
      } else if (demandAmps > panelCapacity) {
        status = 'Exceeds 80% capacity — panel upgrade recommended';
        color = 'bg-orange-50 text-orange-800';
      } else if (openSpaces < 4) {
        status = 'Low on spaces — consider sub-panel or tandem breakers';
        color = 'bg-yellow-50 text-yellow-800';
      } else {
        status = 'Panel has adequate capacity and available spaces';
        color = 'bg-green-50 text-green-800';
      }
      document.getElementById('ep2-status')!.textContent = status;
      document.getElementById('ep2-status-box')!.className = 'p-4 rounded-xl text-center ' + color;
      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('.ep2-in').forEach(el => {
        el.addEventListener('input', calcEP2);
        el.addEventListener('change', calcEP2);
      });
      calcEP2();
    }, 50);
  </script>
</CalculatorLayout>
