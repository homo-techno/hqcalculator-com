---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Ovulation Calculator - Fertile Window & Cycle Tracker";
const description = "Calculate your ovulation date and fertile window based on your menstrual cycle. Track your most fertile days for conception planning.";

const relatedCalcs = [
  { name: "Pregnancy Calculator", url: "/pregnancy-calculator", description: "Due date." },
  { name: "Age Calculator", url: "/age-calculator", description: "Exact age." },
  { name: "Date Calculator", url: "/date-calculator", description: "Date math." },
  { name: "BMI Calculator", url: "/bmi-calculator", description: "Body Mass Index." },
  { name: "Calorie Calculator", url: "/calorie-calculator", description: "Daily calories." },
  { name: "Water Intake", url: "/water-intake-calculator", description: "Hydration." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Ovulation Calculator"
  keywords="ovulation calculator, fertile window, fertility calendar, ovulation predictor, conception calculator, menstrual cycle"
  breadcrumbs={[{ name: "Ovulation Calculator", url: "/ovulation-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Ovulation Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Estimate your ovulation date and most fertile days based on your cycle.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-1">First Day of Last Period</label>
        <input type="date" id="ov-lmp" class="w-full px-4 py-3 border border-border rounded-xl text-lg">
      </div>
      <div class="mb-5">
        <label class="block text-sm font-medium text-text mb-1">Average Cycle Length</label>
        <div class="flex gap-2">
          <input type="number" id="ov-cycle" class="flex-1 px-4 py-3 border border-border rounded-xl text-lg" value="28" min="21" max="45">
          <span class="self-center text-text-muted font-semibold">days</span>
        </div>
        <div class="flex gap-2 mt-2">
          <button class="ov-cyc-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-days="25">25</button>
          <button class="ov-cyc-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-days="26">26</button>
          <button class="ov-cyc-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-days="28">28</button>
          <button class="ov-cyc-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-days="30">30</button>
          <button class="ov-cyc-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-days="32">32</button>
          <button class="ov-cyc-btn px-3 py-1 text-xs rounded-full border border-border hover:bg-surface-alt" data-days="35">35</button>
        </div>
      </div>

      <div class="p-6 bg-primary rounded-2xl text-white text-center mb-4">
        <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Estimated Ovulation</div>
        <div class="text-3xl font-extrabold" id="ov-date">—</div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="p-4 bg-green-50 border border-green-200 rounded-xl text-center">
          <div class="text-xs text-green-700 uppercase">Fertile Window</div>
          <div class="text-lg font-bold text-green-800" id="ov-fertile">—</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Next Period</div>
          <div class="text-lg font-bold" id="ov-next">—</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">Most Fertile Days</div>
          <div class="text-lg font-bold text-secondary" id="ov-peak">—</div>
        </div>
        <div class="p-4 bg-surface-alt rounded-xl text-center">
          <div class="text-xs text-text-muted uppercase">If Pregnant, Due Date</div>
          <div class="text-lg font-bold" id="ov-due">—</div>
        </div>
      </div>

      <!-- 3-month forecast -->
      <div class="p-4 bg-surface-alt rounded-xl mb-6">
        <h3 class="font-semibold text-sm text-text mb-3">3-Month Forecast</h3>
        <div class="space-y-3" id="ov-forecast"></div>
      </div>

      <ShareButton calculatorId="ovulation" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate mx-auto">
      <h2 class="text-2xl font-bold text-text">How Ovulation Is Calculated</h2>
      <p>Ovulation typically occurs 14 days before the next period starts. For a 28-day cycle, that's around day 14. The fertile window spans approximately 5 days before ovulation through 1 day after.</p>

      <div class="bg-surface-alt rounded-xl p-4 my-4 text-center font-mono">Ovulation Day = Cycle Length − 14</div>

      <h3 class="text-xl font-semibold text-text mt-8">Signs of Ovulation</h3>
      <ul>
        <li>Slight rise in basal body temperature (0.5-1°F)</li>
        <li>Change in cervical mucus (clear, stretchy, egg-white consistency)</li>
        <li>Mild pelvic pain (mittelschmerz)</li>
        <li>Positive ovulation predictor kit (OPK) test</li>
      </ul>

      <h3 class="text-xl font-semibold text-text mt-8">Frequently Asked Questions</h3>
      <p><strong>How accurate is this calculator?</strong> It provides estimates based on averages. Actual ovulation can vary by several days, especially with irregular cycles. Use with OPK tests for better accuracy.</p>
      <p><strong>How long is the fertile window?</strong> About 6 days: the 5 days before ovulation plus ovulation day itself. Sperm can survive up to 5 days, but the egg only 12-24 hours.</p>
      <p><strong>Can I get pregnant outside the fertile window?</strong> It's very unlikely but possible if your cycle is irregular or ovulation occurs earlier or later than predicted.</p>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    function addDays(date: Date, days: number): Date {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function fmtDate(d: Date): string {
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function fmtShort(d: Date): string {
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function calcOvulation() {
      const lmpInput = (document.getElementById('ov-lmp') as HTMLInputElement).value;
      if (!lmpInput) return;

      const lmp = new Date(lmpInput + 'T00:00:00');
      const cycle = parseInt((document.getElementById('ov-cycle') as HTMLInputElement).value) || 28;

      const ovDay = cycle - 14;
      const ovDate = addDays(lmp, ovDay);
      const fertileStart = addDays(ovDate, -5);
      const fertileEnd = addDays(ovDate, 1);
      const peakStart = addDays(ovDate, -2);
      const peakEnd = ovDate;
      const nextPeriod = addDays(lmp, cycle);
      const dueDate = addDays(lmp, 280); // Naegele's rule

      document.getElementById('ov-date')!.textContent = fmtDate(ovDate);
      document.getElementById('ov-fertile')!.textContent = `${fmtShort(fertileStart)} – ${fmtShort(fertileEnd)}`;
      document.getElementById('ov-next')!.textContent = fmtDate(nextPeriod);
      document.getElementById('ov-peak')!.textContent = `${fmtShort(peakStart)} – ${fmtShort(peakEnd)}`;
      document.getElementById('ov-due')!.textContent = fmtDate(dueDate);

      // 3-month forecast
      const forecast = [];
      for (let i = 0; i < 3; i++) {
        const cycleStart = addDays(lmp, cycle * i);
        const ov = addDays(cycleStart, ovDay);
        const fs = addDays(ov, -5);
        const fe = addDays(ov, 1);
        const np = addDays(cycleStart, cycle);
        forecast.push({ cycleStart, ov, fs, fe, np, num: i + 1 });
      }

      document.getElementById('ov-forecast')!.innerHTML = forecast.map(f =>
        `<div class="flex flex-col sm:flex-row sm:items-center gap-2 py-2 px-3 rounded-lg bg-white/50">
          <span class="font-semibold text-sm w-20">Cycle ${f.num}</span>
          <span class="text-xs text-text-muted">Period: ${fmtShort(f.cycleStart)}</span>
          <span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700">Fertile: ${fmtShort(f.fs)} – ${fmtShort(f.fe)}</span>
          <span class="text-xs font-semibold text-primary">Ovulation: ${fmtShort(f.ov)}</span>
        </div>`
      ).join('');

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      // Set default date to today
      const today = new Date();
      (document.getElementById('ov-lmp') as HTMLInputElement).value = today.toISOString().split('T')[0];

      document.querySelectorAll('.ov-cyc-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          (document.getElementById('ov-cycle') as HTMLInputElement).value = (btn as HTMLElement).dataset.days || '28';
          calcOvulation();
        });
      });

      document.getElementById('ov-lmp')!.addEventListener('change', calcOvulation);
      document.getElementById('ov-cycle')!.addEventListener('input', calcOvulation);

      calcOvulation();
    }, 50);
  </script>
</CalculatorLayout>
