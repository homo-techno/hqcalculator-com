---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Dental Anesthesia Calculator";
const description = "Calculate maximum local anesthetic dose by patient weight, anesthetic type (lidocaine, articaine, mepivacaine), and number of carpules.";
const relatedCalcs = [
  { name: "Root Canal Calculator", url: "/root-canal-calculator", description: "Root canal treatment cost." },
  { name: "Dental Implant Cost Calculator", url: "/dental-implant-cost-calculator", description: "Implant cost estimates." },
  { name: "Dosage Calculator", url: "/dosage-calculator", description: "Medication dosing calculator." },
  { name: "Dental Crown Calculator", url: "/dental-crown-calculator", description: "Crown cost by material." },
  { name: "Body Surface Area Calculator", url: "/body-surface-area-calculator", description: "BSA calculation." },
  { name: "Creatinine Clearance Calculator", url: "/creatinine-clearance-calculator", description: "Kidney function estimate." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Dental Anesthesia Calculator" keywords="dental anesthesia dose, lidocaine max dose, articaine dose, mepivacaine dose, carpule count, local anesthetic calculator" breadcrumbs={[{ name: "Dental Anesthesia", url: "/dental-anesthesia-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Dental Anesthesia Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate maximum safe local anesthetic doses and carpule limits. <strong class="text-red-600">For educational reference only.</strong></p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Patient Weight</label><input type="number" id="da-wt" class="da-in w-full px-4 py-3 border border-border rounded-xl text-2xl font-bold" value="70" min="10" max="200" step="1"></div>
          <div>
            <label class="block text-xs font-medium text-text mb-1">Weight Unit</label>
            <select id="da-unit" class="da-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
              <option value="kg" selected>Kilograms (kg)</option>
              <option value="lbs">Pounds (lbs)</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Anesthetic Agent</label>
          <select id="da-agent" class="da-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
            <option value="lido2epi" selected>Lidocaine 2% with Epinephrine 1:100,000</option>
            <option value="lido2">Lidocaine 2% (plain, no epi)</option>
            <option value="artic4epi">Articaine 4% with Epinephrine 1:100,000</option>
            <option value="artic4epi200">Articaine 4% with Epinephrine 1:200,000</option>
            <option value="mepi3">Mepivacaine 3% (plain)</option>
            <option value="mepi2epi">Mepivacaine 2% with Levonordefrin 1:20,000</option>
            <option value="bupi05epi">Bupivacaine 0.5% with Epinephrine 1:200,000</option>
            <option value="prilo4epi">Prilocaine 4% with Epinephrine 1:200,000</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-text mb-1">Patient Status</label>
          <select id="da-status" class="da-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold">
            <option value="normal" selected>Healthy Adult</option>
            <option value="child">Child (under 12)</option>
            <option value="cardiac">Cardiac Patient (limit epi)</option>
            <option value="pregnant">Pregnant</option>
            <option value="elderly">Elderly (over 70)</option>
          </select>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Maximum Dose</div>
          <div class="text-5xl font-extrabold font-mono" id="da-maxdose">0 mg</div>
        </div>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Max Carpules (1.7 mL)</div><div class="text-xl font-bold font-mono" id="da-carp">0</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">mg per Carpule</div><div class="text-xl font-bold font-mono" id="da-mgcarp">0 mg</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Max Dose (mg/kg)</div><div class="text-xl font-bold font-mono" id="da-mgkg">0</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Duration of Action</div><div class="text-xl font-bold font-mono" id="da-dur">-</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Max Epi Dose</div><div class="text-xl font-bold font-mono" id="da-epi">-</div></div>
        </div>
        <div class="p-3 bg-red-50 rounded-xl text-center text-xs text-red-800 font-bold">
          For educational reference only. Always verify doses with current pharmacological references and consider individual patient factors.
        </div>
      </div>
      <ShareButton calculatorId="dental-anesthesia" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function calcDA() {
      let wt = parseFloat((document.getElementById('da-wt') as HTMLInputElement).value) || 70;
      const unit = (document.getElementById('da-unit') as HTMLSelectElement).value;
      const agent = (document.getElementById('da-agent') as HTMLSelectElement).value;
      const status = (document.getElementById('da-status') as HTMLSelectElement).value;

      if (unit === 'lbs') wt = wt * 0.453592;

      // Agent properties: { concentration (%), maxDosePerKg (mg/kg), absoluteMax (mg), mgPerCarpule, hasEpi, epiConc, duration }
      const agents: Record<string, { conc: number; maxMgKg: number; absMax: number; mgPerCart: number; hasEpi: boolean; epiConc: string; durPulp: string; durSoft: string }> = {
        'lido2epi':     { conc: 2, maxMgKg: 7.0, absMax: 500, mgPerCart: 34, hasEpi: true, epiConc: '1:100,000', durPulp: '60 min', durSoft: '3-5 hrs' },
        'lido2':        { conc: 2, maxMgKg: 4.4, absMax: 300, mgPerCart: 34, hasEpi: false, epiConc: 'None', durPulp: '5-10 min', durSoft: '1-2 hrs' },
        'artic4epi':    { conc: 4, maxMgKg: 7.0, absMax: 500, mgPerCart: 68, hasEpi: true, epiConc: '1:100,000', durPulp: '60-75 min', durSoft: '3-6 hrs' },
        'artic4epi200': { conc: 4, maxMgKg: 7.0, absMax: 500, mgPerCart: 68, hasEpi: true, epiConc: '1:200,000', durPulp: '45-60 min', durSoft: '2-5 hrs' },
        'mepi3':        { conc: 3, maxMgKg: 6.6, absMax: 400, mgPerCart: 51, hasEpi: false, epiConc: 'None', durPulp: '20-40 min', durSoft: '2-3 hrs' },
        'mepi2epi':     { conc: 2, maxMgKg: 6.6, absMax: 400, mgPerCart: 34, hasEpi: true, epiConc: '1:20,000 (levo)', durPulp: '60 min', durSoft: '3-5 hrs' },
        'bupi05epi':    { conc: 0.5, maxMgKg: 2.0, absMax: 90, mgPerCart: 8.5, hasEpi: true, epiConc: '1:200,000', durPulp: '90-180 min', durSoft: '4-9 hrs' },
        'prilo4epi':    { conc: 4, maxMgKg: 8.0, absMax: 600, mgPerCart: 68, hasEpi: true, epiConc: '1:200,000', durPulp: '60-90 min', durSoft: '3-8 hrs' }
      };

      const a = agents[agent];
      let maxMgKg = a.maxMgKg;
      let absMax = a.absMax;

      // Adjust for patient status
      if (status === 'child') {
        // Children: same mg/kg but lower absolute max
        absMax = Math.min(absMax, wt * maxMgKg);
      } else if (status === 'cardiac') {
        // Limit epinephrine-containing doses
        if (a.hasEpi) maxMgKg = Math.min(maxMgKg, 4.4);
      } else if (status === 'pregnant') {
        // Category B: lidocaine with epi is preferred, but conservative dosing
        maxMgKg = Math.min(maxMgKg, 4.4);
      } else if (status === 'elderly') {
        maxMgKg *= 0.8; // Reduce by 20%
      }

      const maxDose = Math.min(Math.round(wt * maxMgKg), absMax);
      const maxCarpules = Math.floor(maxDose / a.mgPerCart * 10) / 10;
      const duration = a.hasEpi ? a.durPulp + ' pulp / ' + a.durSoft + ' soft' : a.durPulp + ' pulp / ' + a.durSoft + ' soft';

      // Epi max dose for cardiac: 0.04 mg (2 carpules of 1:100,000)
      let epiText = 'N/A';
      if (a.hasEpi) {
        if (status === 'cardiac') {
          epiText = '0.04 mg max (~2 carts)';
        } else {
          epiText = '0.2 mg max (~11 carts)';
        }
      }

      document.getElementById('da-maxdose')!.textContent = maxDose + ' mg';
      document.getElementById('da-carp')!.textContent = maxCarpules.toFixed(1);
      document.getElementById('da-mgcarp')!.textContent = a.mgPerCart + ' mg';
      document.getElementById('da-mgkg')!.textContent = maxMgKg.toFixed(1) + ' mg/kg';
      document.getElementById('da-dur')!.textContent = a.durPulp;
      document.getElementById('da-epi')!.textContent = epiText;

      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.da-in').forEach(el => { el.addEventListener('input', calcDA); el.addEventListener('change', calcDA); });
      calcDA();
    }, 50);
  </script>
</CalculatorLayout>
