---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';
const title = "Bearing Calculator";
const description = "Calculate initial and final bearing between two lat/lon points, back azimuth, and rhumb line bearing.";
const relatedCalcs = [
  { name: "Polar Coordinates", url: "/polar-coordinates-calculator", description: "Polar coords." },
  { name: "Degrees Radians", url: "/degrees-radians-converter-calculator", description: "Angles." },
  { name: "Speed Calculator", url: "/speed-calculator", description: "Speed." },
  { name: "Slope Calculator", url: "/slope-calculator", description: "Slope." },
  { name: "Length Converter", url: "/length-converter-calculator", description: "Distances." },
  { name: "Road Trip", url: "/road-trip-calculator", description: "Trip planning." },
];
---
<CalculatorLayout title={title} description={description} calculatorName="Bearing Calculator" keywords="bearing, azimuth, navigation, initial bearing, final bearing, back azimuth, rhumb line" breadcrumbs={[{ name: "Bearing", url: "/bearing-calculator" }]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Bearing Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Calculate the bearing (direction) between two geographic coordinates, plus back azimuth and rhumb line.</p>
    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8 max-w-2xl mx-auto">
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">Start Latitude</label><input type="number" id="bg-lat1" class="bg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="40.7128" step="0.0001" min="-90" max="90"></div>
          <div><label class="block text-xs font-medium text-text mb-1">Start Longitude</label><input type="number" id="bg-lon1" class="bg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="-74.006" step="0.0001" min="-180" max="180"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-xs font-medium text-text mb-1">End Latitude</label><input type="number" id="bg-lat2" class="bg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="48.8566" step="0.0001" min="-90" max="90"></div>
          <div><label class="block text-xs font-medium text-text mb-1">End Longitude</label><input type="number" id="bg-lon2" class="bg-in w-full px-4 py-3 border border-border rounded-xl text-lg font-bold" value="2.3522" step="0.0001" min="-180" max="180"></div>
        </div>
        <div class="p-6 bg-primary rounded-2xl text-white text-center">
          <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Initial Bearing</div>
          <div class="text-5xl font-extrabold font-mono" id="bg-result">--</div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Final Bearing</div><div class="text-xl font-bold font-mono" id="bg-final">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Back Azimuth</div><div class="text-xl font-bold font-mono" id="bg-back">--</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Rhumb Line Bearing</div><div class="text-xl font-bold font-mono" id="bg-rhumb">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Rhumb Line Distance</div><div class="text-xl font-bold font-mono" id="bg-rdist">--</div></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Great Circle Distance</div><div class="text-xl font-bold font-mono" id="bg-gcd">--</div></div>
          <div class="p-4 bg-surface-alt rounded-xl text-center"><div class="text-xs text-text-muted uppercase">Compass Direction</div><div class="text-xl font-bold font-mono" id="bg-compass">--</div></div>
        </div>
      </div>
      <ShareButton calculatorId="bearing" />
      <FeedbackWidget />
    </div>
    <RelatedCalculators calculators={relatedCalcs} />
  </div>
  <script>
    function toRad(d: number) { return d * Math.PI / 180; }
    function toDeg(r: number) { return r * 180 / Math.PI; }
    function compassDir(deg: number): string {
      const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      return dirs[Math.round(deg / 22.5) % 16];
    }
    function calcBG() {
      const lat1 = parseFloat((document.getElementById('bg-lat1') as HTMLInputElement).value) || 0;
      const lon1 = parseFloat((document.getElementById('bg-lon1') as HTMLInputElement).value) || 0;
      const lat2 = parseFloat((document.getElementById('bg-lat2') as HTMLInputElement).value) || 0;
      const lon2 = parseFloat((document.getElementById('bg-lon2') as HTMLInputElement).value) || 0;
      const f1 = toRad(lat1); const f2 = toRad(lat2);
      const dl = toRad(lon2 - lon1);
      const y = Math.sin(dl) * Math.cos(f2);
      const x = Math.cos(f1) * Math.sin(f2) - Math.sin(f1) * Math.cos(f2) * Math.cos(dl);
      const initialBearing = (toDeg(Math.atan2(y, x)) + 360) % 360;
      const y2 = Math.sin(-dl) * Math.cos(f1);
      const x2 = Math.cos(f2) * Math.sin(f1) - Math.sin(f2) * Math.cos(f1) * Math.cos(-dl);
      const finalBearing = (toDeg(Math.atan2(y2, x2)) + 180) % 360;
      const backAz = (initialBearing + 180) % 360;
      const dPhi = Math.log(Math.tan(Math.PI / 4 + f2 / 2) / Math.tan(Math.PI / 4 + f1 / 2));
      const q = Math.abs(dPhi) > 1e-12 ? (f2 - f1) / dPhi : Math.cos(f1);
      let dLon = lon2 - lon1;
      if (Math.abs(dLon) > 180) dLon = dLon > 0 ? -(360 - dLon) : (360 + dLon);
      const rhumbBearing = (toDeg(Math.atan2(toRad(dLon), dPhi)) + 360) % 360;
      const rhumbDist = Math.sqrt((f2 - f1) * (f2 - f1) + q * q * toRad(dLon) * toRad(dLon)) * 6371;
      const a = Math.sin((f2 - f1) / 2) ** 2 + Math.cos(f1) * Math.cos(f2) * Math.sin(dl / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const gcDist = 6371 * c;

      document.getElementById('bg-result')!.textContent = initialBearing.toFixed(2) + '\u00b0';
      document.getElementById('bg-final')!.textContent = finalBearing.toFixed(2) + '\u00b0';
      document.getElementById('bg-back')!.textContent = backAz.toFixed(2) + '\u00b0';
      document.getElementById('bg-rhumb')!.textContent = rhumbBearing.toFixed(2) + '\u00b0';
      document.getElementById('bg-rdist')!.textContent = rhumbDist.toFixed(1) + ' km';
      document.getElementById('bg-gcd')!.textContent = gcDist.toFixed(1) + ' km';
      document.getElementById('bg-compass')!.textContent = compassDir(initialBearing);
      document.dispatchEvent(new CustomEvent('calc-update'));
    }
    setTimeout(() => {
      document.querySelectorAll('.bg-in').forEach(el => { el.addEventListener('input', calcBG); el.addEventListener('change', calcBG); });
      calcBG();
    }, 50);
  </script>
</CalculatorLayout>
