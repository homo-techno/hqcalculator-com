---
import CalculatorLayout from '../layouts/CalculatorLayout.astro';
import ShareButton from '../components/ShareButton.astro';
import FeedbackWidget from '../components/FeedbackWidget.astro';
import RelatedCalculators from '../components/RelatedCalculators.astro';

const title = "Floor Joist Calculator - Span, Spacing, Board Feet & Deflection";
const description = "Calculate floor joist requirements including max span, number of joists, board feet, and deflection check for your framing project.";

const relatedCalcs = [
  { name: "Structural Load Calculator", url: "/structural-load-calculator", description: "Load analysis." },
  { name: "Truss Calculator", url: "/truss-calculator", description: "Roof truss design." },
  { name: "Rafter Calculator", url: "/rafter-calculator", description: "Rafter length." },
  { name: "Foundation Calculator", url: "/foundation-calculator", description: "Foundation estimator." },
  { name: "Column Calculator", url: "/column-calculator", description: "Column sizing." },
  { name: "Load Bearing Wall Calculator", url: "/load-bearing-wall-calculator", description: "Wall load analysis." },
];
---

<CalculatorLayout
  title={title}
  description={description}
  calculatorName="Floor Joist Calculator"
  keywords="floor joist calculator, joist span, joist spacing, board feet, deflection, joist sizing, floor framing"
  breadcrumbs={[{ name: "Floor Joist Calculator", url: "/floor-joist-calculator" }]}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-text mb-2">Floor Joist Calculator</h1>
    <p class="text-text-secondary mb-8 max-w-2xl">Determine joist count, board feet, and check deflection for floor framing.</p>

    <div class="bg-white border border-border rounded-2xl shadow-sm p-6 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <div class="grid grid-cols-2 gap-3 mb-5">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Joist Span (ft)</label>
              <input type="number" id="fj-span" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="14" min="2" step="0.5">
            </div>
            <div>
              <label class="block text-xs font-medium text-text mb-1">Floor Length (ft)</label>
              <input type="number" id="fj-length" class="w-full px-3 py-3 border border-border rounded-xl text-lg" value="24" min="2" step="0.5">
            </div>
          </div>

          <div class="mb-5">
            <label class="block text-xs font-medium text-text mb-1">Joist Spacing</label>
            <select id="fj-spacing" class="w-full px-3 py-3 border border-border rounded-xl text-lg">
              <option value="12">12 inches OC</option>
              <option value="16" selected>16 inches OC (standard)</option>
              <option value="24">24 inches OC</option>
            </select>
          </div>

          <div class="mb-5">
            <label class="block text-xs font-medium text-text mb-1">Lumber Size</label>
            <select id="fj-size" class="w-full px-3 py-3 border border-border rounded-xl text-lg">
              <option value="2x6">2x6 (1.5" x 5.5")</option>
              <option value="2x8" selected>2x8 (1.5" x 7.25")</option>
              <option value="2x10">2x10 (1.5" x 9.25")</option>
              <option value="2x12">2x12 (1.5" x 11.25")</option>
            </select>
          </div>

          <div class="p-4 bg-surface-alt rounded-xl">
            <div>
              <label class="block text-xs font-medium text-text mb-1">Total Floor Load (psf)</label>
              <input type="number" id="fj-load" class="w-full px-3 py-2 border border-border rounded-lg" value="50" min="10" step="5">
              <div class="text-xs text-text-muted mt-1">40 psf live + 10 psf dead typical</div>
            </div>
          </div>
        </div>

        <div class="space-y-3">
          <div class="p-6 bg-primary rounded-2xl text-white text-center">
            <div class="text-sm text-blue-200 uppercase tracking-wide mb-1">Number of Joists</div>
            <div class="text-5xl font-extrabold font-mono" id="fj-count">0</div>
            <div class="text-sm text-blue-200 mt-1">joists required</div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Max Span for Size</div>
              <div class="text-xl font-bold" id="fj-maxspan">0 ft</div>
              <div class="text-xs text-text-muted">at selected spacing</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Total Board Feet</div>
              <div class="text-xl font-bold" id="fj-bdft">0</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Deflection</div>
              <div class="text-xl font-bold" id="fj-deflect">0 in</div>
              <div class="text-xs text-text-muted">at center of span</div>
            </div>
            <div class="p-4 bg-surface-alt rounded-xl text-center">
              <div class="text-xs text-text-muted uppercase">Deflection Check</div>
              <div class="text-xl font-bold" id="fj-check">--</div>
              <div class="text-xs text-text-muted">L/360 limit</div>
            </div>
          </div>
          <div class="p-4 bg-surface-alt rounded-xl text-center">
            <div class="text-xs text-text-muted uppercase">Total Load on Floor</div>
            <div class="text-xl font-bold" id="fj-totalload">0 lbs</div>
          </div>
        </div>
      </div>

      <ShareButton calculatorId="floor-joist" />
      <FeedbackWidget />
    </div>

    <article class="mt-12 max-w-4xl prose prose-slate">
      <h2 class="text-2xl font-bold text-text">How to Calculate Floor Joists</h2>
      <div class="bg-surface-alt rounded-xl p-4 my-4 font-mono text-sm space-y-1">
        <p><strong>Number of joists:</strong> (Floor length x 12 / Spacing) + 1</p>
        <p><strong>Board feet:</strong> Joists x Span x (nominal width x nominal depth / 12)</p>
        <p><strong>Deflection:</strong> 5wL^4 / (384EI) - must be less than L/360</p>
      </div>

      <h3 class="text-xl font-semibold text-text mt-8">Maximum Joist Spans (SPF #2, 40 psf live)</h3>
      <ul>
        <li><strong>2x6 @ 16" OC:</strong> 9 ft 1 in</li>
        <li><strong>2x8 @ 16" OC:</strong> 12 ft 0 in</li>
        <li><strong>2x10 @ 16" OC:</strong> 15 ft 4 in</li>
        <li><strong>2x12 @ 16" OC:</strong> 18 ft 8 in</li>
      </ul>
    </article>

    <RelatedCalculators calculators={relatedCalcs} />
  </div>

  <script>
    const fjSizes: Record<string, { d: number; nomW: number; nomD: number; I: number }> = {
      '2x6':  { d: 5.5,  nomW: 2, nomD: 6,  I: 20.80 },
      '2x8':  { d: 7.25, nomW: 2, nomD: 8,  I: 47.63 },
      '2x10': { d: 9.25, nomW: 2, nomD: 10, I: 98.93 },
      '2x12': { d: 11.25, nomW: 2, nomD: 12, I: 177.98 },
    };

    // Max spans in feet for 16" OC, SPF #2, 40 psf LL + 10 DL
    const fjMaxSpans16: Record<string, number> = {
      '2x6': 9.1, '2x8': 12.0, '2x10': 15.3, '2x12': 18.7,
    };
    const fjMaxSpans12: Record<string, number> = {
      '2x6': 10.5, '2x8': 13.9, '2x10': 17.7, '2x12': 21.6,
    };
    const fjMaxSpans24: Record<string, number> = {
      '2x6': 7.4, '2x8': 9.9, '2x10': 12.6, '2x12': 15.3,
    };

    function calcFloorJoist() {
      const span = parseFloat((document.getElementById('fj-span') as HTMLInputElement).value) || 0;
      const floorLength = parseFloat((document.getElementById('fj-length') as HTMLInputElement).value) || 0;
      const spacing = parseFloat((document.getElementById('fj-spacing') as HTMLSelectElement).value) || 16;
      const size = (document.getElementById('fj-size') as HTMLSelectElement).value;
      const load = parseFloat((document.getElementById('fj-load') as HTMLInputElement).value) || 50;

      const lumber = fjSizes[size] || fjSizes['2x8'];
      const numJoists = Math.ceil((floorLength * 12) / spacing) + 1;

      // Board feet: nominal dimensions
      const bdFtPerJoist = span * lumber.nomW * lumber.nomD / 12;
      const totalBdFt = Math.ceil(bdFtPerJoist * numJoists);

      // Max span lookup
      let maxSpanTable = fjMaxSpans16;
      if (spacing === 12) maxSpanTable = fjMaxSpans12;
      else if (spacing === 24) maxSpanTable = fjMaxSpans24;
      const maxSpan = maxSpanTable[size] || 12;

      // Deflection: 5wL^4 / (384EI)
      // w = load per inch of joist (psf * spacing / 12)
      // E for SPF #2 = 1,400,000 psi
      const E = 1400000;
      const w = (load * spacing / 12) / 12; // lb/in
      const L = span * 12; // inches
      const I = lumber.I;
      const deflection = (5 * w * Math.pow(L, 4)) / (384 * E * I);
      const limitDeflection = L / 360;
      const passes = deflection <= limitDeflection;

      const floorArea = span * floorLength;
      const totalFloorLoad = floorArea * load;

      document.getElementById('fj-count')!.textContent = String(numJoists);
      document.getElementById('fj-maxspan')!.textContent = maxSpan.toFixed(1) + ' ft';
      document.getElementById('fj-bdft')!.textContent = totalBdFt.toLocaleString();
      document.getElementById('fj-deflect')!.textContent = deflection.toFixed(3) + ' in';
      document.getElementById('fj-check')!.textContent = passes ? 'PASS' : 'FAIL';
      (document.getElementById('fj-check') as HTMLElement).style.color = passes ? '#16a34a' : '#dc2626';
      document.getElementById('fj-totalload')!.textContent = Math.round(totalFloorLoad).toLocaleString() + ' lbs';

      document.dispatchEvent(new CustomEvent('calc-update'));
    }

    setTimeout(() => {
      document.querySelectorAll('#fj-span, #fj-length, #fj-load').forEach(el => {
        el.addEventListener('input', calcFloorJoist);
        el.addEventListener('change', calcFloorJoist);
      });
      document.querySelectorAll('#fj-spacing, #fj-size').forEach(el => {
        el.addEventListener('input', calcFloorJoist);
        el.addEventListener('change', calcFloorJoist);
      });
      calcFloorJoist();
    }, 50);
  </script>
</CalculatorLayout>
